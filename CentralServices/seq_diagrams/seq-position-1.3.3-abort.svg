<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3396px" preserveAspectRatio="none" style="width:1619px;height:3396px;" version="1.1" viewBox="0 0 1619 3396" width="1619px" zoomAndPan="magnify"><defs><filter height="300%" id="f1wduiupjr6sn1" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="276" x="672.5" y="23.5352">1.3.3 Abort Position Handler Consume</text><rect fill="#FFFFE0" height="3350.627" style="stroke: #A80036; stroke-width: 1.0;" width="1352.5" x="39" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="664.75" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="3183.3398" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="97.5" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="606.5" y="3264.627"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="884.5" y="211.5293"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="502.5898" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="884.5" y="474.6348"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="884.5" y="1543.4727"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="119.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="884.5" y="1791.2676"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="884.5" y="2370.2734"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="119.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="884.5" y="2602.7578"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1334.5" y="240.8398"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1334.5" y="528.2559"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1334.5" y="662.498"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1334.5" y="770.4297"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1334.5" y="1572.7832"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1334.5" y="1844.8887"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1334.5" y="2399.584"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1334.5" y="2656.3789"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="3169.3398" style="stroke: #000000; stroke-width: 2.0;" width="1595" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="1317.9434" style="stroke: #000000; stroke-width: 2.0;" width="1575" x="23" y="157.5977"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="564.5215" style="stroke: #000000; stroke-width: 2.0;" width="1555" x="33" y="420.7031"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="459.2793" style="stroke: #000000; stroke-width: 2.0;" width="746.5" x="831.5" y="489.6348"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="812.8008" style="stroke: #000000; stroke-width: 2.0;" width="1402" x="23" y="1489.541"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="181.8633" style="stroke: #000000; stroke-width: 2.0;" width="1374.5" x="33" y="1737.3359"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="76.6211" style="stroke: #000000; stroke-width: 2.0;" width="566" x="831.5" y="1806.2676"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="904.6641" style="stroke: #000000; stroke-width: 2.0;" width="1402" x="23" y="2316.3418"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="181.8633" style="stroke: #000000; stroke-width: 2.0;" width="1374.5" x="33" y="2548.8262"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="76.6211" style="stroke: #000000; stroke-width: 2.0;" width="566" x="831.5" y="2617.7578"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="102" x2="102" y1="116.2871" y2="3319.627"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="611.5" x2="611.5" y1="116.2871" y2="3319.627"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="757.5" x2="757.5" y1="116.2871" y2="3319.627"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="889.5" x2="889.5" y1="116.2871" y2="3319.627"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1339.5" x2="1339.5" y1="116.2871" y2="3319.627"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="43" y="113.334">Position Handler</text><ellipse cx="102.5" cy="83.7988" fill="#FEFECE" filter="url(#f1wduiupjr6sn1)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="98.5,71.7988,104.5,66.7988,102.5,71.7988,104.5,76.7988,98.5,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="43" y="3332.1621">Position Handler</text><ellipse cx="102.5" cy="3351.1152" fill="#FEFECE" filter="url(#f1wduiupjr6sn1)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="98.5,3339.1152,104.5,3334.1152,102.5,3339.1152,104.5,3344.1152,98.5,3339.1152" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f1wduiupjr6sn1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="552.5" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1wduiupjr6sn1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="548.5" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="555.5" y="101.334">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#f1wduiupjr6sn1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="552.5" y="3318.627"/><rect fill="#FEFECE" filter="url(#f1wduiupjr6sn1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="548.5" y="3322.627"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="555.5" y="3343.1621">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#f1wduiupjr6sn1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="688.5" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1wduiupjr6sn1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="684.5" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="691.5" y="101.334">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f1wduiupjr6sn1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="688.5" y="3318.627"/><rect fill="#FEFECE" filter="url(#f1wduiupjr6sn1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="684.5" y="3322.627"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="691.5" y="3343.1621">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="841.5" y="113.334">Position DAO</text><ellipse cx="889.5" cy="83.7988" fill="#FEFECE" filter="url(#f1wduiupjr6sn1)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="877.5" x2="901.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="841.5" y="3332.1621">Position DAO</text><ellipse cx="889.5" cy="3351.1152" fill="#FEFECE" filter="url(#f1wduiupjr6sn1)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="877.5" x2="901.5" y1="3365.1152" y2="3365.1152"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1291.5" y="113.334">Central Store</text><path d="M1321.5,63.7988 C1321.5,53.7988 1339.5,53.7988 1339.5,53.7988 C1339.5,53.7988 1357.5,53.7988 1357.5,63.7988 L1357.5,89.7988 C1357.5,99.7988 1339.5,99.7988 1339.5,99.7988 C1339.5,99.7988 1321.5,99.7988 1321.5,89.7988 L1321.5,63.7988 " fill="#FEFECE" filter="url(#f1wduiupjr6sn1)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1321.5,63.7988 C1321.5,73.7988 1339.5,73.7988 1339.5,73.7988 C1339.5,73.7988 1357.5,73.7988 1357.5,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1291.5" y="3332.1621">Central Store</text><path d="M1321.5,3345.1152 C1321.5,3335.1152 1339.5,3335.1152 1339.5,3335.1152 C1339.5,3335.1152 1357.5,3335.1152 1357.5,3345.1152 L1357.5,3371.1152 C1357.5,3381.1152 1339.5,3381.1152 1339.5,3381.1152 C1339.5,3381.1152 1321.5,3381.1152 1321.5,3371.1152 L1321.5,3345.1152 " fill="#FEFECE" filter="url(#f1wduiupjr6sn1)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1321.5,3345.1152 C1321.5,3355.1152 1339.5,3355.1152 1339.5,3355.1152 C1339.5,3355.1152 1357.5,3355.1152 1357.5,3345.1152 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="3183.3398" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="97.5" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="606.5" y="3264.627"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="884.5" y="211.5293"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="502.5898" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="884.5" y="474.6348"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="884.5" y="1543.4727"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="119.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="884.5" y="1791.2676"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="884.5" y="2370.2734"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="119.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="884.5" y="2602.7578"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1334.5" y="240.8398"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1334.5" y="528.2559"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1334.5" y="662.498"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1334.5" y="770.4297"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1334.5" y="1572.7832"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1334.5" y="1844.8887"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1334.5" y="2399.584"/><rect fill="#FFFFFF" filter="url(#f1wduiupjr6sn1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1334.5" y="2656.3789"/><path d="M13,133.2871 L278,133.2871 L278,140.2871 L268,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3169.3398" style="stroke: #000000; stroke-width: 2.0;" width="1595" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="220" x="28" y="146.8555">Abort Position Handler Consume</text><path d="M23,157.5977 L90,157.5977 L90,164.5977 L80,174.5977 L23,174.5977 L23,157.5977 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1317.9434" style="stroke: #000000; stroke-width: 2.0;" width="1575" x="23" y="157.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="38" y="171.166">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="297" x="105" y="170.2324">[type == 'position' &amp;&amp; action == 'timeout-reserved']</text><polygon fill="#A80036" points="872.5,207.5293,882.5,211.5293,872.5,215.5293,876.5,211.5293" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="878.5" y1="211.5293" y2="211.5293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="114.5" y="199.1318">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="127.5" y="191.4766">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="127.5" y="206.7871">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="204.5" y="206.7871">2003</text><polygon fill="#A80036" points="1322.5,236.8398,1332.5,240.8398,1322.5,244.8398,1326.5,240.8398" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="894.5" x2="1328.5" y1="240.8398" y2="240.8398"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="901.5" y="236.0977">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="914.5" y="236.0977">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#f1wduiupjr6sn1)" points="1274,253.8398,1405,253.8398,1415,272.8398,1405,291.8398,1274,291.8398,1264,272.8398,1274,253.8398" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1276" y="270.4082">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1276" y="285.7188">transferParticipant</text><polygon fill="#A80036" points="905.5,314.7715,895.5,318.7715,905.5,322.7715,901.5,318.7715" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="899.5" x2="1338.5" y1="318.7715" y2="318.7715"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="911.5" y="314.0293">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="924.5" y="314.0293">Return current state of transfer from DB</text><polygon fill="#A80036" points="118.5,344.082,108.5,348.082,118.5,352.082,114.5,348.082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="888.5" y1="348.082" y2="348.082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="124.5" y="343.3398">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="137.5" y="343.3398">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="149.5" y1="392.7031" y2="392.7031"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="149.5" x2="149.5" y1="392.7031" y2="405.7031"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="108.5" x2="149.5" y1="405.7031" y2="405.7031"/><polygon fill="#A80036" points="118.5,401.7031,108.5,405.7031,118.5,409.7031,114.5,405.7031" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="114.5" y="380.3057">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="454" x="127.5" y="372.6504">Validate current state (transferStateChange.transferStateId == 'EXPIRED')</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="127.5" y="387.9609">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="204.5" y="387.9609">2001</text><path d="M33,420.7031 L234,420.7031 L234,427.7031 L224,437.7031 L33,437.7031 L33,420.7031 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="564.5215" style="stroke: #000000; stroke-width: 2.0;" width="1555" x="33" y="420.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="156" x="48" y="434.2715">Persist Position change</text><polygon fill="#A80036" points="872.5,470.6348,882.5,474.6348,872.5,478.6348,876.5,474.6348" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="878.5" y1="474.6348" y2="474.6348"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="114.5" y="462.2373">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="127.5" y="454.582">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="127.5" y="469.8926">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="204.5" y="469.8926">2003</text><path d="M831.5,489.6348 L1123.5,489.6348 L1123.5,496.6348 L1113.5,506.6348 L831.5,506.6348 L831.5,489.6348 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="459.2793" style="stroke: #000000; stroke-width: 2.0;" width="746.5" x="831.5" y="489.6348"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="247" x="846.5" y="503.2031">DB TRANSACTION IMPLEMENTATION</text><polygon fill="#A80036" points="1322.5,524.2559,1332.5,528.2559,1322.5,532.2559,1326.5,528.2559" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="894.5" x2="1328.5" y1="528.2559" y2="528.2559"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="901.5" y="523.5137">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="408" x="914.5" y="523.5137">Select participantPosition.value FOR UPDATE for payerCurrencyId</text><polygon fill="#FFFFE0" filter="url(#f1wduiupjr6sn1)" points="1278,541.2559,1401,541.2559,1411,552.2559,1401,564.2559,1278,564.2559,1268,552.2559,1278,541.2559" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="1280" y="557.8242">participantPosition</text><polygon fill="#A80036" points="905.5,586.877,895.5,590.877,905.5,594.877,901.5,590.877" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="899.5" x2="1338.5" y1="590.877" y2="590.877"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="911.5" y="586.1348">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="924.5" y="586.1348">Return participantPosition</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="894.5" x2="936.5" y1="620.1875" y2="620.1875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="936.5" x2="936.5" y1="620.1875" y2="633.1875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="895.5" x2="936.5" y1="633.1875" y2="633.1875"/><polygon fill="#A80036" points="905.5,629.1875,895.5,633.1875,905.5,637.1875,901.5,633.1875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="901.5" y="615.4453">9</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="90" x="914.5" y="615.4453">latestPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="1008.5" y="615.4453">= participantPosition - payload.amount.amount</text><polygon fill="#A80036" points="1322.5,658.498,1332.5,662.498,1322.5,666.498,1326.5,662.498" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="894.5" x2="1328.5" y1="662.498" y2="662.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="901.5" y="657.7559">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="229" x="923.5" y="657.7559">Persist latestPosition to DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f1wduiupjr6sn1)" points="1247,705.498,1432,705.498,1442,724.498,1432,743.498,1247,743.498,1237,724.498,1247,705.498" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1249" y="722.0664">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1303" y="722.0664">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="1249" y="737.377">SET value = latestPosition</text><polygon fill="#A80036" points="1322.5,766.4297,1332.5,770.4297,1322.5,774.4297,1326.5,770.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="894.5" x2="1328.5" y1="770.4297" y2="770.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="901.5" y="765.6875">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="330" x="923.5" y="765.6875">Persist participant position change and state change</text><polygon fill="#FFFFE0" filter="url(#f1wduiupjr6sn1)" points="1121,813.4297,1558,813.4297,1568,878.4297,1558,943.4297,1121,943.4297,1111,878.4297,1121,813.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="1123" y="829.998">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1171" y="829.998">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="1314" y="829.998">transferStateId = 'EXPIRED_RESERVED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1127" y="845.3086"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="1123" y="860.6191">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="1171" y="860.6191">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="433" x="1123" y="875.9297">SET participantPositionId = participantPosition.participantPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="431" x="1123" y="891.2402">transferStateChangeId = transferStateChange.transferStateChangeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="1123" y="906.5508">value = latestPosition,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="1123" y="921.8613">reservedValue = participantPosition.reservedValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="1123" y="937.1719">createdDate = new Date()</text><polygon fill="#A80036" points="118.5,973.2246,108.5,977.2246,118.5,981.2246,114.5,977.2246" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="888.5" y1="977.2246" y2="977.2246"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="972.4824">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="146.5" y="972.4824">Return success</text><path d="M112,997.2246 L112,1466.2246 L516,1466.2246 L516,1007.2246 L506,997.2246 L112,997.2246 " fill="#FFFF00" filter="url(#f1wduiupjr6sn1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M506,997.2246 L506,1007.2246 L516,1007.2246 L506,997.2246 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="118" y="1014.793">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="134" y="1030.1035">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="134" y="1045.4141">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="134" y="1060.7246">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="134" y="1076.0352">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="134" y="1091.3457">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="150" y="1106.6563">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="150" y="1121.9668">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="170" y="1137.2773">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="186" y="1152.5879">"errorCode": 3303,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="186" y="1167.8984">"errorDescription": "Transfer expired",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="186" y="1183.209">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="170" y="1198.5195">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="1213.8301">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="134" y="1229.1406">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="134" y="1244.4512">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="150" y="1259.7617">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="166" y="1275.0723">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="166" y="1290.3828">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="166" y="1305.6934">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="166" y="1321.0039">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="166" y="1336.3145">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="166" y="1351.625">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="182" y="1366.9355">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="182" y="1382.2461">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="182" y="1397.5566">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="1412.8672">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="1428.1777">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="1443.4883">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="118" y="1458.7988">}</text><path d="M23,1489.541 L90,1489.541 L90,1496.541 L80,1506.541 L23,1506.541 L23,1489.541 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="812.8008" style="stroke: #000000; stroke-width: 2.0;" width="1402" x="23" y="1489.541"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="38" y="1503.1094">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="230" x="105" y="1502.1758">[type == 'position' &amp;&amp; action == 'reject']</text><polygon fill="#A80036" points="872.5,1539.4727,882.5,1543.4727,872.5,1547.4727,876.5,1543.4727" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="878.5" y1="1543.4727" y2="1543.4727"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="1531.0752">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="136.5" y="1523.4199">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="1538.7305">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="1538.7305">2003</text><polygon fill="#A80036" points="1322.5,1568.7832,1332.5,1572.7832,1322.5,1576.7832,1326.5,1572.7832" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="894.5" x2="1328.5" y1="1572.7832" y2="1572.7832"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="901.5" y="1568.041">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="923.5" y="1568.041">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#f1wduiupjr6sn1)" points="1274,1585.7832,1405,1585.7832,1415,1596.7832,1405,1608.7832,1274,1608.7832,1264,1596.7832,1274,1585.7832" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1276" y="1602.3516">transferStateChange</text><polygon fill="#A80036" points="905.5,1631.4043,895.5,1635.4043,905.5,1639.4043,901.5,1635.4043" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="899.5" x2="1338.5" y1="1635.4043" y2="1635.4043"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="911.5" y="1630.6621">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="933.5" y="1630.6621">Return current state of transfer from DB</text><polygon fill="#A80036" points="118.5,1660.7148,108.5,1664.7148,118.5,1668.7148,114.5,1664.7148" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="888.5" y1="1664.7148" y2="1664.7148"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="1659.9727">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="146.5" y="1659.9727">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="149.5" y1="1709.3359" y2="1709.3359"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="149.5" x2="149.5" y1="1709.3359" y2="1722.3359"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="108.5" x2="149.5" y1="1722.3359" y2="1722.3359"/><polygon fill="#A80036" points="118.5,1718.3359,108.5,1722.3359,118.5,1726.3359,114.5,1722.3359" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="1696.9385">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="463" x="136.5" y="1689.2832">Validate current state (transferStateChange.transferStateId == 'REJECTED')</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="1704.5938">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="1704.5938">2001</text><path d="M33,1737.3359 L735,1737.3359 L735,1744.3359 L725,1754.3359 L33,1754.3359 L33,1737.3359 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="181.8633" style="stroke: #000000; stroke-width: 2.0;" width="1374.5" x="33" y="1737.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="657" x="48" y="1750.9043">Persist Position change and Transfer State (with transferState='ABORTED' on position check pass)</text><polygon fill="#A80036" points="872.5,1787.2676,882.5,1791.2676,872.5,1795.2676,876.5,1791.2676" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="878.5" y1="1791.2676" y2="1791.2676"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="1778.8701">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="136.5" y="1771.2148">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="1786.5254">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="1786.5254">2003</text><path d="M831.5,1806.2676 L1242.5,1806.2676 L1242.5,1813.2676 L1232.5,1823.2676 L831.5,1823.2676 L831.5,1806.2676 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="76.6211" style="stroke: #000000; stroke-width: 2.0;" width="566" x="831.5" y="1806.2676"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="366" x="846.5" y="1819.8359">REFER TO DB TRANSACTION IMPLEMENTATION ABOVE</text><polygon fill="#A80036" points="1322.5,1840.8887,1332.5,1844.8887,1322.5,1848.8887,1326.5,1844.8887" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="894.5" x2="1328.5" y1="1844.8887" y2="1844.8887"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="901.5" y="1840.1465">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="923.5" y="1840.1465">Refer to implementation above</text><polygon fill="#A80036" points="118.5,1907.1992,108.5,1911.1992,118.5,1915.1992,114.5,1911.1992" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="888.5" y1="1911.1992" y2="1911.1992"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="1906.457">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="146.5" y="1906.457">Return success</text><path d="M112,1931.1992 L112,2293.1992 L374,2293.1992 L374,1941.1992 L364,1931.1992 L112,1931.1992 " fill="#FFFF00" filter="url(#f1wduiupjr6sn1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M364,1931.1992 L364,1941.1992 L374,1941.1992 L364,1931.1992 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="118" y="1948.7676">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="134" y="1964.0781">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="134" y="1979.3887">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="134" y="1994.6992">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="134" y="2010.0098">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="134" y="2025.3203">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="150" y="2040.6309">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="150" y="2055.9414">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="134" y="2071.252">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="134" y="2086.5625">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="150" y="2101.873">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="166" y="2117.1836">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="166" y="2132.4941">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="166" y="2147.8047">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="166" y="2163.1152">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="166" y="2178.4258">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="166" y="2193.7363">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="182" y="2209.0469">status: "rejected",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="182" y="2224.3574">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="2239.668">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="2254.9785">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="2270.2891">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="118" y="2285.5996">}</text><path d="M23,2316.3418 L90,2316.3418 L90,2323.3418 L80,2333.3418 L23,2333.3418 L23,2316.3418 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="904.6641" style="stroke: #000000; stroke-width: 2.0;" width="1402" x="23" y="2316.3418"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="38" y="2329.9102">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="455" x="105" y="2328.9766">[type == 'position' &amp;&amp; action == 'fail' (Unable to currently trigger this scenario)]</text><polygon fill="#A80036" points="872.5,2366.2734,882.5,2370.2734,872.5,2374.2734,876.5,2370.2734" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="878.5" y1="2370.2734" y2="2370.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="2357.876">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="136.5" y="2350.2207">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="2365.5313">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="2365.5313">2003</text><polygon fill="#A80036" points="1322.5,2395.584,1332.5,2399.584,1322.5,2403.584,1326.5,2399.584" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="894.5" x2="1328.5" y1="2399.584" y2="2399.584"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="901.5" y="2394.8418">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="923.5" y="2394.8418">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#f1wduiupjr6sn1)" points="1274,2412.584,1405,2412.584,1415,2423.584,1405,2435.584,1274,2435.584,1264,2423.584,1274,2412.584" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1276" y="2429.1523">transferStateChange</text><polygon fill="#A80036" points="905.5,2458.2051,895.5,2462.2051,905.5,2466.2051,901.5,2462.2051" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="899.5" x2="1338.5" y1="2462.2051" y2="2462.2051"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="911.5" y="2457.4629">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="933.5" y="2457.4629">Return current state of transfer from DB</text><polygon fill="#A80036" points="118.5,2487.5156,108.5,2491.5156,118.5,2495.5156,114.5,2491.5156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="888.5" y1="2491.5156" y2="2491.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="2486.7734">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="146.5" y="2486.7734">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="149.5" y1="2520.8262" y2="2520.8262"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="149.5" x2="149.5" y1="2520.8262" y2="2533.8262"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="108.5" x2="149.5" y1="2533.8262" y2="2533.8262"/><polygon fill="#A80036" points="118.5,2529.8262,108.5,2533.8262,118.5,2537.8262,114.5,2533.8262" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="2516.084">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="447" x="136.5" y="2516.084">Validate current state (transferStateChange.transferStateId == 'FAILED')</text><path d="M33,2548.8262 L735,2548.8262 L735,2555.8262 L725,2565.8262 L33,2565.8262 L33,2548.8262 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="181.8633" style="stroke: #000000; stroke-width: 2.0;" width="1374.5" x="33" y="2548.8262"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="657" x="48" y="2562.3945">Persist Position change and Transfer State (with transferState='ABORTED' on position check pass)</text><polygon fill="#A80036" points="872.5,2598.7578,882.5,2602.7578,872.5,2606.7578,876.5,2602.7578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="878.5" y1="2602.7578" y2="2602.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="2590.3604">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="136.5" y="2582.7051">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="2598.0156">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="2598.0156">2003</text><path d="M831.5,2617.7578 L1242.5,2617.7578 L1242.5,2624.7578 L1232.5,2634.7578 L831.5,2634.7578 L831.5,2617.7578 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="76.6211" style="stroke: #000000; stroke-width: 2.0;" width="566" x="831.5" y="2617.7578"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="366" x="846.5" y="2631.3262">REFER TO DB TRANSACTION IMPLEMENTATION ABOVE</text><polygon fill="#A80036" points="1322.5,2652.3789,1332.5,2656.3789,1322.5,2660.3789,1326.5,2656.3789" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="894.5" x2="1328.5" y1="2656.3789" y2="2656.3789"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="901.5" y="2651.6367">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="923.5" y="2651.6367">Refer to implementation above</text><polygon fill="#A80036" points="118.5,2718.6895,108.5,2722.6895,118.5,2726.6895,114.5,2722.6895" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="888.5" y1="2722.6895" y2="2722.6895"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="2717.9473">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="146.5" y="2717.9473">Return success</text><path d="M112,2742.6895 L112,3211.6895 L516,3211.6895 L516,2752.6895 L506,2742.6895 L112,2742.6895 " fill="#FFFF00" filter="url(#f1wduiupjr6sn1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M506,2742.6895 L506,2752.6895 L516,2752.6895 L506,2742.6895 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="118" y="2760.2578">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="134" y="2775.5684">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="134" y="2790.8789">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="134" y="2806.1895">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="134" y="2821.5">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="134" y="2836.8105">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="150" y="2852.1211">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="150" y="2867.4316">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="170" y="2882.7422">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="186" y="2898.0527">"errorCode": 3100,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="186" y="2913.3633">"errorDescription": "Transfer failed",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="186" y="2928.6738">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="170" y="2943.9844">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="154" y="2959.2949">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="134" y="2974.6055">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="134" y="2989.916">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="150" y="3005.2266">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="166" y="3020.5371">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="166" y="3035.8477">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="166" y="3051.1582">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="166" y="3066.4688">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="166" y="3081.7793">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="166" y="3097.0898">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="182" y="3112.4004">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="182" y="3127.7109">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="182" y="3143.0215">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="3158.332">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="3173.6426">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="3188.9531">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="118" y="3204.2637">}</text><polygon fill="#A80036" points="594.5,3260.627,604.5,3264.627,594.5,3268.627,598.5,3264.627" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="600.5" y1="3264.627" y2="3264.627"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="3252.2295">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="136.5" y="3244.5742">Publish Transfer event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="3259.8848">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="3259.8848">2003</text><!--
@startuml
title 1.3.3 Abort Position Handler Consume

autonumber


control "Position Handler" as POS_HANDLER
collections "Transfer-Topic" as TOPIC_TRANSFERS
entity "Position DAO" as POS_DAO
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
database "Central Store" as DB

box "Central Service" #LightYellow
    participant POS_HANDLER
    participant TOPIC_TRANSFERS
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant DB
end box

activate POS_HANDLER
group Abort Position Handler Consume
    opt type == 'position' && action == 'timeout-reserved'
        POS_HANDLER -> POS_DAO: Request current state of transfer from DB\n<color #FF0000><b>Error code:</b> 2003</color>
        activate POS_DAO
        POS_DAO -> DB: Retrieve current state of transfer from DB
        activate DB
        hnote over DB #lightyellow
            transferStateChange
            transferParticipant
        end note
        DB - -> POS_DAO: Return current state of transfer from DB
        deactivate DB
        POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
        deactivate POS_DAO
        POS_HANDLER <-> POS_HANDLER: Validate current state (transferStateChange.transferStateId == 'EXPIRED')\n<color #FF0000><b>Error code:</b> 2001</color>

        group Persist Position change
            POS_HANDLER -> POS_DAO: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
            group <color #blue>DB TRANSACTION IMPLEMENTATION</color>
                activate POS_DAO
                POS_DAO -> DB: Select participantPosition.value FOR UPDATE for payerCurrencyId
                activate DB
                hnote over DB #lightyellow
                    participantPosition
                end note
                DB - -> POS_DAO: Return participantPosition
                deactivate DB
                POS_DAO <-> POS_DAO: **latestPosition** = participantPosition - payload.amount.amount
                POS_DAO->DB: Persist latestPosition to DB for Payer
                hnote over DB #lightyellow
                    UPDATE **participantPosition**
                    SET value = latestPosition
                end note
                activate DB
                deactivate DB
                POS_DAO -> DB: Persist participant position change and state change
                hnote over DB #lightyellow
                        INSERT **transferStateChange** transferStateId = 'EXPIRED_RESERVED'

                        INSERT **participantPositionChange**
                        SET participantPositionId = participantPosition.participantPositionId,
                        transferStateChangeId = transferStateChange.transferStateChangeId,
                        value = latestPosition,
                        reservedValue = participantPosition.reservedValue
                        createdDate = new Date()
                end note
                activate DB
                deactivate DB
            end
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        note right of POS_HANDLER #yellow
            Message: {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                         "errorInformation": {
                             "errorCode": 3303,
                             "errorDescription": "Transfer expired",
                             "extensionList": <transferMessage.extensionList>
                         }
                    }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: abort,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
    end
    opt type == 'position' && action == 'reject'
        POS_HANDLER -> POS_DAO: Request current state of transfer from DB\n<color #FF0000><b>Error code:</b> 2003</color>
        activate POS_DAO
        POS_DAO -> DB: Retrieve current state of transfer from DB
        activate DB
        hnote over DB #lightyellow
            transferStateChange
        end note
        DB - -> POS_DAO: Return current state of transfer from DB
        deactivate DB
        POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
        deactivate POS_DAO
        POS_HANDLER <-> POS_HANDLER: Validate current state (transferStateChange.transferStateId == 'REJECTED')\n<color #FF0000><b>Error code:</b> 2001</color>

        group Persist Position change and Transfer State (with transferState='ABORTED' on position check pass)
            POS_HANDLER -> POS_DAO: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
            group <color #blue>REFER TO DB TRANSACTION IMPLEMENTATION ABOVE</color>
                activate POS_DAO
                POS_DAO -> DB: Refer to implementation above
                activate DB
                deactivate DB
            end
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        note right of POS_HANDLER #yellow
            Message: {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: abort,
                        createdAt: <timestamp>,
                        state: {
                            status: "rejected",
                            code: 0
                        }
                    }
                }
            }
        end note
    end
    opt type == 'position' && action == 'fail' (Unable to currently trigger this scenario)
        POS_HANDLER -> POS_DAO: Request current state of transfer from DB\n<color #FF0000><b>Error code:</b> 2003</color>
        activate POS_DAO
        POS_DAO -> DB: Retrieve current state of transfer from DB
        activate DB
        hnote over DB #lightyellow
            transferStateChange
        end note
        DB - -> POS_DAO: Return current state of transfer from DB
        deactivate DB
        POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
        deactivate POS_DAO
        POS_HANDLER <-> POS_HANDLER: Validate current state (transferStateChange.transferStateId == 'FAILED')

        group Persist Position change and Transfer State (with transferState='ABORTED' on position check pass)
            POS_HANDLER -> POS_DAO: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
            group <color #blue>REFER TO DB TRANSACTION IMPLEMENTATION ABOVE</color>
                activate POS_DAO
                POS_DAO -> DB: Refer to implementation above
                activate DB
                deactivate DB
            end
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        note right of POS_HANDLER #yellow
            Message: {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                         "errorInformation": {
                             "errorCode": 3100,
                             "errorDescription": "Transfer failed",
                             "extensionList": <transferMessage.extensionList>
                         }
                     }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: abort,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
    end
    POS_HANDLER -> TOPIC_TRANSFERS: Publish Transfer event\n<color #FF0000><b>Error code:</b> 2003</color>
    activate TOPIC_TRANSFERS
    deactivate TOPIC_TRANSFERS
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>