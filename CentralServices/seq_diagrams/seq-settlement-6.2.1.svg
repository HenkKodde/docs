<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2980px" preserveAspectRatio="none" style="width:1695px;height:2980px;" version="1.1" viewBox="0 0 1695 2980" width="1695px" zoomAndPan="magnify"><defs><filter height="300%" id="f9nkxbzzlq26s" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="406" x="645.5" y="23.5352">6.2.1. Trigger Settlement Event (settlementEventTrigger)</text><rect fill="#FFB6C1" height="2935.1973" style="stroke: #A80036; stroke-width: 1.0;" width="112" x="39" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="54.5" y="47.0566">Central HUB</text><rect fill="#90EE90" height="2935.1973" style="stroke: #A80036; stroke-width: 1.0;" width="670.5" x="282.5" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="555.75" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="2935.1973" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="1287" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="1290" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#f9nkxbzzlq26s)" height="2703.9102" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="90" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f9nkxbzzlq26s)" height="2450.5625" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="360" y="400.6348"/><rect fill="#FFFFFF" filter="url(#f9nkxbzzlq26s)" height="59.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="887" y="445.2559"/><rect fill="#FFFFFF" filter="url(#f9nkxbzzlq26s)" height="167.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="887" y="613.1191"/><rect fill="#FFFFFF" filter="url(#f9nkxbzzlq26s)" height="1198.1484" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="887" y="1277.8145"/><rect fill="#FFFFFF" filter="url(#f9nkxbzzlq26s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1339" y="474.5664"/><rect fill="#FFFFFF" filter="url(#f9nkxbzzlq26s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1339" y="642.4297"/><rect fill="#FFFFFF" filter="url(#f9nkxbzzlq26s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1339" y="1331.4355"/><rect fill="#FFFFFF" filter="url(#f9nkxbzzlq26s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1339" y="1454.6777"/><rect fill="#FFFFFF" filter="url(#f9nkxbzzlq26s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1339" y="1792.2676"/><rect fill="#FFFFFF" filter="url(#f9nkxbzzlq26s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1339" y="2037.9941"/><rect fill="#FFFFFF" filter="url(#f9nkxbzzlq26s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1339" y="2191.8574"/><rect fill="#FFFFFF" filter="url(#f9nkxbzzlq26s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1339" y="2345.7207"/><rect fill="#FFFFFF" filter="url(#f9nkxbzzlq26s)" height="2711.9102" style="stroke: #000000; stroke-width: 2.0;" width="1671" x="13" y="154.2871"/><rect fill="#FFFFFF" filter="url(#f9nkxbzzlq26s)" height="2063.2148" style="stroke: #000000; stroke-width: 2.0;" width="1651" x="23" y="795.9824"/><rect fill="#FFFFFF" filter="url(#f9nkxbzzlq26s)" height="413.9004" style="stroke: #000000; stroke-width: 2.0;" width="687" x="33" y="820.293"/><rect fill="#FFFFFF" filter="url(#f9nkxbzzlq26s)" height="145.5527" style="stroke: #000000; stroke-width: 2.0;" width="406.5" x="266.5" y="844.6035"/><rect fill="#FFFFFF" filter="url(#f9nkxbzzlq26s)" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="386.5" x="276.5" y="908.2246"/><rect fill="#FFFFFF" filter="url(#f9nkxbzzlq26s)" height="1154.8379" style="stroke: #000000; stroke-width: 2.0;" width="839" x="825" y="1292.8145"/><rect fill="#FFFFFF" height="184.1289" style="stroke: none; stroke-width: 1.0;" width="1651" x="23" y="2675.0684"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="95" x2="95" y1="137.2871" y2="2883.1973"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="364.5" x2="364.5" y1="137.2871" y2="2883.1973"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="892" x2="892" y1="137.2871" y2="2883.1973"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1344" x2="1344" y1="137.2871" y2="2883.1973"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="43" y="134.334">Hub Employee</text><ellipse cx="95" cy="63.7988" fill="#FEFECE" filter="url(#f9nkxbzzlq26s)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M95,71.7988 L95,98.7988 M82,79.7988 L108,79.7988 M95,98.7988 L82,113.7988 M95,98.7988 L108,113.7988 " fill="none" filter="url(#f9nkxbzzlq26s)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="43" y="2895.7324">Hub Employee</text><ellipse cx="95" cy="2908.6855" fill="#FEFECE" filter="url(#f9nkxbzzlq26s)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M95,2916.6855 L95,2943.6855 M82,2924.6855 L108,2924.6855 M95,2943.6855 L82,2958.6855 M95,2943.6855 L108,2958.6855 " fill="none" filter="url(#f9nkxbzzlq26s)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="286.5" y="134.334">Settlement Service API</text><path d="M344.5,92.7988 L344.5,116.7988 M344.5,104.7988 L361.5,104.7988 " fill="none" filter="url(#f9nkxbzzlq26s)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="373.5" cy="104.7988" fill="#FEFECE" filter="url(#f9nkxbzzlq26s)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="286.5" y="2895.7324">Settlement Service API</text><path d="M344.5,2902.6855 L344.5,2926.6855 M344.5,2914.6855 L361.5,2914.6855 " fill="none" filter="url(#f9nkxbzzlq26s)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="373.5" cy="2914.6855" fill="#FEFECE" filter="url(#f9nkxbzzlq26s)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="835" y="134.334">Settlement DAO</text><ellipse cx="892" cy="104.7988" fill="#FEFECE" filter="url(#f9nkxbzzlq26s)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="880" x2="904" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="835" y="2895.7324">Settlement DAO</text><ellipse cx="892" cy="2914.6855" fill="#FEFECE" filter="url(#f9nkxbzzlq26s)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="880" x2="904" y1="2928.6855" y2="2928.6855"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1296" y="134.334">Central Store</text><path d="M1326,84.7988 C1326,74.7988 1344,74.7988 1344,74.7988 C1344,74.7988 1362,74.7988 1362,84.7988 L1362,110.7988 C1362,120.7988 1344,120.7988 1344,120.7988 C1344,120.7988 1326,120.7988 1326,110.7988 L1326,84.7988 " fill="#FEFECE" filter="url(#f9nkxbzzlq26s)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1326,84.7988 C1326,94.7988 1344,94.7988 1344,94.7988 C1344,94.7988 1362,94.7988 1362,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1296" y="2895.7324">Central Store</text><path d="M1326,2908.6855 C1326,2898.6855 1344,2898.6855 1344,2898.6855 C1344,2898.6855 1362,2898.6855 1362,2908.6855 L1362,2934.6855 C1362,2944.6855 1344,2944.6855 1344,2944.6855 C1344,2944.6855 1326,2944.6855 1326,2934.6855 L1326,2908.6855 " fill="#FEFECE" filter="url(#f9nkxbzzlq26s)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1326,2908.6855 C1326,2918.6855 1344,2918.6855 1344,2918.6855 C1344,2918.6855 1362,2918.6855 1362,2908.6855 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f9nkxbzzlq26s)" height="2703.9102" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="90" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f9nkxbzzlq26s)" height="2450.5625" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="360" y="400.6348"/><rect fill="#FFFFFF" filter="url(#f9nkxbzzlq26s)" height="59.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="887" y="445.2559"/><rect fill="#FFFFFF" filter="url(#f9nkxbzzlq26s)" height="167.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="887" y="613.1191"/><rect fill="#FFFFFF" filter="url(#f9nkxbzzlq26s)" height="1198.1484" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="887" y="1277.8145"/><rect fill="#FFFFFF" filter="url(#f9nkxbzzlq26s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1339" y="474.5664"/><rect fill="#FFFFFF" filter="url(#f9nkxbzzlq26s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1339" y="642.4297"/><rect fill="#FFFFFF" filter="url(#f9nkxbzzlq26s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1339" y="1331.4355"/><rect fill="#FFFFFF" filter="url(#f9nkxbzzlq26s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1339" y="1454.6777"/><rect fill="#FFFFFF" filter="url(#f9nkxbzzlq26s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1339" y="1792.2676"/><rect fill="#FFFFFF" filter="url(#f9nkxbzzlq26s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1339" y="2037.9941"/><rect fill="#FFFFFF" filter="url(#f9nkxbzzlq26s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1339" y="2191.8574"/><rect fill="#FFFFFF" filter="url(#f9nkxbzzlq26s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1339" y="2345.7207"/><path d="M13,154.2871 L227,154.2871 L227,161.2871 L217,171.2871 L13,171.2871 L13,154.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2711.9102" style="stroke: #000000; stroke-width: 2.0;" width="1671" x="13" y="154.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="169" x="28" y="167.8555">Trigger Settlement Event</text><path d="M105,176.5977 L105,369.5977 L287,369.5977 L287,186.5977 L277,176.5977 L105,176.5977 " fill="#FFFF00" filter="url(#f9nkxbzzlq26s)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M277,176.5977 L277,186.5977 L287,186.5977 L277,176.5977 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="111" y="194.166">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="127" y="209.4766">"id": 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="127" y="224.7871">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="127" y="240.0977">"settlementWindows": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="143" y="255.4082">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="159" y="270.7188">"id": 1,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="143" y="286.0293">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="143" y="301.3398">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="159" y="316.6504">"id": 2,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="143" y="331.9609">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="127" y="347.2715">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="111" y="362.582">}</text><polygon fill="#A80036" points="348,396.6348,358,400.6348,348,404.6348,352,400.6348" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="100" x2="354" y1="400.6348" y2="400.6348"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="107" y="395.8926">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="120" y="395.8926">POST - /settlement/{id}</text><polygon fill="#A80036" points="875,441.2559,885,445.2559,875,449.2559,879,445.2559" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="370" x2="881" y1="445.2559" y2="445.2559"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="377" y="432.8584">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="390" y="425.2031">Create new settlement</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="390" y="440.5137">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="467" y="440.5137">2001</text><polygon fill="#A80036" points="1327,470.5664,1337,474.5664,1327,478.5664,1331,474.5664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="897" x2="1333" y1="474.5664" y2="474.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="904" y="469.8242">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="917" y="469.8242">Insert new settlement</text><polygon fill="#FFFFE0" filter="url(#f9nkxbzzlq26s)" points="1257,517.5664,1431,517.5664,1441,543.5664,1431,570.5664,1257,570.5664,1247,543.5664,1257,517.5664" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1259" y="534.1348">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="1343" y="534.1348">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="1275" y="549.4453">reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="1275" y="564.7559">VALUES (payload.reason)</text><polygon fill="#A80036" points="875,609.1191,885,613.1191,875,617.1191,879,613.1191" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="370" x2="881" y1="613.1191" y2="613.1191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="377" y="600.7217">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="390" y="593.0664">Request settlementWindow(s)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="390" y="608.377">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="467" y="608.377">2001</text><polygon fill="#A80036" points="1327,638.4297,1337,642.4297,1327,646.4297,1331,642.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="897" x2="1333" y1="642.4297" y2="642.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="904" y="637.6875">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="917" y="637.6875">Retrieve settlementWindow(s)</text><polygon fill="#FFFFE0" filter="url(#f9nkxbzzlq26s)" points="1088,685.4297,1600,685.4297,1610,719.4297,1600,754.4297,1088,754.4297,1078,719.4297,1088,685.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="508" x="1090" y="701.998">SELECT MAX(settlementWindowStateChangeId), settlementWindowStateId, reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1090" y="717.3086">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="1134" y="717.3086">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="396" x="1090" y="732.6191">WHERE settlementWindowId = payload./settlementWindow/{id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="411" x="1090" y="747.9297">GROUP BY settlementWindowStateId,settlementWindowId, reason;</text><polygon fill="#A80036" points="381,776.9824,371,780.9824,381,784.9824,377,780.9824" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="375" x2="891" y1="780.9824" y2="780.9824"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="387" y="776.2402">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="400" y="776.2402">Return results</text><path d="M23,795.9824 L85,795.9824 L85,802.9824 L75,812.9824 L23,812.9824 L23,795.9824 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2063.2148" style="stroke: #000000; stroke-width: 2.0;" width="1651" x="23" y="795.9824"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="38" y="809.5508">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="157" x="100" y="808.6172">[Settlement Windows found]</text><path d="M33,820.293 L117,820.293 L117,827.293 L107,837.293 L33,837.293 L33,820.293 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="413.9004" style="stroke: #000000; stroke-width: 2.0;" width="687" x="33" y="820.293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="48" y="833.8613">break</text><path d="M266.5,844.6035 L572.5,844.6035 L572.5,851.6035 L562.5,861.6035 L266.5,861.6035 L266.5,844.6035 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="145.5527" style="stroke: #000000; stroke-width: 2.0;" width="406.5" x="266.5" y="844.6035"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="261" x="281.5" y="858.1719">Validate the list of settlement windows</text><path d="M375,866.9141 L375,891.9141 L620,891.9141 L620,876.9141 L610,866.9141 L375,866.9141 " fill="#D3D3D3" filter="url(#f9nkxbzzlq26s)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M610,866.9141 L610,876.9141 L620,876.9141 L610,866.9141 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="224" x="381" y="884.4824">allSettlementWindowsClosed = true</text><path d="M276.5,908.2246 L350.5,908.2246 L350.5,915.2246 L340.5,925.2246 L276.5,925.2246 L276.5,908.2246 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="386.5" x="276.5" y="908.2246"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="291.5" y="921.793">loop</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="370" x2="412" y1="962.1563" y2="962.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="412" x2="412" y1="962.1563" y2="975.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="371" x2="412" y1="975.1563" y2="975.1563"/><polygon fill="#A80036" points="381,971.1563,371,975.1563,381,979.1563,377,975.1563" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="377" y="949.7588">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="390" y="942.1035">if settlementWindowStateId != 'CLOSED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="261" x="390" y="957.4141">then allSettlementWindowsClosed = false</text><path d="M375,1002.1563 L375,1195.1563 L706,1195.1563 L706,1012.1563 L696,1002.1563 L375,1002.1563 " fill="#FFFF00" filter="url(#f9nkxbzzlq26s)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M696,1002.1563 L696,1012.1563 L706,1012.1563 L696,1002.1563 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="381" y="1019.7246">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="69" x="397" y="1035.0352">"status": 0,</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="6" x="470" y="1035.0352">?</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="397" y="1050.3457">"code": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="397" y="1065.6563">"message": "Invalid payload or state"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="381" y="1080.9668">}</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="20" x="381" y="1096.2773">OR</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="405" y="1096.2773">what is used in 6.2.5.:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="381" y="1111.5879">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="397" y="1126.8984">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="413" y="1142.209">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="413" y="1157.5195">"errorDescription": "Invalid payload or state"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="397" y="1172.8301">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="381" y="1188.1406">}</text><polygon fill="#A80036" points="111,1222.1934,101,1226.1934,111,1230.1934,107,1226.1934" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="105" x2="359" y1="1226.1934" y2="1226.1934"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="117" y="1221.4512">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103" x="130" y="1221.4512">Respond HTTP -</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="237" y="1221.4512">400 (Bad Request)</text><polygon fill="#A80036" points="875,1273.8145,885,1277.8145,875,1281.8145,879,1277.8145" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="370" x2="881" y1="1277.8145" y2="1277.8145"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="377" y="1265.417">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="305" x="390" y="1257.7617">Request 'CLOSE' &amp; 'OPEN' of Settlement Windows</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="390" y="1273.0723">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="467" y="1273.0723">2001</text><path d="M825,1292.8145 L990,1292.8145 L990,1299.8145 L980,1309.8145 L825,1309.8145 L825,1292.8145 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1154.8379" style="stroke: #000000; stroke-width: 2.0;" width="839" x="825" y="1292.8145"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="840" y="1306.3828">DB TRANSACTION</text><polygon fill="#A80036" points="1327,1327.4355,1337,1331.4355,1327,1335.4355,1331,1331.4355" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="897" x2="1333" y1="1331.4355" y2="1331.4355"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="904" y="1326.6934">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="926" y="1326.6934">Insert the list of settlementWindows</text><polygon fill="#FFFFE0" filter="url(#f9nkxbzzlq26s)" points="1136,1374.4355,1551,1374.4355,1561,1400.4355,1551,1427.4355,1136,1427.4355,1126,1400.4355,1136,1374.4355" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1138" y="1391.0039">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="197" x="1222" y="1391.0039">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="223" x="1170" y="1406.3145">(settlementId, settlementWindowId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="395" x="1154" y="1421.625">VALUE(payload.settlementId, payload./settlementWindow/{id});</text><polygon fill="#A80036" points="1327,1450.6777,1337,1454.6777,1327,1458.6777,1331,1454.6777" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="897" x2="1333" y1="1454.6777" y2="1454.6777"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="904" y="1449.9355">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="380" x="926" y="1449.9355">Populate settlementTransferParticipant with aggregated data</text><polygon fill="#FFFFE0" filter="url(#f9nkxbzzlq26s)" points="1105,1497.6777,1582,1497.6777,1592,1631.6777,1582,1765.6777,1105,1765.6777,1095,1631.6777,1105,1497.6777" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1107" y="1514.2461">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="203" x="1191" y="1514.2461">settlementTransferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="424" x="1123" y="1529.5566">(settlementId, participantCurrencyId, transferParticipantRoleTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="1123" y="1544.8672">ledgerEntryTypeId, amount, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="449" x="1107" y="1560.1777">SELECT payload.settlementId AS settlementId, tp.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="344" x="1123" y="1575.4883">tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="347" x="1123" y="1590.7988">SUM(tp.amount) AS amount, CURDATE() AS createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1107" y="1606.1094">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="1147" y="1606.1094">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="30" x="1273" y="1606.1094">AS tf</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1107" y="1621.4199">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1139" y="1621.4199">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="1282" y="1621.4199">AS tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="457" x="1123" y="1636.7305">ON tsc.transferId = tf.transferId AND tsc.transferStateId = ‘COMMITTED’</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1107" y="1652.041">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1139" y="1652.041">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="33" x="1270" y="1652.041">AS tp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="1123" y="1667.3516">ON tp.transferId = tf.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="189" x="1107" y="1682.6621">WHERE tf.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="1123" y="1697.9727">IN (SELECT settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1123" y="1713.2832">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="197" x="1163" y="1713.2832">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="1123" y="1728.5938">WHERE settlementId = payload.settlementId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="433" x="1123" y="1743.9043">GROUP BY tp.participantCurrencyId, tp.transferParticipantRoleTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1139" y="1759.2148">tp.ledgerEntryTypeId</text><polygon fill="#A80036" points="1327,1788.2676,1337,1792.2676,1327,1796.2676,1331,1792.2676" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="897" x2="1333" y1="1792.2676" y2="1792.2676"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="904" y="1787.5254">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="384" x="926" y="1787.5254">Populate settlementParticipantCurrency with aggregated data</text><polygon fill="#FFFFE0" filter="url(#f9nkxbzzlq26s)" points="1044,1835.2676,1644,1835.2676,1654,1923.2676,1644,2011.2676,1044,2011.2676,1034,1923.2676,1044,1835.2676" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1046" y="1851.8359">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="1130" y="1851.8359">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="1062" y="1867.1465">(settlementId, participantCurrencyId, netAmount)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="1046" y="1882.457">SELECT settlementId, participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="1046" y="1897.7676">SUM(CASE</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="568" x="1066" y="1913.0781">WHEN stp.transferParticipantRoleTypeId = 1 AND stp.ledgerEntryTypeId = 1 THEN amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="576" x="1066" y="1928.3887">WHEN stp.transferParticipantRoleTypeId = 2 AND stp.ledgerEntryTypeId = 1 THEN -amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="304" x="1066" y="1943.6992">WHEN stp.ledgerEntryTypeId = 2 THEN -amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="1058" y="1959.0098">END )</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1046" y="1974.3203">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="203" x="1086" y="1974.3203">settlementTransferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="1293" y="1974.3203">AS stp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="1046" y="1989.6309">WHERE settlementId = payload.settlementId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="1046" y="2004.9414">GROUP BY settlementId, participantCurrencyId</text><polygon fill="#A80036" points="1327,2033.9941,1337,2037.9941,1327,2041.9941,1331,2037.9941" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="897" x2="1333" y1="2037.9941" y2="2037.9941"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="904" y="2033.252">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="314" x="926" y="2033.252">Insert initial state change 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#f9nkxbzzlq26s)" points="1085,2080.9941,1603,2080.9941,1613,2122.9941,1603,2164.9941,1085,2164.9941,1075,2122.9941,1085,2080.9941" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1087" y="2097.5625">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="1171" y="2097.5625">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="378" x="1103" y="2112.873">(settlementParticipantCurrencyId, settlementStateId, reason)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="514" x="1087" y="2128.1836">SELECT settlementParticipantCurrencyId, ‘PENDING_SETTLEMENT’, payload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1087" y="2143.4941">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="1127" y="2143.4941">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="1087" y="2158.8047">WHERE settlementId = payload.settlementId</text><polygon fill="#A80036" points="1327,2187.8574,1337,2191.8574,1327,2195.8574,1331,2191.8574" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="897" x2="1333" y1="2191.8574" y2="2191.8574"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="904" y="2187.1152">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="926" y="2187.1152">Insert initial state for settlement 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#f9nkxbzzlq26s)" points="1146,2234.8574,1541,2234.8574,1551,2276.8574,1541,2318.8574,1146,2318.8574,1136,2276.8574,1146,2234.8574" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1148" y="2251.4258">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="157" x="1232" y="2251.4258">settlementStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="1164" y="2266.7363">(settlementId, settlementStateId, reason)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="391" x="1148" y="2282.0469">SELECT settlementId, ‘PENDING_SETTLEMENT’, payload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1148" y="2297.3574">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="1188" y="2297.3574">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="1148" y="2312.668">WHERE settlementId = payload.settlementId</text><polygon fill="#A80036" points="1327,2341.7207,1337,2345.7207,1327,2349.7207,1331,2345.7207" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="897" x2="1333" y1="2345.7207" y2="2345.7207"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="904" y="2340.9785">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="396" x="926" y="2340.9785">Insert new state for settlementWindow 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#f9nkxbzzlq26s)" points="1088,2388.7207,1600,2388.7207,1610,2414.7207,1600,2441.7207,1088,2441.7207,1078,2414.7207,1088,2388.7207" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1090" y="2405.2891">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="1174" y="2405.2891">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="353" x="1106" y="2420.5996">(settlementWindowId, settlementWindowStateId, reason)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="508" x="1090" y="2435.9102">VALUE payload./settlementWindow/{id}, 'PENDING_SETTLEMENT', payload.reason</text><polygon fill="#A80036" points="381,2471.9629,371,2475.9629,381,2479.9629,377,2475.9629" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="375" x2="891" y1="2475.9629" y2="2475.9629"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="387" y="2471.2207">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="471" x="409" y="2471.2207">Results for participant netAmount per ledger for closed settlement window</text><path d="M115,2488.9629 L115,2635.9629 L351,2635.9629 L351,2498.9629 L341,2488.9629 L115,2488.9629 " fill="#FFFF00" filter="url(#f9nkxbzzlq26s)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M341,2488.9629 L341,2498.9629 L351,2498.9629 L341,2488.9629 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="121" y="2506.5313">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="81" x="129" y="2521.8418">"id": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="129" y="2537.1523">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="129" y="2552.4629">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="129" y="2567.7734">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="137" y="2583.084">"amount": 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="137" y="2598.3945">"currency": "string"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="129" y="2613.7051">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="121" y="2629.0156">}</text><polygon fill="#A80036" points="111,2663.0684,101,2667.0684,111,2671.0684,107,2667.0684" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="105" x2="359" y1="2667.0684" y2="2667.0684"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="117" y="2662.3262">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103" x="139" y="2662.3262">Respond HTTP -</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="246" y="2662.3262">200 (OK)</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="1674" y1="2676.0684" y2="2676.0684"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="28" y="2686.7031">[Settlement Windows not found]</text><path d="M375,2695.0234 L375,2720.0234 L502,2720.0234 L502,2705.0234 L492,2695.0234 L375,2695.0234 " fill="#D3D3D3" filter="url(#f9nkxbzzlq26s)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M492,2695.0234 L492,2705.0234 L502,2705.0234 L492,2695.0234 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="381" y="2712.5918">Log ERROR event</text><path d="M184,2734.334 L184,2820.334 L351,2820.334 L351,2744.334 L341,2734.334 L184,2734.334 " fill="#FFFF00" filter="url(#f9nkxbzzlq26s)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M341,2734.334 L341,2744.334 L351,2744.334 L341,2734.334 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="190" y="2751.9023">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="69" x="206" y="2767.2129">"status": 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="206" y="2782.5234">"code": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="206" y="2797.834">"message": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="190" y="2813.1445">}</text><polygon fill="#A80036" points="106,2847.1973,96,2851.1973,106,2855.1973,102,2851.1973" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="100" x2="364" y1="2851.1973" y2="2851.1973"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="112" y="2846.4551">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103" x="134" y="2846.4551">Respond HTTP -</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="241" y="2846.4551">4xx (Client error)</text><!--
@startuml
title 6.2.1. Trigger Settlement Event (settlementEventTrigger)
autonumber

actor "Hub Employee" as OPERATOR
boundary "Settlement Service API" as SSAPI
entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Central HUB" #LightPink
    participant OPERATOR
end box

box "Settlement Service" #LightGreen
    participant SSAPI
    participant SETTLE_DAO
end box

box "Central Services" #LightYellow
    participant DB
end box

group Trigger Settlement Event
activate OPERATOR
    note right of OPERATOR #Yellow
        {
            "id": 0,
            "reason": "string",
            "settlementWindows": [
                {
                    "id": 1,
                },
                {
                    "id": 2,
                }
            ]
        }
    end note
    OPERATOR -> SSAPI: POST - /settlement/{id}
    activate SSAPI
    SSAPI-> SETTLE_DAO: Create new settlement\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    SETTLE_DAO -> DB: Insert new settlement
    activate DB
    deactivate SETTLE_DAO
    hnote over DB #LightYellow
        INSERT INTO **settlement**
            reason
            VALUES (payload.reason)
    end hnote
    deactivate DB

    SSAPI-> SETTLE_DAO: Request settlementWindow(s)\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    SETTLE_DAO -> DB: Retrieve settlementWindow(s)
    activate DB
    hnote over DB #LightYellow
        SELECT MAX(settlementWindowStateChangeId), settlementWindowStateId, reason
        FROM  **settlementWindowStateChange**
        WHERE settlementWindowId = payload./settlementWindow/{id}
        GROUP BY settlementWindowStateId,settlementWindowId, reason;
    end hnote
    deactivate DB
    SSAPI <- - SETTLE_DAO: Return results
    deactivate SETTLE_DAO

    alt Settlement Windows found
        break
            group Validate the list of settlement windows
                note right of SSAPI #LightGray
                    allSettlementWindowsClosed = true
                end note
                loop
                    SSAPI - -> SSAPI: if settlementWindowStateId != 'CLOSED' \nthen allSettlementWindowsClosed = false
                end loop
            end
            note right of SSAPI #yellow
                {
                    "status": 0, <color #FF0000>**?**</color>
                    "code": <integer>,
                    "message": "Invalid payload or state"
                }
                <color #FF0000>**OR**</color> what is used in 6.2.5.:
                {
                    errorInformation: {
                        "errorCode": <integer>,
                        "errorDescription": "Invalid payload or state"
                    }
                }
            end note
            OPERATOR <- - SSAPI: Respond HTTP - <color #FF0000>400 (Bad Request)</color>
        end
        SSAPI ->SETTLE_DAO: Request 'CLOSE' & 'OPEN' of Settlement Windows\n<color #FF0000><b>Error code:</b> 2001</color>
        activate SETTLE_DAO
        group <color #blue>DB TRANSACTION</color>
            SETTLE_DAO -> DB: Insert the list of settlementWindows
            activate DB
            hnote over DB #LightYellow
                INSERT INTO **settlementSettlementWindow**
                	(settlementId, settlementWindowId)
                    VALUE(payload.settlementId, payload./settlementWindow/{id});
            end hnote
            deactivate DB
            SETTLE_DAO -> DB: Populate settlementTransferParticipant with aggregated data
            activate DB
            hnote over DB #LightYellow
                INSERT INTO **settlementTransferParticipant**
                    (settlementId, participantCurrencyId, transferParticipantRoleTypeId,
                    ledgerEntryTypeId, amount, createdDate)
                SELECT payload.settlementId AS settlementId, tp.participantCurrencyId,
                    tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId,
                    SUM(tp.amount) AS amount, CURDATE() AS createdDate
                FROM **transferFulfilment** AS tf
                JOIN **transferStateChange** AS tsc
                    ON tsc.transferId = tf.transferId AND tsc.transferStateId = ‘COMMITTED’
                JOIN **transferParticipant** AS tp
                    ON tp.transferId = tf.transferId
                WHERE tf.settlementWindowId
                    IN (SELECT settlementWindowId
                    FROM **settlementSettlementWindow**
                    WHERE settlementId = payload.settlementId)
                    GROUP BY tp.participantCurrencyId, tp.transferParticipantRoleTypeId,
                        tp.ledgerEntryTypeId
            end hnote
            deactivate DB
            SETTLE_DAO -> DB: Populate settlementParticipantCurrency with aggregated data
            activate DB
            hnote over DB #LightYellow
                INSERT INTO **settlementParticipantCurrency**
                    (settlementId, participantCurrencyId, netAmount)
                SELECT settlementId, participantCurrencyId,
                SUM(CASE
                     WHEN stp.transferParticipantRoleTypeId = 1 AND stp.ledgerEntryTypeId = 1 THEN amount
                     WHEN stp.transferParticipantRoleTypeId = 2 AND stp.ledgerEntryTypeId = 1 THEN -amount
                     WHEN stp.ledgerEntryTypeId = 2 THEN -amount
                   END )
                FROM **settlementTransferParticipant** AS stp
                WHERE settlementId = payload.settlementId
                GROUP BY settlementId, participantCurrencyId
            end hnote
            deactivate DB
            SETTLE_DAO -> DB: Insert initial state change 'PENDING_SETTLEMENT'
            activate DB
            hnote over DB #LightYellow
                INSERT INTO **settlementParticipantCurrencyStateChange**
                    (settlementParticipantCurrencyId, settlementStateId, reason)
                SELECT settlementParticipantCurrencyId, ‘PENDING_SETTLEMENT’, payload.reason
                FROM **settlementParticipantCurrency**
                WHERE settlementId = payload.settlementId
            end hnote
            deactivate DB
            SETTLE_DAO -> DB: Insert initial state for settlement 'PENDING_SETTLEMENT'
            activate DB
            hnote over DB #LightYellow
                INSERT INTO **settlementStateChange**
                    (settlementId, settlementStateId, reason)
                SELECT settlementId, ‘PENDING_SETTLEMENT’, payload.reason
                FROM **settlementParticipantCurrency**
                WHERE settlementId = payload.settlementId
            end hnote
            deactivate DB
            SETTLE_DAO -> DB: Insert new state for settlementWindow 'PENDING_SETTLEMENT'
            activate DB
            hnote over DB #LightYellow
                INSERT INTO **settlementWindowStateChange**
                    (settlementWindowId, settlementWindowStateId, reason)
                VALUE payload./settlementWindow/{id}, 'PENDING_SETTLEMENT', payload.reason
            end hnote
            deactivate DB
        end
        SSAPI <- - SETTLE_DAO: Results for participant netAmount per ledger for closed settlement window
        deactivate SETTLE_DAO
        note left of SSAPI #Yellow
            {
              "id": "string",
              "reason": "string",
              "state": "PENDING_SETTLEMENT",
              "netSettlementAmount": {
                "amount": 0,
                "currency": "string"
              }
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - <color #FF0000>200 (OK)</color>
    else Settlement Windows not found
        note right of SSAPI #lightgray
            Log ERROR event
        end note
        note left of SSAPI #yellow
            {
                "status": 0,
                "code": <integer>,
                "message": <string>
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - <color #FF0000>4xx (Client error)</color>
        deactivate SSAPI
        deactivate OPERATOR
    end
end
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>