<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1797.0001px" preserveAspectRatio="none" style="width:1017px;height:1797px;" version="1.1" viewBox="0 0 1017 1797" width="1017px" zoomAndPan="magnify"><defs><filter height="300%" id="f1upneugioe6mh" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="1.2000000476837158"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="2.4000000953674316" dy="2.4000000953674316" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="8.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="140.4" x="438.9" y="14.1211">6.2.1. Trigger a Settlement event</text><rect fill="#FFB6C1" height="1770.3048" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="67.2" x="23.4" y="20.693"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="48.6" x="32.7" y="28.234">Central HUB</text><rect fill="#90EE90" height="1770.3048" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="402.3" x="169.5" y="20.693"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="74.4" x="333.45" y="28.234">Settlement Service</text><rect fill="#FFFFE0" height="1770.3048" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="68.4" x="772.2" y="20.693"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="64.8" x="774" y="28.234">Central Services</text><rect fill="#FFFFFF" filter="url(#f1upneugioe6mh)" height="1631.3462" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="54" y="88.3723"/><rect fill="#FFFFFF" filter="url(#f1upneugioe6mh)" height="1470.3376" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="216" y="249.3809"/><rect fill="#FFFFFF" filter="url(#f1upneugioe6mh)" height="35.7727" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="532.2" y="275.9672"/><rect fill="#FFFFFF" filter="url(#f1upneugioe6mh)" height="100.9043" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="532.2" y="376.6852"/><rect fill="#FFFFFF" filter="url(#f1upneugioe6mh)" height="719.0754" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="532.2" y="775.5024"/><rect fill="#FFFFFF" filter="url(#f1upneugioe6mh)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="803.4" y="293.7399"/><rect fill="#FFFFFF" filter="url(#f1upneugioe6mh)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="803.4" y="394.4578"/><rect fill="#FFFFFF" filter="url(#f1upneugioe6mh)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="803.4" y="807.8614"/><rect fill="#FFFFFF" filter="url(#f1upneugioe6mh)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="803.4" y="881.8067"/><rect fill="#FFFFFF" filter="url(#f1upneugioe6mh)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="803.4" y="1084.3606"/><rect fill="#FFFFFF" filter="url(#f1upneugioe6mh)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="803.4" y="1231.7965"/><rect fill="#FFFFFF" filter="url(#f1upneugioe6mh)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="803.4" y="1324.1145"/><rect fill="#FFFFFF" filter="url(#f1upneugioe6mh)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="803.4" y="1416.4325"/><rect fill="#FFFFFF" filter="url(#f1upneugioe6mh)" height="1636.3325" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="1002.6" x="7.8" y="92.5723"/><rect fill="#FFFFFF" filter="url(#f1upneugioe6mh)" height="1237.929" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="990.6" x="13.8" y="486.7758"/><rect fill="#FFFFFF" filter="url(#f1upneugioe6mh)" height="248.3402" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="412.2" x="19.8" y="501.3621"/><rect fill="#FFFFFF" filter="url(#f1upneugioe6mh)" height="87.3316" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="243.9" x="159.9" y="515.9485"/><rect fill="#FFFFFF" filter="url(#f1upneugioe6mh)" height="44.959" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="231.9" x="165.9" y="554.1211"/><rect fill="#FFFFFF" filter="url(#f1upneugioe6mh)" height="692.9028" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="503.4" x="495" y="784.875"/><rect fill="#FFFFFF" height="110.4773" style="stroke: none; stroke-width: 0.6000000238418579;" width="990.6" x="13.8" y="1614.2274"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 5.0,5.0;" x1="57" x2="57" y1="82.3723" y2="1739.1048"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 5.0,5.0;" x1="218.7" x2="218.7" y1="82.3723" y2="1739.1048"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 5.0,5.0;" x1="535.2" x2="535.2" y1="82.3723" y2="1739.1048"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 5.0,5.0;" x1="806.4" x2="806.4" y1="82.3723" y2="1739.1048"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="58.8" x="25.8" y="80.6004">Hub Employee</text><ellipse cx="57" cy="38.2793" fill="#FEFECE" filter="url(#f1upneugioe6mh)" rx="4.8" ry="4.8" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><path d="M57,43.0793 L57,59.2793 M49.2,47.8793 L64.8,47.8793 M57,59.2793 L49.2,68.2793 M57,59.2793 L64.8,68.2793 " fill="none" filter="url(#f1upneugioe6mh)" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="58.8" x="25.8" y="1746.6259">Hub Employee</text><ellipse cx="57" cy="1754.3977" fill="#FEFECE" filter="url(#f1upneugioe6mh)" rx="4.8" ry="4.8" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><path d="M57,1759.1977 L57,1775.3977 M49.2,1763.9977 L64.8,1763.9977 M57,1775.3977 L49.2,1784.3977 M57,1775.3977 L64.8,1784.3977 " fill="none" filter="url(#f1upneugioe6mh)" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="90.6" x="171.9" y="80.6004">Settlement Service API</text><path d="M206.7,55.6793 L206.7,70.0793 M206.7,62.8793 L216.9,62.8793 " fill="none" filter="url(#f1upneugioe6mh)" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><ellipse cx="224.1" cy="62.8793" fill="#FEFECE" filter="url(#f1upneugioe6mh)" rx="7.2" ry="7.2" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="90.6" x="171.9" y="1746.6259">Settlement Service API</text><path d="M206.7,1750.7977 L206.7,1765.1977 M206.7,1757.9977 L216.9,1757.9977 " fill="none" filter="url(#f1upneugioe6mh)" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><ellipse cx="224.1" cy="1757.9977" fill="#FEFECE" filter="url(#f1upneugioe6mh)" rx="7.2" ry="7.2" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="64.8" x="501" y="80.6004">Settlement DAO</text><ellipse cx="535.2" cy="62.8793" fill="#FEFECE" filter="url(#f1upneugioe6mh)" rx="7.2" ry="7.2" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><line style="stroke: #A80036; stroke-width: 1.2000000476837158;" x1="528" x2="542.4" y1="71.2793" y2="71.2793"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="64.8" x="501" y="1746.6259">Settlement DAO</text><ellipse cx="535.2" cy="1757.9977" fill="#FEFECE" filter="url(#f1upneugioe6mh)" rx="7.2" ry="7.2" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><line style="stroke: #A80036; stroke-width: 1.2000000476837158;" x1="528" x2="542.4" y1="1766.3977" y2="1766.3977"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="54" x="777.6" y="80.6004">Central Store</text><path d="M795.6,50.8793 C795.6,44.8793 806.4,44.8793 806.4,44.8793 C806.4,44.8793 817.2,44.8793 817.2,50.8793 L817.2,66.4793 C817.2,72.4793 806.4,72.4793 806.4,72.4793 C806.4,72.4793 795.6,72.4793 795.6,66.4793 L795.6,50.8793 " fill="#FEFECE" filter="url(#f1upneugioe6mh)" style="stroke: #000000; stroke-width: 0.9000000357627869;"/><path d="M795.6,50.8793 C795.6,56.8793 806.4,56.8793 806.4,56.8793 C806.4,56.8793 817.2,56.8793 817.2,50.8793 " fill="none" style="stroke: #000000; stroke-width: 0.9000000357627869;"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="54" x="777.6" y="1746.6259">Central Store</text><path d="M795.6,1754.3977 C795.6,1748.3977 806.4,1748.3977 806.4,1748.3977 C806.4,1748.3977 817.2,1748.3977 817.2,1754.3977 L817.2,1769.9977 C817.2,1775.9977 806.4,1775.9977 806.4,1775.9977 C806.4,1775.9977 795.6,1775.9977 795.6,1769.9977 L795.6,1754.3977 " fill="#FEFECE" filter="url(#f1upneugioe6mh)" style="stroke: #000000; stroke-width: 0.9000000357627869;"/><path d="M795.6,1754.3977 C795.6,1760.3977 806.4,1760.3977 806.4,1760.3977 C806.4,1760.3977 817.2,1760.3977 817.2,1754.3977 " fill="none" style="stroke: #000000; stroke-width: 0.9000000357627869;"/><rect fill="#FFFFFF" filter="url(#f1upneugioe6mh)" height="1631.3462" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="54" y="88.3723"/><rect fill="#FFFFFF" filter="url(#f1upneugioe6mh)" height="1470.3376" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="216" y="249.3809"/><rect fill="#FFFFFF" filter="url(#f1upneugioe6mh)" height="35.7727" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="532.2" y="275.9672"/><rect fill="#FFFFFF" filter="url(#f1upneugioe6mh)" height="100.9043" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="532.2" y="376.6852"/><rect fill="#FFFFFF" filter="url(#f1upneugioe6mh)" height="719.0754" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="532.2" y="775.5024"/><rect fill="#FFFFFF" filter="url(#f1upneugioe6mh)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="803.4" y="293.7399"/><rect fill="#FFFFFF" filter="url(#f1upneugioe6mh)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="803.4" y="394.4578"/><rect fill="#FFFFFF" filter="url(#f1upneugioe6mh)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="803.4" y="807.8614"/><rect fill="#FFFFFF" filter="url(#f1upneugioe6mh)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="803.4" y="881.8067"/><rect fill="#FFFFFF" filter="url(#f1upneugioe6mh)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="803.4" y="1084.3606"/><rect fill="#FFFFFF" filter="url(#f1upneugioe6mh)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="803.4" y="1231.7965"/><rect fill="#FFFFFF" filter="url(#f1upneugioe6mh)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="803.4" y="1324.1145"/><rect fill="#FFFFFF" filter="url(#f1upneugioe6mh)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="803.4" y="1416.4325"/><path d="M7.8,92.5723 L136.2,92.5723 L136.2,96.7723 L130.2,102.7723 L7.8,102.7723 L7.8,92.5723 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="1636.3325" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="1002.6" x="7.8" y="92.5723"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101.4" x="16.8" y="100.7133">Trigger Settlement Event</text><path d="M63,105.9586 L63,231.3586 L178.2,231.3586 L178.2,111.9586 L172.2,105.9586 L63,105.9586 " fill="#FFFF00" filter="url(#f1upneugioe6mh)" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><path d="M172.2,105.9586 L172.2,111.9586 L178.2,111.9586 L172.2,105.9586 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="66.6" y="116.4996">{</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="65.4" x="71.4" y="125.6859">"settlementId": 0,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="66.6" x="71.4" y="134.8723">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="87" x="71.4" y="144.0586">"settlementWindows": [</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="76.2" y="153.2449">{</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="25.2" x="81" y="162.4313">"id": 0,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="66.6" x="81" y="171.6176">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="60" x="81" y="180.8039">"state": "string",</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="86.4" x="81" y="189.9902">"createdDate": "string",</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="88.2" x="81" y="199.1766">"changedDate": "string"</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="76.2" y="208.3629">}</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="71.4" y="217.5492">]</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="66.6" y="226.7356">}</text><polygon fill="#A80036" points="208.8,246.9809,214.8,249.3809,208.8,251.7809,211.2,249.3809" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="60" x2="212.4" y1="249.3809" y2="249.3809"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="64.2" y="246.7219">1</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="89.4" x="72" y="246.7219">POST - /settlement/{id}</text><polygon fill="#A80036" points="525,273.5672,531,275.9672,525,278.3672,527.4,275.9672" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="222" x2="528.6" y1="275.9672" y2="275.9672"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="226.2" y="268.9014">2</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="84" x="234" y="264.3082">Create new settlement</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43.8" x="234" y="273.4945">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="19.2" x="280.2" y="273.4945">2001</text><polygon fill="#A80036" points="796.2,291.3399,802.2,293.7399,796.2,296.1399,798.6,293.7399" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="538.2" x2="799.8" y1="293.7399" y2="293.7399"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="542.4" y="291.0809">3</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="81.6" x="550.2" y="291.0809">Insert new settlement</text><polygon fill="#FFFFE0" filter="url(#f1upneugioe6mh)" points="754.2,319.7262,858.6,319.7262,864.6,335.3262,858.6,351.5262,754.2,351.5262,748.2,335.3262,754.2,319.7262" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="48" x="755.4" y="329.6672">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43.2" x="805.8" y="329.6672">settlement</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="25.2" x="765" y="338.8535">reason</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="92.4" x="765" y="348.0399">VALUES (payload.reason)</text><polygon fill="#A80036" points="525,374.2852,531,376.6852,525,379.0852,527.4,376.6852" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="222" x2="528.6" y1="376.6852" y2="376.6852"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="226.2" y="369.6194">4</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="111" x="234" y="365.0262">Request settlementWindow(s)</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43.8" x="234" y="374.2125">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="19.2" x="280.2" y="374.2125">2001</text><polygon fill="#A80036" points="796.2,392.0578,802.2,394.4578,796.2,396.8578,798.6,394.4578" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="538.2" x2="799.8" y1="394.4578" y2="394.4578"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="542.4" y="391.7988">5</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="111" x="550.2" y="391.7988">Retrieve settlementWindow(s)</text><polygon fill="#FFFFE0" filter="url(#f1upneugioe6mh)" points="652.8,420.4442,960,420.4442,966,440.8442,960,461.8442,652.8,461.8442,646.8,440.8442,652.8,420.4442" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="304.8" x="654" y="430.3852">SELECT MAX(settlementWindowStateChangeId), settlementWindowStateId, reason</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="21.6" x="654" y="439.5715">FROM</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="126" x="680.4" y="439.5715">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="237.6" x="654" y="448.7578">WHERE settlementWindowId = payload./settlementWindow/{id}</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="246.6" x="654" y="457.9442">GROUP BY settlementWindowStateId,settlementWindowId, reason;</text><polygon fill="#A80036" points="228.6,475.1895,222.6,477.5895,228.6,479.9895,226.2,477.5895" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="225" x2="534.6" y1="477.5895" y2="477.5895"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="232.2" y="474.9305">6</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="52.8" x="240" y="474.9305">Return results</text><path d="M13.8,486.7758 L51,486.7758 L51,490.9758 L45,496.9758 L13.8,496.9758 L13.8,486.7758 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="1237.929" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="990.6" x="13.8" y="486.7758"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.2" x="22.8" y="494.9168">alt</text><text fill="#000000" font-family="sans-serif" font-size="6.6" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="94.2" x="60" y="494.3567">[Settlement Windows found]</text><path d="M19.8,501.3621 L70.2,501.3621 L70.2,505.5621 L64.2,511.5621 L19.8,511.5621 L19.8,501.3621 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="248.3402" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="412.2" x="19.8" y="501.3621"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="23.4" x="28.8" y="509.5031">break</text><path d="M159.9,515.9485 L343.5,515.9485 L343.5,520.1485 L337.5,526.1485 L159.9,526.1485 L159.9,515.9485 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="87.3316" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="243.9" x="159.9" y="515.9485"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="156.6" x="168.9" y="524.0895">Validate the list of settlement windows</text><path d="M225,529.3348 L225,544.3348 L372,544.3348 L372,535.3348 L366,529.3348 L225,529.3348 " fill="#D3D3D3" filter="url(#f1upneugioe6mh)" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><path d="M366,529.3348 L366,535.3348 L372,535.3348 L366,529.3348 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="134.4" x="228.6" y="539.8758">allSettlementWindowsClosed = true</text><path d="M165.9,554.1211 L210.3,554.1211 L210.3,558.3211 L204.3,564.3211 L165.9,564.3211 L165.9,554.1211 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="44.959" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="231.9" x="165.9" y="554.1211"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17.4" x="174.9" y="562.2621">loop</text><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="222" x2="247.2" y1="586.4801" y2="586.4801"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="247.2" x2="247.2" y1="586.4801" y2="594.2801"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="222.6" x2="247.2" y1="594.2801" y2="594.2801"/><polygon fill="#A80036" points="228.6,591.8801,222.6,594.2801,228.6,596.6801,226.2,594.2801" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="226.2" y="579.0416">7</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="150" x="234" y="574.4485">if settlementWindowStateId != 'CLOSED'</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="156.6" x="234" y="583.6348">then allSettlementWindowsClosed = false</text><path d="M225,610.4801 L225,726.2801 L423.6,726.2801 L423.6,616.4801 L417.6,610.4801 L225,610.4801 " fill="#FFFF00" filter="url(#f1upneugioe6mh)" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><path d="M417.6,610.4801 L417.6,616.4801 L423.6,616.4801 L417.6,610.4801 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="228.6" y="621.0211">{</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="41.4" x="238.2" y="630.2074">"status": 0,</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="3.6" x="282" y="630.2074">?</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="69.6" x="238.2" y="639.3938">"code": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="138" x="238.2" y="648.5801">"message": "Invalid payload or state"</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="228.6" y="657.7664">}</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="12" x="228.6" y="666.9528">OR</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="83.4" x="243" y="666.9528">what is used in 6.2.5.:</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="228.6" y="676.1391">{</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="69.6" x="238.2" y="685.3254">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="88.8" x="247.8" y="694.5117">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="166.8" x="247.8" y="703.6981">"errorDescription": "Invalid payload or state"</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="238.2" y="712.8844">}</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="228.6" y="722.0707">}</text><polygon fill="#A80036" points="66.6,742.316,60.6,744.716,66.6,747.116,64.2,744.716" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="63" x2="215.4" y1="744.716" y2="744.716"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="70.2" y="742.0571">8</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="61.8" x="78" y="742.0571">Respond HTTP -</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="67.2" x="142.2" y="742.0571">400 (Bad Request)</text><polygon fill="#A80036" points="525,773.1024,531,775.5024,525,777.9024,527.4,775.5024" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="222" x2="528.6" y1="775.5024" y2="775.5024"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="226.2" y="768.4366">9</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="183" x="234" y="763.8434">Request 'CLOSE' &amp; 'OPEN' of Settlement Windows</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43.8" x="234" y="773.0297">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="19.2" x="280.2" y="773.0297">2001</text><path d="M495,784.875 L594,784.875 L594,789.075 L588,795.075 L495,795.075 L495,784.875 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="692.9028" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="503.4" x="495" y="784.875"/><text fill="#0000FF" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="504" y="793.016">DB TRANSACTION</text><polygon fill="#A80036" points="796.2,805.4614,802.2,807.8614,796.2,810.2614,798.6,807.8614" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="538.2" x2="799.8" y1="807.8614" y2="807.8614"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="542.4" y="805.2024">10</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="136.8" x="555.6" y="805.2024">Insert the list of settlementWindows</text><polygon fill="#FFFFE0" filter="url(#f1upneugioe6mh)" points="681.6,833.8477,930.6,833.8477,936.6,849.4477,930.6,865.6477,681.6,865.6477,675.6,849.4477,681.6,833.8477" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="48" x="682.8" y="843.7887">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118.2" x="733.2" y="843.7887">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="133.8" x="702" y="852.975">(settlementId, settlementWindowId)</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="237" x="692.4" y="862.1614">VALUE(payload.settlementId, payload./settlementWindow/{id});</text><polygon fill="#A80036" points="796.2,879.4067,802.2,881.8067,796.2,884.2067,798.6,881.8067" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="538.2" x2="799.8" y1="881.8067" y2="881.8067"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="542.4" y="879.1477">11</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="228" x="555.6" y="879.1477">Populate settlementTransferParticipant with aggregated data</text><polygon fill="#FFFFE0" filter="url(#f1upneugioe6mh)" points="663,907.793,949.2,907.793,955.2,988.193,949.2,1068.593,663,1068.593,657,988.193,663,907.793" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="48" x="664.2" y="917.734">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="121.8" x="714.6" y="917.734">settlementTransferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="254.4" x="673.8" y="926.9203">(settlementId, participantCurrencyId, transferParticipantRoleTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="153.6" x="673.8" y="936.1067">ledgerEntryTypeId, amount, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="269.4" x="664.2" y="945.293">SELECT payload.settlementId AS settlementId, tp.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="206.4" x="673.8" y="954.4793">tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="208.2" x="673.8" y="963.6657">SUM(tp.amount) AS amount, CURDATE() AS createdDate</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="21.6" x="664.2" y="972.852">FROM</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73.2" x="688.2" y="972.852">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="18" x="763.8" y="972.852">AS tf</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="16.8" x="664.2" y="982.0383">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="83.4" x="683.4" y="982.0383">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="23.4" x="769.2" y="982.0383">AS tsc</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="274.2" x="673.8" y="991.2246">ON tsc.transferId = tf.transferId AND tsc.transferStateId = ‘COMMITTED’</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="16.8" x="664.2" y="1000.411">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="76.2" x="683.4" y="1000.411">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="19.8" x="762" y="1000.411">AS tp</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="117" x="673.8" y="1009.5973">ON tp.transferId = tf.transferId</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="113.4" x="664.2" y="1018.7836">WHERE tf.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="119.4" x="673.8" y="1027.97">IN (SELECT settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="21.6" x="673.8" y="1037.1563">FROM</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118.2" x="697.8" y="1037.1563">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="168" x="673.8" y="1046.3426">WHERE settlementId = payload.settlementId)</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="259.8" x="673.8" y="1055.5289">GROUP BY tp.participantCurrencyId, tp.transferParticipantRoleTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="78" x="683.4" y="1064.7153">tp.ledgerEntryTypeId</text><polygon fill="#A80036" points="796.2,1081.9606,802.2,1084.3606,796.2,1086.7606,798.6,1084.3606" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="538.2" x2="799.8" y1="1084.3606" y2="1084.3606"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="542.4" y="1081.7016">12</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="230.4" x="555.6" y="1081.7016">Populate settlementParticipantCurrency with aggregated data</text><polygon fill="#FFFFE0" filter="url(#f1upneugioe6mh)" points="626.4,1110.3469,986.4,1110.3469,992.4,1163.1469,986.4,1215.9469,626.4,1215.9469,620.4,1163.1469,626.4,1110.3469" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="48" x="627.6" y="1120.2879">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124.2" x="678" y="1120.2879">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="185.4" x="637.2" y="1129.4743">(settlementId, participantCurrencyId, netAmount)</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="165.6" x="627.6" y="1138.6606">SELECT settlementId, participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="37.8" x="627.6" y="1147.8469">SUM(CASE</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="340.8" x="639.6" y="1157.0332">WHEN stp.transferParticipantRoleTypeId = 1 AND stp.ledgerEntryTypeId = 1 THEN amount</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="345.6" x="639.6" y="1166.2196">WHEN stp.transferParticipantRoleTypeId = 2 AND stp.ledgerEntryTypeId = 1 THEN -amount</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="182.4" x="639.6" y="1175.4059">WHEN stp.ledgerEntryTypeId = 2 THEN -amount</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="21" x="634.8" y="1184.5922">END )</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="21.6" x="627.6" y="1193.7786">FROM</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="121.8" x="651.6" y="1193.7786">settlementTransferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="24" x="775.8" y="1193.7786">AS stp</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="165.6" x="627.6" y="1202.9649">WHERE settlementId = payload.settlementId</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="173.4" x="627.6" y="1212.1512">GROUP BY settlementId, participantCurrencyId</text><polygon fill="#A80036" points="796.2,1229.3965,802.2,1231.7965,796.2,1234.1965,798.6,1231.7965" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="538.2" x2="799.8" y1="1231.7965" y2="1231.7965"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="542.4" y="1229.1375">13</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="188.4" x="555.6" y="1229.1375">Insert initial state change 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#f1upneugioe6mh)" points="651,1257.7829,961.8,1257.7829,967.8,1282.9829,961.8,1308.1829,651,1308.1829,645,1282.9829,651,1257.7829" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="48" x="652.2" y="1267.7239">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="175.2" x="702.6" y="1267.7239">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="226.8" x="661.8" y="1276.9102">(settlementParticipantCurrencyId, settlementStateId, reason)</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="308.4" x="652.2" y="1286.0965">SELECT settlementParticipantCurrencyId, ‘PENDING_SETTLEMENT’, payload.reason</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="21.6" x="652.2" y="1295.2829">FROM</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124.2" x="676.2" y="1295.2829">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="165.6" x="652.2" y="1304.4692">WHERE settlementId = payload.settlementId</text><polygon fill="#A80036" points="796.2,1321.7145,802.2,1324.1145,796.2,1326.5145,798.6,1324.1145" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="538.2" x2="799.8" y1="1324.1145" y2="1324.1145"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="542.4" y="1321.4555">14</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="214.8" x="555.6" y="1321.4555">Insert initial state for settlement 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#f1upneugioe6mh)" points="687.6,1350.1008,924.6,1350.1008,930.6,1375.3008,924.6,1400.5008,687.6,1400.5008,681.6,1375.3008,687.6,1350.1008" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="48" x="688.8" y="1360.0419">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="94.2" x="739.2" y="1360.0419">settlementStateChange</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="153" x="698.4" y="1369.2282">(settlementId, settlementStateId, reason)</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="234.6" x="688.8" y="1378.4145">SELECT settlementId, ‘PENDING_SETTLEMENT’, payload.reason</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="21.6" x="688.8" y="1387.6008">FROM</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124.2" x="712.8" y="1387.6008">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="165.6" x="688.8" y="1396.7872">WHERE settlementId = payload.settlementId</text><polygon fill="#A80036" points="796.2,1414.0325,802.2,1416.4325,796.2,1418.8325,798.6,1416.4325" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="538.2" x2="799.8" y1="1416.4325" y2="1416.4325"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="542.4" y="1413.7735">15</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="237.6" x="555.6" y="1413.7735">Insert new state for settlementWindow 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#f1upneugioe6mh)" points="652.8,1442.4188,960,1442.4188,966,1458.0188,960,1474.2188,652.8,1474.2188,646.8,1458.0188,652.8,1442.4188" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="48" x="654" y="1452.3598">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="126" x="704.4" y="1452.3598">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="211.8" x="663.6" y="1461.5462">(settlementWindowId, settlementWindowStateId, reason)</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="304.8" x="654" y="1470.7325">VALUE payload./settlementWindow/{id}, 'PENDING_SETTLEMENT', payload.reason</text><polygon fill="#A80036" points="228.6,1492.1778,222.6,1494.5778,228.6,1496.9778,226.2,1494.5778" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="225" x2="534.6" y1="1494.5778" y2="1494.5778"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="232.2" y="1491.9188">16</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="282.6" x="245.4" y="1491.9188">Results for participant netAmount per ledger for closed settlement window</text><path d="M69,1502.5641 L69,1590.7641 L210.6,1590.7641 L210.6,1508.5641 L204.6,1502.5641 L69,1502.5641 " fill="#FFFF00" filter="url(#f1upneugioe6mh)" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><path d="M204.6,1502.5641 L204.6,1508.5641 L210.6,1508.5641 L204.6,1502.5641 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="72.6" y="1513.1051">{</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="48.6" x="77.4" y="1522.2915">"id": "string",</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="66.6" x="77.4" y="1531.4778">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="124.2" x="77.4" y="1540.6641">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="95.4" x="77.4" y="1549.8505">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="46.8" x="82.2" y="1559.0368">"amount": 0,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="71.4" x="82.2" y="1568.2231">"currency": "string"</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="77.4" y="1577.4094">}</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="72.6" y="1586.5958">}</text><polygon fill="#A80036" points="66.6,1606.8411,60.6,1609.2411,66.6,1611.6411,64.2,1609.2411" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="63" x2="215.4" y1="1609.2411" y2="1609.2411"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="70.2" y="1606.5821">17</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="61.8" x="83.4" y="1606.5821">Respond HTTP -</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="32.4" x="147.6" y="1606.5821">200 (OK)</text><line style="stroke: #000000; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="13.8" x2="1004.4" y1="1614.8274" y2="1614.8274"/><text fill="#000000" font-family="sans-serif" font-size="6.6" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="107.4" x="16.8" y="1621.2083">[Settlement Windows not found]</text><path d="M225,1626.2005 L225,1641.2005 L301.2,1641.2005 L301.2,1632.2005 L295.2,1626.2005 L225,1626.2005 " fill="#D3D3D3" filter="url(#f1upneugioe6mh)" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><path d="M295.2,1626.2005 L295.2,1632.2005 L301.2,1632.2005 L295.2,1626.2005 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="63.6" x="228.6" y="1636.7415">Log ERROR event</text><path d="M110.4,1649.7868 L110.4,1701.3868 L210.6,1701.3868 L210.6,1655.7868 L204.6,1649.7868 L110.4,1649.7868 " fill="#FFFF00" filter="url(#f1upneugioe6mh)" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><path d="M204.6,1649.7868 L204.6,1655.7868 L210.6,1655.7868 L204.6,1649.7868 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="114" y="1660.3278">{</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="41.4" x="123.6" y="1669.5141">"status": 0,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="69.6" x="123.6" y="1678.7005">"code": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="78" x="123.6" y="1687.8868">"message": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="114" y="1697.0731">}</text><polygon fill="#A80036" points="63.6,1717.3184,57.6,1719.7184,63.6,1722.1184,61.2,1719.7184" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="60" x2="218.4" y1="1719.7184" y2="1719.7184"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="67.2" y="1717.0594">18</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="61.8" x="80.4" y="1717.0594">Respond HTTP -</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="64.2" x="144.6" y="1717.0594">4xx (Client error)</text><!--
@startuml
title 6.2.1. Trigger a Settlement event

autonumber

actor "Hub Employee" as OPERATOR
boundary "Settlement Service API" as SSAPI
entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Central HUB" #LightPink
    participant OPERATOR
end box

box "Settlement Service" #LightGreen
    participant SSAPI
    participant SETTLE_DAO
end box

box "Central Services" #LightYellow
    participant DB
end box

group Trigger Settlement Event
activate OPERATOR
    note right of OPERATOR #Yellow
        {
          "settlementId": 0,
          "reason": "string",
          "settlementWindows": [
            {
              "id": 0,
              "reason": "string",
              "state": "string",
              "createdDate": "string",
              "changedDate": "string"
            }
          ]
        }
    end note
    OPERATOR -> SSAPI: POST - /settlement/{id}
    activate SSAPI
    SSAPI-> SETTLE_DAO: Create new settlement\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    SETTLE_DAO -> DB: Insert new settlement
    activate DB
    deactivate SETTLE_DAO
    hnote over DB #LightYellow
        INSERT INTO **settlement**
            reason
            VALUES (payload.reason)
    end hnote
    deactivate DB

    SSAPI-> SETTLE_DAO: Request settlementWindow(s)\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    SETTLE_DAO -> DB: Retrieve settlementWindow(s)
    activate DB
    hnote over DB #LightYellow
        SELECT MAX(settlementWindowStateChangeId), settlementWindowStateId, reason
        FROM  **settlementWindowStateChange**
        WHERE settlementWindowId = payload./settlementWindow/{id}
        GROUP BY settlementWindowStateId,settlementWindowId, reason;
    end hnote
    deactivate DB
    SSAPI <- - SETTLE_DAO: Return results
    deactivate SETTLE_DAO

    alt Settlement Windows found
        break
            group Validate the list of settlement windows
                note right of SSAPI #LightGray
                    allSettlementWindowsClosed = true
                end note
                loop
                    SSAPI - -> SSAPI: if settlementWindowStateId != 'CLOSED' \nthen allSettlementWindowsClosed = false
                end loop
            end
            note right of SSAPI #yellow
                {
                    "status": 0, <color #FF0000>**?**</color>
                    "code": <integer>,
                    "message": "Invalid payload or state"
                }
                <color #FF0000>**OR**</color> what is used in 6.2.5.:
                {
                    errorInformation: {
                        "errorCode": <integer>,
                        "errorDescription": "Invalid payload or state"
                    }
                }
            end note
            OPERATOR <- - SSAPI: Respond HTTP - <color #FF0000>400 (Bad Request)</color>
        end
        SSAPI ->SETTLE_DAO: Request 'CLOSE' & 'OPEN' of Settlement Windows\n<color #FF0000><b>Error code:</b> 2001</color>
        activate SETTLE_DAO
        group <color #blue>DB TRANSACTION</color>
            SETTLE_DAO -> DB: Insert the list of settlementWindows
            activate DB
            hnote over DB #LightYellow
                INSERT INTO **settlementSettlementWindow**
                	(settlementId, settlementWindowId)
                    VALUE(payload.settlementId, payload./settlementWindow/{id});
            end hnote
            deactivate DB
            SETTLE_DAO -> DB: Populate settlementTransferParticipant with aggregated data
            activate DB
            hnote over DB #LightYellow
                INSERT INTO **settlementTransferParticipant**
                    (settlementId, participantCurrencyId, transferParticipantRoleTypeId,
                    ledgerEntryTypeId, amount, createdDate)
                SELECT payload.settlementId AS settlementId, tp.participantCurrencyId,
                    tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId,
                    SUM(tp.amount) AS amount, CURDATE() AS createdDate
                FROM **transferFulfilment** AS tf
                JOIN **transferStateChange** AS tsc
                    ON tsc.transferId = tf.transferId AND tsc.transferStateId = ‘COMMITTED’
                JOIN **transferParticipant** AS tp
                    ON tp.transferId = tf.transferId
                WHERE tf.settlementWindowId
                    IN (SELECT settlementWindowId
                    FROM **settlementSettlementWindow**
                    WHERE settlementId = payload.settlementId)
                    GROUP BY tp.participantCurrencyId, tp.transferParticipantRoleTypeId,
                        tp.ledgerEntryTypeId
            end hnote
            deactivate DB
            SETTLE_DAO -> DB: Populate settlementParticipantCurrency with aggregated data
            activate DB
            hnote over DB #LightYellow
                INSERT INTO **settlementParticipantCurrency**
                    (settlementId, participantCurrencyId, netAmount)
                SELECT settlementId, participantCurrencyId,
                SUM(CASE
                     WHEN stp.transferParticipantRoleTypeId = 1 AND stp.ledgerEntryTypeId = 1 THEN amount
                     WHEN stp.transferParticipantRoleTypeId = 2 AND stp.ledgerEntryTypeId = 1 THEN -amount
                     WHEN stp.ledgerEntryTypeId = 2 THEN -amount
                   END )
                FROM **settlementTransferParticipant** AS stp
                WHERE settlementId = payload.settlementId
                GROUP BY settlementId, participantCurrencyId
            end hnote
            deactivate DB
            SETTLE_DAO -> DB: Insert initial state change 'PENDING_SETTLEMENT'
            activate DB
            hnote over DB #LightYellow
                INSERT INTO **settlementParticipantCurrencyStateChange**
                    (settlementParticipantCurrencyId, settlementStateId, reason)
                SELECT settlementParticipantCurrencyId, ‘PENDING_SETTLEMENT’, payload.reason
                FROM **settlementParticipantCurrency**
                WHERE settlementId = payload.settlementId
            end hnote
            deactivate DB
            SETTLE_DAO -> DB: Insert initial state for settlement 'PENDING_SETTLEMENT'
            activate DB
            hnote over DB #LightYellow
                INSERT INTO **settlementStateChange**
                    (settlementId, settlementStateId, reason)
                SELECT settlementId, ‘PENDING_SETTLEMENT’, payload.reason
                FROM **settlementParticipantCurrency**
                WHERE settlementId = payload.settlementId
            end hnote
            deactivate DB
            SETTLE_DAO -> DB: Insert new state for settlementWindow 'PENDING_SETTLEMENT'
            activate DB
            hnote over DB #LightYellow
                INSERT INTO **settlementWindowStateChange**
                    (settlementWindowId, settlementWindowStateId, reason)
                VALUE payload./settlementWindow/{id}, 'PENDING_SETTLEMENT', payload.reason
            end hnote
            deactivate DB
        end
        SSAPI <- - SETTLE_DAO: Results for participant netAmount per ledger for closed settlement window
        deactivate SETTLE_DAO
        note left of SSAPI #Yellow
            {
              "id": "string",
              "reason": "string",
              "state": "PENDING_SETTLEMENT",
              "netSettlementAmount": {
                "amount": 0,
                "currency": "string"
              }
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - <color #FF0000>200 (OK)</color>
    else Settlement Windows not found
        note right of SSAPI #lightgray
            Log ERROR event
        end note
        note left of SSAPI #yellow
            {
                "status": 0,
                "code": <integer>,
                "message": <string>
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - <color #FF0000>4xx (Client error)</color>
        deactivate SSAPI
        deactivate OPERATOR
    end
end
@enduml

PlantUML version 1.2018.01(Sun Jan 28 20:08:22 SAST 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_152-release-1136-b29
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: ZA
--></g></svg>