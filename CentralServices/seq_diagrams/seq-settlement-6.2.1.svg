<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1533.0001px" preserveAspectRatio="none" style="width:1165px;height:1533px;" version="1.1" viewBox="0 0 1165 1533" width="1165.2px" zoomAndPan="magnify"><defs><filter height="300%" id="f1m41q539bnhrr" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="1.2000000476837158"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="2.4000000953674316" dy="2.4000000953674316" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="8.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="182.4" x="492" y="14.1211">Trigger the creation of a settlement event</text><rect fill="#FFB6C1" height="1505.9098" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="67.2" x="17.4" y="20.693"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="48.6" x="26.7" y="28.234">Central HUB</text><rect fill="#90EE90" height="1505.9098" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="402.3" x="317.7" y="20.693"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="74.4" x="481.65" y="28.234">Settlement Service</text><rect fill="#FFFFE0" height="1505.9098" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="68.4" x="920.4" y="20.693"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="64.8" x="922.2" y="28.234">Central Services</text><rect fill="#FFFFFF" filter="url(#f1m41q539bnhrr)" height="1376.1376" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="48" y="88.3723"/><rect fill="#FFFFFF" filter="url(#f1m41q539bnhrr)" height="1028.9063" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="364.2" y="263.7809"/><rect fill="#FFFFFF" filter="url(#f1m41q539bnhrr)" height="136.077" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="364.2" y="1319.2465"/><rect fill="#FFFFFF" filter="url(#f1m41q539bnhrr)" height="1037.8793" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="680.4" y="281.3672"/><rect fill="#FFFFFF" filter="url(#f1m41q539bnhrr)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="951.6" y="307.9535"/><rect fill="#FFFFFF" filter="url(#f1m41q539bnhrr)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="951.6" y="391.0852"/><rect fill="#FFFFFF" filter="url(#f1m41q539bnhrr)" height="1371.9376" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="1150.8" x="7.8" y="92.5723"/><rect fill="#FFFFFF" filter="url(#f1m41q539bnhrr)" height="87.3316" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="231" x="637.2" y="466.0031"/><rect fill="#FFFFFF" filter="url(#f1m41q539bnhrr)" height="44.959" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="219" x="643.2" y="504.1758"/><rect fill="#FFFFFF" filter="url(#f1m41q539bnhrr)" height="898.575" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="1138.8" x="13.8" y="561.7348"/><rect fill="#FFFFFF" filter="url(#f1m41q539bnhrr)" height="584.9028" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="503.4" x="643.2" y="576.3211"/><rect fill="#FFFFFF" height="162.6363" style="stroke: none; stroke-width: 0.6000000238418579;" width="1138.8" x="13.8" y="1297.6735"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 5.0,5.0;" x1="51" x2="51" y1="82.3723" y2="1474.7098"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 5.0,5.0;" x1="366.9" x2="366.9" y1="82.3723" y2="1474.7098"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 5.0,5.0;" x1="683.4" x2="683.4" y1="82.3723" y2="1474.7098"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 5.0,5.0;" x1="954.6" x2="954.6" y1="82.3723" y2="1474.7098"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="58.8" x="19.8" y="80.6004">Hub Employee</text><ellipse cx="51" cy="38.2793" fill="#FEFECE" filter="url(#f1m41q539bnhrr)" rx="4.8" ry="4.8" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><path d="M51,43.0793 L51,59.2793 M43.2,47.8793 L58.8,47.8793 M51,59.2793 L43.2,68.2793 M51,59.2793 L58.8,68.2793 " fill="none" filter="url(#f1m41q539bnhrr)" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="58.8" x="19.8" y="1482.2309">Hub Employee</text><ellipse cx="51" cy="1490.0028" fill="#FEFECE" filter="url(#f1m41q539bnhrr)" rx="4.8" ry="4.8" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><path d="M51,1494.8028 L51,1511.0028 M43.2,1499.6028 L58.8,1499.6028 M51,1511.0028 L43.2,1520.0028 M51,1511.0028 L58.8,1520.0028 " fill="none" filter="url(#f1m41q539bnhrr)" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="90.6" x="320.1" y="80.6004">Settlement Service API</text><path d="M354.9,55.6793 L354.9,70.0793 M354.9,62.8793 L365.1,62.8793 " fill="none" filter="url(#f1m41q539bnhrr)" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><ellipse cx="372.3" cy="62.8793" fill="#FEFECE" filter="url(#f1m41q539bnhrr)" rx="7.2" ry="7.2" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="90.6" x="320.1" y="1482.2309">Settlement Service API</text><path d="M354.9,1486.4028 L354.9,1500.8028 M354.9,1493.6028 L365.1,1493.6028 " fill="none" filter="url(#f1m41q539bnhrr)" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><ellipse cx="372.3" cy="1493.6028" fill="#FEFECE" filter="url(#f1m41q539bnhrr)" rx="7.2" ry="7.2" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="64.8" x="649.2" y="80.6004">Settlement DAO</text><ellipse cx="683.4" cy="62.8793" fill="#FEFECE" filter="url(#f1m41q539bnhrr)" rx="7.2" ry="7.2" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><line style="stroke: #A80036; stroke-width: 1.2000000476837158;" x1="676.2" x2="690.6" y1="71.2793" y2="71.2793"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="64.8" x="649.2" y="1482.2309">Settlement DAO</text><ellipse cx="683.4" cy="1493.6028" fill="#FEFECE" filter="url(#f1m41q539bnhrr)" rx="7.2" ry="7.2" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><line style="stroke: #A80036; stroke-width: 1.2000000476837158;" x1="676.2" x2="690.6" y1="1502.0028" y2="1502.0028"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="54" x="925.8" y="80.6004">Central Store</text><path d="M943.8,50.8793 C943.8,44.8793 954.6,44.8793 954.6,44.8793 C954.6,44.8793 965.4,44.8793 965.4,50.8793 L965.4,66.4793 C965.4,72.4793 954.6,72.4793 954.6,72.4793 C954.6,72.4793 943.8,72.4793 943.8,66.4793 L943.8,50.8793 " fill="#FEFECE" filter="url(#f1m41q539bnhrr)" style="stroke: #000000; stroke-width: 0.9000000357627869;"/><path d="M943.8,50.8793 C943.8,56.8793 954.6,56.8793 954.6,56.8793 C954.6,56.8793 965.4,56.8793 965.4,50.8793 " fill="none" style="stroke: #000000; stroke-width: 0.9000000357627869;"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="54" x="925.8" y="1482.2309">Central Store</text><path d="M943.8,1490.0028 C943.8,1484.0028 954.6,1484.0028 954.6,1484.0028 C954.6,1484.0028 965.4,1484.0028 965.4,1490.0028 L965.4,1505.6028 C965.4,1511.6028 954.6,1511.6028 954.6,1511.6028 C954.6,1511.6028 943.8,1511.6028 943.8,1505.6028 L943.8,1490.0028 " fill="#FEFECE" filter="url(#f1m41q539bnhrr)" style="stroke: #000000; stroke-width: 0.9000000357627869;"/><path d="M943.8,1490.0028 C943.8,1496.0028 954.6,1496.0028 954.6,1496.0028 C954.6,1496.0028 965.4,1496.0028 965.4,1490.0028 " fill="none" style="stroke: #000000; stroke-width: 0.9000000357627869;"/><rect fill="#FFFFFF" filter="url(#f1m41q539bnhrr)" height="1376.1376" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="48" y="88.3723"/><rect fill="#FFFFFF" filter="url(#f1m41q539bnhrr)" height="1028.9063" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="364.2" y="263.7809"/><rect fill="#FFFFFF" filter="url(#f1m41q539bnhrr)" height="136.077" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="364.2" y="1319.2465"/><rect fill="#FFFFFF" filter="url(#f1m41q539bnhrr)" height="1037.8793" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="680.4" y="281.3672"/><rect fill="#FFFFFF" filter="url(#f1m41q539bnhrr)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="951.6" y="307.9535"/><rect fill="#FFFFFF" filter="url(#f1m41q539bnhrr)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="951.6" y="391.0852"/><path d="M7.8,92.5723 L136.2,92.5723 L136.2,96.7723 L130.2,102.7723 L7.8,102.7723 L7.8,92.5723 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="1371.9376" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="1150.8" x="7.8" y="92.5723"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101.4" x="16.8" y="100.7133">Trigger Settlement Event</text><path d="M57,105.9586 L57,221.7586 L161.4,221.7586 L161.4,111.9586 L155.4,105.9586 L57,105.9586 " fill="#FFFF00" filter="url(#f1m41q539bnhrr)" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><path d="M155.4,105.9586 L155.4,111.9586 L161.4,111.9586 L155.4,105.9586 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="60.6" y="116.4996">{</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="65.4" x="65.4" y="125.6859">"settlementId": 0,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="66.6" x="65.4" y="134.8723">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="87" x="65.4" y="144.0586">"settlementWindows": [</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="70.2" y="153.2449">{</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="25.2" x="75" y="162.4313">"id": 1,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="4.8" x="70.2" y="171.6176">},</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="70.2" y="180.8039">{</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="25.2" x="75" y="189.9902">"id": 2,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="70.2" y="199.1766">}</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="65.4" y="208.3629">]</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="60.6" y="217.5492">}</text><path d="M57,230.5945 L57,245.5945 L263.4,245.5945 L263.4,236.5945 L257.4,230.5945 L57,230.5945 " fill="#D3D3D3" filter="url(#f1m41q539bnhrr)" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><path d="M257.4,230.5945 L257.4,236.5945 L263.4,236.5945 L257.4,230.5945 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="193.8" x="60.6" y="241.1356">verify if we need the rest of the Swagger messages?</text><polygon fill="#A80036" points="357,261.3809,363,263.7809,357,266.1809,359.4,263.7809" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="54" x2="360.6" y1="263.7809" y2="263.7809"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="58.2" y="261.1219">1</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="89.4" x="66" y="261.1219">POST - /settlement/{id}</text><polygon fill="#A80036" points="673.2,278.9672,679.2,281.3672,673.2,283.7672,675.6,281.3672" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="370.2" x2="676.8" y1="281.3672" y2="281.3672"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="374.4" y="278.7082">2</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="84" x="382.2" y="278.7082">Create new settlement</text><polygon fill="#A80036" points="944.4,305.5535,950.4,307.9535,944.4,310.3535,946.8,307.9535" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="686.4" x2="948" y1="307.9535" y2="307.9535"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="690.6" y="300.8877">3</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="81.6" x="698.4" y="296.2945">Insert new settlement</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43.8" x="698.4" y="305.4809">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="19.2" x="744.6" y="305.4809">2001</text><polygon fill="#FFFFE0" filter="url(#f1m41q539bnhrr)" points="873,334.1262,1036.2,334.1262,1042.2,349.7262,1036.2,365.9262,873,365.9262,867,349.7262,873,334.1262" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="48" x="874.2" y="344.0672">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43.2" x="924.6" y="344.0672">settlement</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="30" x="883.8" y="353.2535">(reason)</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="151.2" x="883.8" y="362.4399">VALUE (payload./settlementId/{reason});</text><polygon fill="#A80036" points="944.4,388.6852,950.4,391.0852,944.4,393.4852,946.8,391.0852" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="686.4" x2="948" y1="391.0852" y2="391.0852"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="690.6" y="384.0194">4</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="93.6" x="698.4" y="379.4262">Get settlementWindow(s)</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43.8" x="698.4" y="388.6125">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="19.2" x="744.6" y="388.6125">2001</text><polygon fill="#FFFFE0" filter="url(#f1m41q539bnhrr)" points="801,417.2578,1108.2,417.2578,1114.2,437.6578,1108.2,458.6578,801,458.6578,795,437.6578,801,417.2578" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="304.8" x="802.2" y="427.1988">SELECT MAX(settlementWindowStateChangeId), settlementWindowStateId, reason</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="21.6" x="802.2" y="436.3852">FROM</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="126" x="828.6" y="436.3852">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="237.6" x="802.2" y="445.5715">WHERE settlementWindowId = payload./settlementWindow/{id}</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="246.6" x="802.2" y="454.7578">GROUP BY settlementWindowStateId,settlementWindowId, reason;</text><path d="M637.2,466.0031 L820.8,466.0031 L820.8,470.2031 L814.8,476.2031 L637.2,476.2031 L637.2,466.0031 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="87.3316" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="231" x="637.2" y="466.0031"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="156.6" x="646.2" y="474.1442">Validate the list of settlement windows</text><path d="M689.4,479.3895 L689.4,494.3895 L836.4,494.3895 L836.4,485.3895 L830.4,479.3895 L689.4,479.3895 " fill="#D3D3D3" filter="url(#f1m41q539bnhrr)" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><path d="M830.4,479.3895 L830.4,485.3895 L836.4,485.3895 L830.4,479.3895 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="134.4" x="693" y="489.9305">allSettlementWindowsClosed = true</text><path d="M643.2,504.1758 L687.6,504.1758 L687.6,508.3758 L681.6,514.3758 L643.2,514.3758 L643.2,504.1758 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="44.959" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="219" x="643.2" y="504.1758"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17.4" x="652.2" y="512.3168">loop</text><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="686.4" x2="711.6" y1="536.5348" y2="536.5348"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="711.6" x2="711.6" y1="536.5348" y2="544.3348"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="687" x2="711.6" y1="544.3348" y2="544.3348"/><polygon fill="#A80036" points="693,541.9348,687,544.3348,693,546.7348,690.6,544.3348" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="690.6" y="529.0963">5</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="150" x="698.4" y="524.5031">if settlementWindowStateId != 'CLOSED'</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="156.6" x="698.4" y="533.6895">then allSettlementWindowsClosed = false</text><path d="M13.8,561.7348 L51,561.7348 L51,565.9348 L45,571.9348 L13.8,571.9348 L13.8,561.7348 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="898.575" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="1138.8" x="13.8" y="561.7348"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.2" x="22.8" y="569.8758">alt</text><text fill="#000000" font-family="sans-serif" font-size="6.6" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="129.6" x="60" y="569.3156">[allSettlementWindowsClosed == true]</text><path d="M643.2,576.3211 L742.2,576.3211 L742.2,580.5211 L736.2,586.5211 L643.2,586.5211 L643.2,576.3211 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="584.9028" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="503.4" x="643.2" y="576.3211"/><text fill="#0000FF" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="652.2" y="584.4621">DB TRANSACTION</text><polygon fill="#A80036" points="947.4,596.9074,953.4,599.3074,947.4,601.7074,949.8,599.3074" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="686.4" x2="951" y1="599.3074" y2="599.3074"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="690.6" y="596.6485">6</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="136.8" x="698.4" y="596.6485">Insert the list of settlementWindows</text><polygon fill="#FFFFE0" filter="url(#f1m41q539bnhrr)" points="829.8,607.2938,1078.8,607.2938,1084.8,622.8938,1078.8,639.0938,829.8,639.0938,823.8,622.8938,829.8,607.2938" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="48" x="831" y="617.2348">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118.2" x="881.4" y="617.2348">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="133.8" x="850.2" y="626.4211">(settlementId, settlementWindowId)</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="237" x="840.6" y="635.6074">VALUE(payload.settlementId, payload./settlementWindow/{id});</text><polygon fill="#A80036" points="947.4,652.8528,953.4,655.2528,947.4,657.6528,949.8,655.2528" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="686.4" x2="951" y1="655.2528" y2="655.2528"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="690.6" y="652.5938">7</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="228" x="698.4" y="652.5938">Populate settlementTransferParticipant with aggregated data</text><polygon fill="#FFFFE0" filter="url(#f1m41q539bnhrr)" points="811.2,663.2391,1097.4,663.2391,1103.4,743.6391,1097.4,824.0391,811.2,824.0391,805.2,743.6391,811.2,663.2391" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="48" x="812.4" y="673.1801">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="121.8" x="862.8" y="673.1801">settlementTransferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="254.4" x="822" y="682.3664">(settlementId, participantCurrencyId, transferParticipantRoleTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="153.6" x="822" y="691.5528">ledgerEntryTypeId, amount, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="269.4" x="812.4" y="700.7391">SELECT payload.settlementId AS settlementId, tp.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="206.4" x="822" y="709.9254">tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="208.2" x="822" y="719.1117">SUM(tp.amount) AS amount, CURDATE() AS createdDate</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="21.6" x="812.4" y="728.2981">FROM</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73.2" x="836.4" y="728.2981">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="18" x="912" y="728.2981">AS tf</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="16.8" x="812.4" y="737.4844">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="83.4" x="831.6" y="737.4844">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="23.4" x="917.4" y="737.4844">AS tsc</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="274.2" x="822" y="746.6707">ON tsc.transferId = tf.transferId AND tsc.transferStateId = ‘COMMITTED’</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="16.8" x="812.4" y="755.8571">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="76.2" x="831.6" y="755.8571">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="19.8" x="910.2" y="755.8571">AS tp</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="117" x="822" y="765.0434">ON tp.transferId = tf.transferId</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="113.4" x="812.4" y="774.2297">WHERE tf.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="119.4" x="822" y="783.416">IN (SELECT settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="21.6" x="822" y="792.6024">FROM</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118.2" x="846" y="792.6024">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="168" x="822" y="801.7887">WHERE settlementId = payload.settlementId)</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="259.8" x="822" y="810.975">GROUP BY tp.participantCurrencyId, tp.transferParticipantRoleTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="78" x="831.6" y="820.1614">tp.ledgerEntryTypeId</text><polygon fill="#A80036" points="947.4,837.4067,953.4,839.8067,947.4,842.2067,949.8,839.8067" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="686.4" x2="951" y1="839.8067" y2="839.8067"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="690.6" y="837.1477">8</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="230.4" x="698.4" y="837.1477">Populate settlementParticipantCurrency with aggregated data</text><polygon fill="#FFFFE0" filter="url(#f1m41q539bnhrr)" points="774.6,847.793,1134.6,847.793,1140.6,900.593,1134.6,953.393,774.6,953.393,768.6,900.593,774.6,847.793" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="48" x="775.8" y="857.734">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124.2" x="826.2" y="857.734">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="185.4" x="785.4" y="866.9203">(settlementId, participantCurrencyId, netAmount)</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="165.6" x="775.8" y="876.1067">SELECT settlementId, participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="37.8" x="775.8" y="885.293">SUM(CASE</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="340.8" x="787.8" y="894.4793">WHEN stp.transferParticipantRoleTypeId = 1 AND stp.ledgerEntryTypeId = 1 THEN amount</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="345.6" x="787.8" y="903.6657">WHEN stp.transferParticipantRoleTypeId = 2 AND stp.ledgerEntryTypeId = 1 THEN -amount</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="182.4" x="787.8" y="912.852">WHEN stp.ledgerEntryTypeId = 2 THEN -amount</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="21" x="783" y="922.0383">END )</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="21.6" x="775.8" y="931.2246">FROM</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="121.8" x="799.8" y="931.2246">settlementTransferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="24" x="924" y="931.2246">AS stp</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="165.6" x="775.8" y="940.411">WHERE settlementId = payload.settlementId</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="173.4" x="775.8" y="949.5973">GROUP BY settlementId, participantCurrencyId</text><polygon fill="#A80036" points="947.4,966.8426,953.4,969.2426,947.4,971.6426,949.8,969.2426" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="686.4" x2="951" y1="969.2426" y2="969.2426"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="690.6" y="966.5836">9</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="188.4" x="698.4" y="966.5836">Insert initial state change 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#f1m41q539bnhrr)" points="799.2,977.2289,1110,977.2289,1116,1002.4289,1110,1027.6289,799.2,1027.6289,793.2,1002.4289,799.2,977.2289" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="48" x="800.4" y="987.17">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="175.2" x="850.8" y="987.17">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="226.8" x="810" y="996.3563">(settlementParticipantCurrencyId, settlementStateId, reason)</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="308.4" x="800.4" y="1005.5426">SELECT settlementParticipantCurrencyId, ‘PENDING_SETTLEMENT’, payload.reason</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="21.6" x="800.4" y="1014.7289">FROM</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124.2" x="824.4" y="1014.7289">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="165.6" x="800.4" y="1023.9153">WHERE settlementId = payload.settlementId</text><polygon fill="#A80036" points="947.4,1041.1606,953.4,1043.5606,947.4,1045.9606,949.8,1043.5606" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="686.4" x2="951" y1="1043.5606" y2="1043.5606"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="690.6" y="1040.9016">10</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="214.8" x="703.8" y="1040.9016">Insert initial state for settlement 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#f1m41q539bnhrr)" points="835.8,1051.5469,1072.8,1051.5469,1078.8,1076.7469,1072.8,1101.9469,835.8,1101.9469,829.8,1076.7469,835.8,1051.5469" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="48" x="837" y="1061.4879">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="94.2" x="887.4" y="1061.4879">settlementStateChange</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="153" x="846.6" y="1070.6743">(settlementId, settlementStateId, reason)</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="234.6" x="837" y="1079.8606">SELECT settlementId, ‘PENDING_SETTLEMENT’, payload.reason</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="21.6" x="837" y="1089.0469">FROM</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124.2" x="861" y="1089.0469">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="165.6" x="837" y="1098.2332">WHERE settlementId = payload.settlementId</text><polygon fill="#A80036" points="947.4,1115.4786,953.4,1117.8786,947.4,1120.2786,949.8,1117.8786" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="686.4" x2="951" y1="1117.8786" y2="1117.8786"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="690.6" y="1115.2196">11</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="237.6" x="703.8" y="1115.2196">Insert new state for settlementWindow 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#f1m41q539bnhrr)" points="801,1125.8649,1108.2,1125.8649,1114.2,1141.4649,1108.2,1157.6649,801,1157.6649,795,1141.4649,801,1125.8649" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="48" x="802.2" y="1135.8059">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="126" x="852.6" y="1135.8059">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="211.8" x="811.8" y="1144.9922">(settlementWindowId, settlementWindowStateId, reason)</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="304.8" x="802.2" y="1154.1786">VALUE payload./settlementWindow/{id}, 'PENDING_SETTLEMENT', payload.reason</text><polygon fill="#A80036" points="376.8,1175.6239,370.8,1178.0239,376.8,1180.4239,374.4,1178.0239" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="373.2" x2="679.8" y1="1178.0239" y2="1178.0239"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="380.4" y="1175.3649">12</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="282.6" x="393.6" y="1175.3649">Results for participant netAmount per ledger for closed settlement window</text><path d="M217.2,1186.0102 L217.2,1274.2102 L358.8,1274.2102 L358.8,1192.0102 L352.8,1186.0102 L217.2,1186.0102 " fill="#FFFF00" filter="url(#f1m41q539bnhrr)" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><path d="M352.8,1186.0102 L352.8,1192.0102 L358.8,1192.0102 L352.8,1186.0102 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="220.8" y="1196.5512">{</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="48.6" x="225.6" y="1205.7375">"id": "string",</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="66.6" x="225.6" y="1214.9239">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="124.2" x="225.6" y="1224.1102">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="95.4" x="225.6" y="1233.2965">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="46.8" x="230.4" y="1242.4829">"amount": 0,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="71.4" x="230.4" y="1251.6692">"currency": "string"</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="225.6" y="1260.8555">}</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="220.8" y="1270.0418">}</text><polygon fill="#A80036" points="60.6,1290.2872,54.6,1292.6872,60.6,1295.0872,58.2,1292.6872" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="57" x2="366.6" y1="1292.6872" y2="1292.6872"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="64.2" y="1290.0282">13</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="282.6" x="77.4" y="1290.0282">Results for participant netAmount per ledger for closed settlement window</text><line style="stroke: #000000; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="13.8" x2="1152.6" y1="1298.2735" y2="1298.2735"/><text fill="#000000" font-family="sans-serif" font-size="6.6" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="132.6" x="16.8" y="1304.6543">[allSettlementWindowsClosed == false]</text><polygon fill="#A80036" points="376.8,1316.8465,370.8,1319.2465,376.8,1321.6465,374.4,1319.2465" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="373.2" x2="682.8" y1="1319.2465" y2="1319.2465"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="380.4" y="1316.5876">14</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="177" x="393.6" y="1316.5876">settlementWindows not closed - Return ERROR</text><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="370.2" x2="395.4" y1="1337.0192" y2="1337.0192"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="395.4" x2="395.4" y1="1337.0192" y2="1344.8192"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="370.8" x2="395.4" y1="1344.8192" y2="1344.8192"/><polygon fill="#A80036" points="376.8,1342.4192,370.8,1344.8192,376.8,1347.2192,374.4,1344.8192" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="374.4" y="1334.1739">15</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="63.6" x="387.6" y="1334.1739">Update Event log</text><path d="M373.2,1352.6192 L373.2,1376.6192 L497.4,1376.6192 L497.4,1358.6192 L491.4,1352.6192 L373.2,1352.6192 " fill="#ADD8E6" filter="url(#f1m41q539bnhrr)" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><path d="M491.4,1352.6192 L491.4,1358.6192 L497.4,1358.6192 L491.4,1352.6192 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="82.2" x="376.8" y="1363.1602">Log ERROR Messages.</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="111.6" x="376.8" y="1372.3465">Update Event log with ERROR.</text><path d="M60,1385.3919 L60,1436.9919 L358.8,1436.9919 L358.8,1391.3919 L352.8,1385.3919 L60,1385.3919 " fill="#FFFF00" filter="url(#f1m41q539bnhrr)" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><path d="M352.8,1385.3919 L352.8,1391.3919 L358.8,1391.3919 L352.8,1385.3919 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="63.6" y="1395.9329">{</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="41.4" x="68.4" y="1405.1192">"status": 0,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="281.4" x="68.4" y="1414.3055">"code": "(ERROR response code eg. '404' - Defined in swagger definition))",</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="72" x="68.4" y="1423.4919">"message": "string"</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="63.6" y="1432.6782">}</text><polygon fill="#A80036" points="60.6,1452.9235,54.6,1455.3235,60.6,1457.7235,58.2,1455.3235" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="57" x2="366.6" y1="1455.3235" y2="1455.3235"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="64.2" y="1452.6645">16</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="51.6" x="77.4" y="1452.6645">Return ERROR</text><!--
@startuml
title Trigger the creation of a settlement event

autonumber

actor "Hub Employee" as OPERATOR

boundary "Settlement Service API" as SSAPI
entity "Settlement DAO" as SETTLE_DAO

database "Central Store" as DB

box "Central HUB" #LightPink
    participant OPERATOR
end box

box "Settlement Service" #LightGreen
    participant SSAPI
    participant SETTLE_DAO
end box

box "Central Services" #LightYellow
    participant DB
end box

group Trigger Settlement Event
activate OPERATOR
    note right of OPERATOR #Yellow
        {
          "settlementId": 0,
          "reason": "string",
          "settlementWindows": [
            {
              "id": 1,
            },
            {
              "id": 2,
            }
          ]
        }
    end note
    note right of OPERATOR #LightGray
        verify if we need the rest of the Swagger messages?
    end note
    OPERATOR -> SSAPI: POST - /settlement/{id}
    activate SSAPI
    SSAPI-> SETTLE_DAO: Create new settlement
    activate SETTLE_DAO
    SETTLE_DAO -> DB: Insert new settlement\n<color #FF0000><b>Error code:</b> 2001</color>
    activate DB
    hnote over DB #LightYellow
        INSERT INTO **settlement**
            (reason)
            VALUE (payload./settlementId/{reason});
    end hnote
    deactivate DB
    SETTLE_DAO -> DB: Get settlementWindow(s)\n<color #FF0000><b>Error code:</b> 2001</color>
    activate DB
    hnote over DB #LightYellow
        SELECT MAX(settlementWindowStateChangeId), settlementWindowStateId, reason
        FROM  **settlementWindowStateChange**
        WHERE settlementWindowId = payload./settlementWindow/{id}
        GROUP BY settlementWindowStateId,settlementWindowId, reason;
    end hnote
    deactivate DB

    group Validate the list of settlement windows
        note right of SETTLE_DAO #LightGray
            allSettlementWindowsClosed = true
        end note
        loop
            SETTLE_DAO <- -> SETTLE_DAO: if settlementWindowStateId != 'CLOSED' \nthen allSettlementWindowsClosed = false
        end loop
    end

    alt allSettlementWindowsClosed == true
        group <color #blue>DB TRANSACTION</color>
            SETTLE_DAO -> DB: Insert the list of settlementWindows
            hnote over DB #LightYellow
                INSERT INTO **settlementSettlementWindow**
                	(settlementId, settlementWindowId)
                    VALUE(payload.settlementId, payload./settlementWindow/{id});
            end hnote
            SETTLE_DAO -> DB: Populate settlementTransferParticipant with aggregated data
            hnote over DB #LightYellow
                INSERT INTO **settlementTransferParticipant**
                    (settlementId, participantCurrencyId, transferParticipantRoleTypeId,
                    ledgerEntryTypeId, amount, createdDate)
                SELECT payload.settlementId AS settlementId, tp.participantCurrencyId,
                    tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId,
                    SUM(tp.amount) AS amount, CURDATE() AS createdDate
                FROM **transferFulfilment** AS tf
                JOIN **transferStateChange** AS tsc
                    ON tsc.transferId = tf.transferId AND tsc.transferStateId = ‘COMMITTED’
                JOIN **transferParticipant** AS tp
                    ON tp.transferId = tf.transferId
                WHERE tf.settlementWindowId
                    IN (SELECT settlementWindowId
                    FROM **settlementSettlementWindow**
                    WHERE settlementId = payload.settlementId)
                    GROUP BY tp.participantCurrencyId, tp.transferParticipantRoleTypeId,
                        tp.ledgerEntryTypeId
            end hnote
            SETTLE_DAO -> DB: Populate settlementParticipantCurrency with aggregated data
            hnote over DB #LightYellow
                INSERT INTO **settlementParticipantCurrency**
                    (settlementId, participantCurrencyId, netAmount)
                SELECT settlementId, participantCurrencyId,
                SUM(CASE
                     WHEN stp.transferParticipantRoleTypeId = 1 AND stp.ledgerEntryTypeId = 1 THEN amount
                     WHEN stp.transferParticipantRoleTypeId = 2 AND stp.ledgerEntryTypeId = 1 THEN -amount
                     WHEN stp.ledgerEntryTypeId = 2 THEN -amount
                   END )
                FROM **settlementTransferParticipant** AS stp
                WHERE settlementId = payload.settlementId
                GROUP BY settlementId, participantCurrencyId
            end hnote
            SETTLE_DAO -> DB: Insert initial state change 'PENDING_SETTLEMENT'
            hnote over DB #LightYellow
                INSERT INTO **settlementParticipantCurrencyStateChange**
                    (settlementParticipantCurrencyId, settlementStateId, reason)
                SELECT settlementParticipantCurrencyId, ‘PENDING_SETTLEMENT’, payload.reason
                FROM **settlementParticipantCurrency**
                WHERE settlementId = payload.settlementId
            end hnote
            SETTLE_DAO -> DB: Insert initial state for settlement 'PENDING_SETTLEMENT'
            hnote over DB #LightYellow
                INSERT INTO **settlementStateChange**
                    (settlementId, settlementStateId, reason)
                SELECT settlementId, ‘PENDING_SETTLEMENT’, payload.reason
                FROM **settlementParticipantCurrency**
                WHERE settlementId = payload.settlementId
            end hnote
            SETTLE_DAO -> DB: Insert new state for settlementWindow 'PENDING_SETTLEMENT'
            hnote over DB #LightYellow
                INSERT INTO **settlementWindowStateChange**
                    (settlementWindowId, settlementWindowStateId, reason)
                VALUE payload./settlementWindow/{id}, 'PENDING_SETTLEMENT', payload.reason
            end hnote
        end
        SSAPI <- - SETTLE_DAO: Results for participant netAmount per ledger for closed settlement window
        note left of SSAPI #Yellow
            {
              "id": "string",
              "reason": "string",
              "state": "PENDING_SETTLEMENT",
              "netSettlementAmount": {
                "amount": 0,
                "currency": "string"
              }
            }
        end note
        OPERATOR <- - SSAPI: Results for participant netAmount per ledger for closed settlement window
        deactivate SSAPI
    else allSettlementWindowsClosed == false
        SETTLE_DAO - -> SSAPI: settlementWindows not closed - Return ERROR
        deactivate SETTLE_DAO
        activate SSAPI
        SSAPI <- -> SSAPI: Update Event log
        note right of SSAPI #LightBlue
            Log ERROR Messages.
            Update Event log with ERROR.
            end note
        note left of SSAPI #Yellow
            {
              "status": 0,
              "code": "(ERROR response code eg. '404' - Defined in swagger definition))",
              "message": "string"
            }
        end note
        OPERATOR <- - SSAPI: Return ERROR
        deactivate SSAPI
    end
deactivate OPERATOR
end
@enduml

PlantUML version 1.2018.01(Sun Jan 28 20:08:22 SAST 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_152-release-1136-b29
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: ZA
--></g></svg>