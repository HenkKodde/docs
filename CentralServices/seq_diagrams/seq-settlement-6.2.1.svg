<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2444px" preserveAspectRatio="none" style="width:2416px;height:2444px;" version="1.1" viewBox="0 0 2416 2444" width="2416px" zoomAndPan="magnify"><defs><filter height="300%" id="f1fuw5yypbh0y4" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="420" x="999" y="23.5352">6.2.1. postSettlementEvent POST: /settlementEventTrigger</text><rect fill="#FFB6C1" height="2398.7441" style="stroke: #A80036; stroke-width: 1.0;" width="112" x="29" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="44.5" y="47.0566">Central HUB</text><rect fill="#90EE90" height="2398.7441" style="stroke: #A80036; stroke-width: 1.0;" width="1142.5" x="524.5" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="1033.75" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="2398.7441" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="2001" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="2004" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#f1fuw5yypbh0y4)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="602" y="455.2559"/><rect fill="#FFFFFF" filter="url(#f1fuw5yypbh0y4)" height="226.7949" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="602" y="1838.2227"/><rect fill="#FFFFFF" filter="url(#f1fuw5yypbh0y4)" height="191.1055" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="602" y="2130.6387"/><rect fill="#FFFFFF" filter="url(#f1fuw5yypbh0y4)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1079" y="484.5664"/><rect fill="#FFFFFF" filter="url(#f1fuw5yypbh0y4)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1079" y="1808.9121"/><rect fill="#FFFFFF" filter="url(#f1fuw5yypbh0y4)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1079" y="2101.3281"/><rect fill="#FFFFFF" filter="url(#f1fuw5yypbh0y4)" height="1587.4512" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1601" y="513.877"/><rect fill="#FFFFFF" filter="url(#f1fuw5yypbh0y4)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2053" y="558.498"/><rect fill="#FFFFFF" filter="url(#f1fuw5yypbh0y4)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2053" y="666.4297"/><rect fill="#FFFFFF" filter="url(#f1fuw5yypbh0y4)" height="2175.457" style="stroke: #000000; stroke-width: 2.0;" width="2392" x="13" y="154.2871"/><rect fill="#FFFFFF" filter="url(#f1fuw5yypbh0y4)" height="145.5527" style="stroke: #000000; stroke-width: 2.0;" width="385" x="1529" y="760.0508"/><rect fill="#FFFFFF" filter="url(#f1fuw5yypbh0y4)" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="365" x="1539" y="823.6719"/><rect fill="#FFFFFF" filter="url(#f1fuw5yypbh0y4)" height="1153.4141" style="stroke: #000000; stroke-width: 2.0;" width="2372" x="23" y="919.6035"/><rect fill="#FFFFFF" filter="url(#f1fuw5yypbh0y4)" height="821.7324" style="stroke: #000000; stroke-width: 2.0;" width="846" x="1539" y="943.9141"/><rect fill="#FFFFFF" height="300.3711" style="stroke: none; stroke-width: 1.0;" width="2372" x="23" y="1772.6465"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="85" x2="85" y1="137.2871" y2="2346.7441"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="606.5" x2="606.5" y1="137.2871" y2="2346.7441"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1083.5" x2="1083.5" y1="137.2871" y2="2346.7441"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1606" x2="1606" y1="137.2871" y2="2346.7441"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="2058" x2="2058" y1="137.2871" y2="2346.7441"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="33" y="134.334">Hub Employee</text><ellipse cx="85" cy="63.7988" fill="#FEFECE" filter="url(#f1fuw5yypbh0y4)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M85,71.7988 L85,98.7988 M72,79.7988 L98,79.7988 M85,98.7988 L72,113.7988 M85,98.7988 L98,113.7988 " fill="none" filter="url(#f1fuw5yypbh0y4)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="33" y="2359.2793">Hub Employee</text><ellipse cx="85" cy="2372.2324" fill="#FEFECE" filter="url(#f1fuw5yypbh0y4)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M85,2380.2324 L85,2407.2324 M72,2388.2324 L98,2388.2324 M85,2407.2324 L72,2422.2324 M85,2407.2324 L98,2422.2324 " fill="none" filter="url(#f1fuw5yypbh0y4)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="528.5" y="134.334">Settlement Service API</text><path d="M586.5,92.7988 L586.5,116.7988 M586.5,104.7988 L603.5,104.7988 " fill="none" filter="url(#f1fuw5yypbh0y4)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="615.5" cy="104.7988" fill="#FEFECE" filter="url(#f1fuw5yypbh0y4)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="528.5" y="2359.2793">Settlement Service API</text><path d="M586.5,2366.2324 L586.5,2390.2324 M586.5,2378.2324 L603.5,2378.2324 " fill="none" filter="url(#f1fuw5yypbh0y4)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="615.5" cy="2378.2324" fill="#FEFECE" filter="url(#f1fuw5yypbh0y4)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="73" x="1044.5" y="134.334">Settlement</text><ellipse cx="1084" cy="104.7988" fill="#FEFECE" filter="url(#f1fuw5yypbh0y4)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="1080,92.7988,1086,87.7988,1084,92.7988,1086,97.7988,1080,92.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="73" x="1044.5" y="2359.2793">Settlement</text><ellipse cx="1084" cy="2378.2324" fill="#FEFECE" filter="url(#f1fuw5yypbh0y4)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="1080,2366.2324,1086,2361.2324,1084,2366.2324,1086,2371.2324,1080,2366.2324" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="1549" y="134.334">Settlement DAO</text><ellipse cx="1606" cy="104.7988" fill="#FEFECE" filter="url(#f1fuw5yypbh0y4)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1594" x2="1618" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="1549" y="2359.2793">Settlement DAO</text><ellipse cx="1606" cy="2378.2324" fill="#FEFECE" filter="url(#f1fuw5yypbh0y4)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1594" x2="1618" y1="2392.2324" y2="2392.2324"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="2010" y="134.334">Central Store</text><path d="M2040,84.7988 C2040,74.7988 2058,74.7988 2058,74.7988 C2058,74.7988 2076,74.7988 2076,84.7988 L2076,110.7988 C2076,120.7988 2058,120.7988 2058,120.7988 C2058,120.7988 2040,120.7988 2040,110.7988 L2040,84.7988 " fill="#FEFECE" filter="url(#f1fuw5yypbh0y4)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M2040,84.7988 C2040,94.7988 2058,94.7988 2058,94.7988 C2058,94.7988 2076,94.7988 2076,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="2010" y="2359.2793">Central Store</text><path d="M2040,2372.2324 C2040,2362.2324 2058,2362.2324 2058,2362.2324 C2058,2362.2324 2076,2362.2324 2076,2372.2324 L2076,2398.2324 C2076,2408.2324 2058,2408.2324 2058,2408.2324 C2058,2408.2324 2040,2408.2324 2040,2398.2324 L2040,2372.2324 " fill="#FEFECE" filter="url(#f1fuw5yypbh0y4)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M2040,2372.2324 C2040,2382.2324 2058,2382.2324 2058,2382.2324 C2058,2382.2324 2076,2382.2324 2076,2372.2324 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1fuw5yypbh0y4)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="602" y="455.2559"/><rect fill="#FFFFFF" filter="url(#f1fuw5yypbh0y4)" height="226.7949" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="602" y="1838.2227"/><rect fill="#FFFFFF" filter="url(#f1fuw5yypbh0y4)" height="191.1055" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="602" y="2130.6387"/><rect fill="#FFFFFF" filter="url(#f1fuw5yypbh0y4)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1079" y="484.5664"/><rect fill="#FFFFFF" filter="url(#f1fuw5yypbh0y4)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1079" y="1808.9121"/><rect fill="#FFFFFF" filter="url(#f1fuw5yypbh0y4)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1079" y="2101.3281"/><rect fill="#FFFFFF" filter="url(#f1fuw5yypbh0y4)" height="1587.4512" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1601" y="513.877"/><rect fill="#FFFFFF" filter="url(#f1fuw5yypbh0y4)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2053" y="558.498"/><rect fill="#FFFFFF" filter="url(#f1fuw5yypbh0y4)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2053" y="666.4297"/><path d="M13,154.2871 L227,154.2871 L227,161.2871 L217,171.2871 L13,171.2871 L13,154.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2175.457" style="stroke: #000000; stroke-width: 2.0;" width="2392" x="13" y="154.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="169" x="28" y="167.8555">Trigger Settlement Event</text><path d="M90,176.5977 L90,385.5977 L264,385.5977 L264,186.5977 L254,176.5977 L90,176.5977 " fill="#FFFF00" filter="url(#f1fuw5yypbh0y4)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M254,176.5977 L254,186.5977 L264,186.5977 L254,176.5977 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="96" y="194.166">settlementEventPayload</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="96" y="209.4766">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="104" y="224.7871">"settlementId": 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="104" y="240.0977">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="104" y="255.4082">"settlementWindows": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="112" y="270.7188">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="120" y="286.0293">"id": 1,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="112" y="301.3398">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="112" y="316.6504">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="120" y="331.9609">"id": 2,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="112" y="347.2715">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="104" y="362.582">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="96" y="377.8926">}</text><path d="M90,399.6348 L90,424.6348 L434,424.6348 L434,409.6348 L424,399.6348 L90,399.6348 " fill="#D3D3D3" filter="url(#f1fuw5yypbh0y4)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M424,399.6348 L424,409.6348 L434,409.6348 L424,399.6348 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="323" x="96" y="417.2031">verify if we need the rest of the Swagger messages?</text><polygon fill="#A80036" points="590,451.2559,600,455.2559,590,459.2559,594,455.2559" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="85" x2="596" y1="455.2559" y2="455.2559"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="92" y="450.5137">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="353" x="105" y="450.5137">API call Settlement Service to request a settlement event</text><polygon fill="#A80036" points="1067,480.5664,1077,484.5664,1067,488.5664,1071,484.5664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="607" x2="1073" y1="484.5664" y2="484.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="614" y="479.8242">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="627" y="479.8242">Create new settlement</text><polygon fill="#A80036" points="1589,509.877,1599,513.877,1589,517.877,1593,513.877" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1084" x2="1595" y1="513.877" y2="513.877"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1091" y="509.1348">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="1104" y="509.1348">Initiate new settlement</text><polygon fill="#A80036" points="2041,554.498,2051,558.498,2041,562.498,2045,558.498" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1611" x2="2047" y1="558.498" y2="558.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1618" y="546.1006">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="1631" y="538.4453">Insert new settlement</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="1631" y="553.7559">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="1708" y="553.7559">2001</text><polygon fill="#FFFFE0" filter="url(#f1fuw5yypbh0y4)" points="2022,601.498,2093,601.498,2103,612.498,2093,624.498,2022,624.498,2012,612.498,2022,601.498" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="67" x="2024" y="618.0664">settlement</text><polygon fill="#A80036" points="2041,662.4297,2051,666.4297,2041,670.4297,2045,666.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1611" x2="2047" y1="666.4297" y2="666.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1618" y="654.0322">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="1631" y="646.377">Get settlementWindow(s) from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="1631" y="661.6875">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="1708" y="661.6875">2001</text><polygon fill="#FFFFE0" filter="url(#f1fuw5yypbh0y4)" points="1959,709.4297,2157,709.4297,2167,728.4297,2157,747.4297,1959,747.4297,1949,728.4297,1959,709.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1961" y="725.998">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1961" y="741.3086">settlementWindowStateChange</text><path d="M1529,760.0508 L1835,760.0508 L1835,767.0508 L1825,777.0508 L1529,777.0508 L1529,760.0508 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="145.5527" style="stroke: #000000; stroke-width: 2.0;" width="385" x="1529" y="760.0508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="261" x="1544" y="773.6191">Validate the list of settlement windows</text><path d="M1616,782.3613 L1616,807.3613 L1861,807.3613 L1861,792.3613 L1851,782.3613 L1616,782.3613 " fill="#D3D3D3" filter="url(#f1fuw5yypbh0y4)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1851,782.3613 L1851,792.3613 L1861,792.3613 L1851,782.3613 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="224" x="1622" y="799.9297">allSettlementWindowsClosed = true</text><path d="M1539,823.6719 L1613,823.6719 L1613,830.6719 L1603,840.6719 L1539,840.6719 L1539,823.6719 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="365" x="1539" y="823.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="1554" y="837.2402">loop</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1611" x2="1653" y1="877.6035" y2="877.6035"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1653" x2="1653" y1="877.6035" y2="890.6035"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1612" x2="1653" y1="890.6035" y2="890.6035"/><polygon fill="#A80036" points="1622,886.6035,1612,890.6035,1622,894.6035,1618,890.6035" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1618" y="865.2061">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="1631" y="857.5508">if settlementWindowStateId != 'CLOSED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="261" x="1631" y="872.8613">then allSettlementWindowsClosed = false</text><path d="M23,919.6035 L85,919.6035 L85,926.6035 L75,936.6035 L23,936.6035 L23,919.6035 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1153.4141" style="stroke: #000000; stroke-width: 2.0;" width="2372" x="23" y="919.6035"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="38" y="933.1719">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="216" x="100" y="932.2383">[allSettlementWindowsClosed == true]</text><path d="M1539,943.9141 L1704,943.9141 L1704,950.9141 L1694,960.9141 L1539,960.9141 L1539,943.9141 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="821.7324" style="stroke: #000000; stroke-width: 2.0;" width="846" x="1539" y="943.9141"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="1554" y="957.4824">DB TRANSACTION</text><polygon fill="#A80036" points="2046,978.5352,2056,982.5352,2046,986.5352,2050,982.5352" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1611" x2="2052" y1="982.5352" y2="982.5352"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1618" y="977.793">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="1631" y="977.793">Insert the list of settlementWindows</text><polygon fill="#FFFFE0" filter="url(#f1fuw5yypbh0y4)" points="1964,995.5352,2151,995.5352,2161,1006.5352,2151,1018.5352,1964,1018.5352,1954,1006.5352,1964,995.5352" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="1966" y="1012.1035">settlementSettlementWindow</text><polygon fill="#A80036" points="2046,1041.1563,2056,1045.1563,2046,1049.1563,2050,1045.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1611" x2="2052" y1="1045.1563" y2="1045.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1618" y="1040.4141">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="380" x="1631" y="1040.4141">Populate settlementTransferParticipant with aggregated data</text><polygon fill="#FFFFE0" filter="url(#f1fuw5yypbh0y4)" points="1750,1058.1563,2365,1058.1563,2375,1161.1563,2365,1265.1563,1750,1265.1563,1740,1161.1563,1750,1058.1563" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1752" y="1074.7246">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="203" x="1836" y="1074.7246">settlementTransferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="611" x="1752" y="1090.0352">SELECT payload.settlementId AS settlementId, tp.participantCurrencyId, tp.participantRoleTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="1768" y="1105.3457">tp.ledgerEntryTypeId, SUM(tp.amount) AS amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1752" y="1120.6563">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="1792" y="1120.6563">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="30" x="1918" y="1120.6563">AS tf</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1752" y="1135.9668">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1784" y="1135.9668">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="1927" y="1135.9668">AS tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="447" x="1752" y="1151.2773">ON tsc.transferId = tf.transferId AND tsc.transferStateId = 'COMMITED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1752" y="1166.5879">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1784" y="1166.5879">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="33" x="1915" y="1166.5879">AS tp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="1752" y="1181.8984">ON tp.transferId = tf.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="215" x="1752" y="1197.209">WHERE tf.settlementWindowId IN (</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="1768" y="1212.5195">SELECT settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1768" y="1227.8301">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="205" x="1808" y="1227.8301">settlementSettelementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="1768" y="1243.1406">WHERE settlementId = payload.settlementId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="519" x="1752" y="1258.4512">GROUP BY tp.participantCurrencyId, tp.participantRoleTypeId, tp.ledgerEntryTypeId</text><polygon fill="#A80036" points="2046,1287.5039,2056,1291.5039,2046,1295.5039,2050,1291.5039" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1611" x2="2052" y1="1291.5039" y2="1291.5039"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1618" y="1286.7617">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="262" x="1631" y="1286.7617">Insert netAmount per participantCurrency</text><polygon fill="#FFFFE0" filter="url(#f1fuw5yypbh0y4)" points="1844,1304.5039,2271,1304.5039,2281,1369.5039,2271,1434.5039,1844,1434.5039,1834,1369.5039,1844,1304.5039" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1846" y="1321.0723">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="1930" y="1321.0723">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="1846" y="1336.3828">SELECT settlementId, participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="407" x="1862" y="1351.6934">SUM(CASE WHEN 'PAYER_DFSP', 'PRINCIPLE_VALUE' THEN amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="347" x="1898" y="1367.0039">WHEN 'PAYEE_DFSP', 'PRINCIPLE_VALUE' THEN -amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="1898" y="1382.3145">WHEN 'INTERCHANGE_FEE' THEN -amount)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="1846" y="1397.625">FROM settlementTransferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="1846" y="1412.9355">WHERE settlementId = payload.settlementId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="1846" y="1428.2461">GROUP BY settlementId, participantCurrencyId</text><polygon fill="#A80036" points="2046,1457.2988,2056,1461.2988,2046,1465.2988,2050,1461.2988" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1611" x2="2052" y1="1461.2988" y2="1461.2988"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1618" y="1456.5566">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="314" x="1640" y="1456.5566">Insert initial state change 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#f1fuw5yypbh0y4)" points="1800,1474.2988,2316,1474.2988,2326,1508.2988,2316,1543.2988,1800,1543.2988,1790,1508.2988,1800,1474.2988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1802" y="1490.8672">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="1886" y="1490.8672">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="512" x="1802" y="1506.1777">SELECT settlementParticipantCurrencyId, 'PENDING_SETTLEMENT', payload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="1802" y="1521.4883">FROM settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="1802" y="1536.7988">WHERE settlementId = payload.settlementId</text><polygon fill="#A80036" points="2046,1565.8516,2056,1569.8516,2046,1573.8516,2050,1569.8516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1611" x2="2052" y1="1569.8516" y2="1569.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1618" y="1565.1094">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="1640" y="1565.1094">Insert initial state for settlement 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#f1fuw5yypbh0y4)" points="1861,1582.8516,2254,1582.8516,2264,1616.8516,2254,1651.8516,1861,1651.8516,1851,1616.8516,1861,1582.8516" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1863" y="1599.4199">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="157" x="1947" y="1599.4199">settlementStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="389" x="1863" y="1614.7305">SELECT settlementId, 'PENDING_SETTLEMENT', payload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="1863" y="1630.041">FROM settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="1863" y="1645.3516">WHERE settlementId = payload.settlementId</text><polygon fill="#A80036" points="2046,1674.4043,2056,1678.4043,2046,1682.4043,2050,1678.4043" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1611" x2="2052" y1="1678.4043" y2="1678.4043"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1618" y="1673.6621">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="396" x="1640" y="1673.6621">Insert new state for settlementWindow 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#f1fuw5yypbh0y4)" points="1861,1691.4043,2254,1691.4043,2264,1725.4043,2254,1760.4043,1861,1760.4043,1851,1725.4043,1861,1691.4043" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1863" y="1707.9727">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="1947" y="1707.9727">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="389" x="1863" y="1723.2832">SELECT settlementId, 'PENDING_SETTLEMENT', payload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="1863" y="1738.5938">FROM settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="1863" y="1753.9043">WHERE settlementId = payload.settlementId</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="2395" y1="1773.6465" y2="1773.6465"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="221" x="28" y="1784.2813">[allSettlementWindowsClosed == false]</text><polygon fill="#A80036" points="1100,1804.9121,1090,1808.9121,1100,1812.9121,1096,1808.9121" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1094" x2="1600" y1="1808.9121" y2="1808.9121"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1106" y="1804.1699">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="295" x="1128" y="1804.1699">settlementWindows not closed - Return ERROR</text><polygon fill="#A80036" points="623,1834.2227,613,1838.2227,623,1842.2227,619,1838.2227" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="617" x2="1083" y1="1838.2227" y2="1838.2227"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="629" y="1833.4805">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="86" x="651" y="1833.4805">Return ERROR</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="612" x2="654" y1="1867.5332" y2="1867.5332"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="654" x2="654" y1="1867.5332" y2="1880.5332"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="613" x2="654" y1="1880.5332" y2="1880.5332"/><polygon fill="#A80036" points="623,1876.5332,613,1880.5332,623,1884.5332,619,1880.5332" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="619" y="1862.791">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="641" y="1862.791">Update Event log</text><path d="M617,1893.5332 L617,1933.5332 L824,1933.5332 L824,1903.5332 L814,1893.5332 L617,1893.5332 " fill="#ADD8E6" filter="url(#f1fuw5yypbh0y4)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M814,1893.5332 L814,1903.5332 L824,1903.5332 L814,1893.5332 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="623" y="1911.1016">Log ERROR Messages.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="186" x="623" y="1926.4121">Update Event log with ERROR.</text><path d="M95,1948.1543 L95,2034.1543 L593,2034.1543 L593,1958.1543 L583,1948.1543 L95,1948.1543 " fill="#FFFF00" filter="url(#f1fuw5yypbh0y4)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M583,1948.1543 L583,1958.1543 L593,1958.1543 L583,1948.1543 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="101" y="1965.7227">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="69" x="109" y="1981.0332">"status": 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="469" x="109" y="1996.3438">"code": "(ERROR response code eg. '404' - Defined in swagger definition))",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="109" y="2011.6543">"message": "string"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="101" y="2026.9648">}</text><polygon fill="#A80036" points="96,2061.0176,86,2065.0176,96,2069.0176,92,2065.0176" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="90" x2="606" y1="2065.0176" y2="2065.0176"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="102" y="2060.2754">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="86" x="124" y="2060.2754">Return ERROR</text><polygon fill="#A80036" points="1100,2097.3281,1090,2101.3281,1100,2105.3281,1096,2101.3281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1094" x2="1605" y1="2101.3281" y2="2101.3281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1106" y="2096.5859">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="471" x="1128" y="2096.5859">Results for participant netAmount per ledger for closed settlement window</text><polygon fill="#A80036" points="623,2126.6387,613,2130.6387,623,2134.6387,619,2130.6387" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="617" x2="1083" y1="2130.6387" y2="2130.6387"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="629" y="2125.8965">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="426" x="651" y="2125.8965">Results for participant netAmount per ledger for settlement window</text><path d="M357,2143.6387 L357,2290.6387 L593,2290.6387 L593,2153.6387 L583,2143.6387 L357,2143.6387 " fill="#FFFF00" filter="url(#f1fuw5yypbh0y4)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M583,2143.6387 L583,2153.6387 L593,2153.6387 L583,2143.6387 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="363" y="2161.207">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="81" x="371" y="2176.5176">"id": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="371" y="2191.8281">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="371" y="2207.1387">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="371" y="2222.4492">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="379" y="2237.7598">"amount": 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="379" y="2253.0703">"currency": "string"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="371" y="2268.3809">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="363" y="2283.6914">}</text><polygon fill="#A80036" points="96,2317.7441,86,2321.7441,96,2325.7441,92,2321.7441" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="90" x2="606" y1="2321.7441" y2="2321.7441"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="102" y="2317.002">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="471" x="124" y="2317.002">Results for participant netAmount per ledger for closed settlement window</text><!--
@startuml
title 6.2.1. postSettlementEvent POST: /settlementEventTrigger

autonumber



actor "Hub Employee" as OPERATOR

boundary "Settlement Service API" as SSAPI
control "Settlement" as SETTLEMENT
entity "Settlement DAO" as SETTLE_DAO

database "Central Store" as DB

box "Central HUB" #LightPink
    participant OPERATOR
end box

box "Settlement Service" #LightGreen
    participant SSAPI
    participant SETTLEMENT
    participant SETTLE_DAO
end box

box "Central Services" #LightYellow
    participant DB
end box


group Trigger Settlement Event
    note right of OPERATOR #Yellow
        settlementEventPayload
        {
          "settlementId": 0,
          "reason": "string",
          "settlementWindows": [
            {
              "id": 1,
            },
            {
              "id": 2,
            }
          ]
        }
    end note
    note right of OPERATOR #LightGray
        verify if we need the rest of the Swagger messages?
    end note
    OPERATOR -> SSAPI: API call Settlement Service to request a settlement event
    activate SSAPI
    SSAPI-> SETTLEMENT: Create new settlement
    deactivate SSAPI
    activate SETTLEMENT
    SETTLEMENT -> SETTLE_DAO: Initiate new settlement
    deactivate SETTLEMENT
    activate SETTLE_DAO

    SETTLE_DAO -> DB: Insert new settlement \n<color #FF0000><b>Error code:</b> 2001</color>
    activate DB
    hnote over DB #LightYellow
        settlement
    end hnote
    deactivate DB
    deactivate SETTLEMENT
    SETTLE_DAO -> DB: Get settlementWindow(s) from DB \n<color #FF0000><b>Error code:</b> 2001</color>
    activate DB
    hnote over DB #LightYellow
        settlementWindow
        settlementWindowStateChange
    end hnote
    deactivate DB
    group Validate the list of settlement windows
        note right of SETTLE_DAO #LightGray
            allSettlementWindowsClosed = true
        end note
        loop
            SETTLE_DAO <-> SETTLE_DAO: if settlementWindowStateId != 'CLOSED' \nthen allSettlementWindowsClosed = false
        end loop
    end
    alt allSettlementWindowsClosed == true
        group <color #blue>DB TRANSACTION</color>
            SETTLE_DAO -> DB: Insert the list of settlementWindows
            hnote over DB #LightYellow
                settlementSettlementWindow
            end hnote
            SETTLE_DAO -> DB: Populate settlementTransferParticipant with aggregated data
            hnote over DB #LightYellow
                INSERT INTO **settlementTransferParticipant**
                SELECT payload.settlementId AS settlementId, tp.participantCurrencyId, tp.participantRoleTypeId,
                    tp.ledgerEntryTypeId, SUM(tp.amount) AS amount
                FROM **transferFulfilment** AS tf
                JOIN **transferStateChange** AS tsc
                ON tsc.transferId = tf.transferId AND tsc.transferStateId = 'COMMITED'
                JOIN **transferParticipant** AS tp
                ON tp.transferId = tf.transferId
                WHERE tf.settlementWindowId IN (
                    SELECT settlementWindowId
                    FROM **settlementSettelementWindow**
                    WHERE settlementId = payload.settlementId)
                GROUP BY tp.participantCurrencyId, tp.participantRoleTypeId, tp.ledgerEntryTypeId
            end hnote

            SETTLE_DAO -> DB: Insert netAmount per participantCurrency
            hnote over DB #LightYellow
                INSERT INTO **settlementParticipantCurrency**
                SELECT settlementId, participantCurrencyId,
                    SUM(CASE WHEN 'PAYER_DFSP', 'PRINCIPLE_VALUE' THEN amount
                             WHEN 'PAYEE_DFSP', 'PRINCIPLE_VALUE' THEN -amount
                             WHEN 'INTERCHANGE_FEE' THEN -amount)
                FROM settlementTransferParticipant
                WHERE settlementId = payload.settlementId
                GROUP BY settlementId, participantCurrencyId
            end hnote

            SETTLE_DAO -> DB: Insert initial state change 'PENDING_SETTLEMENT'
            hnote over DB #LightYellow
                INSERT INTO **settlementParticipantCurrencyStateChange**
                SELECT settlementParticipantCurrencyId, 'PENDING_SETTLEMENT', payload.reason
                FROM settlementParticipantCurrency
                WHERE settlementId = payload.settlementId
            end hnote

            SETTLE_DAO -> DB: Insert initial state for settlement 'PENDING_SETTLEMENT'
            hnote over DB #LightYellow
                INSERT INTO **settlementStateChange**
                SELECT settlementId, 'PENDING_SETTLEMENT', payload.reason
                FROM settlementParticipantCurrency
                WHERE settlementId = payload.settlementId
            end hnote

            SETTLE_DAO -> DB: Insert new state for settlementWindow 'PENDING_SETTLEMENT'
            hnote over DB #LightYellow
                INSERT INTO **settlementWindowStateChange**
                SELECT settlementId, 'PENDING_SETTLEMENT', payload.reason
                FROM settlementParticipantCurrency
                WHERE settlementId = payload.settlementId
            end hnote
        end

    else allSettlementWindowsClosed == false
        SETTLE_DAO -> SETTLEMENT: settlementWindows not closed - Return ERROR
        activate SETTLEMENT
        SETTLEMENT -> SSAPI: Return ERROR
        deactivate SETTLEMENT
        activate SSAPI
        SSAPI <-> SSAPI: Update Event log
        note right of SSAPI #LightBlue
            Log ERROR Messages.
            Update Event log with ERROR.
            end note
        note left of SSAPI #Yellow
            {
              "status": 0,
              "code": "(ERROR response code eg. '404' - Defined in swagger definition))",
              "message": "string"
            }
        end note
        OPERATOR <- SSAPI: Return ERROR
        deactivate SSAPI
    end

    SETTLEMENT <- SETTLE_DAO: Results for participant netAmount per ledger for closed settlement window
    deactivate SETTLE_DAO
    activate SETTLEMENT
    SETTLEMENT -> SSAPI: Results for participant netAmount per ledger for settlement window
    note left of SSAPI #Yellow
        {
          "id": "string",
          "reason": "string",
          "state": "PENDING_SETTLEMENT",
          "netSettlementAmount": {
            "amount": 0,
            "currency": "string"
          }
        }
    end note
    deactivate SETTLEMENT
    activate SSAPI
    SSAPI -> OPERATOR: Results for participant netAmount per ledger for closed settlement window
    deactivate SSAPI
end
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>