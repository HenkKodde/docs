<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2555px" preserveAspectRatio="none" style="width:1942px;height:2555px;" version="1.1" viewBox="0 0 1942 2555" width="1942px" zoomAndPan="magnify"><defs><filter height="300%" id="f1giokp5yzf30o" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="221" x="861.5" y="23.5352">6.2.1. Trigger Settlement Event</text><rect fill="#FFB6C1" height="2509.8496" style="stroke: #A80036; stroke-width: 1.0;" width="112" x="29" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="44.5" y="47.0566">Central HUB</text><rect fill="#90EE90" height="2509.8496" style="stroke: #A80036; stroke-width: 1.0;" width="670.5" x="529.5" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="802.75" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="2509.8496" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="1534" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="1537" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#f1giokp5yzf30o)" height="2293.5625" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="80" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f1giokp5yzf30o)" height="1714.8438" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="607" y="439.9453"/><rect fill="#FFFFFF" filter="url(#f1giokp5yzf30o)" height="226.7949" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="607" y="2199.0547"/><rect fill="#FFFFFF" filter="url(#f1giokp5yzf30o)" height="1729.7988" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1134" y="469.2559"/><rect fill="#FFFFFF" filter="url(#f1giokp5yzf30o)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1586" y="513.877"/><rect fill="#FFFFFF" filter="url(#f1giokp5yzf30o)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1586" y="652.4297"/><rect fill="#FFFFFF" filter="url(#f1giokp5yzf30o)" height="2286.5625" style="stroke: #000000; stroke-width: 2.0;" width="1918" x="13" y="154.2871"/><rect fill="#FFFFFF" filter="url(#f1giokp5yzf30o)" height="145.5527" style="stroke: #000000; stroke-width: 2.0;" width="385" x="1062" y="776.6719"/><rect fill="#FFFFFF" filter="url(#f1giokp5yzf30o)" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="365" x="1072" y="840.293"/><rect fill="#FFFFFF" filter="url(#f1giokp5yzf30o)" height="1497.625" style="stroke: #000000; stroke-width: 2.0;" width="1898" x="23" y="936.2246"/><rect fill="#FFFFFF" filter="url(#f1giokp5yzf30o)" height="974.8379" style="stroke: #000000; stroke-width: 2.0;" width="839" x="1072" y="960.5352"/><rect fill="#FFFFFF" height="271.0605" style="stroke: none; stroke-width: 1.0;" width="1898" x="23" y="2162.7891"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="85" x2="85" y1="137.2871" y2="2457.8496"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="611.5" x2="611.5" y1="137.2871" y2="2457.8496"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1139" x2="1139" y1="137.2871" y2="2457.8496"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1591" x2="1591" y1="137.2871" y2="2457.8496"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="33" y="134.334">Hub Employee</text><ellipse cx="85" cy="63.7988" fill="#FEFECE" filter="url(#f1giokp5yzf30o)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M85,71.7988 L85,98.7988 M72,79.7988 L98,79.7988 M85,98.7988 L72,113.7988 M85,98.7988 L98,113.7988 " fill="none" filter="url(#f1giokp5yzf30o)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="33" y="2470.3848">Hub Employee</text><ellipse cx="85" cy="2483.3379" fill="#FEFECE" filter="url(#f1giokp5yzf30o)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M85,2491.3379 L85,2518.3379 M72,2499.3379 L98,2499.3379 M85,2518.3379 L72,2533.3379 M85,2518.3379 L98,2533.3379 " fill="none" filter="url(#f1giokp5yzf30o)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="533.5" y="134.334">Settlement Service API</text><path d="M591.5,92.7988 L591.5,116.7988 M591.5,104.7988 L608.5,104.7988 " fill="none" filter="url(#f1giokp5yzf30o)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="620.5" cy="104.7988" fill="#FEFECE" filter="url(#f1giokp5yzf30o)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="533.5" y="2470.3848">Settlement Service API</text><path d="M591.5,2477.3379 L591.5,2501.3379 M591.5,2489.3379 L608.5,2489.3379 " fill="none" filter="url(#f1giokp5yzf30o)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="620.5" cy="2489.3379" fill="#FEFECE" filter="url(#f1giokp5yzf30o)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="1082" y="134.334">Settlement DAO</text><ellipse cx="1139" cy="104.7988" fill="#FEFECE" filter="url(#f1giokp5yzf30o)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1127" x2="1151" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="1082" y="2470.3848">Settlement DAO</text><ellipse cx="1139" cy="2489.3379" fill="#FEFECE" filter="url(#f1giokp5yzf30o)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1127" x2="1151" y1="2503.3379" y2="2503.3379"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1543" y="134.334">Central Store</text><path d="M1573,84.7988 C1573,74.7988 1591,74.7988 1591,74.7988 C1591,74.7988 1609,74.7988 1609,84.7988 L1609,110.7988 C1609,120.7988 1591,120.7988 1591,120.7988 C1591,120.7988 1573,120.7988 1573,110.7988 L1573,84.7988 " fill="#FEFECE" filter="url(#f1giokp5yzf30o)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1573,84.7988 C1573,94.7988 1591,94.7988 1591,94.7988 C1591,94.7988 1609,94.7988 1609,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1543" y="2470.3848">Central Store</text><path d="M1573,2483.3379 C1573,2473.3379 1591,2473.3379 1591,2473.3379 C1591,2473.3379 1609,2473.3379 1609,2483.3379 L1609,2509.3379 C1609,2519.3379 1591,2519.3379 1591,2519.3379 C1591,2519.3379 1573,2519.3379 1573,2509.3379 L1573,2483.3379 " fill="#FEFECE" filter="url(#f1giokp5yzf30o)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1573,2483.3379 C1573,2493.3379 1591,2493.3379 1591,2493.3379 C1591,2493.3379 1609,2493.3379 1609,2483.3379 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1giokp5yzf30o)" height="2293.5625" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="80" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f1giokp5yzf30o)" height="1714.8438" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="607" y="439.9453"/><rect fill="#FFFFFF" filter="url(#f1giokp5yzf30o)" height="226.7949" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="607" y="2199.0547"/><rect fill="#FFFFFF" filter="url(#f1giokp5yzf30o)" height="1729.7988" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1134" y="469.2559"/><rect fill="#FFFFFF" filter="url(#f1giokp5yzf30o)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1586" y="513.877"/><rect fill="#FFFFFF" filter="url(#f1giokp5yzf30o)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1586" y="652.4297"/><path d="M13,154.2871 L227,154.2871 L227,161.2871 L217,171.2871 L13,171.2871 L13,154.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2286.5625" style="stroke: #000000; stroke-width: 2.0;" width="1918" x="13" y="154.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="169" x="28" y="167.8555">Trigger Settlement Event</text><path d="M95,176.5977 L95,369.5977 L277,369.5977 L277,186.5977 L267,176.5977 L95,176.5977 " fill="#FFFF00" filter="url(#f1giokp5yzf30o)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M267,176.5977 L267,186.5977 L277,186.5977 L267,176.5977 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="101" y="194.166">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="117" y="209.4766">"id": 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="117" y="224.7871">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="117" y="240.0977">"settlementWindows": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="133" y="255.4082">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="149" y="270.7188">"id": 1,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="133" y="286.0293">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="133" y="301.3398">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="149" y="316.6504">"id": 2,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="133" y="331.9609">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="117" y="347.2715">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="101" y="362.582">}</text><path d="M95,384.3242 L95,409.3242 L439,409.3242 L439,394.3242 L429,384.3242 L95,384.3242 " fill="#D3D3D3" filter="url(#f1giokp5yzf30o)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M429,384.3242 L429,394.3242 L439,394.3242 L429,384.3242 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="323" x="101" y="401.8926">verify if we need the rest of the Swagger messages?</text><polygon fill="#A80036" points="595,435.9453,605,439.9453,595,443.9453,599,439.9453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="90" x2="601" y1="439.9453" y2="439.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="97" y="435.2031">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="110" y="435.2031">POST - /settlement/{id}</text><polygon fill="#A80036" points="1122,465.2559,1132,469.2559,1122,473.2559,1126,469.2559" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="617" x2="1128" y1="469.2559" y2="469.2559"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="624" y="464.5137">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="637" y="464.5137">Create new settlement</text><polygon fill="#A80036" points="1574,509.877,1584,513.877,1574,517.877,1578,513.877" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1144" x2="1580" y1="513.877" y2="513.877"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1151" y="501.4795">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="1164" y="493.8242">Insert new settlement</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="1164" y="509.1348">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="1241" y="509.1348">2001</text><polygon fill="#FFFFE0" filter="url(#f1giokp5yzf30o)" points="1455,556.877,1727,556.877,1737,582.877,1727,609.877,1455,609.877,1445,582.877,1455,556.877" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1457" y="573.4453">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="1541" y="573.4453">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1473" y="588.7559">(reason)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="1473" y="604.0664">VALUE (payload./settlementId/{reason});</text><polygon fill="#A80036" points="1574,648.4297,1584,652.4297,1574,656.4297,1578,652.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1144" x2="1580" y1="652.4297" y2="652.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1151" y="640.0322">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="1164" y="632.377">Get settlementWindow(s)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="1164" y="647.6875">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="1241" y="647.6875">2001</text><polygon fill="#FFFFE0" filter="url(#f1giokp5yzf30o)" points="1335,695.4297,1847,695.4297,1857,729.4297,1847,764.4297,1335,764.4297,1325,729.4297,1335,695.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="508" x="1337" y="711.998">SELECT MAX(settlementWindowStateChangeId), settlementWindowStateId, reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1337" y="727.3086">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="1381" y="727.3086">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="396" x="1337" y="742.6191">WHERE settlementWindowId = payload./settlementWindow/{id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="411" x="1337" y="757.9297">GROUP BY settlementWindowStateId,settlementWindowId, reason;</text><path d="M1062,776.6719 L1368,776.6719 L1368,783.6719 L1358,793.6719 L1062,793.6719 L1062,776.6719 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="145.5527" style="stroke: #000000; stroke-width: 2.0;" width="385" x="1062" y="776.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="261" x="1077" y="790.2402">Validate the list of settlement windows</text><path d="M1149,798.9824 L1149,823.9824 L1394,823.9824 L1394,808.9824 L1384,798.9824 L1149,798.9824 " fill="#D3D3D3" filter="url(#f1giokp5yzf30o)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1384,798.9824 L1384,808.9824 L1394,808.9824 L1384,798.9824 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="224" x="1155" y="816.5508">allSettlementWindowsClosed = true</text><path d="M1072,840.293 L1146,840.293 L1146,847.293 L1136,857.293 L1072,857.293 L1072,840.293 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="365" x="1072" y="840.293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="1087" y="853.8613">loop</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1144" x2="1186" y1="894.2246" y2="894.2246"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1186" x2="1186" y1="894.2246" y2="907.2246"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1145" x2="1186" y1="907.2246" y2="907.2246"/><polygon fill="#A80036" points="1155,903.2246,1145,907.2246,1155,911.2246,1151,907.2246" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1151" y="881.8271">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="1164" y="874.1719">if settlementWindowStateId != 'CLOSED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="261" x="1164" y="889.4824">then allSettlementWindowsClosed = false</text><path d="M23,936.2246 L85,936.2246 L85,943.2246 L75,953.2246 L23,953.2246 L23,936.2246 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1497.625" style="stroke: #000000; stroke-width: 2.0;" width="1898" x="23" y="936.2246"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="38" y="949.793">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="216" x="100" y="948.8594">[allSettlementWindowsClosed == true]</text><path d="M1072,960.5352 L1237,960.5352 L1237,967.5352 L1227,977.5352 L1072,977.5352 L1072,960.5352 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="974.8379" style="stroke: #000000; stroke-width: 2.0;" width="839" x="1072" y="960.5352"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="1087" y="974.1035">DB TRANSACTION</text><polygon fill="#A80036" points="1579,995.1563,1589,999.1563,1579,1003.1563,1583,999.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1144" x2="1585" y1="999.1563" y2="999.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1151" y="994.4141">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="1164" y="994.4141">Insert the list of settlementWindows</text><polygon fill="#FFFFE0" filter="url(#f1giokp5yzf30o)" points="1383,1012.1563,1798,1012.1563,1808,1038.1563,1798,1065.1563,1383,1065.1563,1373,1038.1563,1383,1012.1563" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1385" y="1028.7246">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="197" x="1469" y="1028.7246">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="223" x="1417" y="1044.0352">(settlementId, settlementWindowId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="395" x="1401" y="1059.3457">VALUE(payload.settlementId, payload./settlementWindow/{id});</text><polygon fill="#A80036" points="1579,1088.3984,1589,1092.3984,1579,1096.3984,1583,1092.3984" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1144" x2="1585" y1="1092.3984" y2="1092.3984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1151" y="1087.6563">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="380" x="1164" y="1087.6563">Populate settlementTransferParticipant with aggregated data</text><polygon fill="#FFFFE0" filter="url(#f1giokp5yzf30o)" points="1352,1105.3984,1829,1105.3984,1839,1239.3984,1829,1373.3984,1352,1373.3984,1342,1239.3984,1352,1105.3984" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1354" y="1121.9668">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="203" x="1438" y="1121.9668">settlementTransferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="424" x="1370" y="1137.2773">(settlementId, participantCurrencyId, transferParticipantRoleTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="1370" y="1152.5879">ledgerEntryTypeId, amount, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="449" x="1354" y="1167.8984">SELECT payload.settlementId AS settlementId, tp.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="344" x="1370" y="1183.209">tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="347" x="1370" y="1198.5195">SUM(tp.amount) AS amount, CURDATE() AS createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1354" y="1213.8301">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="1394" y="1213.8301">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="30" x="1520" y="1213.8301">AS tf</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1354" y="1229.1406">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1386" y="1229.1406">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="1529" y="1229.1406">AS tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="457" x="1370" y="1244.4512">ON tsc.transferId = tf.transferId AND tsc.transferStateId = ‘COMMITTED’</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1354" y="1259.7617">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1386" y="1259.7617">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="33" x="1517" y="1259.7617">AS tp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="1370" y="1275.0723">ON tp.transferId = tf.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="189" x="1354" y="1290.3828">WHERE tf.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="1370" y="1305.6934">IN (SELECT settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1370" y="1321.0039">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="197" x="1410" y="1321.0039">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="1370" y="1336.3145">WHERE settlementId = payload.settlementId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="433" x="1370" y="1351.625">GROUP BY tp.participantCurrencyId, tp.transferParticipantRoleTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1386" y="1366.9355">tp.ledgerEntryTypeId</text><polygon fill="#A80036" points="1579,1395.9883,1589,1399.9883,1579,1403.9883,1583,1399.9883" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1144" x2="1585" y1="1399.9883" y2="1399.9883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1151" y="1395.2461">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="384" x="1164" y="1395.2461">Populate settlementParticipantCurrency with aggregated data</text><polygon fill="#FFFFE0" filter="url(#f1giokp5yzf30o)" points="1291,1412.9883,1891,1412.9883,1901,1500.9883,1891,1588.9883,1291,1588.9883,1281,1500.9883,1291,1412.9883" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1293" y="1429.5566">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="1377" y="1429.5566">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="1309" y="1444.8672">(settlementId, participantCurrencyId, netAmount)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="1293" y="1460.1777">SELECT settlementId, participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="1293" y="1475.4883">SUM(CASE</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="568" x="1313" y="1490.7988">WHEN stp.transferParticipantRoleTypeId = 1 AND stp.ledgerEntryTypeId = 1 THEN amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="576" x="1313" y="1506.1094">WHEN stp.transferParticipantRoleTypeId = 2 AND stp.ledgerEntryTypeId = 1 THEN -amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="304" x="1313" y="1521.4199">WHEN stp.ledgerEntryTypeId = 2 THEN -amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="1305" y="1536.7305">END )</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1293" y="1552.041">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="203" x="1333" y="1552.041">settlementTransferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="1540" y="1552.041">AS stp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="1293" y="1567.3516">WHERE settlementId = payload.settlementId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="1293" y="1582.6621">GROUP BY settlementId, participantCurrencyId</text><polygon fill="#A80036" points="1579,1611.7148,1589,1615.7148,1579,1619.7148,1583,1615.7148" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1144" x2="1585" y1="1615.7148" y2="1615.7148"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1151" y="1610.9727">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="314" x="1164" y="1610.9727">Insert initial state change 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#f1giokp5yzf30o)" points="1332,1628.7148,1850,1628.7148,1860,1670.7148,1850,1712.7148,1332,1712.7148,1322,1670.7148,1332,1628.7148" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1334" y="1645.2832">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="1418" y="1645.2832">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="378" x="1350" y="1660.5938">(settlementParticipantCurrencyId, settlementStateId, reason)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="514" x="1334" y="1675.9043">SELECT settlementParticipantCurrencyId, ‘PENDING_SETTLEMENT’, payload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1334" y="1691.2148">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="1374" y="1691.2148">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="1334" y="1706.5254">WHERE settlementId = payload.settlementId</text><polygon fill="#A80036" points="1579,1735.5781,1589,1739.5781,1579,1743.5781,1583,1739.5781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1144" x2="1585" y1="1739.5781" y2="1739.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1151" y="1734.8359">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="1173" y="1734.8359">Insert initial state for settlement 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#f1giokp5yzf30o)" points="1393,1752.5781,1788,1752.5781,1798,1794.5781,1788,1836.5781,1393,1836.5781,1383,1794.5781,1393,1752.5781" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1395" y="1769.1465">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="157" x="1479" y="1769.1465">settlementStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="1411" y="1784.457">(settlementId, settlementStateId, reason)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="391" x="1395" y="1799.7676">SELECT settlementId, ‘PENDING_SETTLEMENT’, payload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1395" y="1815.0781">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="1435" y="1815.0781">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="1395" y="1830.3887">WHERE settlementId = payload.settlementId</text><polygon fill="#A80036" points="1579,1859.4414,1589,1863.4414,1579,1867.4414,1583,1863.4414" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1144" x2="1585" y1="1863.4414" y2="1863.4414"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1151" y="1858.6992">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="396" x="1173" y="1858.6992">Insert new state for settlementWindow 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#f1giokp5yzf30o)" points="1335,1876.4414,1847,1876.4414,1857,1902.4414,1847,1929.4414,1335,1929.4414,1325,1902.4414,1335,1876.4414" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1337" y="1893.0098">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="1421" y="1893.0098">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="353" x="1353" y="1908.3203">(settlementWindowId, settlementWindowStateId, reason)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="508" x="1337" y="1923.6309">VALUE payload./settlementWindow/{id}, 'PENDING_SETTLEMENT', payload.reason</text><polygon fill="#A80036" points="628,1959.6836,618,1963.6836,628,1967.6836,624,1963.6836" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="622" x2="1133" y1="1963.6836" y2="1963.6836"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="634" y="1958.9414">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="471" x="656" y="1958.9414">Results for participant netAmount per ledger for closed settlement window</text><path d="M362,1976.6836 L362,2123.6836 L598,2123.6836 L598,1986.6836 L588,1976.6836 L362,1976.6836 " fill="#FFFF00" filter="url(#f1giokp5yzf30o)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M588,1976.6836 L588,1986.6836 L598,1986.6836 L588,1976.6836 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="368" y="1994.252">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="81" x="376" y="2009.5625">"id": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="376" y="2024.873">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="376" y="2040.1836">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="376" y="2055.4941">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="384" y="2070.8047">"amount": 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="384" y="2086.1152">"currency": "string"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="376" y="2101.4258">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="368" y="2116.7363">}</text><polygon fill="#A80036" points="101,2150.7891,91,2154.7891,101,2158.7891,97,2154.7891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="95" x2="611" y1="2154.7891" y2="2154.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="107" y="2150.0469">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="471" x="129" y="2150.0469">Results for participant netAmount per ledger for closed settlement window</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="1921" y1="2163.7891" y2="2163.7891"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="221" x="28" y="2174.4238">[allSettlementWindowsClosed == false]</text><polygon fill="#A80036" points="628,2195.0547,618,2199.0547,628,2203.0547,624,2199.0547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="622" x2="1138" y1="2199.0547" y2="2199.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="634" y="2194.3125">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="295" x="656" y="2194.3125">settlementWindows not closed - Return ERROR</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="617" x2="659" y1="2228.3652" y2="2228.3652"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="659" x2="659" y1="2228.3652" y2="2241.3652"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="618" x2="659" y1="2241.3652" y2="2241.3652"/><polygon fill="#A80036" points="628,2237.3652,618,2241.3652,628,2245.3652,624,2241.3652" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="624" y="2223.623">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="646" y="2223.623">Update Event log</text><path d="M622,2254.3652 L622,2294.3652 L829,2294.3652 L829,2264.3652 L819,2254.3652 L622,2254.3652 " fill="#ADD8E6" filter="url(#f1giokp5yzf30o)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M819,2254.3652 L819,2264.3652 L829,2264.3652 L819,2254.3652 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="628" y="2271.9336">Log ERROR Messages.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="186" x="628" y="2287.2441">Update Event log with ERROR.</text><path d="M100,2308.9863 L100,2394.9863 L598,2394.9863 L598,2318.9863 L588,2308.9863 L100,2308.9863 " fill="#FFFF00" filter="url(#f1giokp5yzf30o)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M588,2308.9863 L588,2318.9863 L598,2318.9863 L588,2308.9863 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="106" y="2326.5547">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="69" x="114" y="2341.8652">"status": 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="469" x="114" y="2357.1758">"code": "(ERROR response code eg. '404' - Defined in swagger definition))",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="114" y="2372.4863">"message": "string"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="106" y="2387.7969">}</text><polygon fill="#A80036" points="101,2421.8496,91,2425.8496,101,2429.8496,97,2425.8496" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="95" x2="611" y1="2425.8496" y2="2425.8496"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="107" y="2421.1074">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="86" x="129" y="2421.1074">Return ERROR</text><!--
@startuml
title 6.2.1. Trigger Settlement Event
autonumber

actor "Hub Employee" as OPERATOR
boundary "Settlement Service API" as SSAPI
entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Central HUB" #LightPink
    participant OPERATOR
end box

box "Settlement Service" #LightGreen
    participant SSAPI
    participant SETTLE_DAO
end box

box "Central Services" #LightYellow
    participant DB
end box

group Trigger Settlement Event
activate OPERATOR
    note right of OPERATOR #Yellow
        {
            "id": 0,
            "reason": "string",
            "settlementWindows": [
                {
                    "id": 1,
                },
                {
                    "id": 2,
                }
            ]
        }
    end note
    note right of OPERATOR #LightGray
        verify if we need the rest of the Swagger messages?
    end note
    OPERATOR -> SSAPI: POST - /settlement/{id}
    activate SSAPI
    SSAPI-> SETTLE_DAO: Create new settlement
    activate SETTLE_DAO
    SETTLE_DAO -> DB: Insert new settlement\n<color #FF0000><b>Error code:</b> 2001</color>
    activate DB
    hnote over DB #LightYellow
        INSERT INTO **settlement**
            (reason)
            VALUE (payload./settlementId/{reason});
    end hnote
    deactivate DB
    SETTLE_DAO -> DB: Get settlementWindow(s)\n<color #FF0000><b>Error code:</b> 2001</color>
    activate DB
    hnote over DB #LightYellow
        SELECT MAX(settlementWindowStateChangeId), settlementWindowStateId, reason
        FROM  **settlementWindowStateChange**
        WHERE settlementWindowId = payload./settlementWindow/{id}
        GROUP BY settlementWindowStateId,settlementWindowId, reason;
    end hnote
    deactivate DB

    group Validate the list of settlement windows
        note right of SETTLE_DAO #LightGray
            allSettlementWindowsClosed = true
        end note
        loop
            SETTLE_DAO <- -> SETTLE_DAO: if settlementWindowStateId != 'CLOSED' \nthen allSettlementWindowsClosed = false
        end loop
    end

    alt allSettlementWindowsClosed == true
        group <color #blue>DB TRANSACTION</color>
            SETTLE_DAO -> DB: Insert the list of settlementWindows
            hnote over DB #LightYellow
                INSERT INTO **settlementSettlementWindow**
                	(settlementId, settlementWindowId)
                    VALUE(payload.settlementId, payload./settlementWindow/{id});
            end hnote
            SETTLE_DAO -> DB: Populate settlementTransferParticipant with aggregated data
            hnote over DB #LightYellow
                INSERT INTO **settlementTransferParticipant**
                    (settlementId, participantCurrencyId, transferParticipantRoleTypeId,
                    ledgerEntryTypeId, amount, createdDate)
                SELECT payload.settlementId AS settlementId, tp.participantCurrencyId,
                    tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId,
                    SUM(tp.amount) AS amount, CURDATE() AS createdDate
                FROM **transferFulfilment** AS tf
                JOIN **transferStateChange** AS tsc
                    ON tsc.transferId = tf.transferId AND tsc.transferStateId = ‘COMMITTED’
                JOIN **transferParticipant** AS tp
                    ON tp.transferId = tf.transferId
                WHERE tf.settlementWindowId
                    IN (SELECT settlementWindowId
                    FROM **settlementSettlementWindow**
                    WHERE settlementId = payload.settlementId)
                    GROUP BY tp.participantCurrencyId, tp.transferParticipantRoleTypeId,
                        tp.ledgerEntryTypeId
            end hnote
            SETTLE_DAO -> DB: Populate settlementParticipantCurrency with aggregated data
            hnote over DB #LightYellow
                INSERT INTO **settlementParticipantCurrency**
                    (settlementId, participantCurrencyId, netAmount)
                SELECT settlementId, participantCurrencyId,
                SUM(CASE
                     WHEN stp.transferParticipantRoleTypeId = 1 AND stp.ledgerEntryTypeId = 1 THEN amount
                     WHEN stp.transferParticipantRoleTypeId = 2 AND stp.ledgerEntryTypeId = 1 THEN -amount
                     WHEN stp.ledgerEntryTypeId = 2 THEN -amount
                   END )
                FROM **settlementTransferParticipant** AS stp
                WHERE settlementId = payload.settlementId
                GROUP BY settlementId, participantCurrencyId
            end hnote
            SETTLE_DAO -> DB: Insert initial state change 'PENDING_SETTLEMENT'
            hnote over DB #LightYellow
                INSERT INTO **settlementParticipantCurrencyStateChange**
                    (settlementParticipantCurrencyId, settlementStateId, reason)
                SELECT settlementParticipantCurrencyId, ‘PENDING_SETTLEMENT’, payload.reason
                FROM **settlementParticipantCurrency**
                WHERE settlementId = payload.settlementId
            end hnote
            SETTLE_DAO -> DB: Insert initial state for settlement 'PENDING_SETTLEMENT'
            hnote over DB #LightYellow
                INSERT INTO **settlementStateChange**
                    (settlementId, settlementStateId, reason)
                SELECT settlementId, ‘PENDING_SETTLEMENT’, payload.reason
                FROM **settlementParticipantCurrency**
                WHERE settlementId = payload.settlementId
            end hnote
            SETTLE_DAO -> DB: Insert new state for settlementWindow 'PENDING_SETTLEMENT'
            hnote over DB #LightYellow
                INSERT INTO **settlementWindowStateChange**
                    (settlementWindowId, settlementWindowStateId, reason)
                VALUE payload./settlementWindow/{id}, 'PENDING_SETTLEMENT', payload.reason
            end hnote
        end
        SSAPI <- - SETTLE_DAO: Results for participant netAmount per ledger for closed settlement window
        note left of SSAPI #Yellow
            {
              "id": "string",
              "reason": "string",
              "state": "PENDING_SETTLEMENT",
              "netSettlementAmount": {
                "amount": 0,
                "currency": "string"
              }
            }
        end note
        OPERATOR <- - SSAPI: Results for participant netAmount per ledger for closed settlement window
        deactivate SSAPI
    else allSettlementWindowsClosed == false
        SETTLE_DAO - -> SSAPI: settlementWindows not closed - Return ERROR
        deactivate SETTLE_DAO
        activate SSAPI
        SSAPI <- -> SSAPI: Update Event log
        note right of SSAPI #LightBlue
            Log ERROR Messages.
            Update Event log with ERROR.
            end note
        note left of SSAPI #Yellow
            {
              "status": 0,
              "code": "(ERROR response code eg. '404' - Defined in swagger definition))",
              "message": "string"
            }
        end note
        OPERATOR <- - SSAPI: Return ERROR
        deactivate SSAPI
    end
deactivate OPERATOR
end
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>