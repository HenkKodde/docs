<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1492px" preserveAspectRatio="none" style="width:1366px;height:1492px;" version="1.1" viewBox="0 0 1366 1492" width="1366px" zoomAndPan="magnify"><defs><filter height="300%" id="f7acn11puowfo" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="274" x="547" y="23.5352">1.3.2 Fulfil Position Handler Consume</text><rect fill="#FFFFE0" height="1446.8145" style="stroke: #A80036; stroke-width: 1.0;" width="1262.5" x="39" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="619.75" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f7acn11puowfo)" height="1279.5273" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="97.5" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f7acn11puowfo)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="815.5" y="1353.8145"/><rect fill="#FFFFFF" filter="url(#f7acn11puowfo)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="936.5" y="196.2188"/><rect fill="#FFFFFF" filter="url(#f7acn11puowfo)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="936.5" y="413.3926"/><rect fill="#FFFFFF" filter="url(#f7acn11puowfo)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="936.5" y="621.5664"/><rect fill="#FFFFFF" filter="url(#f7acn11puowfo)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1044" y="804.1191"/><rect fill="#FFFFFF" filter="url(#f7acn11puowfo)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1244.5" y="225.5293"/><rect fill="#FFFFFF" filter="url(#f7acn11puowfo)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1244.5" y="442.7031"/><rect fill="#FFFFFF" filter="url(#f7acn11puowfo)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1244.5" y="650.877"/><rect fill="#FFFFFF" filter="url(#f7acn11puowfo)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1244.5" y="833.4297"/><rect fill="#FFFFFF" filter="url(#f7acn11puowfo)" height="1265.5273" style="stroke: #000000; stroke-width: 2.0;" width="1342" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#f7acn11puowfo)" height="1234.2168" style="stroke: #000000; stroke-width: 2.0;" width="1322" x="23" y="157.5977"/><rect fill="#FFFFFF" filter="url(#f7acn11puowfo)" height="376.7266" style="stroke: #000000; stroke-width: 2.0;" width="1298" x="33" y="374.7715"/><rect fill="#FFFFFF" filter="url(#f7acn11puowfo)" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1302" x="33" y="765.498"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="102" x2="102" y1="116.2871" y2="1415.8145"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="820.5" x2="820.5" y1="116.2871" y2="1415.8145"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="941.5" x2="941.5" y1="116.2871" y2="1415.8145"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1048.5" x2="1048.5" y1="116.2871" y2="1415.8145"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1249.5" x2="1249.5" y1="116.2871" y2="1415.8145"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="43" y="113.334">Position Handler</text><ellipse cx="102.5" cy="83.7988" fill="#FEFECE" filter="url(#f7acn11puowfo)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="98.5,71.7988,104.5,66.7988,102.5,71.7988,104.5,76.7988,98.5,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="43" y="1428.3496">Position Handler</text><ellipse cx="102.5" cy="1447.3027" fill="#FEFECE" filter="url(#f7acn11puowfo)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="98.5,1435.3027,104.5,1430.3027,102.5,1435.3027,104.5,1440.3027,98.5,1435.3027" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f7acn11puowfo)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="761.5" y="76.7988"/><rect fill="#FEFECE" filter="url(#f7acn11puowfo)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="757.5" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="764.5" y="101.334">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#f7acn11puowfo)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="761.5" y="1414.8145"/><rect fill="#FEFECE" filter="url(#f7acn11puowfo)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="757.5" y="1418.8145"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="764.5" y="1439.3496">Transfer-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="893.5" y="113.334">Position DAO</text><ellipse cx="941.5" cy="83.7988" fill="#FEFECE" filter="url(#f7acn11puowfo)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="929.5" x2="953.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="893.5" y="1428.3496">Position DAO</text><ellipse cx="941.5" cy="1447.3027" fill="#FEFECE" filter="url(#f7acn11puowfo)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="929.5" x2="953.5" y1="1461.3027" y2="1461.3027"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="999.5" y="113.334">Transfer DAO</text><ellipse cx="1049" cy="83.7988" fill="#FEFECE" filter="url(#f7acn11puowfo)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1037" x2="1061" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="999.5" y="1428.3496">Transfer DAO</text><ellipse cx="1049" cy="1447.3027" fill="#FEFECE" filter="url(#f7acn11puowfo)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1037" x2="1061" y1="1461.3027" y2="1461.3027"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1201.5" y="113.334">Central Store</text><path d="M1231.5,63.7988 C1231.5,53.7988 1249.5,53.7988 1249.5,53.7988 C1249.5,53.7988 1267.5,53.7988 1267.5,63.7988 L1267.5,89.7988 C1267.5,99.7988 1249.5,99.7988 1249.5,99.7988 C1249.5,99.7988 1231.5,99.7988 1231.5,89.7988 L1231.5,63.7988 " fill="#FEFECE" filter="url(#f7acn11puowfo)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1231.5,63.7988 C1231.5,73.7988 1249.5,73.7988 1249.5,73.7988 C1249.5,73.7988 1267.5,73.7988 1267.5,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1201.5" y="1428.3496">Central Store</text><path d="M1231.5,1441.3027 C1231.5,1431.3027 1249.5,1431.3027 1249.5,1431.3027 C1249.5,1431.3027 1267.5,1431.3027 1267.5,1441.3027 L1267.5,1467.3027 C1267.5,1477.3027 1249.5,1477.3027 1249.5,1477.3027 C1249.5,1477.3027 1231.5,1477.3027 1231.5,1467.3027 L1231.5,1441.3027 " fill="#FEFECE" filter="url(#f7acn11puowfo)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1231.5,1441.3027 C1231.5,1451.3027 1249.5,1451.3027 1249.5,1451.3027 C1249.5,1451.3027 1267.5,1451.3027 1267.5,1441.3027 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f7acn11puowfo)" height="1279.5273" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="97.5" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f7acn11puowfo)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="815.5" y="1353.8145"/><rect fill="#FFFFFF" filter="url(#f7acn11puowfo)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="936.5" y="196.2188"/><rect fill="#FFFFFF" filter="url(#f7acn11puowfo)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="936.5" y="413.3926"/><rect fill="#FFFFFF" filter="url(#f7acn11puowfo)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="936.5" y="621.5664"/><rect fill="#FFFFFF" filter="url(#f7acn11puowfo)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1044" y="804.1191"/><rect fill="#FFFFFF" filter="url(#f7acn11puowfo)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1244.5" y="225.5293"/><rect fill="#FFFFFF" filter="url(#f7acn11puowfo)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1244.5" y="442.7031"/><rect fill="#FFFFFF" filter="url(#f7acn11puowfo)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1244.5" y="650.877"/><rect fill="#FFFFFF" filter="url(#f7acn11puowfo)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1244.5" y="833.4297"/><path d="M13,133.2871 L273,133.2871 L273,140.2871 L263,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1265.5273" style="stroke: #000000; stroke-width: 2.0;" width="1342" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="215" x="28" y="146.8555">Fulfil Position Handler Consume</text><path d="M23,157.5977 L85,157.5977 L85,164.5977 L75,174.5977 L23,174.5977 L23,157.5977 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1234.2168" style="stroke: #000000; stroke-width: 2.0;" width="1322" x="23" y="157.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="38" y="171.166">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="295" x="100" y="170.2324">[Calculate &amp; Validate Latest Position Fulfil (success)]</text><polygon fill="#A80036" points="924.5,192.2188,934.5,196.2188,924.5,200.2188,928.5,196.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="930.5" y1="196.2188" y2="196.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="114.5" y="191.4766">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="127.5" y="191.4766">Request current state of transfer from DB</text><polygon fill="#A80036" points="1232.5,221.5293,1242.5,225.5293,1232.5,229.5293,1236.5,225.5293" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="946.5" x2="1238.5" y1="225.5293" y2="225.5293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="953.5" y="220.7871">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="966.5" y="220.7871">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#f7acn11puowfo)" points="1184,238.5293,1315,238.5293,1325,249.5293,1315,261.5293,1184,261.5293,1174,249.5293,1184,238.5293" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1186" y="255.0977">transferStateChange</text><polygon fill="#A80036" points="957.5,284.1504,947.5,288.1504,957.5,292.1504,953.5,288.1504" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="951.5" x2="1248.5" y1="288.1504" y2="288.1504"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="963.5" y="283.4082">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="976.5" y="283.4082">Return current state of transfer from DB</text><polygon fill="#A80036" points="118.5,313.4609,108.5,317.4609,118.5,321.4609,114.5,317.4609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="940.5" y1="317.4609" y2="317.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="124.5" y="312.7188">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="137.5" y="312.7188">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="149.5" y1="346.7715" y2="346.7715"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="149.5" x2="149.5" y1="346.7715" y2="359.7715"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="108.5" x2="149.5" y1="359.7715" y2="359.7715"/><polygon fill="#A80036" points="118.5,355.7715,108.5,359.7715,118.5,363.7715,114.5,359.7715" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="114.5" y="342.0293">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="512" x="127.5" y="342.0293">Validate current state (transferStateChange.transferStateId == 'RECEIVED-FULFIL')</text><path d="M33,374.7715 L332,374.7715 L332,381.7715 L322,391.7715 L33,391.7715 L33,374.7715 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="376.7266" style="stroke: #000000; stroke-width: 2.0;" width="1298" x="33" y="374.7715"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="254" x="48" y="388.3398">Calculate position and persist change</text><polygon fill="#A80036" points="924.5,409.3926,934.5,413.3926,924.5,417.3926,928.5,413.3926" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="930.5" y1="413.3926" y2="413.3926"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="114.5" y="408.6504">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="261" x="127.5" y="408.6504">Request latest position from DB for Payee</text><polygon fill="#A80036" points="1232.5,438.7031,1242.5,442.7031,1232.5,446.7031,1236.5,442.7031" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="946.5" x2="1238.5" y1="442.7031" y2="442.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="953.5" y="437.9609">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="261" x="966.5" y="437.9609">Retrieve latest position from DB for Payee</text><polygon fill="#FFFFE0" filter="url(#f7acn11puowfo)" points="1188,455.7031,1311,455.7031,1321,474.7031,1311,493.7031,1188,493.7031,1178,474.7031,1188,455.7031" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="1190" y="472.2715">participant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="1190" y="487.582">participantPosition</text><polygon fill="#A80036" points="957.5,516.6348,947.5,520.6348,957.5,524.6348,953.5,520.6348" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="951.5" x2="1248.5" y1="520.6348" y2="520.6348"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="963.5" y="515.8926">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="261" x="976.5" y="515.8926">Retrieve latest position from DB for Payee</text><polygon fill="#A80036" points="118.5,545.9453,108.5,549.9453,118.5,553.9453,114.5,549.9453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="940.5" y1="549.9453" y2="549.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="124.5" y="545.2031">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="137.5" y="545.2031">Return latest position</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="149.5" y1="579.2559" y2="579.2559"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="149.5" x2="149.5" y1="579.2559" y2="592.2559"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="108.5" x2="149.5" y1="592.2559" y2="592.2559"/><polygon fill="#A80036" points="118.5,588.2559,108.5,592.2559,118.5,596.2559,114.5,592.2559" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="574.5137">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="672" x="136.5" y="574.5137">Calculate latest position ($latestPosition = participantPosition.reservedAmount - payload.amount.amount)</text><polygon fill="#A80036" points="924.5,617.5664,934.5,621.5664,924.5,625.5664,928.5,621.5664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="930.5" y1="621.5664" y2="621.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="616.8242">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="136.5" y="616.8242">Request to persist latest position for Payee</text><polygon fill="#A80036" points="1232.5,646.877,1242.5,650.877,1232.5,654.877,1236.5,650.877" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="946.5" x2="1238.5" y1="650.877" y2="650.877"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="953.5" y="646.1348">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="975.5" y="646.1348">Persist latest position to DB for Payee</text><polygon fill="#FFFFE0" filter="url(#f7acn11puowfo)" points="1188,693.877,1311,693.877,1321,704.877,1311,716.877,1188,716.877,1178,704.877,1188,693.877" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="1190" y="710.4453">participantPosition</text><polygon fill="#A80036" points="118.5,739.498,108.5,743.498,118.5,747.498,114.5,743.498" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="940.5" y1="743.498" y2="743.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="738.7559">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="146.5" y="738.7559">Return success</text><path d="M33,765.498 L456,765.498 L456,772.498 L446,782.498 L33,782.498 L33,765.498 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1302" x="33" y="765.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="378" x="48" y="779.0664">Persist Transfer State (with transferState='COMMITTED')</text><polygon fill="#A80036" points="1032,800.1191,1042,804.1191,1032,808.1191,1036,804.1191" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="1038" y1="804.1191" y2="804.1191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="799.377">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="136.5" y="799.377">Request to persist transfer</text><polygon fill="#A80036" points="1232.5,829.4297,1242.5,833.4297,1232.5,837.4297,1236.5,833.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1054" x2="1238.5" y1="833.4297" y2="833.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1061" y="828.6875">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1083" y="828.6875">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#f7acn11puowfo)" points="1184,876.4297,1315,876.4297,1325,887.4297,1315,899.4297,1184,899.4297,1174,887.4297,1184,876.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1186" y="892.998">transferStateChange</text><polygon fill="#A80036" points="118.5,922.0508,108.5,926.0508,118.5,930.0508,114.5,926.0508" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="1048" y1="926.0508" y2="926.0508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="921.3086">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="146.5" y="921.3086">Return success</text><path d="M112,946.0508 L112,1323.0508 L374,1323.0508 L374,956.0508 L364,946.0508 L112,946.0508 " fill="#FFFF00" filter="url(#f7acn11puowfo)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M364,946.0508 L364,956.0508 L374,956.0508 L364,946.0508 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="118" y="963.6191">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="118" y="978.9297">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="134" y="994.2402">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="134" y="1009.5508">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="134" y="1024.8613">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="134" y="1040.1719">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="134" y="1055.4824">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="150" y="1070.793">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="150" y="1086.1035">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="134" y="1101.4141">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="134" y="1116.7246">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="150" y="1132.0352">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="166" y="1147.3457">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="166" y="1162.6563">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="166" y="1177.9668">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="166" y="1193.2773">action: commit,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="166" y="1208.5879">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="166" y="1223.8984">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="182" y="1239.209">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="182" y="1254.5195">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="1269.8301">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="1285.1406">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="1300.4512">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="118" y="1315.7617">}</text><polygon fill="#A80036" points="803.5,1349.8145,813.5,1353.8145,803.5,1357.8145,807.5,1353.8145" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="809.5" y1="1353.8145" y2="1353.8145"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="1349.0723">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="136.5" y="1349.0723">Publish Transfer event</text><!--
@startuml
title 1.3.2 Fulfil Position Handler Consume

autonumber


control "Position Handler" as POS_HANDLER
collections "Transfer-Topic" as TOPIC_TRANSFERS
entity "Position DAO" as POS_DAO
entity "Transfer DAO" as TRANS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant POS_HANDLER
    participant TOPIC_TRANSFERS
    participant POS_DAO
    participant TRANS_DAO
    participant DB
end box

activate POS_HANDLER
group Fulfil Position Handler Consume
   alt Calculate & Validate Latest Position Fulfil (success)
        POS_HANDLER -> POS_DAO: Request current state of transfer from DB
        activate POS_DAO
        POS_DAO -> DB: Retrieve current state of transfer from DB
        activate DB
        hnote over DB #lightyellow
            transferStateChange
        end note
        DB - -> POS_DAO: Return current state of transfer from DB
        deactivate DB
        POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
        deactivate POS_DAO
        POS_HANDLER <-> POS_HANDLER: Validate current state (transferStateChange.transferStateId == 'RECEIVED-FULFIL')

        group Calculate position and persist change
            POS_HANDLER -> POS_DAO: Request latest position from DB for Payee
            activate POS_DAO
            POS_DAO -> DB: Retrieve latest position from DB for Payee
            activate DB
            hnote over DB #lightyellow
                participant
                participantPosition
            end note
            DB - -> POS_DAO: Retrieve latest position from DB for Payee
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return latest position
            deactivate POS_DAO
            POS_HANDLER <-> POS_HANDLER: Calculate latest position ($latestPosition = participantPosition.reservedAmount - payload.amount.amount)
            POS_HANDLER -> POS_DAO: Request to persist latest position for Payee
            activate POS_DAO
            POS_DAO -> DB: Persist latest position to DB for Payee
            hnote over DB #lightyellow
                participantPosition
            end note
            activate DB
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end

        group Persist Transfer State (with transferState='COMMITTED')
            POS_HANDLER -> TRANS_DAO: Request to persist transfer
            activate TRANS_DAO
            TRANS_DAO -> DB: Persist transfer state
            hnote over DB #lightyellow
                transferStateChange
            end note
            activate DB
            deactivate DB
            TRANS_DAO - -> POS_HANDLER: Return success
            deactivate TRANS_DAO
        end

        note right of POS_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: commit,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_TRANSFERS: Publish Transfer event
        activate TOPIC_TRANSFERS
        deactivate TOPIC_TRANSFERS

   end
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.5
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>