<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1816px" preserveAspectRatio="none" style="width:1279px;height:1816px;" version="1.1" viewBox="0 0 1279 1816" width="1279px" zoomAndPan="magnify"><defs><filter height="300%" id="fi3xht4g993ja" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="226" x="527.5" y="23.5352">6.1.2. Close Settlement Window</text><rect fill="#FFB6C1" height="1770.7832" style="stroke: #A80036; stroke-width: 1.0;" width="112" x="29" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="44.5" y="47.0566">Central HUB</text><rect fill="#90EE90" height="1770.7832" style="stroke: #A80036; stroke-width: 1.0;" width="454.5" x="272.5" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="437.75" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="1770.7832" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="920" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="923" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#fi3xht4g993ja)" height="1539.4961" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="80" y="147.2871"/><rect fill="#FFFFFF" filter="url(#fi3xht4g993ja)" height="1408.6328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="350" y="278.1504"/><rect fill="#FFFFFF" filter="url(#fi3xht4g993ja)" height="229.1055" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="661" y="633.4297"/><rect fill="#FFFFFF" filter="url(#fi3xht4g993ja)" height="423.6582" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="661" y="931.4668"/><rect fill="#FFFFFF" filter="url(#fi3xht4g993ja)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="972" y="662.7402"/><rect fill="#FFFFFF" filter="url(#fi3xht4g993ja)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="972" y="1117.6406"/><rect fill="#FFFFFF" filter="url(#fi3xht4g993ja)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="972" y="1224.8828"/><rect fill="#FFFFFF" filter="url(#fi3xht4g993ja)" height="1547.4961" style="stroke: #000000; stroke-width: 2.0;" width="1255" x="13" y="154.2871"/><rect fill="#FFFFFF" filter="url(#fi3xht4g993ja)" height="254.3477" style="stroke: #000000; stroke-width: 2.0;" width="687" x="23" y="335.4609"/><rect fill="#FFFFFF" filter="url(#fi3xht4g993ja)" height="817.248" style="stroke: #000000; stroke-width: 2.0;" width="1235" x="23" y="877.5352"/><rect fill="#FFFFFF" filter="url(#fi3xht4g993ja)" height="380.3477" style="stroke: #000000; stroke-width: 2.0;" width="649" x="599" y="946.4668"/><rect fill="#FFFFFF" height="171.1738" style="stroke: none; stroke-width: 1.0;" width="1235" x="23" y="1523.6094"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="85" x2="85" y1="137.2871" y2="1718.7832"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="354.5" x2="354.5" y1="137.2871" y2="1718.7832"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="666" x2="666" y1="137.2871" y2="1718.7832"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="977" x2="977" y1="137.2871" y2="1718.7832"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="33" y="134.334">Hub Employee</text><ellipse cx="85" cy="63.7988" fill="#FEFECE" filter="url(#fi3xht4g993ja)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M85,71.7988 L85,98.7988 M72,79.7988 L98,79.7988 M85,98.7988 L72,113.7988 M85,98.7988 L98,113.7988 " fill="none" filter="url(#fi3xht4g993ja)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="33" y="1731.3184">Hub Employee</text><ellipse cx="85" cy="1744.2715" fill="#FEFECE" filter="url(#fi3xht4g993ja)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M85,1752.2715 L85,1779.2715 M72,1760.2715 L98,1760.2715 M85,1779.2715 L72,1794.2715 M85,1779.2715 L98,1794.2715 " fill="none" filter="url(#fi3xht4g993ja)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="276.5" y="134.334">Settlement Service API</text><path d="M334.5,92.7988 L334.5,116.7988 M334.5,104.7988 L351.5,104.7988 " fill="none" filter="url(#fi3xht4g993ja)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="363.5" cy="104.7988" fill="#FEFECE" filter="url(#fi3xht4g993ja)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="276.5" y="1731.3184">Settlement Service API</text><path d="M334.5,1738.2715 L334.5,1762.2715 M334.5,1750.2715 L351.5,1750.2715 " fill="none" filter="url(#fi3xht4g993ja)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="363.5" cy="1750.2715" fill="#FEFECE" filter="url(#fi3xht4g993ja)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="609" y="134.334">Settlement DAO</text><ellipse cx="666" cy="104.7988" fill="#FEFECE" filter="url(#fi3xht4g993ja)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="654" x2="678" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="609" y="1731.3184">Settlement DAO</text><ellipse cx="666" cy="1750.2715" fill="#FEFECE" filter="url(#fi3xht4g993ja)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="654" x2="678" y1="1764.2715" y2="1764.2715"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="929" y="134.334">Central Store</text><path d="M959,84.7988 C959,74.7988 977,74.7988 977,74.7988 C977,74.7988 995,74.7988 995,84.7988 L995,110.7988 C995,120.7988 977,120.7988 977,120.7988 C977,120.7988 959,120.7988 959,110.7988 L959,84.7988 " fill="#FEFECE" filter="url(#fi3xht4g993ja)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M959,84.7988 C959,94.7988 977,94.7988 977,94.7988 C977,94.7988 995,94.7988 995,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="929" y="1731.3184">Central Store</text><path d="M959,1744.2715 C959,1734.2715 977,1734.2715 977,1734.2715 C977,1734.2715 995,1734.2715 995,1744.2715 L995,1770.2715 C995,1780.2715 977,1780.2715 977,1780.2715 C977,1780.2715 959,1780.2715 959,1770.2715 L959,1744.2715 " fill="#FEFECE" filter="url(#fi3xht4g993ja)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M959,1744.2715 C959,1754.2715 977,1754.2715 977,1754.2715 C977,1754.2715 995,1754.2715 995,1744.2715 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fi3xht4g993ja)" height="1539.4961" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="80" y="147.2871"/><rect fill="#FFFFFF" filter="url(#fi3xht4g993ja)" height="1408.6328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="350" y="278.1504"/><rect fill="#FFFFFF" filter="url(#fi3xht4g993ja)" height="229.1055" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="661" y="633.4297"/><rect fill="#FFFFFF" filter="url(#fi3xht4g993ja)" height="423.6582" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="661" y="931.4668"/><rect fill="#FFFFFF" filter="url(#fi3xht4g993ja)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="972" y="662.7402"/><rect fill="#FFFFFF" filter="url(#fi3xht4g993ja)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="972" y="1117.6406"/><rect fill="#FFFFFF" filter="url(#fi3xht4g993ja)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="972" y="1224.8828"/><path d="M13,154.2871 L227,154.2871 L227,161.2871 L217,171.2871 L13,171.2871 L13,154.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1547.4961" style="stroke: #000000; stroke-width: 2.0;" width="1255" x="13" y="154.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="169" x="28" y="167.8555">Close Settlement Window</text><path d="M95,176.5977 L95,247.5977 L249,247.5977 L249,186.5977 L239,176.5977 L95,176.5977 " fill="#FFFF00" filter="url(#fi3xht4g993ja)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M239,176.5977 L239,186.5977 L249,186.5977 L239,176.5977 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="101" y="194.166">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="117" y="209.4766">"state": "CLOSED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="117" y="224.7871">"reason": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="101" y="240.0977">}</text><polygon fill="#A80036" points="338,274.1504,348,278.1504,338,282.1504,342,278.1504" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="90" x2="344" y1="278.1504" y2="278.1504"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="97" y="273.4082">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="110" y="273.4082">POST - /settlementWindows/{id}</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="360" x2="402" y1="307.4609" y2="307.4609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="402" x2="402" y1="307.4609" y2="320.4609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="361" x2="402" y1="320.4609" y2="320.4609"/><polygon fill="#A80036" points="371,316.4609,361,320.4609,371,324.4609,367,320.4609" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="367" y="302.7188">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="380" y="302.7188">Validate payload and requested state</text><path d="M23,335.4609 L107,335.4609 L107,342.4609 L97,352.4609 L23,352.4609 L23,335.4609 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="254.3477" style="stroke: #000000; stroke-width: 2.0;" width="687" x="23" y="335.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="38" y="349.0293">break</text><path d="M365,357.7715 L365,550.7715 L696,550.7715 L696,367.7715 L686,357.7715 L365,357.7715 " fill="#FFFF00" filter="url(#fi3xht4g993ja)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M686,357.7715 L686,367.7715 L696,367.7715 L686,357.7715 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="371" y="375.3398">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="69" x="387" y="390.6504">"status": 0,</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="6" x="460" y="390.6504">?</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="387" y="405.9609">"code": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="387" y="421.2715">"message": "Invalid payload or state"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="371" y="436.582">}</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="20" x="371" y="451.8926">OR</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="395" y="451.8926">what is used in 6.2.5.:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="371" y="467.2031">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="387" y="482.5137">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="403" y="497.8242">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="403" y="513.1348">"errorDescription": "Invalid payload or state"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="387" y="528.4453">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="371" y="543.7559">}</text><polygon fill="#A80036" points="101,577.8086,91,581.8086,101,585.8086,97,581.8086" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="95" x2="349" y1="581.8086" y2="581.8086"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="107" y="577.0664">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="120" y="577.0664">Respond HTTP - 400 (Bad Request)</text><polygon fill="#A80036" points="649,629.4297,659,633.4297,649,637.4297,653,633.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="360" x2="655" y1="633.4297" y2="633.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="367" y="621.0322">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="269" x="380" y="613.377">Get requested settlementWindow and state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="380" y="628.6875">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="457" y="628.6875">2001</text><polygon fill="#A80036" points="960,658.7402,970,662.7402,960,666.7402,964,662.7402" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="671" x2="966" y1="662.7402" y2="662.7402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="678" y="657.998">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="691" y="657.998">Get settlementWindow state</text><polygon fill="#FFFFE0" filter="url(#fi3xht4g993ja)" points="775,705.7402,1179,705.7402,1189,770.7402,1179,835.7402,775,835.7402,765,770.7402,775,705.7402" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="400" x="777" y="722.3086">SELECT sw.settlementWindowId, swsc.settlementWindowStateId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="777" y="737.6191">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="817" y="737.6191">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="37" x="946" y="737.6191">AS sw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="777" y="752.9297">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="809" y="752.9297">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="51" x="1023" y="752.9297">AS swsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="777" y="768.2402">ON swsc.settlementWindowStateChangeId = (</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="793" y="783.5508">SELECT MAX(settlementWindowStateChangeId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="793" y="798.8613">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="833" y="798.8613">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="793" y="814.1719">WHERE settlementWindowId = {id})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="777" y="829.4824">WHERE sw.settlementWindowId = {id}</text><polygon fill="#A80036" points="371,858.5352,361,862.5352,371,866.5352,367,862.5352" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="365" x2="665" y1="862.5352" y2="862.5352"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="377" y="857.793">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="81" x="390" y="857.793">Return result</text><path d="M23,877.5352 L85,877.5352 L85,884.5352 L75,894.5352 L23,894.5352 L23,877.5352 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="817.248" style="stroke: #000000; stroke-width: 2.0;" width="1235" x="23" y="877.5352"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="38" y="891.1035">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="373" x="100" y="890.1699">[settlementWindow found &amp;&amp; settlementWindowStateId == 'OPEN']</text><polygon fill="#A80036" points="649,927.4668,659,931.4668,649,935.4668,653,931.4668" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="360" x2="655" y1="931.4668" y2="931.4668"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="367" y="919.0693">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="380" y="911.4141">Close current window and open a new one</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="380" y="926.7246">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="457" y="926.7246">2001</text><path d="M599,946.4668 L764,946.4668 L764,953.4668 L754,963.4668 L599,963.4668 L599,946.4668 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="380.3477" style="stroke: #000000; stroke-width: 2.0;" width="649" x="599" y="946.4668"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="614" y="960.0352">DB TRANSACTION</text><polygon fill="#A80036" points="965,981.0879,975,985.0879,965,989.0879,969,985.0879" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="671" x2="971" y1="985.0879" y2="985.0879"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="678" y="980.3457">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="691" y="980.3457">Close requested window</text><polygon fill="#FFFFE0" filter="url(#fi3xht4g993ja)" points="784,998.0879,1169,998.0879,1179,1024.0879,1169,1051.0879,784,1051.0879,774,1024.0879,784,998.0879" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="786" y="1014.6563">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="870" y="1014.6563">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="353" x="814" y="1029.9668">(settlementWindowId, settlementWindowStateId, reason)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="786" y="1045.2773">VALUES ({id}, payload.state, payload.reason)</text><path d="M676,1062.0195 L676,1087.0195 L910,1087.0195 L910,1072.0195 L900,1062.0195 L676,1062.0195 " fill="#D3D3D3" filter="url(#fi3xht4g993ja)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M900,1062.0195 L900,1072.0195 L910,1072.0195 L900,1062.0195 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="682" y="1079.5879">let transactionTimestamp = now()</text><polygon fill="#A80036" points="960,1113.6406,970,1117.6406,960,1121.6406,964,1117.6406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="671" x2="966" y1="1117.6406" y2="1117.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="678" y="1112.8984">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="189" x="691" y="1112.8984">Create new settlementWindow</text><polygon fill="#FFFFE0" filter="url(#fi3xht4g993ja)" points="802,1130.6406,1152,1130.6406,1162,1149.6406,1152,1168.6406,802,1168.6406,792,1149.6406,802,1130.6406" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="804" y="1147.209">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="888" y="1147.209">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="1017" y="1147.209">(reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="303" x="804" y="1162.5195">VALUES (payload.reason, transactionTimestamp)</text><polygon fill="#A80036" points="682,1191.5723,672,1195.5723,682,1199.5723,678,1195.5723" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="676" x2="976" y1="1195.5723" y2="1195.5723"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="688" y="1190.8301">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="710" y="1190.8301">Return @settlementWindowId</text><polygon fill="#A80036" points="960,1220.8828,970,1224.8828,960,1228.8828,964,1224.8828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="671" x2="966" y1="1224.8828" y2="1224.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="678" y="1220.1406">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="700" y="1220.1406">Insert intial state for the created window</text><polygon fill="#FFFFE0" filter="url(#fi3xht4g993ja)" points="726,1267.8828,1228,1267.8828,1238,1293.8828,1228,1320.8828,726,1320.8828,716,1293.8828,726,1267.8828" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="728" y="1284.4512">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="812" y="1284.4512">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="436" x="756" y="1299.7617">(settlementWindowId, settlementWindowStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="498" x="728" y="1315.0723">VALUES (@settlementWindowId, 'OPEN', payload.reason, transactionTimestamp)</text><polygon fill="#A80036" points="371,1351.125,361,1355.125,371,1359.125,367,1355.125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="365" x2="665" y1="1355.125" y2="1355.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="377" y="1350.3828">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="399" y="1350.3828">Return success</text><path d="M157,1368.125 L157,1485.125 L341,1485.125 L341,1378.125 L331,1368.125 L157,1368.125 " fill="#FFFF00" filter="url(#fi3xht4g993ja)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M331,1368.125 L331,1378.125 L341,1378.125 L331,1368.125 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="163" y="1385.6934">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="179" y="1401.0039">"id": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="179" y="1416.3145">"state": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="179" y="1431.625">"reason": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="179" y="1446.9355">"createdDate": &lt;date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="179" y="1462.2461">"changedDate": &lt;date&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="163" y="1477.5566">}</text><polygon fill="#A80036" points="101,1511.6094,91,1515.6094,101,1519.6094,97,1515.6094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="95" x2="349" y1="1515.6094" y2="1515.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="107" y="1510.8672">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103" x="129" y="1510.8672">Respond HTTP -</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="236" y="1510.8672">201 (Created)</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="1258" y1="1524.6094" y2="1524.6094"/><path d="M365,1530.6094 L365,1555.6094 L492,1555.6094 L492,1540.6094 L482,1530.6094 L365,1530.6094 " fill="#D3D3D3" filter="url(#fi3xht4g993ja)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M482,1530.6094 L482,1540.6094 L492,1540.6094 L482,1530.6094 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="371" y="1548.1777">Log ERROR event</text><path d="M174,1569.9199 L174,1655.9199 L341,1655.9199 L341,1579.9199 L331,1569.9199 L174,1569.9199 " fill="#FFFF00" filter="url(#fi3xht4g993ja)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M331,1569.9199 L331,1579.9199 L341,1579.9199 L331,1569.9199 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="180" y="1587.4883">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="69" x="196" y="1602.7988">"status": 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="196" y="1618.1094">"code": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="196" y="1633.4199">"message": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="180" y="1648.7305">}</text><polygon fill="#A80036" points="96,1682.7832,86,1686.7832,96,1690.7832,92,1686.7832" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="90" x2="354" y1="1686.7832" y2="1686.7832"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="102" y="1682.041">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="124" y="1682.041">Respond HTTP - 4xx (Client error)</text><!--
@startuml
title 6.1.2. Close Settlement Window

autonumber

actor "Hub Employee" as OPERATOR
boundary "Settlement Service API" as SSAPI
entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Central HUB" #LightPink
    participant OPERATOR
end box

box "Settlement Service" #LightGreen
    participant SSAPI
    participant SETTLE_DAO
end box

box "Central Services" #LightYellow
    participant DB
end box

group Close Settlement Window
    activate OPERATOR
    note right of OPERATOR #Yellow
        {
            "state": "CLOSED",
            "reason": <string>
        }
    end note

    OPERATOR -> SSAPI: POST - /settlementWindows/{id}
    activate SSAPI
    SSAPI -> SSAPI: Validate payload and requested state
    break
        note right of SSAPI #yellow
            {
                "status": 0, <color #FF0000>**?**</color>
                "code": <integer>,
                "message": "Invalid payload or state"
            }
            <color #FF0000>**OR**</color> what is used in 6.2.5.:
            {
                errorInformation: {
                    "errorCode": <integer>,
                    "errorDescription": "Invalid payload or state"
                }
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 400 (Bad Request)
    end
    SSAPI -> SETTLE_DAO: Get requested settlementWindow and state\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    SETTLE_DAO -> DB: Get settlementWindow state
    activate DB
    hnote over DB #lightyellow
        SELECT sw.settlementWindowId, swsc.settlementWindowStateId
        FROM **settlementWindow** AS sw
        JOIN **settlementWindowStateChange** AS swsc
        ON swsc.settlementWindowStateChangeId = (
            SELECT MAX(settlementWindowStateChangeId)
            FROM **settlementWindowStateChange**
            WHERE settlementWindowId = {id})
        WHERE sw.settlementWindowId = {id}
    end hnote
    deactivate DB
    SETTLE_DAO - -> SSAPI: Return result
    deactivate SETTLE_DAO

    alt settlementWindow found && settlementWindowStateId == 'OPEN'
        SSAPI -> SETTLE_DAO: Close current window and open a new one\n<color #FF0000><b>Error code:</b> 2001</color>
        activate SETTLE_DAO
        group <color #blue>DB TRANSACTION</color>
            SETTLE_DAO -> DB: Close requested window
            hnote over DB #LightYellow
                INSERT INTO **settlementWindowStateChange**
                       (settlementWindowId, settlementWindowStateId, reason)
                VALUES ({id}, payload.state, payload.reason)
            end hnote
            deactivate DB

            note right of SETTLE_DAO #lightgray
                let transactionTimestamp = now()
            end note

            SETTLE_DAO -> DB: Create new settlementWindow
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementWindow** (reason, createdDate)
                VALUES (payload.reason, transactionTimestamp)
            end note
            SETTLE_DAO <- - DB: Return @settlementWindowId
            deactivate DB

            SETTLE_DAO -> DB: Insert intial state for the created window
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementWindowStateChange**
                       (settlementWindowId, settlementWindowStateId, reason, createdDate)
                VALUES (@settlementWindowId, 'OPEN', payload.reason, transactionTimestamp)
            end note
            deactivate DB
            deactivate DB
        end
        SSAPI <- - SETTLE_DAO: Return success
        deactivate SETTLE_DAO

        note left of SSAPI #yellow
            {
                "id": <integer>,
                "state": <string>,
                "reason": <string>,
                "createdDate": <date>,
                "changedDate": <date>
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - <color #FF0000>201 (Created)</color>
    else
        note right of SSAPI #lightgray
            Log ERROR event
        end note
        note left of SSAPI #yellow
            {
                "status": 0,
                "code": <integer>,
                "message": <string>
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 4xx (Client error)
        deactivate SSAPI
        deactivate OPERATOR
    end
end
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>