<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1126.2px" preserveAspectRatio="none" style="width:769px;height:1126px;" version="1.1" viewBox="0 0 769 1126" width="769.8px" zoomAndPan="magnify"><defs><filter height="300%" id="fu6bdy80atso0" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="1.2000000476837158"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="2.4000000953674316" dy="2.4000000953674316" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="8.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135.6" x="317.4" y="14.1211">6.1.2. Close Settlement Window</text><rect fill="#FFB6C1" height="1099.2153" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="67.2" x="17.4" y="20.693"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="48.6" x="26.7" y="28.234">Central HUB</text><rect fill="#90EE90" height="1099.2153" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="272.7" x="163.5" y="20.693"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="74.4" x="262.65" y="28.234">Settlement Service</text><rect fill="#FFFFE0" height="1099.2153" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="68.4" x="552" y="20.693"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="64.8" x="553.8" y="28.234">Central Services</text><rect fill="#FFFFFF" filter="url(#fu6bdy80atso0)" height="960.2567" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="48" y="88.3723"/><rect fill="#FFFFFF" filter="url(#fu6bdy80atso0)" height="881.925" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="210" y="166.7039"/><rect fill="#FFFFFF" filter="url(#fu6bdy80atso0)" height="174.3949" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="396.6" y="379.6852"/><rect fill="#FFFFFF" filter="url(#fu6bdy80atso0)" height="254.3813" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="396.6" y="595.2528"/><rect fill="#FFFFFF" filter="url(#fu6bdy80atso0)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="583.2" y="397.4578"/><rect fill="#FFFFFF" filter="url(#fu6bdy80atso0)" height="46.759" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="583.2" y="707.1434"/><rect fill="#FFFFFF" filter="url(#fu6bdy80atso0)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="583.2" y="771.4887"/><rect fill="#FFFFFF" filter="url(#fu6bdy80atso0)" height="965.243" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="754.8" x="7.8" y="92.5723"/><rect fill="#FFFFFF" filter="url(#fu6bdy80atso0)" height="152.6086" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="412.2" x="13.8" y="201.2766"/><rect fill="#FFFFFF" filter="url(#fu6bdy80atso0)" height="490.3488" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="741" x="13.8" y="563.2664"/><rect fill="#FFFFFF" filter="url(#fu6bdy80atso0)" height="228.2086" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="389.4" x="359.4" y="604.6254"/><rect fill="#FFFFFF" height="102.7043" style="stroke: none; stroke-width: 0.6000000238418579;" width="741" x="13.8" y="950.911"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 5.0,5.0;" x1="51" x2="51" y1="82.3723" y2="1068.0153"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 5.0,5.0;" x1="212.7" x2="212.7" y1="82.3723" y2="1068.0153"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 5.0,5.0;" x1="399.6" x2="399.6" y1="82.3723" y2="1068.0153"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 5.0,5.0;" x1="586.2" x2="586.2" y1="82.3723" y2="1068.0153"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="58.8" x="19.8" y="80.6004">Hub Employee</text><ellipse cx="51" cy="38.2793" fill="#FEFECE" filter="url(#fu6bdy80atso0)" rx="4.8" ry="4.8" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><path d="M51,43.0793 L51,59.2793 M43.2,47.8793 L58.8,47.8793 M51,59.2793 L43.2,68.2793 M51,59.2793 L58.8,68.2793 " fill="none" filter="url(#fu6bdy80atso0)" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="58.8" x="19.8" y="1075.5364">Hub Employee</text><ellipse cx="51" cy="1083.3082" fill="#FEFECE" filter="url(#fu6bdy80atso0)" rx="4.8" ry="4.8" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><path d="M51,1088.1082 L51,1104.3082 M43.2,1092.9082 L58.8,1092.9082 M51,1104.3082 L43.2,1113.3082 M51,1104.3082 L58.8,1113.3082 " fill="none" filter="url(#fu6bdy80atso0)" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="90.6" x="165.9" y="80.6004">Settlement Service API</text><path d="M200.7,55.6793 L200.7,70.0793 M200.7,62.8793 L210.9,62.8793 " fill="none" filter="url(#fu6bdy80atso0)" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><ellipse cx="218.1" cy="62.8793" fill="#FEFECE" filter="url(#fu6bdy80atso0)" rx="7.2" ry="7.2" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="90.6" x="165.9" y="1075.5364">Settlement Service API</text><path d="M200.7,1079.7082 L200.7,1094.1082 M200.7,1086.9082 L210.9,1086.9082 " fill="none" filter="url(#fu6bdy80atso0)" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><ellipse cx="218.1" cy="1086.9082" fill="#FEFECE" filter="url(#fu6bdy80atso0)" rx="7.2" ry="7.2" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="64.8" x="365.4" y="80.6004">Settlement DAO</text><ellipse cx="399.6" cy="62.8793" fill="#FEFECE" filter="url(#fu6bdy80atso0)" rx="7.2" ry="7.2" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><line style="stroke: #A80036; stroke-width: 1.2000000476837158;" x1="392.4" x2="406.8" y1="71.2793" y2="71.2793"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="64.8" x="365.4" y="1075.5364">Settlement DAO</text><ellipse cx="399.6" cy="1086.9082" fill="#FEFECE" filter="url(#fu6bdy80atso0)" rx="7.2" ry="7.2" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><line style="stroke: #A80036; stroke-width: 1.2000000476837158;" x1="392.4" x2="406.8" y1="1095.3082" y2="1095.3082"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="54" x="557.4" y="80.6004">Central Store</text><path d="M575.4,50.8793 C575.4,44.8793 586.2,44.8793 586.2,44.8793 C586.2,44.8793 597,44.8793 597,50.8793 L597,66.4793 C597,72.4793 586.2,72.4793 586.2,72.4793 C586.2,72.4793 575.4,72.4793 575.4,66.4793 L575.4,50.8793 " fill="#FEFECE" filter="url(#fu6bdy80atso0)" style="stroke: #000000; stroke-width: 0.9000000357627869;"/><path d="M575.4,50.8793 C575.4,56.8793 586.2,56.8793 586.2,56.8793 C586.2,56.8793 597,56.8793 597,50.8793 " fill="none" style="stroke: #000000; stroke-width: 0.9000000357627869;"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="54" x="557.4" y="1075.5364">Central Store</text><path d="M575.4,1083.3082 C575.4,1077.3082 586.2,1077.3082 586.2,1077.3082 C586.2,1077.3082 597,1077.3082 597,1083.3082 L597,1098.9082 C597,1104.9082 586.2,1104.9082 586.2,1104.9082 C586.2,1104.9082 575.4,1104.9082 575.4,1098.9082 L575.4,1083.3082 " fill="#FEFECE" filter="url(#fu6bdy80atso0)" style="stroke: #000000; stroke-width: 0.9000000357627869;"/><path d="M575.4,1083.3082 C575.4,1089.3082 586.2,1089.3082 586.2,1089.3082 C586.2,1089.3082 597,1089.3082 597,1083.3082 " fill="none" style="stroke: #000000; stroke-width: 0.9000000357627869;"/><rect fill="#FFFFFF" filter="url(#fu6bdy80atso0)" height="960.2567" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="48" y="88.3723"/><rect fill="#FFFFFF" filter="url(#fu6bdy80atso0)" height="881.925" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="210" y="166.7039"/><rect fill="#FFFFFF" filter="url(#fu6bdy80atso0)" height="174.3949" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="396.6" y="379.6852"/><rect fill="#FFFFFF" filter="url(#fu6bdy80atso0)" height="254.3813" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="396.6" y="595.2528"/><rect fill="#FFFFFF" filter="url(#fu6bdy80atso0)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="583.2" y="397.4578"/><rect fill="#FFFFFF" filter="url(#fu6bdy80atso0)" height="46.759" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="583.2" y="707.1434"/><rect fill="#FFFFFF" filter="url(#fu6bdy80atso0)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="583.2" y="771.4887"/><path d="M7.8,92.5723 L189.6,92.5723 L189.6,96.7723 L183.6,102.7723 L7.8,102.7723 L7.8,92.5723 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="965.243" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="754.8" x="7.8" y="92.5723"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154.8" x="16.8" y="100.7133">Request closure of Settlement Window</text><path d="M57,105.9586 L57,148.5586 L149.4,148.5586 L149.4,111.9586 L143.4,105.9586 L57,105.9586 " fill="#FFFF00" filter="url(#fu6bdy80atso0)" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><path d="M143.4,105.9586 L143.4,111.9586 L149.4,111.9586 L143.4,105.9586 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="60.6" y="116.4996">{</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="67.8" x="70.2" y="125.6859">"state": "CLOSED",</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="70.2" x="70.2" y="134.8723">"reason": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="60.6" y="144.0586">}</text><polygon fill="#A80036" points="202.8,164.3039,208.8,166.7039,202.8,169.1039,205.2,166.7039" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="54" x2="206.4" y1="166.7039" y2="166.7039"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="58.2" y="164.0449">1</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="123" x="66" y="164.0449">POST - /settlementWindows/{id}</text><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="216" x2="241.2" y1="184.4766" y2="184.4766"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="241.2" x2="241.2" y1="184.4766" y2="192.2766"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="216.6" x2="241.2" y1="192.2766" y2="192.2766"/><polygon fill="#A80036" points="222.6,189.8766,216.6,192.2766,222.6,194.6766,220.2,192.2766" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="220.2" y="181.6313">2</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="138.6" x="228" y="181.6313">Validate payload and requested state</text><path d="M13.8,201.2766 L64.2,201.2766 L64.2,205.4766 L58.2,211.4766 L13.8,211.4766 L13.8,201.2766 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="152.6086" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="412.2" x="13.8" y="201.2766"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="23.4" x="22.8" y="209.4176">break</text><path d="M219,214.6629 L219,330.4629 L417.6,330.4629 L417.6,220.6629 L411.6,214.6629 L219,214.6629 " fill="#FFFF00" filter="url(#fu6bdy80atso0)" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><path d="M411.6,214.6629 L411.6,220.6629 L417.6,220.6629 L411.6,214.6629 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="222.6" y="225.2039">{</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="41.4" x="232.2" y="234.3902">"status": 0,</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="3.6" x="276" y="234.3902">?</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="69.6" x="232.2" y="243.5766">"code": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="138" x="232.2" y="252.7629">"message": "Invalid payload or state"</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="222.6" y="261.9492">}</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="12" x="222.6" y="271.1356">OR</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="83.4" x="237" y="271.1356">what is used in 6.2.5.:</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="222.6" y="280.3219">{</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="69.6" x="232.2" y="289.5082">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="88.8" x="241.8" y="298.6945">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="166.8" x="241.8" y="307.8809">"errorDescription": "Invalid payload or state"</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="232.2" y="317.0672">}</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="222.6" y="326.2535">}</text><polygon fill="#A80036" points="60.6,346.4988,54.6,348.8988,60.6,351.2988,58.2,348.8988" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="57" x2="209.4" y1="348.8988" y2="348.8988"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="64.2" y="346.2399">3</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="61.8" x="72" y="346.2399">Respond HTTP -</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="67.2" x="136.2" y="346.2399">400 (Bad Request)</text><polygon fill="#A80036" points="389.4,377.2852,395.4,379.6852,389.4,382.0852,391.8,379.6852" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="216" x2="393" y1="379.6852" y2="379.6852"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="220.2" y="372.6194">4</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="161.4" x="228" y="368.0262">Get requested settlementWindow and state</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43.8" x="228" y="377.2125">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="19.2" x="274.2" y="377.2125">2001</text><polygon fill="#A80036" points="576,395.0578,582,397.4578,576,399.8578,578.4,397.4578" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="402.6" x2="579.6" y1="397.4578" y2="397.4578"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="406.8" y="394.7988">5</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="105.6" x="414.6" y="394.7988">Get settlementWindow state</text><polygon fill="#FFFFE0" filter="url(#fu6bdy80atso0)" points="421.8,423.4442,750.6,423.4442,756.6,480.4442,750.6,538.0442,421.8,538.0442,415.8,480.4442,421.8,423.4442" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="240" x="423" y="433.3852">SELECT sw.settlementWindowId, swsc.settlementWindowStateId</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="118.2" x="423" y="442.5715">FROM settlementWindow AS sw</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="156" x="432.6" y="451.7578">JOIN (SELECT swsc1.settlementWindowId,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="171" x="471" y="460.9442">MAX(swsc1.settlementWindowStateChangeId)</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="139.8" x="471" y="470.1305">maxSettlementWindowStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="178.2" x="451.8" y="479.3168">FROM settlementWindowStateChange AS swsc1</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="130.8" x="451.8" y="488.5031">WHERE swsc1.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="161.4" x="451.8" y="497.6895">GROUP BY swsc1.settlementWindowId) sws</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="208.2" x="432.6" y="506.8758">ON sws.settlementWindowId = sw.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="168.6" x="423" y="516.0621">JOIN settlementWindowStateChange AS swsc</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="326.4" x="423" y="525.2485">ON swsc.settlementWindowStateChangeId = sws.maxSettlementWindowStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="140.4" x="423" y="534.4348">WHERE sw.settlementWindowId = {id}</text><polygon fill="#A80036" points="222.6,551.6801,216.6,554.0801,222.6,556.4801,220.2,554.0801" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="219" x2="399" y1="554.0801" y2="554.0801"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="226.2" y="551.4211">6</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="48.6" x="234" y="551.4211">Return result</text><path d="M13.8,563.2664 L51,563.2664 L51,567.4664 L45,573.4664 L13.8,573.4664 L13.8,563.2664 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="490.3488" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="741" x="13.8" y="563.2664"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.2" x="22.8" y="571.4074">alt</text><text fill="#000000" font-family="sans-serif" font-size="6.6" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="190.2" x="60" y="570.8473">[1 row returned &amp;&amp; settlementWindowStateId == 'OPEN']</text><polygon fill="#A80036" points="389.4,592.8528,395.4,595.2528,389.4,597.6528,391.8,595.2528" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="216" x2="393" y1="595.2528" y2="595.2528"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="220.2" y="588.1869">7</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="159" x="228" y="583.5938">Close current window and open a new one</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43.8" x="228" y="592.7801">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="19.2" x="274.2" y="592.7801">2001</text><path d="M359.4,604.6254 L458.4,604.6254 L458.4,608.8254 L452.4,614.8254 L359.4,614.8254 L359.4,604.6254 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="228.2086" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="389.4" x="359.4" y="604.6254"/><text fill="#0000FF" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="368.4" y="612.7664">DB TRANSACTION</text><polygon fill="#A80036" points="579,625.2117,585,627.6117,579,630.0117,581.4,627.6117" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="402.6" x2="582.6" y1="627.6117" y2="627.6117"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="406.8" y="624.9528">8</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="91.8" x="414.6" y="624.9528">Close requested window</text><polygon fill="#FFFFE0" filter="url(#fu6bdy80atso0)" points="470.4,635.5981,701.4,635.5981,707.4,651.1981,701.4,667.3981,470.4,667.3981,464.4,651.1981,470.4,635.5981" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="48" x="471.6" y="645.5391">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="126" x="522" y="645.5391">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="211.8" x="488.4" y="654.7254">(settlementWindowId, settlementWindowStateId, reason)</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="164.4" x="471.6" y="663.9117">VALUES ({id}, payload.state, payload.reason)</text><path d="M405.6,673.9571 L405.6,688.9571 L546,688.9571 L546,679.9571 L540,673.9571 L405.6,673.9571 " fill="#D3D3D3" filter="url(#fu6bdy80atso0)" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><path d="M540,673.9571 L540,679.9571 L546,679.9571 L540,673.9571 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="127.8" x="409.2" y="684.4981">let transactionTimestamp = now()</text><polygon fill="#A80036" points="576,704.7434,582,707.1434,576,709.5434,578.4,707.1434" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="402.6" x2="579.6" y1="707.1434" y2="707.1434"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="406.8" y="704.4844">9</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="113.4" x="414.6" y="704.4844">Create new settlementWindow</text><polygon fill="#FFFFE0" filter="url(#fu6bdy80atso0)" points="481.2,715.1297,691.2,715.1297,697.2,726.5297,691.2,737.9297,481.2,737.9297,475.2,726.5297,481.2,715.1297" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="48" x="482.4" y="725.0707">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="75" x="532.8" y="725.0707">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="79.8" x="610.2" y="725.0707">(reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="181.8" x="482.4" y="734.2571">VALUES (payload.reason, transactionTimestamp)</text><polygon fill="#A80036" points="409.2,751.5024,403.2,753.9024,409.2,756.3024,406.8,753.9024" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="405.6" x2="585.6" y1="753.9024" y2="753.9024"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="412.8" y="751.2434">10</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="110.4" x="426" y="751.2434">Return @settlementWindowId</text><polygon fill="#A80036" points="576,769.0887,582,771.4887,576,773.8887,578.4,771.4887" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="402.6" x2="579.6" y1="771.4887" y2="771.4887"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="406.8" y="768.8297">11</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="153" x="420" y="768.8297">Insert intial state for the created window</text><polygon fill="#FFFFE0" filter="url(#fu6bdy80atso0)" points="435.6,797.475,736.8,797.475,742.8,813.075,736.8,829.275,435.6,829.275,429.6,813.075,435.6,797.475" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="48" x="436.8" y="807.416">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="126" x="487.2" y="807.416">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="261.6" x="453.6" y="816.6024">(settlementWindowId, settlementWindowStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="298.8" x="436.8" y="825.7887">VALUES (@settlementWindowId, 'OPEN', payload.reason, transactionTimestamp)</text><polygon fill="#A80036" points="222.6,847.234,216.6,849.634,222.6,852.034,220.2,849.634" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="219" x2="399" y1="849.634" y2="849.634"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="226.2" y="846.975">12</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="57" x="239.4" y="846.975">Return success</text><path d="M94.2,857.6203 L94.2,927.8203 L204.6,927.8203 L204.6,863.6203 L198.6,857.6203 L94.2,857.6203 " fill="#FFFF00" filter="url(#fu6bdy80atso0)" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><path d="M198.6,857.6203 L198.6,863.6203 L204.6,863.6203 L198.6,857.6203 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="97.8" y="868.1614">{</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="25.2" x="107.4" y="877.3477">"id": 0,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="66.6" x="107.4" y="886.534">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="60" x="107.4" y="895.7203">"state": "string",</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="86.4" x="107.4" y="904.9067">"createdDate": "string",</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="88.2" x="107.4" y="914.093">"changedDate": "string"</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="97.8" y="923.2793">}</text><polygon fill="#A80036" points="60.6,943.5246,54.6,945.9246,60.6,948.3246,58.2,945.9246" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="57" x2="209.4" y1="945.9246" y2="945.9246"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="64.2" y="943.2657">13</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="61.8" x="77.4" y="943.2657">Respond HTTP -</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="50.4" x="141.6" y="943.2657">201 (Created)</text><line style="stroke: #000000; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="13.8" x2="754.8" y1="951.511" y2="951.511"/><path d="M219,955.111 L219,970.111 L295.2,970.111 L295.2,961.111 L289.2,955.111 L219,955.111 " fill="#D3D3D3" filter="url(#fu6bdy80atso0)" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><path d="M289.2,955.111 L289.2,961.111 L295.2,961.111 L289.2,955.111 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="63.6" x="222.6" y="965.652">Log ERROR event</text><path d="M104.4,978.6973 L104.4,1030.2973 L204.6,1030.2973 L204.6,984.6973 L198.6,978.6973 L104.4,978.6973 " fill="#FFFF00" filter="url(#fu6bdy80atso0)" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><path d="M198.6,978.6973 L198.6,984.6973 L204.6,984.6973 L198.6,978.6973 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="108" y="989.2383">{</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="41.4" x="117.6" y="998.4246">"status": 0,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="69.6" x="117.6" y="1007.611">"code": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="78" x="117.6" y="1016.7973">"message": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="108" y="1025.9836">}</text><polygon fill="#A80036" points="57.6,1046.2289,51.6,1048.6289,57.6,1051.0289,55.2,1048.6289" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="54" x2="212.4" y1="1048.6289" y2="1048.6289"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="61.2" y="1045.97">14</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="61.8" x="74.4" y="1045.97">Respond HTTP -</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="64.2" x="138.6" y="1045.97">4xx (Client error)</text><!--
@startuml
title 6.1.2. Close Settlement Window

autonumber

actor "Hub Employee" as OPERATOR
boundary "Settlement Service API" as SSAPI
entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Central HUB" #LightPink
    participant OPERATOR
end box

box "Settlement Service" #LightGreen
    participant SSAPI
    participant SETTLE_DAO
end box

box "Central Services" #LightYellow
    participant DB
end box

group Request closure of Settlement Window
    activate OPERATOR
    note right of OPERATOR #Yellow
        {
            "state": "CLOSED",
            "reason": <string>
        }
    end note

    OPERATOR -> SSAPI: POST - /settlementWindows/{id}
    activate SSAPI
    SSAPI -> SSAPI: Validate payload and requested state
    break
        note right of SSAPI #yellow
            {
                "status": 0, <color #FF0000>**?**</color>
                "code": <integer>,
                "message": "Invalid payload or state"
            }
            <color #FF0000>**OR**</color> what is used in 6.2.5.:
            {
                errorInformation: {
                    "errorCode": <integer>,
                    "errorDescription": "Invalid payload or state"
                }
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - <color #FF0000>400 (Bad Request)</color>
    end
    SSAPI -> SETTLE_DAO: Get requested settlementWindow and state\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    SETTLE_DAO -> DB: Get settlementWindow state
    activate DB
    hnote over DB #lightyellow
        SELECT sw.settlementWindowId, swsc.settlementWindowStateId
        FROM settlementWindow AS sw
            JOIN (SELECT swsc1.settlementWindowId, 
                            MAX(swsc1.settlementWindowStateChangeId)
                            maxSettlementWindowStateChangeId
                    FROM settlementWindowStateChange AS swsc1
                    WHERE swsc1.settlementWindowId
                    GROUP BY swsc1.settlementWindowId) sws
            ON sws.settlementWindowId = sw.settlementWindowId
        JOIN settlementWindowStateChange AS swsc
        ON swsc.settlementWindowStateChangeId = sws.maxSettlementWindowStateChangeId
        WHERE sw.settlementWindowId = {id}
    end hnote
    deactivate DB
    SETTLE_DAO - -> SSAPI: Return result
    deactivate SETTLE_DAO

    alt 1 row returned && settlementWindowStateId == 'OPEN'
        SSAPI -> SETTLE_DAO: Close current window and open a new one\n<color #FF0000><b>Error code:</b> 2001</color>
        activate SETTLE_DAO
        group <color #blue>DB TRANSACTION</color>
            SETTLE_DAO -> DB: Close requested window
            hnote over DB #LightYellow
                INSERT INTO **settlementWindowStateChange**
                       (settlementWindowId, settlementWindowStateId, reason)
                VALUES ({id}, payload.state, payload.reason)
            end hnote
            deactivate DB

            note right of SETTLE_DAO #lightgray
                let transactionTimestamp = now()
            end note

            SETTLE_DAO -> DB: Create new settlementWindow
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementWindow** (reason, createdDate)
                VALUES (payload.reason, transactionTimestamp)
            end note
            SETTLE_DAO <- - DB: Return @settlementWindowId
            deactivate DB

            SETTLE_DAO -> DB: Insert intial state for the created window
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementWindowStateChange**
                       (settlementWindowId, settlementWindowStateId, reason, createdDate)
                VALUES (@settlementWindowId, 'OPEN', payload.reason, transactionTimestamp)
            end note
            deactivate DB
            deactivate DB
        end
        SSAPI <- - SETTLE_DAO: Return success
        deactivate SETTLE_DAO

        note left of SSAPI #yellow
            {
                "id": 0,
                "reason": "string",
                "state": "string",
                "createdDate": "string",
                "changedDate": "string"
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - <color #FF0000>201 (Created)</color>
    else
        note right of SSAPI #lightgray
            Log ERROR event
        end note
        note left of SSAPI #yellow
            {
                "status": 0,
                "code": <integer>,
                "message": <string>
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - <color #FF0000>4xx (Client error)</color>
        deactivate SSAPI
        deactivate OPERATOR
    end
end
@enduml

PlantUML version 1.2018.01(Sun Jan 28 20:08:22 SAST 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_152-release-1136-b29
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: ZA
--></g></svg>