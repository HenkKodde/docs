<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1877px" preserveAspectRatio="none" style="width:1283px;height:1877px;" version="1.1" viewBox="0 0 1283 1877" width="1283px" zoomAndPan="magnify"><defs><filter height="300%" id="fgwcdj3xlr102" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="226" x="529" y="23.5352">6.1.2. Close Settlement Window</text><rect fill="#FFB6C1" height="1832.0254" style="stroke: #A80036; stroke-width: 1.0;" width="112" x="29" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="44.5" y="47.0566">Central HUB</text><rect fill="#90EE90" height="1832.0254" style="stroke: #A80036; stroke-width: 1.0;" width="454.5" x="272.5" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="437.75" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="1832.0254" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="920" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="923" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#fgwcdj3xlr102)" height="1600.7383" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="80" y="147.2871"/><rect fill="#FFFFFF" filter="url(#fgwcdj3xlr102)" height="1469.875" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="350" y="278.1504"/><rect fill="#FFFFFF" filter="url(#fgwcdj3xlr102)" height="290.3477" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="661" y="633.4297"/><rect fill="#FFFFFF" filter="url(#fgwcdj3xlr102)" height="423.6582" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="661" y="992.709"/><rect fill="#FFFFFF" filter="url(#fgwcdj3xlr102)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="972" y="662.7402"/><rect fill="#FFFFFF" filter="url(#fgwcdj3xlr102)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="972" y="1178.8828"/><rect fill="#FFFFFF" filter="url(#fgwcdj3xlr102)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="972" y="1286.125"/><rect fill="#FFFFFF" filter="url(#fgwcdj3xlr102)" height="1608.7383" style="stroke: #000000; stroke-width: 2.0;" width="1258" x="13" y="154.2871"/><rect fill="#FFFFFF" filter="url(#fgwcdj3xlr102)" height="254.3477" style="stroke: #000000; stroke-width: 2.0;" width="687" x="23" y="335.4609"/><rect fill="#FFFFFF" filter="url(#fgwcdj3xlr102)" height="817.248" style="stroke: #000000; stroke-width: 2.0;" width="1235" x="23" y="938.7773"/><rect fill="#FFFFFF" filter="url(#fgwcdj3xlr102)" height="380.3477" style="stroke: #000000; stroke-width: 2.0;" width="649" x="599" y="1007.709"/><rect fill="#FFFFFF" height="171.1738" style="stroke: none; stroke-width: 1.0;" width="1235" x="23" y="1584.8516"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="85" x2="85" y1="137.2871" y2="1780.0254"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="354.5" x2="354.5" y1="137.2871" y2="1780.0254"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="666" x2="666" y1="137.2871" y2="1780.0254"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="977" x2="977" y1="137.2871" y2="1780.0254"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="33" y="134.334">Hub Employee</text><ellipse cx="85" cy="63.7988" fill="#FEFECE" filter="url(#fgwcdj3xlr102)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M85,71.7988 L85,98.7988 M72,79.7988 L98,79.7988 M85,98.7988 L72,113.7988 M85,98.7988 L98,113.7988 " fill="none" filter="url(#fgwcdj3xlr102)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="33" y="1792.5605">Hub Employee</text><ellipse cx="85" cy="1805.5137" fill="#FEFECE" filter="url(#fgwcdj3xlr102)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M85,1813.5137 L85,1840.5137 M72,1821.5137 L98,1821.5137 M85,1840.5137 L72,1855.5137 M85,1840.5137 L98,1855.5137 " fill="none" filter="url(#fgwcdj3xlr102)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="276.5" y="134.334">Settlement Service API</text><path d="M334.5,92.7988 L334.5,116.7988 M334.5,104.7988 L351.5,104.7988 " fill="none" filter="url(#fgwcdj3xlr102)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="363.5" cy="104.7988" fill="#FEFECE" filter="url(#fgwcdj3xlr102)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="276.5" y="1792.5605">Settlement Service API</text><path d="M334.5,1799.5137 L334.5,1823.5137 M334.5,1811.5137 L351.5,1811.5137 " fill="none" filter="url(#fgwcdj3xlr102)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="363.5" cy="1811.5137" fill="#FEFECE" filter="url(#fgwcdj3xlr102)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="609" y="134.334">Settlement DAO</text><ellipse cx="666" cy="104.7988" fill="#FEFECE" filter="url(#fgwcdj3xlr102)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="654" x2="678" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="609" y="1792.5605">Settlement DAO</text><ellipse cx="666" cy="1811.5137" fill="#FEFECE" filter="url(#fgwcdj3xlr102)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="654" x2="678" y1="1825.5137" y2="1825.5137"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="929" y="134.334">Central Store</text><path d="M959,84.7988 C959,74.7988 977,74.7988 977,74.7988 C977,74.7988 995,74.7988 995,84.7988 L995,110.7988 C995,120.7988 977,120.7988 977,120.7988 C977,120.7988 959,120.7988 959,110.7988 L959,84.7988 " fill="#FEFECE" filter="url(#fgwcdj3xlr102)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M959,84.7988 C959,94.7988 977,94.7988 977,94.7988 C977,94.7988 995,94.7988 995,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="929" y="1792.5605">Central Store</text><path d="M959,1805.5137 C959,1795.5137 977,1795.5137 977,1795.5137 C977,1795.5137 995,1795.5137 995,1805.5137 L995,1831.5137 C995,1841.5137 977,1841.5137 977,1841.5137 C977,1841.5137 959,1841.5137 959,1831.5137 L959,1805.5137 " fill="#FEFECE" filter="url(#fgwcdj3xlr102)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M959,1805.5137 C959,1815.5137 977,1815.5137 977,1815.5137 C977,1815.5137 995,1815.5137 995,1805.5137 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fgwcdj3xlr102)" height="1600.7383" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="80" y="147.2871"/><rect fill="#FFFFFF" filter="url(#fgwcdj3xlr102)" height="1469.875" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="350" y="278.1504"/><rect fill="#FFFFFF" filter="url(#fgwcdj3xlr102)" height="290.3477" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="661" y="633.4297"/><rect fill="#FFFFFF" filter="url(#fgwcdj3xlr102)" height="423.6582" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="661" y="992.709"/><rect fill="#FFFFFF" filter="url(#fgwcdj3xlr102)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="972" y="662.7402"/><rect fill="#FFFFFF" filter="url(#fgwcdj3xlr102)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="972" y="1178.8828"/><rect fill="#FFFFFF" filter="url(#fgwcdj3xlr102)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="972" y="1286.125"/><path d="M13,154.2871 L316,154.2871 L316,161.2871 L306,171.2871 L13,171.2871 L13,154.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1608.7383" style="stroke: #000000; stroke-width: 2.0;" width="1258" x="13" y="154.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="258" x="28" y="167.8555">Request closure of Settlement Window</text><path d="M95,176.5977 L95,247.5977 L249,247.5977 L249,186.5977 L239,176.5977 L95,176.5977 " fill="#FFFF00" filter="url(#fgwcdj3xlr102)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M239,176.5977 L239,186.5977 L249,186.5977 L239,176.5977 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="101" y="194.166">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="117" y="209.4766">"state": "CLOSED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="117" y="224.7871">"reason": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="101" y="240.0977">}</text><polygon fill="#A80036" points="338,274.1504,348,278.1504,338,282.1504,342,278.1504" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="90" x2="344" y1="278.1504" y2="278.1504"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="97" y="273.4082">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="110" y="273.4082">POST - /settlementWindows/{id}</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="360" x2="402" y1="307.4609" y2="307.4609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="402" x2="402" y1="307.4609" y2="320.4609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="361" x2="402" y1="320.4609" y2="320.4609"/><polygon fill="#A80036" points="371,316.4609,361,320.4609,371,324.4609,367,320.4609" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="367" y="302.7188">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="380" y="302.7188">Validate payload and requested state</text><path d="M23,335.4609 L107,335.4609 L107,342.4609 L97,352.4609 L23,352.4609 L23,335.4609 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="254.3477" style="stroke: #000000; stroke-width: 2.0;" width="687" x="23" y="335.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="38" y="349.0293">break</text><path d="M365,357.7715 L365,550.7715 L696,550.7715 L696,367.7715 L686,357.7715 L365,357.7715 " fill="#FFFF00" filter="url(#fgwcdj3xlr102)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M686,357.7715 L686,367.7715 L696,367.7715 L686,357.7715 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="371" y="375.3398">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="69" x="387" y="390.6504">"status": 0,</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="6" x="460" y="390.6504">?</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="387" y="405.9609">"code": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="387" y="421.2715">"message": "Invalid payload or state"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="371" y="436.582">}</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="20" x="371" y="451.8926">OR</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="395" y="451.8926">what is used in 6.2.5.:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="371" y="467.2031">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="387" y="482.5137">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="403" y="497.8242">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="403" y="513.1348">"errorDescription": "Invalid payload or state"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="387" y="528.4453">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="371" y="543.7559">}</text><polygon fill="#A80036" points="101,577.8086,91,581.8086,101,585.8086,97,581.8086" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="95" x2="349" y1="581.8086" y2="581.8086"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="107" y="577.0664">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="120" y="577.0664">Respond HTTP - 400 (Bad Request)</text><polygon fill="#A80036" points="649,629.4297,659,633.4297,649,637.4297,653,633.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="360" x2="655" y1="633.4297" y2="633.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="367" y="621.0322">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="269" x="380" y="613.377">Get requested settlementWindow and state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="380" y="628.6875">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="457" y="628.6875">2001</text><polygon fill="#A80036" points="960,658.7402,970,662.7402,960,666.7402,964,662.7402" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="671" x2="966" y1="662.7402" y2="662.7402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="678" y="657.998">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="691" y="657.998">Get settlementWindow state</text><polygon fill="#FFFFE0" filter="url(#fgwcdj3xlr102)" points="703,705.7402,1251,705.7402,1261,800.7402,1251,896.7402,703,896.7402,693,800.7402,703,705.7402" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="400" x="705" y="722.3086">SELECT sw.settlementWindowId, swsc.settlementWindowStateId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="705" y="737.6191">FROM settlementWindow AS sw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="260" x="721" y="752.9297">JOIN (SELECT swsc1.settlementWindowId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="285" x="785" y="768.2402">MAX(swsc1.settlementWindowStateChangeId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="785" y="783.5508">maxSettlementWindowStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="297" x="753" y="798.8613">FROM settlementWindowStateChange AS swsc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="753" y="814.1719">WHERE swsc1.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="269" x="753" y="829.4824">GROUP BY swsc1.settlementWindowId) sws</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="347" x="721" y="844.793">ON sws.settlementWindowId = sw.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="281" x="705" y="860.1035">JOIN settlementWindowStateChange AS swsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="544" x="705" y="875.4141">ON swsc.settlementWindowStateChangeId = sws.maxSettlementWindowStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="705" y="890.7246">WHERE sw.settlementWindowId = {id}</text><polygon fill="#A80036" points="371,919.7773,361,923.7773,371,927.7773,367,923.7773" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="365" x2="665" y1="923.7773" y2="923.7773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="377" y="919.0352">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="81" x="390" y="919.0352">Return result</text><path d="M23,938.7773 L85,938.7773 L85,945.7773 L75,955.7773 L23,955.7773 L23,938.7773 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="817.248" style="stroke: #000000; stroke-width: 2.0;" width="1235" x="23" y="938.7773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="38" y="952.3457">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="317" x="100" y="951.4121">[1 row returned &amp;&amp; settlementWindowStateId == 'OPEN']</text><polygon fill="#A80036" points="649,988.709,659,992.709,649,996.709,653,992.709" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="360" x2="655" y1="992.709" y2="992.709"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="367" y="980.3115">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="380" y="972.6563">Close current window and open a new one</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="380" y="987.9668">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="457" y="987.9668">2001</text><path d="M599,1007.709 L764,1007.709 L764,1014.709 L754,1024.709 L599,1024.709 L599,1007.709 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="380.3477" style="stroke: #000000; stroke-width: 2.0;" width="649" x="599" y="1007.709"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="614" y="1021.2773">DB TRANSACTION</text><polygon fill="#A80036" points="965,1042.3301,975,1046.3301,965,1050.3301,969,1046.3301" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="671" x2="971" y1="1046.3301" y2="1046.3301"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="678" y="1041.5879">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="691" y="1041.5879">Close requested window</text><polygon fill="#FFFFE0" filter="url(#fgwcdj3xlr102)" points="784,1059.3301,1169,1059.3301,1179,1085.3301,1169,1112.3301,784,1112.3301,774,1085.3301,784,1059.3301" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="786" y="1075.8984">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="870" y="1075.8984">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="353" x="814" y="1091.209">(settlementWindowId, settlementWindowStateId, reason)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="786" y="1106.5195">VALUES ({id}, payload.state, payload.reason)</text><path d="M676,1123.2617 L676,1148.2617 L910,1148.2617 L910,1133.2617 L900,1123.2617 L676,1123.2617 " fill="#D3D3D3" filter="url(#fgwcdj3xlr102)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M900,1123.2617 L900,1133.2617 L910,1133.2617 L900,1123.2617 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="682" y="1140.8301">let transactionTimestamp = now()</text><polygon fill="#A80036" points="960,1174.8828,970,1178.8828,960,1182.8828,964,1178.8828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="671" x2="966" y1="1178.8828" y2="1178.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="678" y="1174.1406">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="189" x="691" y="1174.1406">Create new settlementWindow</text><polygon fill="#FFFFE0" filter="url(#fgwcdj3xlr102)" points="802,1191.8828,1152,1191.8828,1162,1210.8828,1152,1229.8828,802,1229.8828,792,1210.8828,802,1191.8828" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="804" y="1208.4512">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="888" y="1208.4512">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="1017" y="1208.4512">(reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="303" x="804" y="1223.7617">VALUES (payload.reason, transactionTimestamp)</text><polygon fill="#A80036" points="682,1252.8145,672,1256.8145,682,1260.8145,678,1256.8145" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="676" x2="976" y1="1256.8145" y2="1256.8145"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="688" y="1252.0723">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="710" y="1252.0723">Return @settlementWindowId</text><polygon fill="#A80036" points="960,1282.125,970,1286.125,960,1290.125,964,1286.125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="671" x2="966" y1="1286.125" y2="1286.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="678" y="1281.3828">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="700" y="1281.3828">Insert intial state for the created window</text><polygon fill="#FFFFE0" filter="url(#fgwcdj3xlr102)" points="726,1329.125,1228,1329.125,1238,1355.125,1228,1382.125,726,1382.125,716,1355.125,726,1329.125" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="728" y="1345.6934">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="812" y="1345.6934">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="436" x="756" y="1361.0039">(settlementWindowId, settlementWindowStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="498" x="728" y="1376.3145">VALUES (@settlementWindowId, 'OPEN', payload.reason, transactionTimestamp)</text><polygon fill="#A80036" points="371,1412.3672,361,1416.3672,371,1420.3672,367,1416.3672" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="365" x2="665" y1="1416.3672" y2="1416.3672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="377" y="1411.625">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="399" y="1411.625">Return success</text><path d="M157,1429.3672 L157,1546.3672 L341,1546.3672 L341,1439.3672 L331,1429.3672 L157,1429.3672 " fill="#FFFF00" filter="url(#fgwcdj3xlr102)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M331,1429.3672 L331,1439.3672 L341,1439.3672 L331,1429.3672 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="163" y="1446.9355">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="179" y="1462.2461">"id": 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="179" y="1477.5566">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="179" y="1492.8672">"state": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="179" y="1508.1777">"createdDate": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="179" y="1523.4883">"changedDate": "string"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="163" y="1538.7988">}</text><polygon fill="#A80036" points="101,1572.8516,91,1576.8516,101,1580.8516,97,1576.8516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="95" x2="349" y1="1576.8516" y2="1576.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="107" y="1572.1094">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103" x="129" y="1572.1094">Respond HTTP -</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="236" y="1572.1094">201 (Created)</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="1258" y1="1585.8516" y2="1585.8516"/><path d="M365,1591.8516 L365,1616.8516 L492,1616.8516 L492,1601.8516 L482,1591.8516 L365,1591.8516 " fill="#D3D3D3" filter="url(#fgwcdj3xlr102)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M482,1591.8516 L482,1601.8516 L492,1601.8516 L482,1591.8516 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="371" y="1609.4199">Log ERROR event</text><path d="M174,1631.1621 L174,1717.1621 L341,1717.1621 L341,1641.1621 L331,1631.1621 L174,1631.1621 " fill="#FFFF00" filter="url(#fgwcdj3xlr102)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M331,1631.1621 L331,1641.1621 L341,1641.1621 L331,1631.1621 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="180" y="1648.7305">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="69" x="196" y="1664.041">"status": 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="196" y="1679.3516">"code": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="196" y="1694.6621">"message": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="180" y="1709.9727">}</text><polygon fill="#A80036" points="96,1744.0254,86,1748.0254,96,1752.0254,92,1748.0254" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="90" x2="354" y1="1748.0254" y2="1748.0254"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="102" y="1743.2832">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103" x="124" y="1743.2832">Respond HTTP -</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="231" y="1743.2832">4xx (Client error)</text><!--
@startuml
title 6.1.2. Close Settlement Window

autonumber

actor "Hub Employee" as OPERATOR
boundary "Settlement Service API" as SSAPI
entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Central HUB" #LightPink
    participant OPERATOR
end box

box "Settlement Service" #LightGreen
    participant SSAPI
    participant SETTLE_DAO
end box

box "Central Services" #LightYellow
    participant DB
end box

group Request closure of Settlement Window
    activate OPERATOR
    note right of OPERATOR #Yellow
        {
            "state": "CLOSED",
            "reason": <string>
        }
    end note

    OPERATOR -> SSAPI: POST - /settlementWindows/{id}
    activate SSAPI
    SSAPI -> SSAPI: Validate payload and requested state
    break
        note right of SSAPI #yellow
            {
                "status": 0, <color #FF0000>**?**</color>
                "code": <integer>,
                "message": "Invalid payload or state"
            }
            <color #FF0000>**OR**</color> what is used in 6.2.5.:
            {
                errorInformation: {
                    "errorCode": <integer>,
                    "errorDescription": "Invalid payload or state"
                }
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 400 (Bad Request)
    end
    SSAPI -> SETTLE_DAO: Get requested settlementWindow and state\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    SETTLE_DAO -> DB: Get settlementWindow state
    activate DB
    hnote over DB #lightyellow
        SELECT sw.settlementWindowId, swsc.settlementWindowStateId
        FROM settlementWindow AS sw
            JOIN (SELECT swsc1.settlementWindowId, 
                            MAX(swsc1.settlementWindowStateChangeId)
                            maxSettlementWindowStateChangeId
                    FROM settlementWindowStateChange AS swsc1
                    WHERE swsc1.settlementWindowId
                    GROUP BY swsc1.settlementWindowId) sws
            ON sws.settlementWindowId = sw.settlementWindowId
        JOIN settlementWindowStateChange AS swsc
        ON swsc.settlementWindowStateChangeId = sws.maxSettlementWindowStateChangeId
        WHERE sw.settlementWindowId = {id}
    end hnote
    deactivate DB
    SETTLE_DAO - -> SSAPI: Return result
    deactivate SETTLE_DAO

    alt 1 row returned && settlementWindowStateId == 'OPEN'
        SSAPI -> SETTLE_DAO: Close current window and open a new one\n<color #FF0000><b>Error code:</b> 2001</color>
        activate SETTLE_DAO
        group <color #blue>DB TRANSACTION</color>
            SETTLE_DAO -> DB: Close requested window
            hnote over DB #LightYellow
                INSERT INTO **settlementWindowStateChange**
                       (settlementWindowId, settlementWindowStateId, reason)
                VALUES ({id}, payload.state, payload.reason)
            end hnote
            deactivate DB

            note right of SETTLE_DAO #lightgray
                let transactionTimestamp = now()
            end note

            SETTLE_DAO -> DB: Create new settlementWindow
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementWindow** (reason, createdDate)
                VALUES (payload.reason, transactionTimestamp)
            end note
            SETTLE_DAO <- - DB: Return @settlementWindowId
            deactivate DB

            SETTLE_DAO -> DB: Insert intial state for the created window
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementWindowStateChange**
                       (settlementWindowId, settlementWindowStateId, reason, createdDate)
                VALUES (@settlementWindowId, 'OPEN', payload.reason, transactionTimestamp)
            end note
            deactivate DB
            deactivate DB
        end
        SSAPI <- - SETTLE_DAO: Return success
        deactivate SETTLE_DAO

        note left of SSAPI #yellow
            {
                "id": 0,
                "reason": "string",
                "state": "string",
                "createdDate": "string",
                "changedDate": "string"
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - <color #FF0000>201 (Created)</color>
    else
        note right of SSAPI #lightgray
            Log ERROR event
        end note
        note left of SSAPI #yellow
            {
                "status": 0,
                "code": <integer>,
                "message": <string>
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - <color #FF0000>4xx (Client error)</color>
        deactivate SSAPI
        deactivate OPERATOR
    end
end
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>