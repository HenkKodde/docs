<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1955.2px" preserveAspectRatio="none" style="width:1928px;height:1955px;" version="1.1" viewBox="0 0 1928 1955" width="1928.8px" zoomAndPan="magnify"><defs><filter height="300%" id="f19bhn5qixnnix" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="1.600000023841858"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="3.200000047683716" dy="3.200000047683716" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="11.2" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="336" x="797.2" y="18.8281">6.2.1. postSettlementEvent POST: /settlementEventTrigger</text><rect fill="#FFB6C1" height="1918.9953" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="89.6" x="23.2" y="27.5906"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="64.8" x="35.6" y="37.6453">Central HUB</text><rect fill="#90EE90" height="1918.9953" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="914" x="419.6" y="27.5906"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="99.2" x="827" y="37.6453">Settlement Service</text><rect fill="#FFFFE0" height="1918.9953" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="217.6" x="1466.4" y="27.5906"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="86.4" x="1532" y="37.6453">Central Services</text><rect fill="#FFFFFF" filter="url(#f19bhn5qixnnix)" height="23.4484" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="481.6" y="363.9563"/><rect fill="#FFFFFF" filter="url(#f19bhn5qixnnix)" height="100.9938" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="481.6" y="1470.3297"/><rect fill="#FFFFFF" filter="url(#f19bhn5qixnnix)" height="152.8844" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="481.6" y="1704.2625"/><rect fill="#FFFFFF" filter="url(#f19bhn5qixnnix)" height="23.4484" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="863.2" y="387.4047"/><rect fill="#FFFFFF" filter="url(#f19bhn5qixnnix)" height="23.4484" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="863.2" y="1446.8813"/><rect fill="#FFFFFF" filter="url(#f19bhn5qixnnix)" height="23.4484" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="863.2" y="1680.8141"/><rect fill="#FFFFFF" filter="url(#f19bhn5qixnnix)" height="1269.961" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1280.8" y="410.8531"/><rect fill="#FFFFFF" filter="url(#f19bhn5qixnnix)" height="24" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1638.4" y="446.3016"/><rect fill="#FFFFFF" filter="url(#f19bhn5qixnnix)" height="24" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1638.4" y="532.6469"/><rect fill="#FFFFFF" filter="url(#f19bhn5qixnnix)" height="1740.3657" style="stroke: #000000; stroke-width: 1.600000023841858;" width="1909.6" x="10.4" y="123.4297"/><rect fill="#FFFFFF" filter="url(#f19bhn5qixnnix)" height="116.4422" style="stroke: #000000; stroke-width: 1.600000023841858;" width="308" x="1223.2" y="608.0406"/><rect fill="#FFFFFF" filter="url(#f19bhn5qixnnix)" height="59.9453" style="stroke: #000000; stroke-width: 1.600000023841858;" width="292" x="1231.2" y="658.9375"/><rect fill="#FFFFFF" filter="url(#f19bhn5qixnnix)" height="922.7313" style="stroke: #000000; stroke-width: 1.600000023841858;" width="1893.6" x="18.4" y="735.6828"/><rect fill="#FFFFFF" filter="url(#f19bhn5qixnnix)" height="657.3859" style="stroke: #000000; stroke-width: 1.600000023841858;" width="672.8" x="1231.2" y="755.1313"/><rect fill="#FFFFFF" height="240.2969" style="stroke: none; stroke-width: 0.800000011920929;" width="1893.6" x="18.4" y="1418.1172"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 5.0,5.0;" x1="68" x2="68" y1="109.8297" y2="1877.3953"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 5.0,5.0;" x1="485.2" x2="485.2" y1="109.8297" y2="1877.3953"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 5.0,5.0;" x1="866.8" x2="866.8" y1="109.8297" y2="1877.3953"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 5.0,5.0;" x1="961.2" x2="961.2" y1="109.8297" y2="1877.3953"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 5.0,5.0;" x1="1055.6" x2="1055.6" y1="109.8297" y2="1877.3953"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 5.0,5.0;" x1="1284.8" x2="1284.8" y1="109.8297" y2="1877.3953"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 5.0,5.0;" x1="1523.2" x2="1523.2" y1="109.8297" y2="1877.3953"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 5.0,5.0;" x1="1642.4" x2="1642.4" y1="109.8297" y2="1877.3953"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="78.4" x="26.4" y="107.4672">Hub Employee</text><ellipse cx="68" cy="51.0391" fill="#FEFECE" filter="url(#f19bhn5qixnnix)" rx="6.4" ry="6.4" style="stroke: #A80036; stroke-width: 1.600000023841858;"/><path d="M68,57.4391 L68,79.0391 M57.6,63.8391 L78.4,63.8391 M68,79.0391 L57.6,91.0391 M68,79.0391 L78.4,91.0391 " fill="none" filter="url(#f19bhn5qixnnix)" style="stroke: #A80036; stroke-width: 1.600000023841858;"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="78.4" x="26.4" y="1887.4235">Hub Employee</text><ellipse cx="68" cy="1897.786" fill="#FEFECE" filter="url(#f19bhn5qixnnix)" rx="6.4" ry="6.4" style="stroke: #A80036; stroke-width: 1.600000023841858;"/><path d="M68,1904.186 L68,1925.786 M57.6,1910.586 L78.4,1910.586 M68,1925.786 L57.6,1937.786 M68,1925.786 L78.4,1937.786 " fill="none" filter="url(#f19bhn5qixnnix)" style="stroke: #A80036; stroke-width: 1.600000023841858;"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="120.8" x="422.8" y="107.4672">Settlement Service API</text><path d="M469.2,74.2391 L469.2,93.4391 M469.2,83.8391 L482.8,83.8391 " fill="none" filter="url(#f19bhn5qixnnix)" style="stroke: #A80036; stroke-width: 1.600000023841858;"/><ellipse cx="492.4" cy="83.8391" fill="#FEFECE" filter="url(#f19bhn5qixnnix)" rx="9.6" ry="9.6" style="stroke: #A80036; stroke-width: 1.600000023841858;"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="120.8" x="422.8" y="1887.4235">Settlement Service API</text><path d="M469.2,1892.986 L469.2,1912.186 M469.2,1902.586 L482.8,1902.586 " fill="none" filter="url(#f19bhn5qixnnix)" style="stroke: #A80036; stroke-width: 1.600000023841858;"/><ellipse cx="492.4" cy="1902.586" fill="#FEFECE" filter="url(#f19bhn5qixnnix)" rx="9.6" ry="9.6" style="stroke: #A80036; stroke-width: 1.600000023841858;"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="58.4" x="835.6" y="107.4672">Settlement</text><ellipse cx="867.2" cy="83.8391" fill="#FEFECE" filter="url(#f19bhn5qixnnix)" rx="9.6" ry="9.6" style="stroke: #A80036; stroke-width: 1.600000023841858;"/><polygon fill="#A80036" points="864,74.2391,868.8,70.2391,867.2,74.2391,868.8,78.2391,864,74.2391" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="58.4" x="835.6" y="1887.4235">Settlement</text><ellipse cx="867.2" cy="1902.586" fill="#FEFECE" filter="url(#f19bhn5qixnnix)" rx="9.6" ry="9.6" style="stroke: #A80036; stroke-width: 1.600000023841858;"/><polygon fill="#A80036" points="864,1892.986,868.8,1888.986,867.2,1892.986,868.8,1896.986,864,1892.986" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="104.8" x="906.8" y="107.4672">Settlement Window</text><ellipse cx="961.6" cy="83.8391" fill="#FEFECE" filter="url(#f19bhn5qixnnix)" rx="9.6" ry="9.6" style="stroke: #A80036; stroke-width: 1.600000023841858;"/><polygon fill="#A80036" points="958.4,74.2391,963.2,70.2391,961.6,74.2391,963.2,78.2391,958.4,74.2391" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="104.8" x="906.8" y="1887.4235">Settlement Window</text><ellipse cx="961.6" cy="1902.586" fill="#FEFECE" filter="url(#f19bhn5qixnnix)" rx="9.6" ry="9.6" style="stroke: #A80036; stroke-width: 1.600000023841858;"/><polygon fill="#A80036" points="958.4,1892.986,963.2,1888.986,961.6,1892.986,963.2,1896.986,958.4,1892.986" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="58.4" x="1024.4" y="107.4672">Participant</text><ellipse cx="1056" cy="83.8391" fill="#FEFECE" filter="url(#f19bhn5qixnnix)" rx="9.6" ry="9.6" style="stroke: #A80036; stroke-width: 1.600000023841858;"/><polygon fill="#A80036" points="1052.8,74.2391,1057.6,70.2391,1056,74.2391,1057.6,78.2391,1052.8,74.2391" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="58.4" x="1024.4" y="1887.4235">Participant</text><ellipse cx="1056" cy="1902.586" fill="#FEFECE" filter="url(#f19bhn5qixnnix)" rx="9.6" ry="9.6" style="stroke: #A80036; stroke-width: 1.600000023841858;"/><polygon fill="#A80036" points="1052.8,1892.986,1057.6,1888.986,1056,1892.986,1057.6,1896.986,1052.8,1892.986" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="86.4" x="1239.2" y="107.4672">Settlement DAO</text><ellipse cx="1284.8" cy="83.8391" fill="#FEFECE" filter="url(#f19bhn5qixnnix)" rx="9.6" ry="9.6" style="stroke: #A80036; stroke-width: 1.600000023841858;"/><line style="stroke: #A80036; stroke-width: 1.600000023841858;" x1="1275.2" x2="1294.4" y1="95.0391" y2="95.0391"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="86.4" x="1239.2" y="1887.4235">Settlement DAO</text><ellipse cx="1284.8" cy="1902.586" fill="#FEFECE" filter="url(#f19bhn5qixnnix)" rx="9.6" ry="9.6" style="stroke: #A80036; stroke-width: 1.600000023841858;"/><line style="stroke: #A80036; stroke-width: 1.600000023841858;" x1="1275.2" x2="1294.4" y1="1913.786" y2="1913.786"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="102.4" x="1469.6" y="107.4672">Central Service API</text><path d="M1506.8,74.2391 L1506.8,93.4391 M1506.8,83.8391 L1520.4,83.8391 " fill="none" filter="url(#f19bhn5qixnnix)" style="stroke: #A80036; stroke-width: 1.600000023841858;"/><ellipse cx="1530" cy="83.8391" fill="#FEFECE" filter="url(#f19bhn5qixnnix)" rx="9.6" ry="9.6" style="stroke: #A80036; stroke-width: 1.600000023841858;"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="102.4" x="1469.6" y="1887.4235">Central Service API</text><path d="M1506.8,1892.986 L1506.8,1912.186 M1506.8,1902.586 L1520.4,1902.586 " fill="none" filter="url(#f19bhn5qixnnix)" style="stroke: #A80036; stroke-width: 1.600000023841858;"/><ellipse cx="1530" cy="1902.586" fill="#FEFECE" filter="url(#f19bhn5qixnnix)" rx="9.6" ry="9.6" style="stroke: #A80036; stroke-width: 1.600000023841858;"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="72" x="1604" y="107.4672">Central Store</text><path d="M1628,67.8391 C1628,59.8391 1642.4,59.8391 1642.4,59.8391 C1642.4,59.8391 1656.8,59.8391 1656.8,67.8391 L1656.8,88.6391 C1656.8,96.6391 1642.4,96.6391 1642.4,96.6391 C1642.4,96.6391 1628,96.6391 1628,88.6391 L1628,67.8391 " fill="#FEFECE" filter="url(#f19bhn5qixnnix)" style="stroke: #000000; stroke-width: 1.2000000178813934;"/><path d="M1628,67.8391 C1628,75.8391 1642.4,75.8391 1642.4,75.8391 C1642.4,75.8391 1656.8,75.8391 1656.8,67.8391 " fill="none" style="stroke: #000000; stroke-width: 1.2000000178813934;"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="72" x="1604" y="1887.4235">Central Store</text><path d="M1628,1897.786 C1628,1889.786 1642.4,1889.786 1642.4,1889.786 C1642.4,1889.786 1656.8,1889.786 1656.8,1897.786 L1656.8,1918.586 C1656.8,1926.586 1642.4,1926.586 1642.4,1926.586 C1642.4,1926.586 1628,1926.586 1628,1918.586 L1628,1897.786 " fill="#FEFECE" filter="url(#f19bhn5qixnnix)" style="stroke: #000000; stroke-width: 1.2000000178813934;"/><path d="M1628,1897.786 C1628,1905.786 1642.4,1905.786 1642.4,1905.786 C1642.4,1905.786 1656.8,1905.786 1656.8,1897.786 " fill="none" style="stroke: #000000; stroke-width: 1.2000000178813934;"/><rect fill="#FFFFFF" filter="url(#f19bhn5qixnnix)" height="23.4484" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="481.6" y="363.9563"/><rect fill="#FFFFFF" filter="url(#f19bhn5qixnnix)" height="100.9938" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="481.6" y="1470.3297"/><rect fill="#FFFFFF" filter="url(#f19bhn5qixnnix)" height="152.8844" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="481.6" y="1704.2625"/><rect fill="#FFFFFF" filter="url(#f19bhn5qixnnix)" height="23.4484" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="863.2" y="387.4047"/><rect fill="#FFFFFF" filter="url(#f19bhn5qixnnix)" height="23.4484" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="863.2" y="1446.8813"/><rect fill="#FFFFFF" filter="url(#f19bhn5qixnnix)" height="23.4484" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="863.2" y="1680.8141"/><rect fill="#FFFFFF" filter="url(#f19bhn5qixnnix)" height="1269.961" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1280.8" y="410.8531"/><rect fill="#FFFFFF" filter="url(#f19bhn5qixnnix)" height="24" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1638.4" y="446.3016"/><rect fill="#FFFFFF" filter="url(#f19bhn5qixnnix)" height="24" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1638.4" y="532.6469"/><path d="M10.4,123.4297 L181.6,123.4297 L181.6,129.0297 L173.6,137.0297 L10.4,137.0297 L10.4,123.4297 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.800000011920929;"/><rect fill="none" height="1740.3657" style="stroke: #000000; stroke-width: 1.600000023841858;" width="1909.6" x="10.4" y="123.4297"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135.2" x="22.4" y="134.2844">Trigger Settlement Event</text><path d="M72,141.2781 L72,308.4781 L211.2,308.4781 L211.2,149.2781 L203.2,141.2781 L72,141.2781 " fill="#FFFF00" filter="url(#f19bhn5qixnnix)" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><path d="M203.2,141.2781 L203.2,149.2781 L211.2,149.2781 L203.2,141.2781 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="119.2" x="76.8" y="155.3328">settlementEventPayload</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="76.8" y="167.5813">{</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="87.2" x="83.2" y="179.8297">"settlementId": 0,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="88.8" x="83.2" y="192.0781">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="116" x="83.2" y="204.3266">"settlementWindows": [</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="89.6" y="216.575">{</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="33.6" x="96" y="228.8234">"id": 1,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="6.4" x="89.6" y="241.0719">},</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="89.6" y="253.3203">{</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="33.6" x="96" y="265.5688">"id": 2,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="89.6" y="277.8172">}</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="83.2" y="290.0656">]</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="76.8" y="302.3141">}</text><path d="M72,319.7078 L72,339.7078 L347.2,339.7078 L347.2,327.7078 L339.2,319.7078 L72,319.7078 " fill="#D3D3D3" filter="url(#f19bhn5qixnnix)" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><path d="M339.2,319.7078 L339.2,327.7078 L347.2,327.7078 L339.2,319.7078 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="258.4" x="76.8" y="333.7625">verify if we need the rest of the Swagger messages?</text><polygon fill="#A80036" points="472,360.7563,480,363.9563,472,367.1563,475.2,363.9563" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="68" x2="476.8" y1="363.9563" y2="363.9563"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7.2" x="73.6" y="360.4109">1</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="282.4" x="84" y="360.4109">API call Settlement Service to request a settlement event</text><polygon fill="#A80036" points="853.6,384.2047,861.6,387.4047,853.6,390.6047,856.8,387.4047" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="485.6" x2="858.4" y1="387.4047" y2="387.4047"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7.2" x="491.2" y="383.8594">2</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="112" x="501.6" y="383.8594">Create new settlement</text><polygon fill="#A80036" points="1271.2,407.6531,1279.2,410.8531,1271.2,414.0531,1274.4,410.8531" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="867.2" x2="1276" y1="410.8531" y2="410.8531"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7.2" x="872.8" y="407.3078">3</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="115.2" x="883.2" y="407.3078">Initiate new settlement</text><polygon fill="#A80036" points="1628.8,443.1016,1636.8,446.3016,1628.8,449.5016,1632,446.3016" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="1288.8" x2="1633.6" y1="446.3016" y2="446.3016"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7.2" x="1294.4" y="436.8805">4</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="108.8" x="1304.8" y="430.7563">Insert new settlement</text><text fill="#FF0000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="58.4" x="1304.8" y="443.0047">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="25.6" x="1366.4" y="443.0047">2001</text><polygon fill="#FFFFE0" filter="url(#f19bhn5qixnnix)" points="1613.6,481.1984,1670.4,481.1984,1678.4,489.9984,1670.4,499.5984,1613.6,499.5984,1605.6,489.9984,1613.6,481.1984" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="53.6" x="1615.2" y="494.4531">settlement</text><polygon fill="#A80036" points="1628.8,529.4469,1636.8,532.6469,1628.8,535.8469,1632,532.6469" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="1288.8" x2="1633.6" y1="532.6469" y2="532.6469"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7.2" x="1294.4" y="523.2258">5</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="168.8" x="1304.8" y="517.1016">Get settlementWindow(s) from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="58.4" x="1304.8" y="529.35">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="25.6" x="1366.4" y="529.35">2001</text><polygon fill="#FFFFE0" filter="url(#f19bhn5qixnnix)" points="1563.2,567.5438,1721.6,567.5438,1729.6,582.7438,1721.6,597.9438,1563.2,597.9438,1555.2,582.7438,1563.2,567.5438" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="92.8" x="1564.8" y="580.7984">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="155.2" x="1564.8" y="593.0469">settlementWindowStateChange</text><path d="M1223.2,608.0406 L1468,608.0406 L1468,613.6406 L1460,621.6406 L1223.2,621.6406 L1223.2,608.0406 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.800000011920929;"/><rect fill="none" height="116.4422" style="stroke: #000000; stroke-width: 1.600000023841858;" width="308" x="1223.2" y="608.0406"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="208.8" x="1235.2" y="618.8953">Validate the list of settlement windows</text><path d="M1292.8,625.8891 L1292.8,645.8891 L1488.8,645.8891 L1488.8,633.8891 L1480.8,625.8891 L1292.8,625.8891 " fill="#D3D3D3" filter="url(#f19bhn5qixnnix)" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><path d="M1480.8,625.8891 L1480.8,633.8891 L1488.8,633.8891 L1480.8,625.8891 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="179.2" x="1297.6" y="639.9438">allSettlementWindowsClosed = true</text><path d="M1231.2,658.9375 L1290.4,658.9375 L1290.4,664.5375 L1282.4,672.5375 L1231.2,672.5375 L1231.2,658.9375 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.800000011920929;"/><rect fill="none" height="59.9453" style="stroke: #000000; stroke-width: 1.600000023841858;" width="292" x="1231.2" y="658.9375"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="23.2" x="1243.2" y="669.7922">loop</text><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="1288.8" x2="1322.4" y1="702.0828" y2="702.0828"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="1322.4" x2="1322.4" y1="702.0828" y2="712.4828"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="1289.6" x2="1322.4" y1="712.4828" y2="712.4828"/><polygon fill="#A80036" points="1297.6,709.2828,1289.6,712.4828,1297.6,715.6828,1294.4,712.4828" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7.2" x="1294.4" y="692.1649">6</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="200" x="1304.8" y="686.0406">if settlementWindowStateId != 'CLOSED'</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="208.8" x="1304.8" y="698.2891">then allSettlementWindowsClosed = false</text><path d="M18.4,735.6828 L68,735.6828 L68,741.2828 L60,749.2828 L18.4,749.2828 L18.4,735.6828 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.800000011920929;"/><rect fill="none" height="922.7313" style="stroke: #000000; stroke-width: 1.600000023841858;" width="1893.6" x="18.4" y="735.6828"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="13.6" x="30.4" y="746.5375">alt</text><text fill="#000000" font-family="sans-serif" font-size="8.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="172.8" x="80" y="745.7906">[allSettlementWindowsClosed == true]</text><path d="M1231.2,755.1313 L1363.2,755.1313 L1363.2,760.7313 L1355.2,768.7313 L1231.2,768.7313 L1231.2,755.1313 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.800000011920929;"/><rect fill="none" height="657.3859" style="stroke: #000000; stroke-width: 1.600000023841858;" width="672.8" x="1231.2" y="755.1313"/><text fill="#0000FF" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="96" x="1243.2" y="765.9859">DB TRANSACTION</text><polygon fill="#A80036" points="1632.8,782.5797,1640.8,785.7797,1632.8,788.9797,1636,785.7797" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="1288.8" x2="1637.6" y1="785.7797" y2="785.7797"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7.2" x="1294.4" y="782.2344">7</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="182.4" x="1304.8" y="782.2344">Insert the list of settlementWindows</text><polygon fill="#FFFFE0" filter="url(#f19bhn5qixnnix)" points="1567.2,796.4281,1716.8,796.4281,1724.8,805.2281,1716.8,814.8281,1567.2,814.8281,1559.2,805.2281,1567.2,796.4281" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="146.4" x="1568.8" y="809.6828">settlementSettlementWindow</text><polygon fill="#A80036" points="1632.8,832.6766,1640.8,835.8766,1632.8,839.0766,1636,835.8766" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="1288.8" x2="1637.6" y1="835.8766" y2="835.8766"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7.2" x="1294.4" y="832.3313">8</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="304" x="1304.8" y="832.3313">Populate settlementTransferParticipant with aggregated data</text><polygon fill="#FFFFE0" filter="url(#f19bhn5qixnnix)" points="1396,846.525,1888,846.525,1896,928.925,1888,1012.125,1396,1012.125,1388,928.925,1396,846.525" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="64" x="1397.6" y="859.7797">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="162.4" x="1464.8" y="859.7797">settlementTransferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="488.8" x="1397.6" y="872.0281">SELECT payload.settlementId AS settlementId, tp.participantCurrencyId, tp.participantRoleTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="248" x="1410.4" y="884.2766">tp.ledgerEntryTypeId, SUM(tp.amount) AS amount</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="28.8" x="1397.6" y="896.525">FROM</text><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97.6" x="1429.6" y="896.525">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="24" x="1530.4" y="896.525">AS tf</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="22.4" x="1397.6" y="908.7735">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="111.2" x="1423.2" y="908.7735">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="31.2" x="1537.6" y="908.7735">AS tsc</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="357.6" x="1397.6" y="921.0219">ON tsc.transferId = tf.transferId AND tsc.transferStateId = 'COMMITED'</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="22.4" x="1397.6" y="933.2703">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101.6" x="1423.2" y="933.2703">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="26.4" x="1528" y="933.2703">AS tp</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="156" x="1397.6" y="945.5188">ON tp.transferId = tf.transferId</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="172" x="1397.6" y="957.7672">WHERE tf.settlementWindowId IN (</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="141.6" x="1410.4" y="970.0156">SELECT settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="28.8" x="1410.4" y="982.2641">FROM</text><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="164" x="1442.4" y="982.2641">settlementSettelementWindow</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="224" x="1410.4" y="994.5125">WHERE settlementId = payload.settlementId)</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="415.2" x="1397.6" y="1006.761">GROUP BY tp.participantCurrencyId, tp.participantRoleTypeId, tp.ledgerEntryTypeId</text><polygon fill="#A80036" points="1632.8,1029.7547,1640.8,1032.9547,1632.8,1036.1547,1636,1032.9547" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="1288.8" x2="1637.6" y1="1032.9547" y2="1032.9547"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7.2" x="1294.4" y="1029.4094">9</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="209.6" x="1304.8" y="1029.4094">Insert netAmount per participantCurrency</text><polygon fill="#FFFFE0" filter="url(#f19bhn5qixnnix)" points="1471.2,1043.6031,1812.8,1043.6031,1820.8,1095.6031,1812.8,1147.6031,1471.2,1147.6031,1463.2,1095.6031,1471.2,1043.6031" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="64" x="1472.8" y="1056.8578">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="165.6" x="1540" y="1056.8578">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="220.8" x="1472.8" y="1069.1063">SELECT settlementId, participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="325.6" x="1485.6" y="1081.3547">SUM(CASE WHEN 'PAYER_DFSP', 'PRINCIPLE_VALUE' THEN amount</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="277.6" x="1514.4" y="1093.6031">WHEN 'PAYEE_DFSP', 'PRINCIPLE_VALUE' THEN -amount</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="216" x="1514.4" y="1105.8516">WHEN 'INTERCHANGE_FEE' THEN -amount)</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="180.8" x="1472.8" y="1118.1">FROM settlementTransferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="220.8" x="1472.8" y="1130.3485">WHERE settlementId = payload.settlementId</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="231.2" x="1472.8" y="1142.5969">GROUP BY settlementId, participantCurrencyId</text><polygon fill="#A80036" points="1632.8,1165.5906,1640.8,1168.7906,1632.8,1171.9906,1636,1168.7906" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="1288.8" x2="1637.6" y1="1168.7906" y2="1168.7906"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="1294.4" y="1165.2453">10</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="207.2" x="1312" y="1165.2453">Insert initial state change 'NOT_SETTLED'</text><polygon fill="#FFFFE0" filter="url(#f19bhn5qixnnix)" points="1457.6,1179.4391,1826.4,1179.4391,1834.4,1206.6391,1826.4,1234.6391,1457.6,1234.6391,1449.6,1206.6391,1457.6,1179.4391" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="64" x="1459.2" y="1192.6938">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="233.6" x="1526.4" y="1192.6938">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="365.6" x="1459.2" y="1204.9422">SELECT settlementParticipantCurrencyId, 'NOT_SETTLED', payload.reason</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="184" x="1459.2" y="1217.1906">FROM settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="220.8" x="1459.2" y="1229.4391">WHERE settlementId = payload.settlementId</text><polygon fill="#A80036" points="1632.8,1252.4328,1640.8,1255.6328,1632.8,1258.8328,1636,1255.6328" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="1288.8" x2="1637.6" y1="1255.6328" y2="1255.6328"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="1294.4" y="1252.0875">11</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="242.4" x="1312" y="1252.0875">Insert initial state for settlement 'NOT_SETTLED'</text><polygon fill="#FFFFE0" filter="url(#f19bhn5qixnnix)" points="1507.2,1266.2813,1777.6,1266.2813,1785.6,1293.4813,1777.6,1321.4813,1507.2,1321.4813,1499.2,1293.4813,1507.2,1266.2813" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="64" x="1508.8" y="1279.536">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125.6" x="1576" y="1279.536">settlementStateChange</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="267.2" x="1508.8" y="1291.7844">SELECT settlementId, 'NOT_SETTLED', payload.reason</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="184" x="1508.8" y="1304.0328">FROM settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="220.8" x="1508.8" y="1316.2813">WHERE settlementId = payload.settlementId</text><polygon fill="#A80036" points="1632.8,1339.275,1640.8,1342.475,1632.8,1345.675,1636,1342.475" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="1288.8" x2="1637.6" y1="1342.475" y2="1342.475"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="1294.4" y="1338.9297">12</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="316.8" x="1312" y="1338.9297">Insert new state for settlementWindow 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#f19bhn5qixnnix)" points="1484.8,1353.1235,1799.2,1353.1235,1807.2,1380.3235,1799.2,1408.3235,1484.8,1408.3235,1476.8,1380.3235,1484.8,1353.1235" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="64" x="1486.4" y="1366.3781">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="168" x="1553.6" y="1366.3781">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="311.2" x="1486.4" y="1378.6266">SELECT settlementId, 'PENDING_SETTLEMENT', payload.reason</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="184" x="1486.4" y="1390.875">FROM settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="220.8" x="1486.4" y="1403.1235">WHERE settlementId = payload.settlementId</text><line style="stroke: #000000; stroke-width: 0.800000011920929; stroke-dasharray: 2.0,2.0;" x1="18.4" x2="1912" y1="1418.9172" y2="1418.9172"/><text fill="#000000" font-family="sans-serif" font-size="8.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="176.8" x="22.4" y="1427.425">[allSettlementWindowsClosed == false]</text><polygon fill="#A80036" points="880,1443.6813,872,1446.8813,880,1450.0813,876.8,1446.8813" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="875.2" x2="1280" y1="1446.8813" y2="1446.8813"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="884.8" y="1443.336">13</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="236" x="902.4" y="1443.336">settlementWindows not closed - Return ERROR</text><polygon fill="#A80036" points="498.4,1467.1297,490.4,1470.3297,498.4,1473.5297,495.2,1470.3297" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="493.6" x2="866.4" y1="1470.3297" y2="1470.3297"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="503.2" y="1466.7844">14</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="68.8" x="520.8" y="1466.7844">Return ERROR</text><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="489.6" x2="523.2" y1="1494.0266" y2="1494.0266"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="523.2" x2="523.2" y1="1494.0266" y2="1504.4266"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="490.4" x2="523.2" y1="1504.4266" y2="1504.4266"/><polygon fill="#A80036" points="498.4,1501.2266,490.4,1504.4266,498.4,1507.6266,495.2,1504.4266" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="495.2" y="1490.2328">15</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="84.8" x="512.8" y="1490.2328">Update Event log</text><path d="M493.6,1514.8266 L493.6,1546.8266 L659.2,1546.8266 L659.2,1522.8266 L651.2,1514.8266 L493.6,1514.8266 " fill="#ADD8E6" filter="url(#f19bhn5qixnnix)" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><path d="M651.2,1514.8266 L651.2,1522.8266 L659.2,1522.8266 L651.2,1514.8266 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="109.6" x="498.4" y="1528.8813">Log ERROR Messages.</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="148.8" x="498.4" y="1541.1297">Update Event log with ERROR.</text><polygon fill="#A80036" points="76.8,1568.1235,68.8,1571.3235,76.8,1574.5235,73.6,1571.3235" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="72" x2="484.8" y1="1571.3235" y2="1571.3235"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="81.6" y="1567.7781">16</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="68.8" x="99.2" y="1567.7781">Return ERROR</text><path d="M243.2,1581.9719 L243.2,1650.7719 L478.4,1650.7719 L478.4,1589.9719 L470.4,1581.9719 L243.2,1581.9719 " fill="#FFFF00" filter="url(#f19bhn5qixnnix)" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><path d="M470.4,1581.9719 L470.4,1589.9719 L478.4,1589.9719 L470.4,1581.9719 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="248" y="1596.0266">{</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="55.2" x="254.4" y="1608.275">"status": 0,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="212" x="254.4" y="1620.5235">"code": "MISSING_REQUIRED_PARAMETER",</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="96" x="254.4" y="1632.7719">"message": "string"</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="248" y="1645.0203">}</text><polygon fill="#A80036" points="880,1677.6141,872,1680.8141,880,1684.0141,876.8,1680.8141" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="875.2" x2="1284" y1="1680.8141" y2="1680.8141"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="884.8" y="1677.2688">17</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="376.8" x="902.4" y="1677.2688">Results for participant netAmount per ledger for closed settlement window</text><polygon fill="#A80036" points="498.4,1701.0625,490.4,1704.2625,498.4,1707.4625,495.2,1704.2625" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="493.6" x2="866.4" y1="1704.2625" y2="1704.2625"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="503.2" y="1700.7172">18</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="340.8" x="520.8" y="1700.7172">Results for participant netAmount per ledger for settlement window</text><path d="M285.6,1714.911 L285.6,1832.511 L474.4,1832.511 L474.4,1722.911 L466.4,1714.911 L285.6,1714.911 " fill="#FFFF00" filter="url(#f19bhn5qixnnix)" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><path d="M466.4,1714.911 L466.4,1722.911 L474.4,1722.911 L466.4,1714.911 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="290.4" y="1728.9657">{</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="64.8" x="296.8" y="1741.2141">"id": "string",</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="88.8" x="296.8" y="1753.4625">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="165.6" x="296.8" y="1765.711">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="127.2" x="296.8" y="1777.9594">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="62.4" x="303.2" y="1790.2078">"amount": 0,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="95.2" x="303.2" y="1802.4563">"currency": "string"</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="296.8" y="1814.7047">}</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="290.4" y="1826.9532">}</text><polygon fill="#A80036" points="76.8,1853.9469,68.8,1857.1469,76.8,1860.3469,73.6,1857.1469" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="72" x2="484.8" y1="1857.1469" y2="1857.1469"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="81.6" y="1853.6016">19</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="376.8" x="99.2" y="1853.6016">Results for participant netAmount per ledger for closed settlement window</text><!--
@startuml
title 6.2.1. postSettlementEvent POST: /settlementEventTrigger

autonumber



actor "Hub Employee" as OPERATOR

boundary "Settlement Service API" as SSAPI
control "Settlement" as SETTLEMENT
control "Settlement Window" as SETTLEWINDOW
control "Participant" as PARTICIPANT
entity "Settlement DAO" as SETTLE_DAO

boundary "Central Service API" as CSAPI
database "Central Store" as DB

box "Central HUB" #LightPink
    participant OPERATOR
end box

box "Settlement Service" #LightGreen
    participant SSAPI
    participant SETTLEMENT
    participant SETTLEWINDOW
    participant PARTICIPANT
    participant SETTLE_DAO
end box

box "Central Services" #LightYellow
    participant CSAPI
    participant DB
end box


group Trigger Settlement Event
    note right of OPERATOR #Yellow
        settlementEventPayload
        {
          "settlementId": 0,
          "reason": "string",
          "settlementWindows": [
            {
              "id": 1,
            },
            {
              "id": 2,
            }
          ]
        }
    end note
    note right of OPERATOR #LightGray
        verify if we need the rest of the Swagger messages?
    end note
    OPERATOR -> SSAPI: API call Settlement Service to request a settlement event
    activate SSAPI
    SSAPI-> SETTLEMENT: Create new settlement
    deactivate SSAPI
    activate SETTLEMENT
    SETTLEMENT -> SETTLE_DAO: Initiate new settlement
    deactivate SETTLEMENT
    activate SETTLE_DAO

    SETTLE_DAO -> DB: Insert new settlement \n<color #FF0000><b>Error code:</b> 2001</color>
    activate DB
    hnote over DB #LightYellow
        settlement
    end hnote
    deactivate DB
    deactivate SETTLEMENT
    SETTLE_DAO -> DB: Get settlementWindow(s) from DB \n<color #FF0000><b>Error code:</b> 2001</color>
    activate DB
    hnote over DB #LightYellow
        settlementWindow
        settlementWindowStateChange
    end hnote
    deactivate DB
    group Validate the list of settlement windows
        note right of SETTLE_DAO #LightGray
            allSettlementWindowsClosed = true
        end note
        loop
            SETTLE_DAO <-> SETTLE_DAO: if settlementWindowStateId != 'CLOSED' \nthen allSettlementWindowsClosed = false
        end loop
    end
    alt allSettlementWindowsClosed == true
        group <color #blue>DB TRANSACTION</color>
            SETTLE_DAO -> DB: Insert the list of settlementWindows
            hnote over DB #LightYellow
                settlementSettlementWindow
            end hnote
            SETTLE_DAO -> DB: Populate settlementTransferParticipant with aggregated data
            hnote over DB #LightYellow
                INSERT INTO **settlementTransferParticipant**
                SELECT payload.settlementId AS settlementId, tp.participantCurrencyId, tp.participantRoleTypeId,
                    tp.ledgerEntryTypeId, SUM(tp.amount) AS amount
                FROM **transferFulfilment** AS tf
                JOIN **transferStateChange** AS tsc
                ON tsc.transferId = tf.transferId AND tsc.transferStateId = 'COMMITED'
                JOIN **transferParticipant** AS tp
                ON tp.transferId = tf.transferId
                WHERE tf.settlementWindowId IN (
                    SELECT settlementWindowId
                    FROM **settlementSettelementWindow**
                    WHERE settlementId = payload.settlementId)
                GROUP BY tp.participantCurrencyId, tp.participantRoleTypeId, tp.ledgerEntryTypeId
            end hnote

            SETTLE_DAO -> DB: Insert netAmount per participantCurrency
            hnote over DB #LightYellow
                INSERT INTO **settlementParticipantCurrency**
                SELECT settlementId, participantCurrencyId,
                    SUM(CASE WHEN 'PAYER_DFSP', 'PRINCIPLE_VALUE' THEN amount
                             WHEN 'PAYEE_DFSP', 'PRINCIPLE_VALUE' THEN -amount
                             WHEN 'INTERCHANGE_FEE' THEN -amount)
                FROM settlementTransferParticipant
                WHERE settlementId = payload.settlementId
                GROUP BY settlementId, participantCurrencyId
            end hnote

            SETTLE_DAO -> DB: Insert initial state change 'NOT_SETTLED'
            hnote over DB #LightYellow
                INSERT INTO **settlementParticipantCurrencyStateChange**
                SELECT settlementParticipantCurrencyId, 'NOT_SETTLED', payload.reason
                FROM settlementParticipantCurrency
                WHERE settlementId = payload.settlementId
            end hnote

            SETTLE_DAO -> DB: Insert initial state for settlement 'NOT_SETTLED'
            hnote over DB #LightYellow
                INSERT INTO **settlementStateChange**
                SELECT settlementId, 'NOT_SETTLED', payload.reason
                FROM settlementParticipantCurrency
                WHERE settlementId = payload.settlementId
            end hnote

            SETTLE_DAO -> DB: Insert new state for settlementWindow 'PENDING_SETTLEMENT'
            hnote over DB #LightYellow
                INSERT INTO **settlementWindowStateChange**
                SELECT settlementId, 'PENDING_SETTLEMENT', payload.reason
                FROM settlementParticipantCurrency
                WHERE settlementId = payload.settlementId
            end hnote
        end

    else allSettlementWindowsClosed == false
        SETTLE_DAO -> SETTLEMENT: settlementWindows not closed - Return ERROR
        activate SETTLEMENT
        SETTLEMENT -> SSAPI: Return ERROR
        deactivate SETTLEMENT
        activate SSAPI
        SSAPI <-> SSAPI: Update Event log
        note right of SSAPI #LightBlue
            Log ERROR Messages.
            Update Event log with ERROR.
            end note
        OPERATOR <- SSAPI: Return ERROR
        note left of SSAPI #Yellow
            {
              "status": 0,
              "code": "MISSING_REQUIRED_PARAMETER",
              "message": "string"
            }
        end note
        deactivate SSAPI
    end

    SETTLEMENT <- SETTLE_DAO: Results for participant netAmount per ledger for closed settlement window
    deactivate SETTLE_DAO
    activate SETTLEMENT
    SETTLEMENT -> SSAPI: Results for participant netAmount per ledger for settlement window
    note left of SSAPI #Yellow
        {
          "id": "string",
          "reason": "string",
          "state": "PENDING_SETTLEMENT",
          "netSettlementAmount": {
            "amount": 0,
            "currency": "string"
          }
        }
    end note
    deactivate SETTLEMENT
    activate SSAPI
    SSAPI -> OPERATOR: Results for participant netAmount per ledger for closed settlement window
    deactivate SSAPI
end
@enduml

PlantUML version 1.2018.01(Sun Jan 28 20:08:22 SAST 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_152-release-1136-b29
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: ZA
--></g></svg>