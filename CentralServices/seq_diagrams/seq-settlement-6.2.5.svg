<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="10576px" preserveAspectRatio="none" style="width:1500px;height:10576px;" version="1.1" viewBox="0 0 1500 10576" width="1500px" zoomAndPan="magnify"><defs><filter height="300%" id="fd3oz7vrgavfm" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="342" x="580" y="23.5352">6.2.5. Acknowledgement of Settlement Transfer</text><rect fill="#FFB6C1" height="10530.9082" style="stroke: #A80036; stroke-width: 1.0;" width="112" x="53" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="68.5" y="47.0566">Central HUB</text><rect fill="#90EE90" height="10530.9082" style="stroke: #A80036; stroke-width: 1.0;" width="656.5" x="209.5" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="475.75" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="10530.9082" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="1085" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="1088" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="10322.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="104" y="147.2871"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="9731.0625" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="287" y="730.8457"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="243.7266" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="800" y="775.4668"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="366.2109" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="800" y="1088.125"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="320.2793" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="800" y="1498.957"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="228.416" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="800" y="1863.8574"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="74.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="800" y="8589.625"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="350.9004" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="800" y="8756.1777"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="74.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="800" y="9519.1152"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="185.1055" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1137" y="804.7773"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="307.5898" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1137" y="1117.4355"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="261.6582" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1137" y="1528.2676"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="169.7949" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1137" y="1893.168"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1137" y="8634.2461"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="276.9688" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1137" y="8800.7988"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1137" y="9563.7363"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="10307.6211" style="stroke: #000000; stroke-width: 2.0;" width="1476" x="13" y="154.2871"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="8661.8086" style="stroke: #000000; stroke-width: 2.0;" width="1325.5" x="153.5" y="1034.1934"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="480.7422" style="stroke: #000000; stroke-width: 2.0;" width="578" x="282" y="3401.4961"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="165.1523" style="stroke: #000000; stroke-width: 2.0;" width="351" x="292" y="3710.0859"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="351" x="292" y="3766.707"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="351" x="292" y="3820.9727"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="179.1055" style="stroke: #000000; stroke-width: 2.0;" width="297" x="292" y="3975.8594"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="465.4316" style="stroke: #000000; stroke-width: 2.0;" width="534" x="282" y="4248.5859"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="165.1523" style="stroke: #000000; stroke-width: 2.0;" width="432" x="292" y="4541.8652"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="432" x="292" y="4598.4863"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="432" x="292" y="4652.752"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="3435.0859" style="stroke: #000000; stroke-width: 2.0;" width="977.5" x="163.5" y="5077.6074"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="3318.5332" style="stroke: #000000; stroke-width: 2.0;" width="957.5" x="173.5" y="5187.1602"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="2270.8672" style="stroke: #000000; stroke-width: 2.0;" width="879" x="242" y="5250.7813"/><rect fill="#FFFFFF" height="146.1289" style="stroke: none; stroke-width: 1.0;" width="879" x="242" y="5399.2656"/><rect fill="#FFFFFF" height="1976.2539" style="stroke: none; stroke-width: 1.0;" width="879" x="242" y="5545.3945"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="1947.2988" style="stroke: #000000; stroke-width: 2.0;" width="859" x="252" y="5567.3496"/><rect fill="#FFFFFF" height="568.8926" style="stroke: none; stroke-width: 1.0;" width="859" x="252" y="5807.6973"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="179.1055" style="stroke: #000000; stroke-width: 2.0;" width="618" x="292" y="6190.4844"/><rect fill="#FFFFFF" height="1138.0586" style="stroke: none; stroke-width: 1.0;" width="859" x="252" y="6376.5898"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="102.5527" style="stroke: #000000; stroke-width: 2.0;" width="510" x="292" y="6468.4766"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="922.6191" style="stroke: #000000; stroke-width: 2.0;" width="839" x="262" y="6585.0293"/><rect fill="#FFFFFF" height="758.8242" style="stroke: none; stroke-width: 1.0;" width="839" x="262" y="6748.8242"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="729.8691" style="stroke: #000000; stroke-width: 2.0;" width="819" x="272" y="6770.7793"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="659.248" style="stroke: #000000; stroke-width: 2.0;" width="799" x="282" y="6834.4004"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="102.5527" style="stroke: #000000; stroke-width: 2.0;" width="486" x="292" y="6913.332"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="87.2422" style="stroke: #000000; stroke-width: 2.0;" width="424" x="292" y="7069.1953"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="615.9395" style="stroke: #000000; stroke-width: 2.0;" width="584.5" x="183.5" y="7676.959"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="559.6289" style="stroke: #000000; stroke-width: 2.0;" width="564.5" x="193.5" y="7701.2695"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="450.0977" style="stroke: #000000; stroke-width: 2.0;" width="544.5" x="203.5" y="7778.8008"/><rect fill="#FFFFFF" height="164.4395" style="stroke: none; stroke-width: 1.0;" width="544.5" x="203.5" y="8064.459"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="166.7949" style="stroke: #000000; stroke-width: 2.0;" width="488.5" x="203.5" y="8306.8984"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="185.8633" style="stroke: #000000; stroke-width: 2.0;" width="1114.5" x="193.5" y="8526.6934"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="154.5527" style="stroke: #000000; stroke-width: 2.0;" width="1094.5" x="203.5" y="8551.0039"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="526.9688" style="stroke: #000000; stroke-width: 2.0;" width="1107.5" x="173.5" y="9122.0781"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="195.8633" style="stroke: #000000; stroke-width: 2.0;" width="540.5" x="183.5" y="9204.0098"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="451.5" x="203.5" y="9228.3203"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="90.9316" style="stroke: #000000; stroke-width: 2.0;" width="520.5" x="193.5" y="9301.9414"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="500.5" x="203.5" y="9326.252"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="185.8633" style="stroke: #000000; stroke-width: 2.0;" width="1077.5" x="193.5" y="9456.1836"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="154.5527" style="stroke: #000000; stroke-width: 2.0;" width="1057.5" x="203.5" y="9480.4941"/><rect fill="#FFFFFF" height="39.9551" style="stroke: none; stroke-width: 1.0;" width="1325.5" x="153.5" y="9656.0469"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="109" x2="109" y1="137.2871" y2="10478.9082"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="291.5" x2="291.5" y1="137.2871" y2="10478.9082"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="805" x2="805" y1="137.2871" y2="10478.9082"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1142" x2="1142" y1="137.2871" y2="10478.9082"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="57" y="134.334">Hub Employee</text><ellipse cx="109" cy="63.7988" fill="#FEFECE" filter="url(#fd3oz7vrgavfm)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M109,71.7988 L109,98.7988 M96,79.7988 L122,79.7988 M109,98.7988 L96,113.7988 M109,98.7988 L122,113.7988 " fill="none" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="57" y="10491.4434">Hub Employee</text><ellipse cx="109" cy="10504.3965" fill="#FEFECE" filter="url(#fd3oz7vrgavfm)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M109,10512.3965 L109,10539.3965 M96,10520.3965 L122,10520.3965 M109,10539.3965 L96,10554.3965 M109,10539.3965 L122,10554.3965 " fill="none" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="213.5" y="134.334">Settlement Service API</text><path d="M271.5,92.7988 L271.5,116.7988 M271.5,104.7988 L288.5,104.7988 " fill="none" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="300.5" cy="104.7988" fill="#FEFECE" filter="url(#fd3oz7vrgavfm)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="213.5" y="10491.4434">Settlement Service API</text><path d="M271.5,10498.3965 L271.5,10522.3965 M271.5,10510.3965 L288.5,10510.3965 " fill="none" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="300.5" cy="10510.3965" fill="#FEFECE" filter="url(#fd3oz7vrgavfm)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="748" y="134.334">Settlement DAO</text><ellipse cx="805" cy="104.7988" fill="#FEFECE" filter="url(#fd3oz7vrgavfm)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="793" x2="817" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="748" y="10491.4434">Settlement DAO</text><ellipse cx="805" cy="10510.3965" fill="#FEFECE" filter="url(#fd3oz7vrgavfm)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="793" x2="817" y1="10524.3965" y2="10524.3965"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1094" y="134.334">Central Store</text><path d="M1124,84.7988 C1124,74.7988 1142,74.7988 1142,74.7988 C1142,74.7988 1160,74.7988 1160,84.7988 L1160,110.7988 C1160,120.7988 1142,120.7988 1142,120.7988 C1142,120.7988 1124,120.7988 1124,110.7988 L1124,84.7988 " fill="#FEFECE" filter="url(#fd3oz7vrgavfm)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1124,84.7988 C1124,94.7988 1142,94.7988 1142,94.7988 C1142,94.7988 1160,94.7988 1160,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1094" y="10491.4434">Central Store</text><path d="M1124,10504.3965 C1124,10494.3965 1142,10494.3965 1142,10494.3965 C1142,10494.3965 1160,10494.3965 1160,10504.3965 L1160,10530.3965 C1160,10540.3965 1142,10540.3965 1142,10540.3965 C1142,10540.3965 1124,10540.3965 1124,10530.3965 L1124,10504.3965 " fill="#FEFECE" filter="url(#fd3oz7vrgavfm)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1124,10504.3965 C1124,10514.3965 1142,10514.3965 1142,10514.3965 C1142,10514.3965 1160,10514.3965 1160,10504.3965 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="10322.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="104" y="147.2871"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="9731.0625" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="287" y="730.8457"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="243.7266" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="800" y="775.4668"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="366.2109" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="800" y="1088.125"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="320.2793" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="800" y="1498.957"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="228.416" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="800" y="1863.8574"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="74.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="800" y="8589.625"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="350.9004" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="800" y="8756.1777"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="74.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="800" y="9519.1152"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="185.1055" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1137" y="804.7773"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="307.5898" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1137" y="1117.4355"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="261.6582" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1137" y="1528.2676"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="169.7949" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1137" y="1893.168"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1137" y="8634.2461"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="276.9688" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1137" y="8800.7988"/><rect fill="#FFFFFF" filter="url(#fd3oz7vrgavfm)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1137" y="9563.7363"/><path d="M13,154.2871 L339,154.2871 L339,161.2871 L329,171.2871 L13,171.2871 L13,154.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="10307.6211" style="stroke: #000000; stroke-width: 2.0;" width="1476" x="13" y="154.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="281" x="28" y="167.8555">Acknowledgement of Settlement Transfer</text><path d="M119,176.5977 L119,630.5977 L427,630.5977 L427,186.5977 L417,176.5977 L119,176.5977 " fill="#FFFF00" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M417,176.5977 L417,186.5977 L427,186.5977 L417,176.5977 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="125" y="194.166">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="141" y="209.4766">"participants": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="157" y="224.7871">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="173" y="240.0977">"id": 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="173" y="255.4082">"accounts" : [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="189" y="270.7188">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="205" y="286.0293">"id": 1,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="205" y="301.3398">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="205" y="316.6504">"reason": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="189" y="331.9609">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="189" y="347.2715">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="205" y="362.582">"id": 2,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="205" y="377.8926">"state": "SETTLED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="205" y="393.2031">"reason": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="189" y="408.5137">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="173" y="423.8242">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="157" y="439.1348">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="157" y="454.4453">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="173" y="469.7559">"id": 2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="173" y="485.0664">"accounts" : [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="189" y="500.377">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="205" y="515.6875">"id": 3,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="152" x="205" y="530.998">"state": "NOT_SETTLED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="205" y="546.3086">"reason": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="189" y="561.6191">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="173" y="576.9297">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="157" y="592.2402">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="141" y="607.5508">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="125" y="622.8613">}</text><path d="M119,644.6035 L119,699.6035 L399,699.6035 L399,654.6035 L389,644.6035 L119,644.6035 " fill="#D3D3D3" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M389,644.6035 L389,654.6035 L399,654.6035 L389,644.6035 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="125" y="662.1719">In the sequence diagram below:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="87" x="125" y="677.4824">participantId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="216" y="677.4824">is participants[N].id</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="149" x="125" y="692.793">participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="278" y="692.793">is accounts[N].id</text><polygon fill="#A80036" points="275,726.8457,285,730.8457,275,734.8457,279,730.8457" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="114" x2="281" y1="730.8457" y2="730.8457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="121" y="726.1035">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="134" y="726.1035">PUT - /settlement/{id}</text><polygon fill="#A80036" points="788,771.4668,798,775.4668,788,779.4668,792,775.4668" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="794" y1="775.4668" y2="775.4668"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="304" y="763.0693">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="239" x="317" y="755.4141">Retrive full information for settlement</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="317" y="770.7246">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="394" y="770.7246">2001</text><polygon fill="#A80036" points="1125,800.7773,1135,804.7773,1125,808.7773,1129,804.7773" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="810" x2="1131" y1="804.7773" y2="804.7773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="817" y="800.0352">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="830" y="800.0352">Select from DB</text><polygon fill="#FFFFE0" filter="url(#fd3oz7vrgavfm)" points="907,817.7773,1376,817.7773,1386,889.7773,1376,962.7773,907,962.7773,897,889.7773,907,817.7773" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="465" x="909" y="834.3457">SELECT s.settlementId, ssc.settlementStateId, ssc.reason, ssc.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="909" y="849.6563">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="949" y="849.6563">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="7" x="1025" y="849.6563">s</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="909" y="864.9668">LEFT JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="157" x="974" y="864.9668">settlementStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="1135" y="864.9668">ssc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="909" y="880.2773">ON ssc.settlementId = s.settlementId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="909" y="895.5879">AND ssc.settelementStateChangeId = (</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="282" x="925" y="910.8984">SELECT MAX(ssc1.settelementStateChangeId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="925" y="926.209">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="157" x="965" y="926.209">settlementStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="29" x="1126" y="926.209">ssc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="925" y="941.5195">WHERE ssc1.settlementId = {id})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="909" y="956.8301">WHERE s.settlementId = {id}</text><polygon fill="#A80036" points="821,985.8828,811,989.8828,821,993.8828,817,989.8828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="815" x2="1141" y1="989.8828" y2="989.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="827" y="985.1406">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="840" y="985.1406">Return data</text><polygon fill="#A80036" points="308,1015.1934,298,1019.1934,308,1023.1934,304,1019.1934" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="302" x2="804" y1="1019.1934" y2="1019.1934"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="314" y="1014.4512">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="327" y="1014.4512">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="103" x="372" y="1014.4512">settlementData</text><path d="M153.5,1034.1934 L215.5,1034.1934 L215.5,1041.1934 L205.5,1051.1934 L153.5,1051.1934 L153.5,1034.1934 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="8661.8086" style="stroke: #000000; stroke-width: 2.0;" width="1325.5" x="153.5" y="1034.1934"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="168.5" y="1047.7617">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="297" x="230.5" y="1046.8281">[settlementStateChange == 'PENDING_SETTLEMENT']</text><polygon fill="#A80036" points="788,1084.125,798,1088.125,788,1092.125,792,1088.125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="794" y1="1088.125" y2="1088.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="304" y="1075.7275">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="300" x="317" y="1068.0723">Retrive full information for settlement accounts</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="317" y="1083.3828">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="394" y="1083.3828">2001</text><polygon fill="#A80036" points="1125,1113.4355,1135,1117.4355,1125,1121.4355,1129,1117.4355" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="810" x2="1131" y1="1117.4355" y2="1117.4355"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="817" y="1112.6934">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="830" y="1112.6934">Select from DB</text><polygon fill="#FFFFE0" filter="url(#fd3oz7vrgavfm)" points="829,1130.4355,1455,1130.4355,1465,1264.4355,1455,1398.4355,829,1398.4355,819,1264.4355,829,1130.4355" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="570" x="831" y="1147.0039">SELECT pc.participantId, spc.participantCurrencyId, spcsc.settlementStateId, spcsc.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="568" x="859" y="1162.3145">spcsc.createdDate, spc.netAmount, pc.currencyId, spc.settlementParticipantCurrencyId AS</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1431" y="1162.3145">key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="831" y="1177.625">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="871" y="1177.625">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1082" y="1177.625">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="339" x="831" y="1192.9355">JOIN (SELECT spcsc1.settlementParticipantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="384" x="883" y="1208.2461">MAX(spcsc1.settlementParticipantCurrencyStateChangeId) AS</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="307" x="883" y="1223.5566">maxSettlementParticipantCurrencyStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="855" y="1238.8672">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="895" y="1238.8672">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="30" x="1106" y="1238.8672">spc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="855" y="1254.1777">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="887" y="1254.1777">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="1183" y="1254.1777">spcsc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="528" x="855" y="1269.4883">ON spcsc1.settlementParticipantCurrencyId = spc1.settlementParticipantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="855" y="1284.7988">WHERE spc1.settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="353" x="855" y="1300.1094">GROUP BY spcsc1.settlementParticipantCurrencyId) spcs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="831" y="1315.4199">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="863" y="1315.4199">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1159" y="1315.4199">spcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="831" y="1330.7305">ON spcsc.settlementParticipantCurrencyStateChangeId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="340" x="843" y="1346.041">spcs.maxSettlementParticipantCurrencyStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="831" y="1361.3516">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="863" y="1361.3516">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="1003" y="1361.3516">pc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="831" y="1376.6621">ON pc.participantCurrencyId = spc.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="831" y="1391.9727">WHERE spc.settlementId = {id}</text><polygon fill="#A80036" points="821,1421.0254,811,1425.0254,821,1429.0254,817,1425.0254" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="815" x2="1141" y1="1425.0254" y2="1425.0254"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="827" y="1420.2832">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="840" y="1420.2832">Return data</text><polygon fill="#A80036" points="308,1450.3359,298,1454.3359,308,1458.3359,304,1454.3359" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="302" x2="804" y1="1454.3359" y2="1454.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="314" y="1449.5938">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="327" y="1449.5938">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158" x="372" y="1449.5938">settlementAccountsList</text><polygon fill="#A80036" points="788,1494.957,798,1498.957,788,1502.957,792,1498.957" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="794" y1="1498.957" y2="1498.957"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="1486.5596">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="298" x="326" y="1478.9043">Retrive full information for settlement windows</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="326" y="1494.2148">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="403" y="1494.2148">2001</text><polygon fill="#A80036" points="1125,1524.2676,1135,1528.2676,1125,1532.2676,1129,1528.2676" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="810" x2="1131" y1="1528.2676" y2="1528.2676"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="817" y="1523.5254">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="839" y="1523.5254">Select from DB</text><polygon fill="#FFFFE0" filter="url(#fd3oz7vrgavfm)" points="824,1541.2676,1459,1541.2676,1469,1652.2676,1459,1763.2676,824,1763.2676,814,1652.2676,824,1541.2676" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="631" x="826" y="1557.8359">SELECT ssw.settlementWindowId, sswsc.settlementWindowStateId, sswsc.reason, sswsc.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="826" y="1573.1465">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="197" x="866" y="1573.1465">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="1067" y="1573.1465">ssw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="583" x="826" y="1588.457">JOIN (SELECT sswsc1.settlementWindowId, MAX(sswsc1.settlementWindowStateChangeId) AS</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="878" y="1603.7676">maxSettlementWindowStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="850" y="1619.0781">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="282" x="890" y="1619.0781">settlementSettlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="1176" y="1619.0781">sswsc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="850" y="1634.3887">WHERE sswsc1.settlementWindowId IN (</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="866" y="1649.6992">SELECT ssw1.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="866" y="1665.0098">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="197" x="906" y="1665.0098">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="1107" y="1665.0098">ssw1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="866" y="1680.3203">WHERE ssw1.settlementId = {id})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="283" x="850" y="1695.6309">GROUP BY sswsc1.settlementWindowId) ssws</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="361" x="826" y="1710.9414">ON ssws.settlementWindowId = ssw.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="826" y="1726.252">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="282" x="858" y="1726.252">settlementSettlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="1144" y="1726.252">sswsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="558" x="826" y="1741.5625">ON sswsc.settlementWindowStateChangeId = ssws.maxSettlementWindowStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="826" y="1756.873">WHERE ssw.settlementId = {id}</text><polygon fill="#A80036" points="821,1785.9258,811,1789.9258,821,1793.9258,817,1789.9258" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="815" x2="1141" y1="1789.9258" y2="1789.9258"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="827" y="1785.1836">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="849" y="1785.1836">Return data</text><polygon fill="#A80036" points="308,1815.2363,298,1819.2363,308,1823.2363,304,1819.2363" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="302" x2="804" y1="1819.2363" y2="1819.2363"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="314" y="1814.4941">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="336" y="1814.4941">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="83" x="381" y="1814.4941">windowsList</text><polygon fill="#A80036" points="788,1859.8574,798,1863.8574,788,1867.8574,792,1863.8574" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="794" y1="1863.8574" y2="1863.8574"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="1851.46">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="326" y="1843.8047">Retrive full information for settlement windows accounts</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="326" y="1859.1152">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="403" y="1859.1152">2001</text><polygon fill="#A80036" points="1125,1889.168,1135,1893.168,1125,1897.168,1129,1893.168" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="810" x2="1131" y1="1893.168" y2="1893.168"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="817" y="1888.4258">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="839" y="1888.4258">Select from DB</text><polygon fill="#FFFFE0" filter="url(#fd3oz7vrgavfm)" points="948,1906.168,1335,1906.168,1345,1971.168,1335,2036.168,948,2036.168,938,1971.168,948,1906.168" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="366" x="950" y="1922.7363">SELECT ssw.settlementWindowId, tp.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="950" y="1938.0469">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="197" x="990" y="1938.0469">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="1191" y="1938.0469">ssw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="950" y="1953.3574">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="982" y="1953.3574">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="1108" y="1953.3574">tf</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="340" x="950" y="1968.668">ON tf.settlementWindowId = ssw.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="950" y="1983.9785">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="982" y="1983.9785">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="13" x="1113" y="1983.9785">tp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="950" y="1999.2891">ON tp.transferId = tf.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="950" y="2014.5996">WHERE settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="383" x="950" y="2029.9102">GROUP BY ssw.settlementWindowId, tp.participantCurrencyId</text><polygon fill="#A80036" points="821,2058.9629,811,2062.9629,821,2066.9629,817,2062.9629" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="815" x2="1141" y1="2062.9629" y2="2062.9629"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="827" y="2058.2207">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="849" y="2058.2207">Return data</text><polygon fill="#A80036" points="308,2088.2734,298,2092.2734,308,2096.2734,304,2092.2734" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="302" x2="804" y1="2092.2734" y2="2092.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="314" y="2087.5313">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="336" y="2087.5313">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="145" x="381" y="2087.5313">windowsAccountsList</text><path d="M302,2105.2734 L302,3125.2734 L1073,3125.2734 L1073,2115.2734 L1063,2105.2734 L302,2105.2734 " fill="#D3D3D3" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1063,2105.2734 L1063,2115.2734 L1073,2115.2734 L1063,2105.2734 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="308" y="2122.8418">Available raw datasets from DB:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="103" x="308" y="2138.1523">settlementData</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="423" x="415" y="2138.1523">contains information about settlement and its current state/reason</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158" x="308" y="2153.4629">settlementAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="426" x="470" y="2153.4629">holds information about all accounts and their current state/reason</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="83" x="308" y="2168.7734">windowsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="411" x="395" y="2168.7734">has information about all windows and their current state/reason</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="145" x="308" y="2184.084">windowsAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="457" y="2184.084">has information about all accounts and windows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="312" y="2199.3945"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="308" y="2214.7051">Local variables and objects:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="308" y="2230.0156">settlementAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="442" y="2230.0156">: { // (derived from</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="564" y="2230.0156">settlementAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="713" y="2230.0156">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="567" x="324" y="2245.3262">pendingSettlementCount: &lt;integer&gt;, // count of accounts in PENDING_SETTLEMENT state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="402" x="324" y="2260.6367">settledCount: &lt;integer&gt;, // count of accounts in SETTLED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="454" x="324" y="2275.9473">notSettledCount: &lt;integer&gt; // count of accounts in NOT_SETTLED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="308" y="2291.2578">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="96" x="308" y="2306.5684">allParticipants</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="497" x="404" y="2306.5684">: { // same as participants response object with initial data &amp; key (derived from</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="905" y="2306.5684">settlementAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1054" y="2306.5684">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="471" x="324" y="2321.8789">participantId_key: { // number used to access the object in array-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="340" y="2337.1895">id: participantId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="69" x="340" y="2352.5">accounts: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="527" x="356" y="2367.8105">participantCurrencyId_key: { // number used to access the object in array-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="372" y="2383.1211">id: participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="372" y="2398.4316">state: settlementStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="372" y="2413.7422">reason: reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="372" y="2429.0527">createdDate: createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="372" y="2444.3633">netSettlementAmount: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="388" y="2459.6738">amount: netAmount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="388" y="2474.9844">currency: currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="372" y="2490.2949">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="356" y="2505.6055">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="340" y="2520.916">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="324" y="2536.2266">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="308" y="2551.5371">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="78" x="308" y="2566.8477">allAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="406" x="386" y="2566.8477">: { // same as previous but accessed by account id (derived from</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="796" y="2566.8477">settlementAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="945" y="2566.8477">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="527" x="324" y="2582.1582">participantCurrencyId_key: { // number used to access the object in array-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="340" y="2597.4688">id: participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="340" y="2612.7793">state: settlementStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="340" y="2628.0898">reason: reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="340" y="2643.4004">createdDate: createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="340" y="2658.7109">netSettlementAmount: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="356" y="2674.0215">amount: netAmount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="356" y="2689.332">currency: currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="340" y="2704.6426">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="468" x="340" y="2719.9531">participantId: participantId, // could be used to reconstruct allParticipants</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="340" y="2735.2637">key:</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="370" y="2735.2637">key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="430" x="396" y="2735.2637">// will be used to insert new state for settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="324" y="2750.5742">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="308" y="2765.8848">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="76" x="308" y="2781.1953">allWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="506" x="384" y="2781.1953">: { // same as settlementWindows response object with initial data (derived from</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="894" y="2781.1953">windowsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="972" y="2781.1953">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="519" x="324" y="2796.5059">settlementWindowId_key: { // number used to access the object in array-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="340" y="2811.8164">id: settlementWindowId, // same as key value</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="340" y="2827.127">state: settlementWindowStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="340" y="2842.4375">reason: reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="340" y="2857.748">createdDate: createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="324" y="2873.0586">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="308" y="2888.3691">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="121" x="308" y="2903.6797">windowsAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="429" y="2903.6797">: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="519" x="324" y="2918.9902">settlementWindowId_key: { // number used to access the object in array-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="340" y="2934.3008">id: settlementWindowId // same as key value</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="527" x="340" y="2949.6113">pendingSettlementAccounts: [], // array of accounts in PENDING_SETTLEMENT state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="362" x="340" y="2964.9219">settledAccounts: [], // array of accounts in SETTLED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="414" x="340" y="2980.2324">notSettledAccounts: [] // array of accounts in NOT_SETTLED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="324" y="2995.543">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="308" y="3010.8535">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="308" y="3026.1641">accountsWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="428" y="3026.1641">: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="527" x="324" y="3041.4746">participantCurrencyId_key: { // number used to access the object in array-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="340" y="3056.7852">id: participantCurrencyId, // same as key value</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="448" x="340" y="3072.0957">windows: [] // array of windows to which the account settlement spans</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="324" y="3087.4063">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="308" y="3102.7168">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="308" y="3118.0273">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="328" y="3118.0273">transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="484" y="3118.0273">= now()</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="339" y1="3196.3906" y2="3196.3906"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="339" x2="339" y1="3196.3906" y2="3209.3906"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="298" x2="339" y1="3209.3906" y2="3209.3906"/><polygon fill="#A80036" points="308,3205.3906,298,3209.3906,308,3213.3906,304,3209.3906" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="3183.9932">18</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="326" y="3176.3379">Acquire DB lock</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="292" x="430" y="3176.3379">on settlementParticipantCurrencyStateChange,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="370" x="326" y="3191.6484">settlementWindowStateChange and settlementStateChange</text><path d="M302,3222.3906 L302,3385.3906 L605,3385.3906 L605,3232.3906 L595,3222.3906 L302,3222.3906 " fill="#D3D3D3" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M595,3222.3906 L595,3232.3906 L605,3232.3906 L595,3222.3906 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="308" y="3239.959">let settlementAccounts = {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="324" y="3255.2695">pendingSettlementAccounts: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="324" y="3270.5801">settledAccounts: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="324" y="3285.8906">notSettledAccounts: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="308" y="3301.2012">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="282" x="308" y="3316.5117">let allParticipants = {} // declare sparse array</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="267" x="308" y="3331.8223">let allAccounts = {} // declare sparse array</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="308" y="3347.1328">let pid // participantId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="271" x="308" y="3362.4434">let aid // accountId (participantCurrencyId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="51" x="308" y="3377.7539">let state</text><path d="M282,3401.4961 L356,3401.4961 L356,3408.4961 L346,3418.4961 L282,3418.4961 L282,3401.4961 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="480.7422" style="stroke: #000000; stroke-width: 2.0;" width="578" x="282" y="3401.4961"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="297" y="3415.0645">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="193" x="371" y="3414.1309">[settlementAccountsList as record]</text><path d="M302,3423.8066 L302,3693.8066 L846,3693.8066 L846,3433.8066 L836,3423.8066 L302,3423.8066 " fill="#D3D3D3" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M836,3423.8066 L836,3433.8066 L846,3433.8066 L836,3423.8066 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="308" y="3441.375">pid = record.participantId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="308" y="3456.6855">aid = record.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="203" x="308" y="3471.9961">state = record.settlementStateId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="312" y="3487.3066"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="308" y="3502.6172">allAccounts[aid] = {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="324" y="3517.9277">id: aid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="324" y="3533.2383">state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="324" y="3548.5488">reason: record.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="324" y="3563.8594">createDate: record.createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="324" y="3579.1699">netSettlementAmount: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="340" y="3594.4805">amount: record.netAmount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="340" y="3609.791">currency: record.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="324" y="3625.1016">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="324" y="3640.4121">key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="308" y="3655.7227">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="523" x="308" y="3671.0332">allParticipants[pid] = allParticipants[pid] ? allParticipants[pid] : {id: pid, accounts: {}}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="324" x="308" y="3686.3438">allParticipants[pid].accounts[aid] = allAccounts[aid]</text><path d="M292,3710.0859 L354,3710.0859 L354,3717.0859 L344,3727.0859 L292,3727.0859 L292,3710.0859 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="165.1523" style="stroke: #000000; stroke-width: 2.0;" width="351" x="292" y="3710.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="307" y="3723.6543">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="198" x="369" y="3722.7207">[state == 'PENDING_SETTLEMENT']</text><path d="M302,3732.3965 L302,3757.3965 L629,3757.3965 L629,3742.3965 L619,3732.3965 L302,3732.3965 " fill="#D3D3D3" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M619,3732.3965 L619,3742.3965 L629,3742.3965 L619,3732.3965 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="308" y="3749.9648">settlementAccounts.pendingSettlementCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="292" x2="643" y1="3767.707" y2="3767.707"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="117" x="297" y="3778.3418">[state == 'SETTLED']</text><path d="M302,3786.6621 L302,3811.6621 L554,3811.6621 L554,3796.6621 L544,3786.6621 L302,3786.6621 " fill="#D3D3D3" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M544,3786.6621 L544,3796.6621 L554,3796.6621 L544,3786.6621 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="308" y="3804.2305">settlementAccounts.settledCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="292" x2="643" y1="3821.9727" y2="3821.9727"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="148" x="297" y="3832.6074">[state == 'NOT_SETTLED']</text><path d="M302,3840.9277 L302,3865.9277 L575,3865.9277 L575,3850.9277 L565,3840.9277 L302,3840.9277 " fill="#D3D3D3" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M565,3840.9277 L565,3850.9277 L575,3850.9277 L565,3840.9277 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="308" y="3858.4961">settlementAccounts.notSettledCount++</text><path d="M302,3919.2383 L302,3959.2383 L587,3959.2383 L587,3929.2383 L577,3919.2383 L302,3919.2383 " fill="#D3D3D3" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M577,3919.2383 L577,3929.2383 L587,3929.2383 L577,3919.2383 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="308" y="3936.8066">let allWindows = {} // declare sparse array</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="308" y="3952.1172">let wid // settlementWindowId</text><path d="M292,3975.8594 L366,3975.8594 L366,3982.8594 L356,3992.8594 L292,3992.8594 L292,3975.8594 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="179.1055" style="stroke: #000000; stroke-width: 2.0;" width="297" x="292" y="3975.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="307" y="3989.4277">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="133" x="381" y="3988.4941">[windowsList as record]</text><path d="M302,3998.1699 L302,4145.1699 L575,4145.1699 L575,4008.1699 L565,3998.1699 L302,3998.1699 " fill="#D3D3D3" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M565,3998.1699 L565,4008.1699 L575,4008.1699 L565,3998.1699 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212" x="308" y="4015.7383">wid = record.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="308" y="4031.0488">state = record.settlementWindowStateId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="312" y="4046.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="308" y="4061.6699">allWindows[wid] = {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="324" y="4076.9805">id: wid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="324" y="4092.291">state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="324" y="4107.6016">reason: record.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="324" y="4122.9121">createDate: record.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="308" y="4138.2227">}</text><path d="M302,4191.9648 L302,4231.9648 L630,4231.9648 L630,4201.9648 L620,4191.9648 L302,4191.9648 " fill="#D3D3D3" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M620,4191.9648 L620,4201.9648 L630,4201.9648 L620,4191.9648 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="307" x="308" y="4209.5332">let windowsAccounts = {} // declare sparse array</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="308" y="4224.8438">let accountsWindows = {} // declare sparse array</text><path d="M282,4248.5859 L356,4248.5859 L356,4255.5859 L346,4265.5859 L282,4265.5859 L282,4248.5859 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="465.4316" style="stroke: #000000; stroke-width: 2.0;" width="534" x="282" y="4248.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="297" y="4262.1543">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="184" x="371" y="4261.2207">[windowsAccountsList as record]</text><path d="M302,4270.8965 L302,4524.8965 L802,4524.8965 L802,4280.8965 L792,4270.8965 L302,4270.8965 " fill="#D3D3D3" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M792,4270.8965 L792,4280.8965 L802,4280.8965 L792,4270.8965 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212" x="308" y="4288.4648">wid = record.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="308" y="4303.7754">aid = record.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="308" y="4319.0859">state = allAccounts[aid]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="312" y="4334.3965"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="467" x="308" y="4349.707">accountsWindows[aid] = accountsWindows[aid] ? accountsWindows[aid] : {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="324" y="4365.0176">id: aid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="71" x="324" y="4380.3281">windows: []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="308" y="4395.6387">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="308" y="4410.9492">accountsWindows[aid].windows.push(wid)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="312" y="4426.2598"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="479" x="308" y="4441.5703">windowsAccounts[wid] = windowsAccounts[wid] ? windowsAccounts[wid] : {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="324" y="4456.8809">id: wid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="324" y="4472.1914">pendingSettlementAccounts: [],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="324" y="4487.502">settledAccounts: [],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="324" y="4502.8125">notSettledAccounts: []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="308" y="4518.123">}</text><path d="M292,4541.8652 L354,4541.8652 L354,4548.8652 L344,4558.8652 L292,4558.8652 L292,4541.8652 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="165.1523" style="stroke: #000000; stroke-width: 2.0;" width="432" x="292" y="4541.8652"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="307" y="4555.4336">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="198" x="369" y="4554.5">[state == 'PENDING_SETTLEMENT']</text><path d="M302,4564.1758 L302,4589.1758 L710,4589.1758 L710,4574.1758 L700,4564.1758 L302,4564.1758 " fill="#D3D3D3" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M700,4564.1758 L700,4574.1758 L710,4574.1758 L700,4564.1758 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="387" x="308" y="4581.7441">windowsAccounts[wid].pendingSettlementAccounts.push(aid)</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="292" x2="724" y1="4599.4863" y2="4599.4863"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="117" x="297" y="4610.1211">[state == 'SETTLED']</text><path d="M302,4618.4414 L302,4643.4414 L635,4643.4414 L635,4628.4414 L625,4618.4414 L302,4618.4414 " fill="#D3D3D3" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M625,4618.4414 L625,4628.4414 L635,4628.4414 L625,4618.4414 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="308" y="4636.0098">windowsAccounts[wid].settledAccounts.push(aid)</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="292" x2="724" y1="4653.752" y2="4653.752"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="148" x="297" y="4664.3867">[state == 'NOT_SETTLED']</text><path d="M302,4672.707 L302,4697.707 L656,4697.707 L656,4682.707 L646,4672.707 L302,4672.707 " fill="#D3D3D3" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M646,4672.707 L646,4682.707 L656,4682.707 L646,4672.707 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="308" y="4690.2754">windowsAccounts[wid].notSettledAccounts.push(aid)</text><path d="M302,4751.0176 L302,5036.0176 L996,5036.0176 L996,4761.0176 L986,4751.0176 L302,4751.0176 " fill="#D3D3D3" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M986,4751.0176 L986,4761.0176 L996,4761.0176 L986,4751.0176 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="308" y="4768.5859">Available objects after the setup:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="308" y="4783.8965">settlementAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="414" x="446" y="4783.8965">is used for tracing settlement state and state transition allowance</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="96" x="308" y="4799.207">allParticipants</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="406" x="408" y="4799.207">is used for tracing participant/account state and state transition</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="78" x="308" y="4814.5176">allAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="474" x="390" y="4814.5176">is helper object, same as previous, providing direct access to account by id</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="76" x="308" y="4829.8281">allWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="363" x="388" y="4829.8281">has window information for all windows in the settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="121" x="308" y="4845.1387">windowsAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="466" x="433" y="4845.1387">is used for tracing settlement window state and state transition allowance</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="308" y="4860.4492">accountsWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="499" x="432" y="4860.4492">is helper object to show the list of windows to which settlement account spans</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="312" y="4875.7598"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="308" y="4891.0703">Now we are ready to process the</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="54" x="516" y="4891.0703">payload</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="570" y="4891.0703">:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="308" y="4906.3809">participants</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="588" x="393" y="4906.3809">= [] // part of the response object that lists the affected participants and respective accounts</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="115" x="308" y="4921.6914">affectedWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="427" y="4921.6914">= [] // array of the affected windows</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="308" y="4937.002">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="261" x="604" y="4937.002">= [] // array to collect inserts to the table</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="131" x="308" y="4952.3125">processedAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="471" x="443" y="4952.3125">= [] // array to log processed accounts and restrict subsequent processing</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="308" y="4967.623">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="13" x="328" y="4967.623">pi</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="345" y="4967.623">// declare participant index</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="308" y="4982.9336">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="12" x="328" y="4982.9336">ai</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="344" y="4982.9336">// declare account index</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="308" y="4998.2441">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="74" x="328" y="4998.2441">participant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="292" x="406" y="4998.2441">-- declare pointer to current participant in the</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="100" x="702" y="4998.2441">response object</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="308" y="5013.5547">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="328" y="5013.5547">participantPayload</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="292" x="459" y="5013.5547">-- declare pointer to current participant in the</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="92" x="755" y="5013.5547">payload object</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="308" y="5028.8652">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="106" x="328" y="5028.8652">accountPayload</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="438" y="5028.8652">-- declare pointer to current account in the</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="92" x="716" y="5028.8652">payload object</text><path d="M163.5,5077.6074 L237.5,5077.6074 L237.5,5084.6074 L227.5,5094.6074 L163.5,5094.6074 L163.5,5077.6074 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3435.0859" style="stroke: #000000; stroke-width: 2.0;" width="977.5" x="163.5" y="5077.6074"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="178.5" y="5091.1758">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="165" x="252.5" y="5090.2422">[let p IN payload.participants]</text><path d="M302,5099.918 L302,5170.918 L682,5170.918 L682,5109.918 L672,5099.918 L302,5099.918 " fill="#D3D3D3" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M672,5099.918 L672,5109.918 L682,5109.918 L672,5099.918 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="308" y="5117.4863">participantPayload = payload.participants[p]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="308" y="5132.7969">participants.push({id: participantPayload.id, accounts: []})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="308" y="5148.1074">pi = participants.length - 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="308" y="5163.418">participant = participants[pi]</text><path d="M173.5,5187.1602 L247.5,5187.1602 L247.5,5194.1602 L237.5,5204.1602 L173.5,5204.1602 L173.5,5187.1602 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3318.5332" style="stroke: #000000; stroke-width: 2.0;" width="957.5" x="173.5" y="5187.1602"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="188.5" y="5200.7285">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="262.5" y="5199.7949">[let a IN participantPayload.accounts]</text><path d="M302,5209.4707 L302,5234.4707 L631,5234.4707 L631,5219.4707 L621,5209.4707 L302,5209.4707 " fill="#D3D3D3" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M621,5209.4707 L621,5219.4707 L631,5219.4707 L621,5209.4707 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="308" y="5227.0391">accountPayload = participantPayload.accounts[a]</text><path d="M242,5250.7813 L304,5250.7813 L304,5257.7813 L294,5267.7813 L242,5267.7813 L242,5250.7813 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2270.8672" style="stroke: #000000; stroke-width: 2.0;" width="879" x="242" y="5250.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="257" y="5264.3496">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="263" x="319" y="5263.416">[allAccounts[accountPayload.id] == undefined]</text><path d="M302,5273.0918 L302,5390.0918 L590,5390.0918 L590,5283.0918 L580,5273.0918 L302,5273.0918 " fill="#D3D3D3" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M580,5273.0918 L580,5283.0918 L590,5283.0918 L580,5273.0918 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="308" y="5290.6602">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="324" y="5305.9707">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="324" y="5321.2813">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="340" y="5336.5918">errorCode: &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="340" y="5351.9023">errorDescription: 'Account not found'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="324" y="5367.2129">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="308" y="5382.5234">})</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="242" x2="1121" y1="5400.2656" y2="5400.2656"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="270" x="247" y="5410.9004">[processedAccounts.indexOf(accountPayload.id)]</text><path d="M302,5419.2207 L302,5536.2207 L675,5536.2207 L675,5429.2207 L665,5419.2207 L302,5419.2207 " fill="#D3D3D3" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M665,5419.2207 L665,5429.2207 L675,5429.2207 L665,5419.2207 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="308" y="5436.7891">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="324" y="5452.0996">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="324" y="5467.4102">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="340" y="5482.7207">errorCode: &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320" x="340" y="5498.0313">errorDescription: 'Account already processed once'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="324" y="5513.3418">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="308" y="5528.6523">})</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="242" x2="1121" y1="5546.3945" y2="5546.3945"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="331" x="247" y="5557.0293">[allAccounts[account.id].state == 'PENDING_SETTLEMENT']</text><path d="M252,5567.3496 L314,5567.3496 L314,5574.3496 L304,5584.3496 L252,5584.3496 L252,5567.3496 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1947.2988" style="stroke: #000000; stroke-width: 2.0;" width="859" x="252" y="5567.3496"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="267" y="5580.918">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="350" x="329" y="5579.9844">[accountPayload.state == 'PENDING_SETTLEMENT' // allowed]</text><path d="M302,5589.6602 L302,5798.6602 L821,5798.6602 L821,5599.6602 L811,5589.6602 L302,5589.6602 " fill="#D3D3D3" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M811,5589.6602 L811,5599.6602 L821,5599.6602 L811,5589.6602 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="308" y="5607.2285">processedAccounts.push(accountPayload.id)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="308" y="5622.5391">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="324" y="5637.8496">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="324" y="5653.1602">state: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="324" y="5668.4707">reason: accountPayload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="324" y="5683.7813">createdDate: transactionTimestamp,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="324" y="5699.0918">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="308" y="5714.4023">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="308" y="5729.7129">settlementParticipantCurrencyStateChange.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="436" x="324" y="5745.0234">settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="324" y="5760.334">settlementStateId: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="324" y="5775.6445">reason: accountPayload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="308" y="5790.9551">})</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="252" x2="1111" y1="5808.6973" y2="5808.6973"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="269" x="257" y="5819.332">[accountPayload.state == 'SETTLED' // allowed]</text><path d="M302,5827.6523 L302,6173.6523 L947,6173.6523 L947,5837.6523 L937,5827.6523 L302,5827.6523 " fill="#D3D3D3" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M937,5827.6523 L937,5837.6523 L947,5837.6523 L937,5827.6523 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="308" y="5845.2207">processedAccounts.push(accountPayload.id)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="308" y="5860.5313">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="324" y="5875.8418">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="324" y="5891.1523">state: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="324" y="5906.4629">reason: accountPayload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="324" y="5921.7734">createdDate: transactionTimestamp,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="324" y="5937.084">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="308" y="5952.3945">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="308" y="5967.7051">settlementParticipantCurrencyStateChange.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="436" x="324" y="5983.0156">settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="324" y="5998.3262">settlementStateId: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="324" y="6013.6367">reason: accountPayload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="308" y="6028.9473">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="308" y="6044.2578">settlementAccounts.pendingSettlementCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="308" y="6059.5684">settlementAccounts.settledCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="382" x="308" y="6074.8789">allAccounts[accountPayload.id].state = accountPayload.state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="404" x="308" y="6090.1895">allAccounts[accountPayload.id].reason = accountPayload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="408" x="308" y="6105.5">allAccounts[accountPayload.id].createdDate = currentTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="598" x="308" y="6120.8105">allParticipants[participantPayload.id].accounts[accountPayload.id].state = accountPayload.state</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="620" x="308" y="6136.1211">allParticipants[participantPayload.id].accounts[accountPayload.id].reason = accountPayload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="624" x="308" y="6151.4316">allParticipants[participantPayload.id].accounts[accountPayload.id].createdDate = currentTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="308" y="6166.7422">let settlementWindowId</text><path d="M292,6190.4844 L366,6190.4844 L366,6197.4844 L356,6207.4844 L292,6207.4844 L292,6190.4844 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="179.1055" style="stroke: #000000; stroke-width: 2.0;" width="618" x="292" y="6190.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="307" y="6204.0527">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="320" x="381" y="6203.1191">[let aw IN accountsWindows[accountPayload.id].windows]</text><path d="M302,6212.7949 L302,6359.7949 L896,6359.7949 L896,6222.7949 L886,6212.7949 L302,6212.7949 " fill="#D3D3D3" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M886,6212.7949 L886,6222.7949 L896,6222.7949 L886,6212.7949 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="465" x="308" y="6230.3633">settlementWindowId = accountsWindows[accountPayload.id].windows[aw]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="573" x="308" y="6245.6738">_.remove(windowsAccounts[settlementWindowId].pendingSettlementAccounts, (value) =&gt; {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="324" y="6260.9844">value == accountPayload.id</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="308" y="6276.2949">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="513" x="308" y="6291.6055">windowsAccounts[settlementWindowId].settledAccounts.push(accountPayload.id)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="312" y="6306.916"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="352" x="308" y="6322.2266">if (affectedWindows.indexOf(settlementWindowId) &lt; 0) {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="324" y="6337.5371">affectedWindows.push(settlementWindowId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="308" y="6352.8477">}</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="252" x2="1111" y1="6377.5898" y2="6377.5898"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="320" x="257" y="6388.2246">[accountPayload.state == 'NOT_SETTLED' // conditional]</text><path d="M302,6396.5449 L302,6451.5449 L471,6451.5449 L471,6406.5449 L461,6396.5449 L302,6396.5449 " fill="#D3D3D3" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M461,6396.5449 L461,6406.5449 L471,6406.5449 L461,6396.5449 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="308" y="6414.1133">let settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="308" y="6429.4238">let windowAccount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="308" y="6444.7344">let isAllowed = true</text><path d="M292,6468.4766 L366,6468.4766 L366,6475.4766 L356,6485.4766 L292,6485.4766 L292,6468.4766 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="102.5527" style="stroke: #000000; stroke-width: 2.0;" width="510" x="292" y="6468.4766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="307" y="6482.0449">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="320" x="381" y="6481.1113">[let aw IN accountsWindows[accountPayload.id].windows]</text><path d="M302,6490.7871 L302,6561.7871 L788,6561.7871 L788,6500.7871 L778,6490.7871 L302,6490.7871 " fill="#D3D3D3" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M778,6490.7871 L778,6500.7871 L788,6500.7871 L778,6490.7871 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="465" x="308" y="6508.3555">settlementWindowId = accountsWindows[accountPayload.id].windows[aw]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="390" x="308" y="6523.666">if (windowsAccounts[settlementWindowId].settledCount) &gt; 0 {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="324" y="6538.9766">isAllowed = false</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="308" y="6554.2871">}</text><path d="M262,6585.0293 L324,6585.0293 L324,6592.0293 L314,6602.0293 L262,6602.0293 L262,6585.0293 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="922.6191" style="stroke: #000000; stroke-width: 2.0;" width="839" x="262" y="6585.0293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="277" y="6598.5977">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="116" x="339" y="6597.6641">[isAllowed == false]</text><path d="M302,6607.3398 L302,6739.3398 L960,6739.3398 L960,6617.3398 L950,6607.3398 L302,6607.3398 " fill="#D3D3D3" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M950,6607.3398 L950,6617.3398 L960,6617.3398 L950,6607.3398 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="308" y="6624.9082">processedAccounts.push(accountPayload.id)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="308" y="6640.2188">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="324" y="6655.5293">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="324" y="6670.8398">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="340" y="6686.1504">errorCode: &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="605" x="340" y="6701.4609">errorDescription: 'NOT_SETTLED can not be set when there is a settled account within a window'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="324" y="6716.7715">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="308" y="6732.082">})</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="262" x2="1101" y1="6749.8242" y2="6749.8242"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="111" x="267" y="6760.459">[isAllowed == true]</text><path d="M272,6770.7793 L346,6770.7793 L346,6777.7793 L336,6787.7793 L272,6787.7793 L272,6770.7793 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="729.8691" style="stroke: #000000; stroke-width: 2.0;" width="819" x="272" y="6770.7793"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="287" y="6784.3477">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="320" x="361" y="6783.4141">[let aw IN accountsWindows[accountPayload.id].windows]</text><path d="M302,6793.0898 L302,6818.0898 L788,6818.0898 L788,6803.0898 L778,6793.0898 L302,6793.0898 " fill="#D3D3D3" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M778,6793.0898 L778,6803.0898 L788,6803.0898 L778,6793.0898 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="465" x="308" y="6810.6582">settlementWindowId = accountsWindows[accountPayload.id].windows[aw]</text><path d="M282,6834.4004 L356,6834.4004 L356,6841.4004 L346,6851.4004 L282,6851.4004 L282,6834.4004 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="659.248" style="stroke: #000000; stroke-width: 2.0;" width="799" x="282" y="6834.4004"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="297" y="6847.9688">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="439" x="371" y="6847.0352">[let wa IN windowsAccounts[settlementWindowId].pendingSettlementAccounts]</text><path d="M302,6856.7109 L302,6896.7109 L897,6896.7109 L897,6866.7109 L887,6856.7109 L302,6856.7109 " fill="#D3D3D3" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M887,6856.7109 L887,6866.7109 L897,6866.7109 L887,6856.7109 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="574" x="308" y="6874.2793">windowAccount = windowsAccounts[settlementWindowId].pendingSettlementAccounts[wa]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="266" x="308" y="6889.5898">processedAccounts.push(windowAccount)</text><path d="M292,6913.332 L359,6913.332 L359,6920.332 L349,6930.332 L292,6930.332 L292,6913.332 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="102.5527" style="stroke: #000000; stroke-width: 2.0;" width="486" x="292" y="6913.332"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="307" y="6926.9004">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="399" x="374" y="6925.9668">[participants[allAccounts[windowAccount].participantId] == undefined]</text><path d="M302,6935.6426 L302,7006.6426 L694,7006.6426 L694,6945.6426 L684,6935.6426 L302,6935.6426 " fill="#D3D3D3" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M684,6935.6426 L684,6945.6426 L694,6945.6426 L684,6935.6426 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="371" x="308" y="6953.2109">participants[allAccounts[windowAccount].participantId] = {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="290" x="324" y="6968.5215">id: allAccounts[windowAccount].participantId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="73" x="324" y="6983.832">accounts: []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="308" y="6999.1426">}</text><path d="M302,7027.8848 L302,7052.8848 L758,7052.8848 L758,7037.8848 L748,7027.8848 L302,7027.8848 " fill="#D3D3D3" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M748,7027.8848 L748,7037.8848 L758,7037.8848 L748,7027.8848 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="435" x="308" y="7045.4531">participant = participants[allAccounts[windowAccount].participantId]</text><path d="M292,7069.1953 L359,7069.1953 L359,7076.1953 L349,7086.1953 L292,7086.1953 L292,7069.1953 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="87.2422" style="stroke: #000000; stroke-width: 2.0;" width="424" x="292" y="7069.1953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="307" y="7082.7637">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="374" y="7081.8301">[participant.accounts[windowAccount] != undefined]</text><path d="M302,7091.5059 L302,7146.5059 L702,7146.5059 L702,7101.5059 L692,7091.5059 L302,7091.5059 " fill="#D3D3D3" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M692,7091.5059 L692,7101.5059 L702,7101.5059 L692,7091.5059 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="379" x="308" y="7109.0742">_.remove(participant.accounts[windowAccount], (value) =&gt; {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="298" x="324" y="7124.3848">value == participant.accounts[windowAccount]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="308" y="7139.6953">}</text><path d="M302,7168.4375 L302,7484.4375 L1067,7484.4375 L1067,7178.4375 L1057,7168.4375 L302,7168.4375 " fill="#D3D3D3" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1057,7168.4375 L1057,7178.4375 L1067,7178.4375 L1057,7168.4375 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="308" y="7186.0059">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="324" y="7201.3164">id: windowAccount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="324" y="7216.627">state: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="324" y="7231.9375">reason: accountPayload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="324" y="7247.248">createdDate: transactionTimestamp,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="468" x="324" y="7262.5586">netSettlementAmount: allAccounts[windowAccount].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="308" y="7277.8691">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="308" y="7293.1797">settlementParticipantCurrencyStateChange.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="422" x="324" y="7308.4902">settlementParticipantCurrencyId: allAccounts[windowAccount].key,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="324" y="7323.8008">settlementStateId: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="324" y="7339.1113">reason: accountPayload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="308" y="7354.4219">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="308" y="7369.7324">settlementAccounts.pendingSettlementCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="308" y="7385.043">settlementAccounts.notSettledCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="368" x="308" y="7400.3535">allAccounts[windowAccount].state = accountPayload.state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="390" x="308" y="7415.6641">allAccounts[windowAccount].reason = accountPayload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="394" x="308" y="7430.9746">allAccounts[windowAccount].createdDate = currentTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="718" x="308" y="7446.2852">allParticipants[allAccounts[windowAccount].participantId].accounts[windowAccount].state = accountPayload.state</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="740" x="308" y="7461.5957">allParticipants[allAccounts[windowAccount].participantId].accounts[windowAccount].reason = accountPayload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="744" x="308" y="7476.9063">allParticipants[allAccounts[windowAccount].participantId].accounts[windowAccount].createdDate = currentTimestamp</text><path d="M302,7533.6484 L302,7543.6484 L323,7543.6484 L323,7543.6484 L313,7533.6484 L302,7533.6484 " fill="#D3D3D3" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M313,7533.6484 L313,7543.6484 L323,7543.6484 L313,7533.6484 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="339" y1="7648.959" y2="7648.959"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="339" x2="339" y1="7648.959" y2="7661.959"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="298" x2="339" y1="7661.959" y2="7661.959"/><polygon fill="#A80036" points="308,7657.959,298,7661.959,308,7665.959,304,7661.959" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="7644.2168">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="326" y="7644.2168">accountIsFound = false</text><path d="M183.5,7676.959 L257.5,7676.959 L257.5,7683.959 L247.5,7693.959 L183.5,7693.959 L183.5,7676.959 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="615.9395" style="stroke: #000000; stroke-width: 2.0;" width="584.5" x="183.5" y="7676.959"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="198.5" y="7690.5273">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="272.5" y="7689.5938">[spcStateChangeList as record]</text><path d="M193.5,7701.2695 L255.5,7701.2695 L255.5,7708.2695 L245.5,7718.2695 L193.5,7718.2695 L193.5,7701.2695 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="559.6289" style="stroke: #000000; stroke-width: 2.0;" width="564.5" x="193.5" y="7701.2695"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="208.5" y="7714.8379">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="274" x="270.5" y="7713.9043">[participant.participantId == record.participantId</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="381" x="270.5" y="7726.8594">and account.participantCurrencyId == record.participantCurrencyId]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="339" y1="7750.8008" y2="7750.8008"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="339" x2="339" y1="7750.8008" y2="7763.8008"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="298" x2="339" y1="7763.8008" y2="7763.8008"/><polygon fill="#A80036" points="308,7759.8008,298,7763.8008,308,7767.8008,304,7763.8008" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="7746.0586">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="326" y="7746.0586">accountIsFound = true</text><path d="M203.5,7778.8008 L265.5,7778.8008 L265.5,7785.8008 L255.5,7795.8008 L203.5,7795.8008 L203.5,7778.8008 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="450.0977" style="stroke: #000000; stroke-width: 2.0;" width="544.5" x="203.5" y="7778.8008"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="218.5" y="7792.3691">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="306" x="280.5" y="7791.4355">[record.settlementStateId == 'PENDING_SETTLEMENT']</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="339" y1="7863.3535" y2="7863.3535"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="339" x2="339" y1="7863.3535" y2="7876.3535"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="298" x2="339" y1="7876.3535" y2="7876.3535"/><polygon fill="#A80036" points="308,7872.3535,298,7876.3535,308,7880.3535,304,7876.3535" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="7835.6455">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="326" y="7812.6797">settlementParticipantCurrencyIdList.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="394" x="342" y="7827.9902">participantCurrencyId: record.settlementParticipantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="342" y="7843.3008">reason: 'string'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="326" y="7858.6113">})</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="339" y1="8043.459" y2="8043.459"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="339" x2="339" y1="8043.459" y2="8056.459"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="298" x2="339" y1="8056.459" y2="8056.459"/><polygon fill="#A80036" points="308,8052.459,298,8056.459,308,8060.459,304,8056.459" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="7969.8193">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="326" y="7900.9219">participantList[participantList.length-1].accounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="326" y="7916.2324">.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="342" y="7931.543">participantCurrencyId: account.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="342" y="7946.8535">reason: 'string',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103" x="342" y="7962.1641">state: 'SETTLED',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="342" y="7977.4746">netSettlementAmount: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="358" y="7992.7852">amount: record.netAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="358" y="8008.0957">currency: record.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="342" y="8023.4063">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="326" y="8038.7168">})</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="203.5" x2="748" y1="8065.459" y2="8065.459"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="225" x="208.5" y="8076.0938">[record.settlementStateId == 'SETTLED']</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="339" y1="8207.8984" y2="8207.8984"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="339" x2="339" y1="8207.8984" y2="8220.8984"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="298" x2="339" y1="8220.8984" y2="8220.8984"/><polygon fill="#A80036" points="308,8216.8984,298,8220.8984,308,8224.8984,304,8220.8984" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="8149.5693">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="326" y="8095.9824">participantList[participantList.length-1].accounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="326" y="8111.293">.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="342" y="8126.6035">participantCurrencyId: account.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="342" y="8141.9141">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="358" y="8157.2246">errorCode: 'code',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="358" y="8172.5352">errorDescription: 'Already settled'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="342" y="8187.8457">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="326" y="8203.1563">})</text><path d="M203.5,8306.8984 L270.5,8306.8984 L270.5,8313.8984 L260.5,8323.8984 L203.5,8323.8984 L203.5,8306.8984 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="166.7949" style="stroke: #000000; stroke-width: 2.0;" width="488.5" x="203.5" y="8306.8984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="218.5" y="8320.4668">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="148" x="285.5" y="8319.5332">[accountIsFound == false]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="339" y1="8452.6934" y2="8452.6934"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="339" x2="339" y1="8452.6934" y2="8465.6934"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="298" x2="339" y1="8465.6934" y2="8465.6934"/><polygon fill="#A80036" points="308,8461.6934,298,8465.6934,308,8469.6934,304,8465.6934" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="8394.3643">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="326" y="8340.7773">participantList[participantList.length-1].accounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="326" y="8356.0879">.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="342" y="8371.3984">participantCurrencyId: account.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="342" y="8386.709">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="358" y="8402.0195">errorCode: 'code',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="358" y="8417.3301">errorDescription: 'Account not found'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="342" y="8432.6406">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="326" y="8447.9512">})</text><path d="M193.5,8526.6934 L358.5,8526.6934 L358.5,8533.6934 L348.5,8543.6934 L193.5,8543.6934 L193.5,8526.6934 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="185.8633" style="stroke: #000000; stroke-width: 2.0;" width="1114.5" x="193.5" y="8526.6934"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="208.5" y="8540.2617">DB TRANSACTION</text><path d="M203.5,8551.0039 L277.5,8551.0039 L277.5,8558.0039 L267.5,8568.0039 L203.5,8568.0039 L203.5,8551.0039 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="154.5527" style="stroke: #000000; stroke-width: 2.0;" width="1094.5" x="203.5" y="8551.0039"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="218.5" y="8564.5723">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="263" x="292.5" y="8563.6387">[settlementParticipantCurrencyIdList as record]</text><polygon fill="#A80036" points="788,8585.625,798,8589.625,788,8593.625,792,8589.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="794" y1="8589.625" y2="8589.625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="8584.8828">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="283" x="326" y="8584.8828">Change settlement participant currency state</text><polygon fill="#A80036" points="1125,8630.2461,1135,8634.2461,1125,8638.2461,1129,8634.2461" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="810" x2="1131" y1="8634.2461" y2="8634.2461"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="817" y="8621.8486">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="281" x="839" y="8614.1934">Insert new state 'SETTLED' and record.reason</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="839" y="8629.5039">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="916" y="8629.5039">2001</text><polygon fill="#FFFFE0" filter="url(#fd3oz7vrgavfm)" points="1006,8677.2461,1278,8677.2461,1288,8688.2461,1278,8700.2461,1006,8700.2461,996,8688.2461,1006,8677.2461" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="1008" y="8693.8145">settlementParticipantCurrencyStateChange</text><polygon fill="#A80036" points="788,8752.1777,798,8756.1777,788,8760.1777,792,8756.1777" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="794" y1="8756.1777" y2="8756.1777"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="8743.7803">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="346" x="326" y="8736.125">Get list of all NOT_SETTELED or PENDING_SETTLEMENT</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="222" x="326" y="8751.4355">participantCurrencies in settlement</text><polygon fill="#A80036" points="1125,8796.7988,1135,8800.7988,1125,8804.7988,1129,8800.7988" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="810" x2="1131" y1="8800.7988" y2="8800.7988"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="817" y="8788.4014">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="67" x="839" y="8780.7461">Retrive list</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="839" y="8796.0566">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="916" y="8796.0566">2001</text><polygon fill="#FFFFE0" filter="url(#fd3oz7vrgavfm)" points="872,8813.7988,1412,8813.7988,1422,8931.7988,1412,9050.7988,872,9050.7988,862,8931.7988,872,8813.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="874" y="8830.3672">SELECT spc.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="874" y="8845.6777">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="914" y="8845.6777">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1125" y="8845.6777">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="317" x="874" y="8860.9883">JOIN (SELECT spc.settlementParticipantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="336" x="926" y="8876.2988">MAX(settlementParticipantCurrencyStateChangeId) AS</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="307" x="926" y="8891.6094">maxSettlementParticipantCurrencyStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="898" y="8906.9199">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="938" y="8906.9199">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1234" y="8906.9199">spcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="898" y="8922.2305">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="930" y="8922.2305">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1141" y="8922.2305">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="512" x="898" y="8937.541">ON spc.settlementParticipantCurrencyId = spcsc.settlementParticipantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="898" y="8952.8516">WHERE spc.settlementId = {id}) AS mx</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="496" x="874" y="8968.1621">ON mx.settlementParticipantCurrencyId = spc.settlementParticipantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="874" y="8983.4727">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="906" y="8983.4727">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1202" y="8983.4727">spcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="874" y="8998.7832">ON spcsc.settlementParticipantCurrencyStateChangeId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="331" x="886" y="9014.0938">mx.maxSettlementParticipantCurrencyStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="874" y="9029.4043">WHERE spc.settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="874" y="9044.7148">AND spcsc.settlementStateId != 'SETTLED'</text><polygon fill="#A80036" points="821,9073.7676,811,9077.7676,821,9081.7676,817,9077.7676" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="815" x2="1141" y1="9077.7676" y2="9077.7676"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="827" y="9073.0254">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="849" y="9073.0254">Return list</text><polygon fill="#A80036" points="308,9103.0781,298,9107.0781,308,9111.0781,304,9107.0781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="302" x2="804" y1="9107.0781" y2="9107.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="314" y="9102.3359">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="336" y="9102.3359">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="231" x="381" y="9102.3359">settlementParticipantCurrencyList</text><path d="M173.5,9122.0781 L391.5,9122.0781 L391.5,9129.0781 L381.5,9139.0781 L173.5,9139.0781 L173.5,9122.0781 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="526.9688" style="stroke: #000000; stroke-width: 2.0;" width="1107.5" x="173.5" y="9122.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="173" x="188.5" y="9135.6465">Settle settlementWindows</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="339" y1="9176.0098" y2="9176.0098"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="339" x2="339" y1="9176.0098" y2="9189.0098"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="298" x2="339" y1="9189.0098" y2="9189.0098"/><polygon fill="#A80036" points="308,9185.0098,298,9189.0098,308,9193.0098,304,9189.0098" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="9163.6123">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="326" y="9155.957">allWindowsList = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="326" y="9171.2676">notSettledWindowsList = []</text><path d="M183.5,9204.0098 L257.5,9204.0098 L257.5,9211.0098 L247.5,9221.0098 L183.5,9221.0098 L183.5,9204.0098 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="195.8633" style="stroke: #000000; stroke-width: 2.0;" width="540.5" x="183.5" y="9204.0098"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="198.5" y="9217.5781">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="309" x="272.5" y="9216.6445">[settlementWindowsParticipantCurrencyList as window]</text><path d="M203.5,9228.3203 L270.5,9228.3203 L270.5,9235.3203 L260.5,9245.3203 L203.5,9245.3203 L203.5,9228.3203 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="451.5" x="203.5" y="9228.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="218.5" y="9241.8887">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="300" x="285.5" y="9240.9551">[window.settlementWindowId NOT IN allWindowsList]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="339" y1="9266.9414" y2="9266.9414"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="339" x2="339" y1="9266.9414" y2="9279.9414"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="298" x2="339" y1="9279.9414" y2="9279.9414"/><polygon fill="#A80036" points="308,9275.9414,298,9279.9414,308,9283.9414,304,9279.9414" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="9262.1992">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="317" x="326" y="9262.1992">allWindowsList.push(window.settlementWindowId)</text><path d="M193.5,9301.9414 L267.5,9301.9414 L267.5,9308.9414 L257.5,9318.9414 L193.5,9318.9414 L193.5,9301.9414 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="90.9316" style="stroke: #000000; stroke-width: 2.0;" width="520.5" x="193.5" y="9301.9414"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="208.5" y="9315.5098">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="229" x="282.5" y="9314.5762">[settlementParticipantCurrencyList as pc]</text><path d="M203.5,9326.252 L270.5,9326.252 L270.5,9333.252 L260.5,9343.252 L203.5,9343.252 L203.5,9326.252 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="500.5" x="203.5" y="9326.252"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="218.5" y="9339.8203">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="338" x="285.5" y="9338.8867">[pc.participantCurrencyId == window.participantCurrencyId]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="339" y1="9364.873" y2="9364.873"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="339" x2="339" y1="9364.873" y2="9377.873"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="298" x2="339" y1="9377.873" y2="9377.873"/><polygon fill="#A80036" points="308,9373.873,298,9377.873,308,9381.873,304,9377.873" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="9360.1309">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="366" x="326" y="9360.1309">notSettledWindowsList.push(window.settlementWindowId)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="339" y1="9428.1836" y2="9428.1836"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="339" x2="339" y1="9428.1836" y2="9441.1836"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="298" x2="339" y1="9441.1836" y2="9441.1836"/><polygon fill="#A80036" points="308,9437.1836,298,9441.1836,308,9445.1836,304,9441.1836" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="9423.4414">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="467" x="326" y="9423.4414">settledWindowsList = _.difference(allWindowsList, notSettledWindowsList)</text><path d="M193.5,9456.1836 L358.5,9456.1836 L358.5,9463.1836 L348.5,9473.1836 L193.5,9473.1836 L193.5,9456.1836 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="185.8633" style="stroke: #000000; stroke-width: 2.0;" width="1077.5" x="193.5" y="9456.1836"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="208.5" y="9469.752">DB TRANSACTION</text><path d="M203.5,9480.4941 L277.5,9480.4941 L277.5,9487.4941 L267.5,9497.4941 L203.5,9497.4941 L203.5,9480.4941 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="154.5527" style="stroke: #000000; stroke-width: 2.0;" width="1057.5" x="203.5" y="9480.4941"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="218.5" y="9494.0625">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="171" x="292.5" y="9493.1289">[settledWindowsList as record]</text><polygon fill="#A80036" points="788,9515.1152,798,9519.1152,788,9523.1152,792,9519.1152" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="794" y1="9519.1152" y2="9519.1152"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="9514.373">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="403" x="326" y="9514.373">Change settlement window state for record.settlementWindowId</text><polygon fill="#A80036" points="1125,9559.7363,1135,9563.7363,1125,9567.7363,1129,9563.7363" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="810" x2="1131" y1="9563.7363" y2="9563.7363"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="817" y="9551.3389">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="839" y="9543.6836">Insert new state 'SETTLED'</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="839" y="9558.9941">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="916" y="9558.9941">2001</text><polygon fill="#FFFFE0" filter="url(#fd3oz7vrgavfm)" points="1043,9606.7363,1241,9606.7363,1251,9617.7363,1241,9629.7363,1043,9629.7363,1033,9617.7363,1043,9606.7363" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1045" y="9623.3047">settlementWindowStateChange</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="153.5" x2="1479" y1="9657.0469" y2="9657.0469"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="313" x="158.5" y="9667.6816">[settlementStateChange IN ['NOT_SETTLED', 'SETTLED']]</text><path d="M23,9708.002 L23,10452.002 L278,10452.002 L278,9718.002 L268,9708.002 L23,9708.002 " fill="#FFFFE0" filter="url(#fd3oz7vrgavfm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M268,9708.002 L268,9718.002 L278,9718.002 L268,9708.002 " fill="#FFFFE0" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="29" y="9725.5703">[</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="37" y="9740.8809">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="45" y="9756.1914">"id": 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="45" y="9771.502">"state": &lt;enum&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="45" y="9786.8125">"createdDate": &lt;date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="45" y="9802.123">"settlementWindows": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="53" y="9817.4336">[</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="61" y="9832.7441">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="69" y="9848.0547">"id": 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="69" y="9863.3652">"state": &lt;enum&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="69" y="9878.6758">"reason": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="69" y="9893.9863">"createdDate": &lt;date&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="61" y="9909.2969">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="53" y="9924.6074">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="45" y="9939.918">],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="45" y="9955.2285">"participants": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="53" y="9970.5391">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="61" y="9985.8496">"id": 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="61" y="10001.1602">"accounts": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="69" y="10016.4707">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="77" y="10031.7813">"id": 1,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="77" y="10047.0918">"state": "SETTLED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="77" y="10062.4023">"reason": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="77" y="10077.7129">"createdDate": &lt;date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="77" y="10093.0234">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="85" y="10108.334">"amount": 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="85" y="10123.6445">"currency": &lt;enum&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="77" y="10138.9551">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="69" y="10154.2656">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="69" y="10169.5762">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="77" y="10184.8867">"id": 2,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="77" y="10200.1973">"state": "SETTLED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="77" y="10215.5078">"reason": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="77" y="10230.8184">"createdDate": &lt;date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="77" y="10246.1289">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="85" y="10261.4395">"amount": 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="85" y="10276.75">"currency": &lt;enum&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="77" y="10292.0605">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="77" y="10307.3711">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="85" y="10322.6816">"errorCode": 8001,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="85" y="10337.9922">"errorDescription": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="77" y="10353.3027">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="69" y="10368.6133">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="61" y="10383.9238">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="53" y="10399.2344">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="45" y="10414.5449">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="37" y="10429.8555">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="29" y="10445.166">]</text><!--
@startuml
title 6.2.5. Acknowledgement of Settlement Transfer
autonumber

actor "Hub Employee" as OPERATOR
boundary "Settlement Service API" as SSAPI
entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Central HUB" #lightpink
    participant OPERATOR
end box

box "Settlement Service" #lightgreen
    participant SSAPI
    participant SETTLE_DAO
end box

box "Central Services" #lightyellow
    participant DB
end box

group Acknowledgement of Settlement Transfer
    activate OPERATOR
    note right of OPERATOR #yellow
        {
            "participants": [
                {
                    "id": 1
                    "accounts" : [
                        {
                            "id": 1,
                            "state": "PENDING_SETTLEMENT",
                            "reason": <string>
                        },
                        {
                            "id": 2,
                            "state": "SETTLED",
                            "reason": <string>
                        }
                    ]
                },
                {
                    "id": 2
                    "accounts" : [
                        {
                            "id": 3,
                            "state": "NOT_SETTLED",
                            "reason": <string>
                        }
                    ]
                }
            ]
        }
    end note
    
    note right of OPERATOR #lightgray
        In the sequence diagram below:
        **participantId** is participants[N].id
        **participantCurrencyId** is accounts[N].id
    end note

    OPERATOR -> SSAPI: PUT - /settlement/{id}
    activate SSAPI
    SSAPI -> SETTLE_DAO: Retrive full information for settlement\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    SETTLE_DAO -> DB: Select from DB
    activate DB
    hnote over DB #lightyellow
        SELECT s.settlementId, ssc.settlementStateId, ssc.reason, ssc.createdDate
        FROM **settlement** s
        LEFT JOIN **settlementStateChange** ssc
        ON ssc.settlementId = s.settlementId
        AND ssc.settelementStateChangeId = (
            SELECT MAX(ssc1.settelementStateChangeId)
            FROM **settlementStateChange** ssc1
            WHERE ssc1.settlementId = {id})
        WHERE s.settlementId = {id}
    end hnote
    SETTLE_DAO <- - DB: Return data
    deactivate DB
    SSAPI <- - SETTLE_DAO: Return **settlementData**
    deactivate SETTLE_DAO

    alt settlementStateChange == 'PENDING_SETTLEMENT'
        SSAPI -> SETTLE_DAO: Retrive full information for settlement accounts\n<color #FF0000><b>Error code:</b> 2001</color>
        activate SETTLE_DAO
        SETTLE_DAO -> DB: Select from DB
        activate DB
        hnote over DB #lightyellow
            SELECT pc.participantId, spc.participantCurrencyId, spcsc.settlementStateId, spcsc.reason,
                   spcsc.createdDate, spc.netAmount, pc.currencyId, spc.settlementParticipantCurrencyId AS <color #0000FF>key</color>
            FROM **settlementParticipantCurrency** spc
            JOIN (SELECT spcsc1.settlementParticipantCurrencyId, 
                         MAX(spcsc1.settlementParticipantCurrencyStateChangeId) AS
                         maxSettlementParticipantCurrencyStateChangeId
                  FROM **settlementParticipantCurrency** spc1
                  JOIN **settlementParticipantCurrencyStateChange** spcsc1
                  ON spcsc1.settlementParticipantCurrencyId = spc1.settlementParticipantCurrencyId
                  WHERE spc1.settlementId = {id}
                  GROUP BY spcsc1.settlementParticipantCurrencyId) spcs
            JOIN **settlementParticipantCurrencyStateChange** spcsc
            ON spcsc.settlementParticipantCurrencyStateChangeId =
               spcs.maxSettlementParticipantCurrencyStateChangeId
            JOIN **participantCurrency** pc
            ON pc.participantCurrencyId = spc.participantCurrencyId
            WHERE spc.settlementId = {id}
        end hnote
        SETTLE_DAO <- - DB: Return data
        deactivate DB
        SSAPI <- - SETTLE_DAO: Return **settlementAccountsList**
        deactivate SETTLE_DAO

        SSAPI -> SETTLE_DAO: Retrive full information for settlement windows\n<color #FF0000><b>Error code:</b> 2001</color>
        activate SETTLE_DAO
        SETTLE_DAO -> DB: Select from DB
        activate DB
        hnote over DB #lightyellow
            SELECT ssw.settlementWindowId, sswsc.settlementWindowStateId, sswsc.reason, sswsc.createdDate
            FROM **settlementSettlementWindow** ssw
            JOIN (SELECT sswsc1.settlementWindowId, MAX(sswsc1.settlementWindowStateChangeId) AS
                         maxSettlementWindowStateChangeId
                  FROM **settlementSettlementWindowStateChange** sswsc1
                  WHERE sswsc1.settlementWindowId IN (
                      SELECT ssw1.settlementWindowId
                      FROM **settlementSettlementWindow** ssw1
                      WHERE ssw1.settlementId = {id})
                  GROUP BY sswsc1.settlementWindowId) ssws
            ON ssws.settlementWindowId = ssw.settlementWindowId
            JOIN **settlementSettlementWindowStateChange** sswsc
            ON sswsc.settlementWindowStateChangeId = ssws.maxSettlementWindowStateChangeId
            WHERE ssw.settlementId = {id}
        end hnote
        SETTLE_DAO <- - DB: Return data
        deactivate DB
        SSAPI <- - SETTLE_DAO: Return **windowsList**
        deactivate SETTLE_DAO

        SSAPI -> SETTLE_DAO: Retrive full information for settlement windows accounts\n<color #FF0000><b>Error code:</b> 2001</color>
        activate SETTLE_DAO
        SETTLE_DAO -> DB: Select from DB
        activate DB
        hnote over DB #lightyellow
            SELECT ssw.settlementWindowId, tp.participantCurrencyId
            FROM **settlementSettlementWindow** ssw
            JOIN **transferFulfilment** tf
            ON tf.settlementWindowId = ssw.settlementWindowId
            JOIN **transferParticipant** tp
            ON tp.transferId = tf.transferId
            WHERE settlementId = {id}
            GROUP BY ssw.settlementWindowId, tp.participantCurrencyId
        end hnote
        SETTLE_DAO <- - DB: Return data
        deactivate DB
        SSAPI <- - SETTLE_DAO: Return **windowsAccountsList**
        deactivate SETTLE_DAO

        note right of SSAPI #lightgray
            Available raw datasets from DB:
            **settlementData** contains information about settlement and its current state/reason
            **settlementAccountsList** holds information about all accounts and their current state/reason
            **windowsList** has information about all windows and their current state/reason
            **windowsAccountsList** has information about all accounts and windows

            Local variables and objects:
            **settlementAccounts**: { // (derived from <color 0000FF>settlementAccountsList</color>)
                pendingSettlementCount: <integer>, // count of accounts in PENDING_SETTLEMENT state
                settledCount: <integer>, // count of accounts in SETTLED state
                notSettledCount: <integer> // count of accounts in NOT_SETTLED state
            }
            **allParticipants**: { // same as participants response object with initial data & key (derived from <color 0000FF>settlementAccountsList</color>)
                participantId_key: { // number used to access the object in array-like style
                    id: participantId,
                    accounts: {
                        participantCurrencyId_key: { // number used to access the object in array-like style
                            id: participantCurrencyId,
                            state: settlementStateId,
                            reason: reason,
                            createdDate: createdDate,
                            netSettlementAmount: {
                                amount: netAmount,
                                currency: currencyId
                            }
                        }
                    }
                }
            }
            **allAccounts**: { // same as previous but accessed by account id (derived from <color 0000FF>settlementAccountsList</color>)
                participantCurrencyId_key: { // number used to access the object in array-like style
                    id: participantCurrencyId,
                    state: settlementStateId,
                    reason: reason,
                    createdDate: createdDate,
                    netSettlementAmount: {
                        amount: netAmount,
                        currency: currencyId
                    },
                    participantId: participantId, // could be used to reconstruct allParticipants
                    key: <color 0000FF>key</color> // will be used to insert new state for settlementParticipantCurrency
                }
            }
            **allWindows**: { // same as settlementWindows response object with initial data (derived from <color 0000FF>windowsList</color>)
                settlementWindowId_key: { // number used to access the object in array-like style
                    id: settlementWindowId, // same as key value
                    state: settlementWindowStateId, 
                    reason: reason, 
                    createdDate: createdDate
                }
            }
            **windowsAccounts**: {
                settlementWindowId_key: { // number used to access the object in array-like style
                    id: settlementWindowId // same as key value
                    pendingSettlementAccounts: [], // array of accounts in PENDING_SETTLEMENT state
                    settledAccounts: [], // array of accounts in SETTLED state
                    notSettledAccounts: [] // array of accounts in NOT_SETTLED state
                }
            }
            **accountsWindows**: {
                participantCurrencyId_key: { // number used to access the object in array-like style
                    id: participantCurrencyId, // same as key value
                    windows: [] // array of windows to which the account settlement spans
                }
            }
            let **transactionTimestamp** = now()
        end note
        |||
        SSAPI -> SSAPI: <color FF0000>Acquire DB lock</color> on settlementParticipantCurrencyStateChange,\nsettlementWindowStateChange and settlementStateChange
        note right of SSAPI #lightgray
            let settlementAccounts = {
                pendingSettlementAccounts: 0,
                settledAccounts: 0,
                notSettledAccounts: 0,
            }
            let allParticipants = {} // declare sparse array
            let allAccounts = {} // declare sparse array
            let pid // participantId
            let aid // accountId (participantCurrencyId)
            let state
        end note
        loop settlementAccountsList as record
            note right of SSAPI #lightgray
                pid = record.participantId
                aid = record.participantCurrencyId
                state = record.settlementStateId

                allAccounts[aid] = {
                    id: aid,
                    state,
                    reason: record.reason,
                    createDate: record.createdDate,
                    netSettlementAmount: {
                        amount: record.netAmount,
                        currency: record.currencyId
                    },
                    key
                }
                allParticipants[pid] = allParticipants[pid] ? allParticipants[pid] : {id: pid, accounts: {}}
                allParticipants[pid].accounts[aid] = allAccounts[aid]
            end note
            alt state == 'PENDING_SETTLEMENT'
                note right of SSAPI #lightgray
                    settlementAccounts.pendingSettlementCount++
                end note
            else state == 'SETTLED'
                note right of SSAPI #lightgray
                    settlementAccounts.settledCount++
                end note
            else state == 'NOT_SETTLED'
                note right of SSAPI #lightgray
                    settlementAccounts.notSettledCount++
                end note
            end
        end 
        |||
        note right of SSAPI #lightgray
            let allWindows = {} // declare sparse array
            let wid // settlementWindowId
        end note
        loop windowsList as record
            note right of SSAPI #lightgray
                wid = record.settlementWindowId
                state = record.settlementWindowStateId

                allWindows[wid] = {
                    id: wid,
                    state,
                    reason: record.reason,
                    createDate: record.createdDate
                }
            end note
        end 
        |||
        note right of SSAPI #lightgray
            let windowsAccounts = {} // declare sparse array
            let accountsWindows = {} // declare sparse array
        end note
        loop windowsAccountsList as record
            note right of SSAPI #lightgray
                wid = record.settlementWindowId
                aid = record.participantCurrencyId
                state = allAccounts[aid]

                accountsWindows[aid] = accountsWindows[aid] ? accountsWindows[aid] : {
                    id: aid,
                    windows: []
                }
                accountsWindows[aid].windows.push(wid)

                windowsAccounts[wid] = windowsAccounts[wid] ? windowsAccounts[wid] : {
                    id: wid, 
                    pendingSettlementAccounts: [],
                    settledAccounts: [],
                    notSettledAccounts: []
                }
            end note
            alt state == 'PENDING_SETTLEMENT'
                note right of SSAPI #lightgray
                    windowsAccounts[wid].pendingSettlementAccounts.push(aid)
                end note
            else state == 'SETTLED'
                note right of SSAPI #lightgray
                    windowsAccounts[wid].settledAccounts.push(aid)
                end note
            else state == 'NOT_SETTLED'
                note right of SSAPI #lightgray
                    windowsAccounts[wid].notSettledAccounts.push(aid)
                end note
            end
        end 
        |||
        note right of SSAPI #lightgray
            Available objects after the setup:
            **settlementAccounts** is used for tracing settlement state and state transition allowance
            **allParticipants** is used for tracing participant/account state and state transition
            **allAccounts** is helper object, same as previous, providing direct access to account by id
            **allWindows** has window information for all windows in the settlement
            **windowsAccounts** is used for tracing settlement window state and state transition allowance
            **accountsWindows** is helper object to show the list of windows to which settlement account spans

            Now we are ready to process the **payload**:
            **participants** = [] // part of the response object that lists the affected participants and respective accounts
            **affectedWindows** = [] // array of the affected windows
            **settlementParticipantCurrencyStateChange** = [] // array to collect inserts to the table
            **processedAccounts** = [] // array to log processed accounts and restrict subsequent processing
            let **pi** // declare participant index
            let **ai** // declare account index
            let **participant** - - declare pointer to current participant in the //response object//
            let **participantPayload** - - declare pointer to current participant in the //payload object//
            let **accountPayload** - - declare pointer to current account in the //payload object//
        end note
        |||
        loop let p IN payload.participants
            note right of SSAPI #lightgray
                participantPayload = payload.participants[p]
                participants.push({id: participantPayload.id, accounts: []})
                pi = participants.length - 1
                participant = participants[pi]
            end note
            loop let a IN participantPayload.accounts
                note right of SSAPI #lightgray
                    accountPayload = participantPayload.accounts[a]
                end note
                alt allAccounts[accountPayload.id] == undefined
                    note right of SSAPI #lightgray
                        participant.accounts.push({
                            id: accountPayload.id,
                            errorInformation: {
                                errorCode: <integer>,
                                errorDescription: 'Account not found'
                            }
                        })
                    end note
                else processedAccounts.indexOf(accountPayload.id)
                    note right of SSAPI #lightgray
                        participant.accounts.push({
                            id: accountPayload.id,
                            errorInformation: {
                                errorCode: <integer>,
                                errorDescription: 'Account already processed once'
                            }
                        })
                    end note
                else allAccounts[account.id].state == 'PENDING_SETTLEMENT'
                    alt accountPayload.state == 'PENDING_SETTLEMENT' // allowed
                        note right of SSAPI #lightgray
                            processedAccounts.push(accountPayload.id)
                            participant.accounts.push({
                                id: accountPayload.id,
                                state: accountPayload.state,
                                reason: accountPayload.reason,
                                createdDate: transactionTimestamp,
                                netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                            })
                            settlementParticipantCurrencyStateChange.push({
                                settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,
                                settlementStateId: accountPayload.state,
                                reason: accountPayload.reason
                            })
                        end note
                    else accountPayload.state == 'SETTLED' // allowed
                        note right of SSAPI #lightgray
                            processedAccounts.push(accountPayload.id)
                            participant.accounts.push({
                                id: accountPayload.id,
                                state: accountPayload.state,
                                reason: accountPayload.reason,
                                createdDate: transactionTimestamp,
                                netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                            })
                            settlementParticipantCurrencyStateChange.push({
                                settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,
                                settlementStateId: accountPayload.state,
                                reason: accountPayload.reason
                            })
                            settlementAccounts.pendingSettlementCount- -
                            settlementAccounts.settledCount++
                            allAccounts[accountPayload.id].state = accountPayload.state
                            allAccounts[accountPayload.id].reason = accountPayload.reason
                            allAccounts[accountPayload.id].createdDate = currentTimestamp
                            //allParticipants[participantPayload.id].accounts[accountPayload.id].state = accountPayload.state//
                            //allParticipants[participantPayload.id].accounts[accountPayload.id].reason = accountPayload.reason//
                            //allParticipants[participantPayload.id].accounts[accountPayload.id].createdDate = currentTimestamp//
                            let settlementWindowId
                        end note
                        loop let aw IN accountsWindows[accountPayload.id].windows
                            note right of SSAPI #lightgray
                                settlementWindowId = accountsWindows[accountPayload.id].windows[aw]
                                _.remove(windowsAccounts[settlementWindowId].pendingSettlementAccounts, (value) => {
                                    value == accountPayload.id
                                }
                                windowsAccounts[settlementWindowId].settledAccounts.push(accountPayload.id)

                                if (affectedWindows.indexOf(settlementWindowId) < 0) {
                                    affectedWindows.push(settlementWindowId)
                                }
                            end note
                        end
                    else accountPayload.state == 'NOT_SETTLED' // conditional
                        note right of SSAPI #lightgray
                            let settlementWindowId
                            let windowAccount
                            let isAllowed = true
                        end note
                        loop let aw IN accountsWindows[accountPayload.id].windows
                            note right of SSAPI #lightgray
                                settlementWindowId = accountsWindows[accountPayload.id].windows[aw]
                                if (windowsAccounts[settlementWindowId].settledCount) > 0 {
                                    isAllowed = false
                                }
                            end note
                        end
                        alt isAllowed == false
                            note right of SSAPI #lightgray
                                processedAccounts.push(accountPayload.id)
                                participant.accounts.push({
                                    id: accountPayload.id,
                                    errorInformation: {
                                        errorCode: <integer>,
                                        errorDescription: 'NOT_SETTLED can not be set when there is a settled account within a window'
                                    }
                                })
                            end note
                        else isAllowed == true
                            loop let aw IN accountsWindows[accountPayload.id].windows
                                note right of SSAPI #lightgray
                                    settlementWindowId = accountsWindows[accountPayload.id].windows[aw]
                                end note
                                loop let wa IN windowsAccounts[settlementWindowId].pendingSettlementAccounts
                                    note right of SSAPI #lightgray
                                        windowAccount = windowsAccounts[settlementWindowId].pendingSettlementAccounts[wa]
                                        processedAccounts.push(windowAccount)
                                    end note
                                    opt participants[allAccounts[windowAccount].participantId] == undefined
                                        note right of SSAPI #lightgray
                                            participants[allAccounts[windowAccount].participantId] = {
                                                id: allAccounts[windowAccount].participantId,
                                                accounts: []
                                            }
                                        end note
                                    end
                                    note right of SSAPI #lightgray
                                        participant = participants[allAccounts[windowAccount].participantId]
                                    end note
                                    opt participant.accounts[windowAccount] != undefined
                                        note right of SSAPI #lightgray
                                            _.remove(participant.accounts[windowAccount], (value) => {
                                                value == participant.accounts[windowAccount]
                                            }
                                        end note
                                    end
                                    note right of SSAPI #lightgray
                                        participant.accounts.push({
                                            id: windowAccount,
                                            state: accountPayload.state,
                                            reason: accountPayload.reason,
                                            createdDate: transactionTimestamp,
                                            netSettlementAmount: allAccounts[windowAccount].netSettlementAmount
                                        })
                                        settlementParticipantCurrencyStateChange.push({
                                            settlementParticipantCurrencyId: allAccounts[windowAccount].key,
                                            settlementStateId: accountPayload.state,
                                            reason: accountPayload.reason
                                        })
                                        settlementAccounts.pendingSettlementCount- -
                                        settlementAccounts.notSettledCount++
                                        allAccounts[windowAccount].state = accountPayload.state
                                        allAccounts[windowAccount].reason = accountPayload.reason
                                        allAccounts[windowAccount].createdDate = currentTimestamp
                                        //allParticipants[allAccounts[windowAccount].participantId].accounts[windowAccount].state = accountPayload.state//
                                        //allParticipants[allAccounts[windowAccount].participantId].accounts[windowAccount].reason = accountPayload.reason//
                                        //allParticipants[allAccounts[windowAccount].participantId].accounts[windowAccount].createdDate = currentTimestamp//
                                    end note
                                end
                            end
                        end
                    end
                end
                note right of SSAPI #lightgray
                    
                end note







                |||
                |||
                |||
                SSAPI -> SSAPI: accountIsFound = false
                loop spcStateChangeList as record
                    alt participant.participantId == record.participantId\nand account.participantCurrencyId == record.participantCurrencyId
                        SSAPI -> SSAPI: accountIsFound = true
                        alt record.settlementStateId == 'PENDING_SETTLEMENT'
                            SSAPI -> SSAPI: settlementParticipantCurrencyIdList.push({\n    participantCurrencyId: record.settlementParticipantCurrencyId,\n    reason: 'string'\n})
                            SSAPI -> SSAPI: participantList[participantList.length-1].accounts\n.push({\n    participantCurrencyId: account.participantCurrencyId,\n    reason: 'string',\n    state: 'SETTLED',\n    netSettlementAmount: {\n        amount: record.netAmount\n        currency: record.currencyId\n    }\n})
                        else record.settlementStateId == 'SETTLED'
                            SSAPI -> SSAPI: participantList[participantList.length-1].accounts\n.push({\n    participantCurrencyId: account.participantCurrencyId,\n    errorInformation: {\n        errorCode: 'code',\n        errorDescription: 'Already settled'\n    }\n})
                        end
                        |||
                    end
                    |||
                end
                opt accountIsFound == false
                    SSAPI -> SSAPI: participantList[participantList.length-1].accounts\n.push({\n    participantCurrencyId: account.participantCurrencyId,\n    errorInformation: {\n        errorCode: 'code',\n        errorDescription: 'Account not found'\n    }\n})
                end
                |||
            end
        end
        group <color #blue>DB TRANSACTION</color>
            loop settlementParticipantCurrencyIdList as record
                SSAPI -> SETTLE_DAO: Change settlement participant currency state
                activate SETTLE_DAO
                SETTLE_DAO -> DB: Insert new state 'SETTLED' and record.reason\n<color #FF0000><b>Error code:</b> 2001</color>
                activate DB
                hnote over DB #lightyellow
                    settlementParticipantCurrencyStateChange
                end hnote
                deactivate DB
                deactivate SETTLE_DAO
            end
        end



        SSAPI -> SETTLE_DAO: Get list of all NOT_SETTELED or PENDING_SETTLEMENT\nparticipantCurrencies in settlement
        activate SETTLE_DAO
        SETTLE_DAO -> DB: Retrive list\n<color #FF0000><b>Error code:</b> 2001</color>
        activate DB
        hnote over DB #lightyellow
            SELECT spc.participantCurrencyId
            FROM **settlementParticipantCurrency** spc
            JOIN (SELECT spc.settlementParticipantCurrencyId, 
                         MAX(settlementParticipantCurrencyStateChangeId) AS
                         maxSettlementParticipantCurrencyStateChangeId
                  FROM **settlementParticipantCurrencyStateChange** spcsc
                  JOIN **settlementParticipantCurrency** spc
                  ON spc.settlementParticipantCurrencyId = spcsc.settlementParticipantCurrencyId
                  WHERE spc.settlementId = {id}) AS mx
            ON mx.settlementParticipantCurrencyId = spc.settlementParticipantCurrencyId
            JOIN **settlementParticipantCurrencyStateChange** spcsc
            ON spcsc.settlementParticipantCurrencyStateChangeId = 
               mx.maxSettlementParticipantCurrencyStateChangeId
            WHERE spc.settlementId = {id}
            AND spcsc.settlementStateId != 'SETTLED'
        end hnote
        SETTLE_DAO <- - DB: Return list
        deactivate DB
        SSAPI <- - SETTLE_DAO: Return **settlementParticipantCurrencyList**
        deactivate SETTLE_DAO

        group Settle settlementWindows
            SSAPI -> SSAPI: allWindowsList = []\nnotSettledWindowsList = []
            loop settlementWindowsParticipantCurrencyList as window
                opt window.settlementWindowId NOT IN allWindowsList
                    SSAPI -> SSAPI: allWindowsList.push(window.settlementWindowId)
                end
                loop settlementParticipantCurrencyList as pc
                    opt pc.participantCurrencyId == window.participantCurrencyId
                        SSAPI -> SSAPI: notSettledWindowsList.push(window.settlementWindowId)
                    end
                end
            end
            SSAPI -> SSAPI: settledWindowsList = _.difference(allWindowsList, notSettledWindowsList)

            group <color #blue>DB TRANSACTION</color>
                loop settledWindowsList as record
                    SSAPI -> SETTLE_DAO: Change settlement window state for record.settlementWindowId
                    activate SETTLE_DAO
                    SETTLE_DAO -> DB: Insert new state 'SETTLED'\n<color #FF0000><b>Error code:</b> 2001</color>
                    activate DB
                    hnote over DB #lightyellow
                        settlementWindowStateChange
                    end hnote
                    deactivate DB
                    deactivate SETTLE_DAO
                end
            end
        end


    else settlementStateChange IN ['NOT_SETTLED', 'SETTLED']
        |||
    end

    note left of SSAPI #lightyellow
        [
          {
            "id": 0,
            "state": <enum>,
            "createdDate": <date>,
            "settlementWindows": [
              [
                {
                  "id": 0,
                  "state": <enum>,
                  "reason": <string>,
                  "createdDate": <date>
                }
              ]
            ],
            "participants": [
              {
                "id": 0,
                "accounts": [
                  {
                    "id": 1,
                    "state": "SETTLED",
                    "reason": <string>,
                    "createdDate": <date>,
                    "netSettlementAmount": {
                      "amount": 0,
                      "currency": <enum>
                    }
                  },
                  {
                    "id": 2,
                    "state": "SETTLED",
                    "reason": <string>,
                    "createdDate": <date>,
                    "netSettlementAmount": {
                      "amount": 0,
                      "currency": <enum>
                    },
                    "errorInformation": {
                      "errorCode": 8001,
                      "errorDescription": <string>
                    }
                  }
                ]
              }
            ]
          }
        ]
    end note
    deactivate SSAPI
end
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>