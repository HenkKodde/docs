<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="4498px" preserveAspectRatio="none" style="width:1426px;height:4498px;" version="1.1" viewBox="0 0 1426 4498" width="1426px" zoomAndPan="magnify"><defs><filter height="300%" id="fecah958g60n4" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="342" x="543" y="23.5352">6.2.5. Acknowledgement of Settlement Transfer</text><rect fill="#FFB6C1" height="4453.3535" style="stroke: #A80036; stroke-width: 1.0;" width="112" x="26" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="41.5" y="47.0566">Central HUB</text><rect fill="#90EE90" height="4453.3535" style="stroke: #A80036; stroke-width: 1.0;" width="656.5" x="182.5" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="448.75" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="4453.3535" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="1058" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="1061" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="4245.0664" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="77" y="147.2871"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="3723.4395" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="260" y="660.9141"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="773" y="690.2246"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="442.7637" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="773" y="938.0195"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="74.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="773" y="2499.3125"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="243.7266" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="773" y="2650.5547"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="350.9004" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="773" y="2923.5918"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="74.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="773" y="3686.5293"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1110" y="734.8457"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="368.832" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1110" y="982.6406"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1110" y="2543.9336"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="169.7949" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1110" y="2695.1758"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="276.9688" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1110" y="2968.2129"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1110" y="3731.1504"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="4230.0664" style="stroke: #000000; stroke-width: 2.0;" width="1402" x="13" y="154.2871"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="3006.3281" style="stroke: #000000; stroke-width: 2.0;" width="1278.5" x="126.5" y="857.0879"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="968.9766" style="stroke: #000000; stroke-width: 2.0;" width="637.5" x="136.5" y="1453.4043"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="895.3555" style="stroke: #000000; stroke-width: 2.0;" width="604.5" x="146.5" y="1520.0254"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="615.9395" style="stroke: #000000; stroke-width: 2.0;" width="584.5" x="156.5" y="1586.6465"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="559.6289" style="stroke: #000000; stroke-width: 2.0;" width="564.5" x="166.5" y="1610.957"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="450.0977" style="stroke: #000000; stroke-width: 2.0;" width="544.5" x="176.5" y="1688.4883"/><rect fill="#FFFFFF" height="164.4395" style="stroke: none; stroke-width: 1.0;" width="544.5" x="176.5" y="1974.1465"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="166.7949" style="stroke: #000000; stroke-width: 2.0;" width="488.5" x="176.5" y="2216.5859"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="185.8633" style="stroke: #000000; stroke-width: 2.0;" width="1114.5" x="166.5" y="2436.3809"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="154.5527" style="stroke: #000000; stroke-width: 2.0;" width="1094.5" x="176.5" y="2460.6914"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="526.9688" style="stroke: #000000; stroke-width: 2.0;" width="1107.5" x="146.5" y="3289.4922"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="195.8633" style="stroke: #000000; stroke-width: 2.0;" width="540.5" x="156.5" y="3371.4238"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="451.5" x="176.5" y="3395.7344"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="90.9316" style="stroke: #000000; stroke-width: 2.0;" width="520.5" x="166.5" y="3469.3555"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="500.5" x="176.5" y="3493.666"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="185.8633" style="stroke: #000000; stroke-width: 2.0;" width="1077.5" x="166.5" y="3623.5977"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="154.5527" style="stroke: #000000; stroke-width: 2.0;" width="1057.5" x="176.5" y="3647.9082"/><rect fill="#FFFFFF" height="39.9551" style="stroke: none; stroke-width: 1.0;" width="1278.5" x="126.5" y="3823.4609"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="82" x2="82" y1="137.2871" y2="4401.3535"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="264.5" x2="264.5" y1="137.2871" y2="4401.3535"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="778" x2="778" y1="137.2871" y2="4401.3535"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1115" x2="1115" y1="137.2871" y2="4401.3535"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="30" y="134.334">Hub Employee</text><ellipse cx="82" cy="63.7988" fill="#FEFECE" filter="url(#fecah958g60n4)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M82,71.7988 L82,98.7988 M69,79.7988 L95,79.7988 M82,98.7988 L69,113.7988 M82,98.7988 L95,113.7988 " fill="none" filter="url(#fecah958g60n4)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="30" y="4413.8887">Hub Employee</text><ellipse cx="82" cy="4426.8418" fill="#FEFECE" filter="url(#fecah958g60n4)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M82,4434.8418 L82,4461.8418 M69,4442.8418 L95,4442.8418 M82,4461.8418 L69,4476.8418 M82,4461.8418 L95,4476.8418 " fill="none" filter="url(#fecah958g60n4)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="186.5" y="134.334">Settlement Service API</text><path d="M244.5,92.7988 L244.5,116.7988 M244.5,104.7988 L261.5,104.7988 " fill="none" filter="url(#fecah958g60n4)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="273.5" cy="104.7988" fill="#FEFECE" filter="url(#fecah958g60n4)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="186.5" y="4413.8887">Settlement Service API</text><path d="M244.5,4420.8418 L244.5,4444.8418 M244.5,4432.8418 L261.5,4432.8418 " fill="none" filter="url(#fecah958g60n4)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="273.5" cy="4432.8418" fill="#FEFECE" filter="url(#fecah958g60n4)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="721" y="134.334">Settlement DAO</text><ellipse cx="778" cy="104.7988" fill="#FEFECE" filter="url(#fecah958g60n4)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="766" x2="790" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="721" y="4413.8887">Settlement DAO</text><ellipse cx="778" cy="4432.8418" fill="#FEFECE" filter="url(#fecah958g60n4)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="766" x2="790" y1="4446.8418" y2="4446.8418"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1067" y="134.334">Central Store</text><path d="M1097,84.7988 C1097,74.7988 1115,74.7988 1115,74.7988 C1115,74.7988 1133,74.7988 1133,84.7988 L1133,110.7988 C1133,120.7988 1115,120.7988 1115,120.7988 C1115,120.7988 1097,120.7988 1097,110.7988 L1097,84.7988 " fill="#FEFECE" filter="url(#fecah958g60n4)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1097,84.7988 C1097,94.7988 1115,94.7988 1115,94.7988 C1115,94.7988 1133,94.7988 1133,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1067" y="4413.8887">Central Store</text><path d="M1097,4426.8418 C1097,4416.8418 1115,4416.8418 1115,4416.8418 C1115,4416.8418 1133,4416.8418 1133,4426.8418 L1133,4452.8418 C1133,4462.8418 1115,4462.8418 1115,4462.8418 C1115,4462.8418 1097,4462.8418 1097,4452.8418 L1097,4426.8418 " fill="#FEFECE" filter="url(#fecah958g60n4)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1097,4426.8418 C1097,4436.8418 1115,4436.8418 1115,4436.8418 C1115,4436.8418 1133,4436.8418 1133,4426.8418 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="4245.0664" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="77" y="147.2871"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="3723.4395" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="260" y="660.9141"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="773" y="690.2246"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="442.7637" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="773" y="938.0195"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="74.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="773" y="2499.3125"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="243.7266" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="773" y="2650.5547"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="350.9004" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="773" y="2923.5918"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="74.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="773" y="3686.5293"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1110" y="734.8457"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="368.832" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1110" y="982.6406"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1110" y="2543.9336"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="169.7949" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1110" y="2695.1758"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="276.9688" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1110" y="2968.2129"/><rect fill="#FFFFFF" filter="url(#fecah958g60n4)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1110" y="3731.1504"/><path d="M13,154.2871 L339,154.2871 L339,161.2871 L329,171.2871 L13,171.2871 L13,154.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="4230.0664" style="stroke: #000000; stroke-width: 2.0;" width="1402" x="13" y="154.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="281" x="28" y="167.8555">Acknowledgement of Settlement Transfer</text><path d="M92,176.5977 L92,630.5977 L359,630.5977 L359,186.5977 L349,176.5977 L92,176.5977 " fill="#FFFF00" filter="url(#fecah958g60n4)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M349,176.5977 L349,186.5977 L359,186.5977 L349,176.5977 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="98" y="194.166">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="114" y="209.4766">"participants": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="130" y="224.7871">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="146" y="240.0977">"participantId": 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="146" y="255.4082">"accounts" : [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="162" y="270.7188">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="178" y="286.0293">"participantCurrencyId": 1,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="178" y="301.3398">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="178" y="316.6504"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="178" y="316.6504">"state": "SETTLED"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="162" y="331.9609">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="162" y="347.2715">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="178" y="362.582">"participantCurrencyId": 2,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="178" y="377.8926">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="178" y="393.2031"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="178" y="393.2031">"state": "SETTLED"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="162" y="408.5137">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="146" y="423.8242">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="130" y="439.1348">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="130" y="454.4453">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="146" y="469.7559">"participantId": 2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="146" y="485.0664">"accounts" : [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="162" y="500.377">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="178" y="515.6875">"participantCurrencyId": 3,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="178" y="530.998">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="178" y="546.3086"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="178" y="546.3086">"state": "SETTLED"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="162" y="561.6191">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="146" y="576.9297">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="130" y="592.2402">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="114" y="607.5508">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="98" y="622.8613">}</text><polygon fill="#A80036" points="248,656.9141,258,660.9141,248,664.9141,252,660.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="87" x2="254" y1="660.9141" y2="660.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="94" y="656.1719">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="107" y="656.1719">PUT - /settlement/{id}</text><polygon fill="#A80036" points="761,686.2246,771,690.2246,761,694.2246,765,690.2246" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="270" x2="767" y1="690.2246" y2="690.2246"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="277" y="685.4824">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="290" y="685.4824">Lookup settlement</text><polygon fill="#A80036" points="1098,730.8457,1108,734.8457,1098,738.8457,1102,734.8457" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="783" x2="1104" y1="734.8457" y2="734.8457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="790" y="722.4482">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="803" y="714.793">Lookup settlement and settlement state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="803" y="730.1035">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="880" y="730.1035">2001</text><polygon fill="#FFFFE0" filter="url(#fecah958g60n4)" points="1040,747.8457,1189,747.8457,1199,766.8457,1189,785.8457,1040,785.8457,1030,766.8457,1040,747.8457" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="67" x="1042" y="764.4141">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="1042" y="779.7246">settlementStateChange</text><polygon fill="#A80036" points="794,808.7773,784,812.7773,794,816.7773,790,812.7773" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="788" x2="1114" y1="812.7773" y2="812.7773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="800" y="808.0352">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="813" y="808.0352">Return data</text><polygon fill="#A80036" points="281,838.0879,271,842.0879,281,846.0879,277,842.0879" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="275" x2="777" y1="842.0879" y2="842.0879"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="287" y="837.3457">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="300" y="837.3457">Return data</text><path d="M126.5,857.0879 L188.5,857.0879 L188.5,864.0879 L178.5,874.0879 L126.5,874.0879 L126.5,857.0879 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3006.3281" style="stroke: #000000; stroke-width: 2.0;" width="1278.5" x="126.5" y="857.0879"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="141.5" y="870.6563">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="297" x="203.5" y="869.7227">[settlementStateChange == 'PENDING_SETTLEMENT']</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="270" x2="312" y1="895.709" y2="895.709"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="312" x2="312" y1="895.709" y2="908.709"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="271" x2="312" y1="908.709" y2="908.709"/><polygon fill="#A80036" points="281,904.709,271,908.709,281,912.709,277,908.709" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="277" y="890.9668">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="290" y="890.9668">Create</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="111" x="334" y="890.9668">participantIdList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="81" x="449" y="890.9668">from request</text><polygon fill="#A80036" points="761,934.0195,771,938.0195,761,942.0195,765,938.0195" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="270" x2="767" y1="938.0195" y2="938.0195"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="277" y="933.2773">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="254" x="290" y="933.2773">Select all currencies for participantIdList</text><polygon fill="#A80036" points="1098,978.6406,1108,982.6406,1098,986.6406,1102,982.6406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="783" x2="1104" y1="982.6406" y2="982.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="790" y="970.2432">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="803" y="962.5879">Select from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="803" y="977.8984">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="880" y="977.8984">2001</text><polygon fill="#FFFFE0" filter="url(#fecah958g60n4)" points="849,995.6406,1381,995.6406,1391,1159.6406,1381,1324.6406,849,1324.6406,839,1159.6406,849,995.6406" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="480" x="851" y="1012.209">SELECT pc.participantId, spc.participantCurrencyId, spcsc.settlementStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="425" x="867" y="1027.5195">spc.settlementParticipantCurrencyId, spc.netAmount, pc.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="851" y="1042.8301">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="891" y="1042.8301">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="1031" y="1042.8301">pc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="851" y="1058.1406">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="883" y="1058.1406">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1094" y="1058.1406">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="851" y="1073.4512">ON spc.participantCurrencyId = pc.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="317" x="851" y="1088.7617">JOIN (SELECT spc.settlementParticipantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="336" x="899" y="1104.0723">MAX(settlementParticipantCurrencyStateChangeId) AS</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="307" x="899" y="1119.3828">maxSettlementParticipantCurrencyStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="867" y="1134.6934">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="907" y="1134.6934">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1203" y="1134.6934">spcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="867" y="1150.0039">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="899" y="1150.0039">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1110" y="1150.0039">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="512" x="867" y="1165.3145">ON spc.settlementParticipantCurrencyId = spcsc.settlementParticipantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="867" y="1180.625">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="899" y="1180.625">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="1039" y="1180.625">pc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="867" y="1195.9355">ON pc.participantCurrencyId = spc.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="867" y="1211.2461">WHERE spc.settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="313" x="867" y="1226.5566">AND pc.participantId IN {participantIdList}) AS mx</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="496" x="851" y="1241.8672">ON mx.settlementParticipantCurrencyId = spc.settlementParticipantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="851" y="1257.1777">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="883" y="1257.1777">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1179" y="1257.1777">spcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="851" y="1272.4883">ON spcsc.settlementParticipantCurrencyStateChangeId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="331" x="863" y="1287.7988">mx.maxSettlementParticipantCurrencyStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="851" y="1303.1094">WHERE spc.settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="851" y="1318.4199">AND pc.participantId IN {participantIdList}</text><polygon fill="#A80036" points="794,1347.4727,784,1351.4727,794,1355.4727,790,1351.4727" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="788" x2="1114" y1="1351.4727" y2="1351.4727"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="800" y="1346.7305">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="813" y="1346.7305">Return data</text><polygon fill="#A80036" points="281,1376.7832,271,1380.7832,281,1384.7832,277,1380.7832" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="275" x2="777" y1="1380.7832" y2="1380.7832"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="287" y="1376.041">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="309" y="1376.041">Return spcStateChangeList</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="270" x2="312" y1="1425.4043" y2="1425.4043"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="312" x2="312" y1="1425.4043" y2="1438.4043"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="271" x2="312" y1="1438.4043" y2="1438.4043"/><polygon fill="#A80036" points="281,1434.4043,271,1438.4043,281,1442.4043,277,1438.4043" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="277" y="1413.0068">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="299" y="1405.3516">participantList = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="299" y="1420.6621">settlementParticipantCurrencyIdList = []</text><path d="M136.5,1453.4043 L210.5,1453.4043 L210.5,1460.4043 L200.5,1470.4043 L136.5,1470.4043 L136.5,1453.4043 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="968.9766" style="stroke: #000000; stroke-width: 2.0;" width="637.5" x="136.5" y="1453.4043"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="151.5" y="1466.9727">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="200" x="225.5" y="1466.0391">[payload.participants as participant]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="270" x2="312" y1="1492.0254" y2="1492.0254"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="312" x2="312" y1="1492.0254" y2="1505.0254"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="271" x2="312" y1="1505.0254" y2="1505.0254"/><polygon fill="#A80036" points="281,1501.0254,271,1505.0254,281,1509.0254,277,1505.0254" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="277" y="1487.2832">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="463" x="299" y="1487.2832">participantList.push({participantId: participant.participantId, accounts: []})</text><path d="M146.5,1520.0254 L220.5,1520.0254 L220.5,1527.0254 L210.5,1537.0254 L146.5,1537.0254 L146.5,1520.0254 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="895.3555" style="stroke: #000000; stroke-width: 2.0;" width="604.5" x="146.5" y="1520.0254"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="161.5" y="1533.5938">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="183" x="235.5" y="1532.6602">[participant.accounts as account]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="270" x2="312" y1="1558.6465" y2="1558.6465"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="312" x2="312" y1="1558.6465" y2="1571.6465"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="271" x2="312" y1="1571.6465" y2="1571.6465"/><polygon fill="#A80036" points="281,1567.6465,271,1571.6465,281,1575.6465,277,1571.6465" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="277" y="1553.9043">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="299" y="1553.9043">accountIsFound = false</text><path d="M156.5,1586.6465 L230.5,1586.6465 L230.5,1593.6465 L220.5,1603.6465 L156.5,1603.6465 L156.5,1586.6465 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="615.9395" style="stroke: #000000; stroke-width: 2.0;" width="584.5" x="156.5" y="1586.6465"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="171.5" y="1600.2148">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="245.5" y="1599.2813">[spcStateChangeList as record]</text><path d="M166.5,1610.957 L228.5,1610.957 L228.5,1617.957 L218.5,1627.957 L166.5,1627.957 L166.5,1610.957 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="559.6289" style="stroke: #000000; stroke-width: 2.0;" width="564.5" x="166.5" y="1610.957"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="181.5" y="1624.5254">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="274" x="243.5" y="1623.5918">[participant.participantId == record.participantId</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="381" x="243.5" y="1636.5469">and account.participantCurrencyId == record.participantCurrencyId]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="270" x2="312" y1="1660.4883" y2="1660.4883"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="312" x2="312" y1="1660.4883" y2="1673.4883"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="271" x2="312" y1="1673.4883" y2="1673.4883"/><polygon fill="#A80036" points="281,1669.4883,271,1673.4883,281,1677.4883,277,1673.4883" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="277" y="1655.7461">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="299" y="1655.7461">accountIsFound = true</text><path d="M176.5,1688.4883 L238.5,1688.4883 L238.5,1695.4883 L228.5,1705.4883 L176.5,1705.4883 L176.5,1688.4883 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="450.0977" style="stroke: #000000; stroke-width: 2.0;" width="544.5" x="176.5" y="1688.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="191.5" y="1702.0566">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="306" x="253.5" y="1701.123">[record.settlementStateId == 'PENDING_SETTLEMENT']</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="270" x2="312" y1="1773.041" y2="1773.041"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="312" x2="312" y1="1773.041" y2="1786.041"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="271" x2="312" y1="1786.041" y2="1786.041"/><polygon fill="#A80036" points="281,1782.041,271,1786.041,281,1790.041,277,1786.041" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="277" y="1745.333">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="299" y="1722.3672">settlementParticipantCurrencyIdList.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="394" x="315" y="1737.6777">participantCurrencyId: record.settlementParticipantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="315" y="1752.9883">reason: 'string'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="299" y="1768.2988">})</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="270" x2="312" y1="1953.1465" y2="1953.1465"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="312" x2="312" y1="1953.1465" y2="1966.1465"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="271" x2="312" y1="1966.1465" y2="1966.1465"/><polygon fill="#A80036" points="281,1962.1465,271,1966.1465,281,1970.1465,277,1966.1465" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="277" y="1879.5068">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="299" y="1810.6094">participantList[participantList.length-1].accounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="299" y="1825.9199">.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="315" y="1841.2305">participantCurrencyId: account.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="315" y="1856.541">reason: 'string',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103" x="315" y="1871.8516">state: 'SETTLED',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="315" y="1887.1621">netSettlementAmount: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="331" y="1902.4727">amount: record.netAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="331" y="1917.7832">currency: record.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="315" y="1933.0938">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="299" y="1948.4043">})</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="176.5" x2="721" y1="1975.1465" y2="1975.1465"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="225" x="181.5" y="1985.7813">[record.settlementStateId == 'SETTLED']</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="270" x2="312" y1="2117.5859" y2="2117.5859"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="312" x2="312" y1="2117.5859" y2="2130.5859"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="271" x2="312" y1="2130.5859" y2="2130.5859"/><polygon fill="#A80036" points="281,2126.5859,271,2130.5859,281,2134.5859,277,2130.5859" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="277" y="2059.2568">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="299" y="2005.6699">participantList[participantList.length-1].accounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="299" y="2020.9805">.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="315" y="2036.291">participantCurrencyId: account.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="315" y="2051.6016">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="331" y="2066.9121">errorCode: 'code',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="331" y="2082.2227">errorDescription: 'Already settled'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="315" y="2097.5332">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="299" y="2112.8438">})</text><path d="M176.5,2216.5859 L243.5,2216.5859 L243.5,2223.5859 L233.5,2233.5859 L176.5,2233.5859 L176.5,2216.5859 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="166.7949" style="stroke: #000000; stroke-width: 2.0;" width="488.5" x="176.5" y="2216.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="191.5" y="2230.1543">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="148" x="258.5" y="2229.2207">[accountIsFound == false]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="270" x2="312" y1="2362.3809" y2="2362.3809"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="312" x2="312" y1="2362.3809" y2="2375.3809"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="271" x2="312" y1="2375.3809" y2="2375.3809"/><polygon fill="#A80036" points="281,2371.3809,271,2375.3809,281,2379.3809,277,2375.3809" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="277" y="2304.0518">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="299" y="2250.4648">participantList[participantList.length-1].accounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="299" y="2265.7754">.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="315" y="2281.0859">participantCurrencyId: account.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="315" y="2296.3965">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="331" y="2311.707">errorCode: 'code',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="331" y="2327.0176">errorDescription: 'Account not found'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="315" y="2342.3281">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="299" y="2357.6387">})</text><path d="M166.5,2436.3809 L331.5,2436.3809 L331.5,2443.3809 L321.5,2453.3809 L166.5,2453.3809 L166.5,2436.3809 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="185.8633" style="stroke: #000000; stroke-width: 2.0;" width="1114.5" x="166.5" y="2436.3809"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="181.5" y="2449.9492">DB TRANSACTION</text><path d="M176.5,2460.6914 L250.5,2460.6914 L250.5,2467.6914 L240.5,2477.6914 L176.5,2477.6914 L176.5,2460.6914 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="154.5527" style="stroke: #000000; stroke-width: 2.0;" width="1094.5" x="176.5" y="2460.6914"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="191.5" y="2474.2598">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="263" x="265.5" y="2473.3262">[settlementParticipantCurrencyIdList as record]</text><polygon fill="#A80036" points="761,2495.3125,771,2499.3125,761,2503.3125,765,2499.3125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="270" x2="767" y1="2499.3125" y2="2499.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="277" y="2494.5703">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="283" x="299" y="2494.5703">Change settlement participant currency state</text><polygon fill="#A80036" points="1098,2539.9336,1108,2543.9336,1098,2547.9336,1102,2543.9336" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="783" x2="1104" y1="2543.9336" y2="2543.9336"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="790" y="2531.5361">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="281" x="812" y="2523.8809">Insert new state 'SETTLED' and record.reason</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="812" y="2539.1914">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="889" y="2539.1914">2001</text><polygon fill="#FFFFE0" filter="url(#fecah958g60n4)" points="979,2586.9336,1251,2586.9336,1261,2597.9336,1251,2609.9336,979,2609.9336,969,2597.9336,979,2586.9336" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="981" y="2603.502">settlementParticipantCurrencyStateChange</text><polygon fill="#A80036" points="761,2646.5547,771,2650.5547,761,2654.5547,765,2650.5547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="270" x2="767" y1="2650.5547" y2="2650.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="277" y="2645.8125">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="355" x="299" y="2645.8125">Get list of settlementWindows and participantCurrencies</text><polygon fill="#A80036" points="1098,2691.1758,1108,2695.1758,1098,2699.1758,1102,2695.1758" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="783" x2="1104" y1="2695.1758" y2="2695.1758"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="790" y="2682.7783">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="67" x="812" y="2675.123">Retrive list</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="812" y="2690.4336">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="889" y="2690.4336">2001</text><polygon fill="#FFFFE0" filter="url(#fecah958g60n4)" points="921,2708.1758,1308,2708.1758,1318,2773.1758,1308,2838.1758,921,2838.1758,911,2773.1758,921,2708.1758" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="366" x="923" y="2724.7441">SELECT ssw.settlementWindowId, tp.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="923" y="2740.0547">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="197" x="963" y="2740.0547">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="1164" y="2740.0547">ssw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="923" y="2755.3652">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="955" y="2755.3652">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="1081" y="2755.3652">tf</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="340" x="923" y="2770.6758">ON tf.settlementWindowId = ssw.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="923" y="2785.9863">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="955" y="2785.9863">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="13" x="1086" y="2785.9863">tp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="923" y="2801.2969">ON tp.transferId = tf.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="923" y="2816.6074">WHERE settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="383" x="923" y="2831.918">GROUP BY ssw.settlementWindowId, tp.participantCurrencyId</text><polygon fill="#A80036" points="794,2860.9707,784,2864.9707,794,2868.9707,790,2864.9707" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="788" x2="1114" y1="2864.9707" y2="2864.9707"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="800" y="2860.2285">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="822" y="2860.2285">Return list</text><polygon fill="#A80036" points="281,2890.2813,271,2894.2813,281,2898.2813,277,2894.2813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="275" x2="777" y1="2894.2813" y2="2894.2813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="287" y="2889.5391">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="309" y="2889.5391">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="291" x="354" y="2889.5391">settlementWindowsParticipantCurrencyList</text><polygon fill="#A80036" points="761,2919.5918,771,2923.5918,761,2927.5918,765,2923.5918" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="270" x2="767" y1="2923.5918" y2="2923.5918"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="277" y="2918.8496">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="378" x="299" y="2918.8496">Get list of NOT SETTLED participantCurrencies in settlement</text><polygon fill="#A80036" points="1098,2964.2129,1108,2968.2129,1098,2972.2129,1102,2968.2129" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="783" x2="1104" y1="2968.2129" y2="2968.2129"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="790" y="2955.8154">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="67" x="812" y="2948.1602">Retrive list</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="812" y="2963.4707">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="889" y="2963.4707">2001</text><polygon fill="#FFFFE0" filter="url(#fecah958g60n4)" points="845,2981.2129,1385,2981.2129,1395,3099.2129,1385,3218.2129,845,3218.2129,835,3099.2129,845,2981.2129" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="847" y="2997.7813">SELECT spc.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="847" y="3013.0918">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="887" y="3013.0918">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1098" y="3013.0918">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="317" x="847" y="3028.4023">JOIN (SELECT spc.settlementParticipantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="336" x="899" y="3043.7129">MAX(settlementParticipantCurrencyStateChangeId) AS</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="307" x="899" y="3059.0234">maxSettlementParticipantCurrencyStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="871" y="3074.334">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="911" y="3074.334">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1207" y="3074.334">spcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="871" y="3089.6445">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="903" y="3089.6445">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1114" y="3089.6445">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="512" x="871" y="3104.9551">ON spc.settlementParticipantCurrencyId = spcsc.settlementParticipantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="871" y="3120.2656">WHERE spc.settlementId = {id}) AS mx</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="496" x="847" y="3135.5762">ON mx.settlementParticipantCurrencyId = spc.settlementParticipantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="847" y="3150.8867">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="879" y="3150.8867">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1175" y="3150.8867">spcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="847" y="3166.1973">ON spcsc.settlementParticipantCurrencyStateChangeId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="331" x="859" y="3181.5078">mx.maxSettlementParticipantCurrencyStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="847" y="3196.8184">WHERE spc.settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="847" y="3212.1289">AND spcsc.settlementStateId != 'SETTLED'</text><polygon fill="#A80036" points="794,3241.1816,784,3245.1816,794,3249.1816,790,3245.1816" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="788" x2="1114" y1="3245.1816" y2="3245.1816"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="800" y="3240.4395">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="822" y="3240.4395">Return list</text><polygon fill="#A80036" points="281,3270.4922,271,3274.4922,281,3278.4922,277,3274.4922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="275" x2="777" y1="3274.4922" y2="3274.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="287" y="3269.75">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="309" y="3269.75">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="231" x="354" y="3269.75">settlementParticipantCurrencyList</text><path d="M146.5,3289.4922 L364.5,3289.4922 L364.5,3296.4922 L354.5,3306.4922 L146.5,3306.4922 L146.5,3289.4922 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="526.9688" style="stroke: #000000; stroke-width: 2.0;" width="1107.5" x="146.5" y="3289.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="173" x="161.5" y="3303.0605">Settle settlementWindows</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="270" x2="312" y1="3343.4238" y2="3343.4238"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="312" x2="312" y1="3343.4238" y2="3356.4238"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="271" x2="312" y1="3356.4238" y2="3356.4238"/><polygon fill="#A80036" points="281,3352.4238,271,3356.4238,281,3360.4238,277,3356.4238" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="277" y="3331.0264">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="299" y="3323.3711">allWindowsList = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="299" y="3338.6816">notSettledWindowsList = []</text><path d="M156.5,3371.4238 L230.5,3371.4238 L230.5,3378.4238 L220.5,3388.4238 L156.5,3388.4238 L156.5,3371.4238 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="195.8633" style="stroke: #000000; stroke-width: 2.0;" width="540.5" x="156.5" y="3371.4238"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="171.5" y="3384.9922">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="309" x="245.5" y="3384.0586">[settlementWindowsParticipantCurrencyList as window]</text><path d="M176.5,3395.7344 L243.5,3395.7344 L243.5,3402.7344 L233.5,3412.7344 L176.5,3412.7344 L176.5,3395.7344 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="451.5" x="176.5" y="3395.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="191.5" y="3409.3027">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="300" x="258.5" y="3408.3691">[window.settlementWindowId NOT IN allWindowsList]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="270" x2="312" y1="3434.3555" y2="3434.3555"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="312" x2="312" y1="3434.3555" y2="3447.3555"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="271" x2="312" y1="3447.3555" y2="3447.3555"/><polygon fill="#A80036" points="281,3443.3555,271,3447.3555,281,3451.3555,277,3447.3555" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="277" y="3429.6133">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="317" x="299" y="3429.6133">allWindowsList.push(window.settlementWindowId)</text><path d="M166.5,3469.3555 L240.5,3469.3555 L240.5,3476.3555 L230.5,3486.3555 L166.5,3486.3555 L166.5,3469.3555 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="90.9316" style="stroke: #000000; stroke-width: 2.0;" width="520.5" x="166.5" y="3469.3555"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="181.5" y="3482.9238">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="229" x="255.5" y="3481.9902">[settlementParticipantCurrencyList as pc]</text><path d="M176.5,3493.666 L243.5,3493.666 L243.5,3500.666 L233.5,3510.666 L176.5,3510.666 L176.5,3493.666 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="500.5" x="176.5" y="3493.666"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="191.5" y="3507.2344">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="338" x="258.5" y="3506.3008">[pc.participantCurrencyId == window.participantCurrencyId]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="270" x2="312" y1="3532.2871" y2="3532.2871"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="312" x2="312" y1="3532.2871" y2="3545.2871"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="271" x2="312" y1="3545.2871" y2="3545.2871"/><polygon fill="#A80036" points="281,3541.2871,271,3545.2871,281,3549.2871,277,3545.2871" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="277" y="3527.5449">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="366" x="299" y="3527.5449">notSettledWindowsList.push(window.settlementWindowId)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="270" x2="312" y1="3595.5977" y2="3595.5977"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="312" x2="312" y1="3595.5977" y2="3608.5977"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="271" x2="312" y1="3608.5977" y2="3608.5977"/><polygon fill="#A80036" points="281,3604.5977,271,3608.5977,281,3612.5977,277,3608.5977" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="277" y="3590.8555">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="467" x="299" y="3590.8555">settledWindowsList = _.difference(allWindowsList, notSettledWindowsList)</text><path d="M166.5,3623.5977 L331.5,3623.5977 L331.5,3630.5977 L321.5,3640.5977 L166.5,3640.5977 L166.5,3623.5977 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="185.8633" style="stroke: #000000; stroke-width: 2.0;" width="1077.5" x="166.5" y="3623.5977"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="181.5" y="3637.166">DB TRANSACTION</text><path d="M176.5,3647.9082 L250.5,3647.9082 L250.5,3654.9082 L240.5,3664.9082 L176.5,3664.9082 L176.5,3647.9082 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="154.5527" style="stroke: #000000; stroke-width: 2.0;" width="1057.5" x="176.5" y="3647.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="191.5" y="3661.4766">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="171" x="265.5" y="3660.543">[settledWindowsList as record]</text><polygon fill="#A80036" points="761,3682.5293,771,3686.5293,761,3690.5293,765,3686.5293" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="270" x2="767" y1="3686.5293" y2="3686.5293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="277" y="3681.7871">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="403" x="299" y="3681.7871">Change settlement window state for record.settlementWindowId</text><polygon fill="#A80036" points="1098,3727.1504,1108,3731.1504,1098,3735.1504,1102,3731.1504" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="783" x2="1104" y1="3731.1504" y2="3731.1504"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="790" y="3718.7529">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="812" y="3711.0977">Insert new state 'SETTLED'</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="812" y="3726.4082">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="889" y="3726.4082">2001</text><polygon fill="#FFFFE0" filter="url(#fecah958g60n4)" points="1016,3774.1504,1214,3774.1504,1224,3785.1504,1214,3797.1504,1016,3797.1504,1006,3785.1504,1016,3774.1504" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1018" y="3790.7188">settlementWindowStateChange</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="126.5" x2="1405" y1="3824.4609" y2="3824.4609"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="313" x="131.5" y="3835.0957">[settlementStateChange IN ['NOT_SETTLED', 'SETTLED']]</text><path d="M23,3875.416 L23,4374.416 L251,4374.416 L251,3885.416 L241,3875.416 L23,3875.416 " fill="#FFFFE0" filter="url(#fecah958g60n4)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M241,3875.416 L241,3885.416 L251,3885.416 L241,3875.416 " fill="#FFFFE0" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="29" y="3892.9844">[</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="37" y="3908.2949">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="45" y="3923.6055">"id": 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="45" y="3938.916">"state": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="45" y="3954.2266">"settlementWindows": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="53" y="3969.5371">[</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="61" y="3984.8477">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="69" y="4000.1582">"id": 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="69" y="4015.4688">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="69" y="4030.7793">"state": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="69" y="4046.0898">"createdDate": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="61" y="4061.4004">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="53" y="4076.7109">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="45" y="4092.0215">],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="45" y="4107.332">"participants": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="53" y="4122.6426">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="61" y="4137.9531">"id": 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="61" y="4153.2637">"accounts": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="69" y="4168.5742">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="81" x="77" y="4183.8848">"id": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="77" y="4199.1953">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="77" y="4214.5059">"state": "SETTLED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="77" y="4229.8164">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="85" y="4245.127">"amount": 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="85" y="4260.4375">"currency": "string"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="77" y="4275.748">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="69" y="4291.0586">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="61" y="4306.3691">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="53" y="4321.6797">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="45" y="4336.9902">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="37" y="4352.3008">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="29" y="4367.6113">]</text><!--
@startuml
title 6.2.5. Acknowledgement of Settlement Transfer
autonumber

actor "Hub Employee" as OPERATOR
boundary "Settlement Service API" as SSAPI
entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Central HUB" #LightPink
    participant OPERATOR
end box

box "Settlement Service" #LightGreen
    participant SSAPI
    participant SETTLE_DAO
end box

box "Central Services" #LightYellow
    participant DB
end box

group Acknowledgement of Settlement Transfer
    activate OPERATOR
    note right of OPERATOR #Yellow
        {
            "participants": [
                {
                    "participantId": 1
                    "accounts" : [
                        {
                            "participantCurrencyId": 1,
                            "reason": "string",
                            <color #FF0000>"state": "SETTLED"</color>
                        },
                        {
                            "participantCurrencyId": 2,
                            "reason": "string",
                            <color #FF0000>"state": "SETTLED"</color>
                        }
                    ]
                },
                {
                    "participantId": 2
                    "accounts" : [
                        {
                            "participantCurrencyId": 3,
                            "reason": "string",
                            <color #FF0000>"state": "SETTLED"</color>
                        }
                    ]
                }
            ]
        }
    end note
    OPERATOR -> SSAPI: PUT - /settlement/{id}
    activate SSAPI
    SSAPI -> SETTLE_DAO: Lookup settlement
    activate SETTLE_DAO
    SETTLE_DAO -> DB: Lookup settlement and settlement state\n<color #FF0000><b>Error code:</b> 2001</color>
    activate DB
    hnote over DB #LightYellow
        settlement
        settlementStateChange
    end hnote
    SETTLE_DAO <- - DB: Return data
    deactivate DB
    SSAPI <- - SETTLE_DAO: Return data
    deactivate SETTLE_DAO

    alt settlementStateChange == 'PENDING_SETTLEMENT'
        SSAPI -> SSAPI: Create **participantIdList** from request

        SSAPI -> SETTLE_DAO: Select all currencies for participantIdList
        activate SETTLE_DAO
        SETTLE_DAO -> DB: Select from DB\n<color #FF0000><b>Error code:</b> 2001</color>
        activate DB
        hnote over DB #LightYellow
            SELECT pc.participantId, spc.participantCurrencyId, spcsc.settlementStateId, 
                spc.settlementParticipantCurrencyId, spc.netAmount, pc.currencyId
            FROM **participantCurrency** pc
            JOIN **settlementParticipantCurrency** spc
            ON spc.participantCurrencyId = pc.participantCurrencyId
            JOIN (SELECT spc.settlementParticipantCurrencyId, 
                        MAX(settlementParticipantCurrencyStateChangeId) AS
                        maxSettlementParticipantCurrencyStateChangeId
                FROM **settlementParticipantCurrencyStateChange** spcsc
                JOIN **settlementParticipantCurrency** spc
                ON spc.settlementParticipantCurrencyId = spcsc.settlementParticipantCurrencyId
                JOIN **participantCurrency** pc
                ON pc.participantCurrencyId = spc.participantCurrencyId
                WHERE spc.settlementId = {id}
                AND pc.participantId IN {participantIdList}) AS mx
            ON mx.settlementParticipantCurrencyId = spc.settlementParticipantCurrencyId
            JOIN **settlementParticipantCurrencyStateChange** spcsc
            ON spcsc.settlementParticipantCurrencyStateChangeId = 
               mx.maxSettlementParticipantCurrencyStateChangeId
            WHERE spc.settlementId = {id}
            AND pc.participantId IN {participantIdList}
        end hnote
        SETTLE_DAO <- - DB: Return data
        deactivate DB
        SSAPI <- - SETTLE_DAO: Return spcStateChangeList
        deactivate SETTLE_DAO

        SSAPI -> SSAPI: participantList = []\nsettlementParticipantCurrencyIdList = []
        loop payload.participants as participant
            SSAPI -> SSAPI: participantList.push({participantId: participant.participantId, accounts: []})
            loop participant.accounts as account
                SSAPI -> SSAPI: accountIsFound = false
                loop spcStateChangeList as record
                    alt participant.participantId == record.participantId\nand account.participantCurrencyId == record.participantCurrencyId
                        SSAPI -> SSAPI: accountIsFound = true
                        alt record.settlementStateId == 'PENDING_SETTLEMENT'
                            SSAPI -> SSAPI: settlementParticipantCurrencyIdList.push({\n    participantCurrencyId: record.settlementParticipantCurrencyId,\n    reason: 'string'\n})
                            SSAPI -> SSAPI: participantList[participantList.length-1].accounts\n.push({\n    participantCurrencyId: account.participantCurrencyId,\n    reason: 'string',\n    state: 'SETTLED',\n    netSettlementAmount: {\n        amount: record.netAmount\n        currency: record.currencyId\n    }\n})
                        else record.settlementStateId == 'SETTLED'
                            SSAPI -> SSAPI: participantList[participantList.length-1].accounts\n.push({\n    participantCurrencyId: account.participantCurrencyId,\n    errorInformation: {\n        errorCode: 'code',\n        errorDescription: 'Already settled'\n    }\n})
                        end
                        |||
                    end
                    |||
                end
                opt accountIsFound == false
                    SSAPI -> SSAPI: participantList[participantList.length-1].accounts\n.push({\n    participantCurrencyId: account.participantCurrencyId,\n    errorInformation: {\n        errorCode: 'code',\n        errorDescription: 'Account not found'\n    }\n})
                end
                |||
            end
        end
        group <color #blue>DB TRANSACTION</color>
            loop settlementParticipantCurrencyIdList as record
                SSAPI -> SETTLE_DAO: Change settlement participant currency state
                activate SETTLE_DAO
                SETTLE_DAO -> DB: Insert new state 'SETTLED' and record.reason\n<color #FF0000><b>Error code:</b> 2001</color>
                activate DB
                hnote over DB #LightYellow
                    settlementParticipantCurrencyStateChange
                end hnote
                deactivate DB
                deactivate SETTLE_DAO
            end
        end

        SSAPI -> SETTLE_DAO: Get list of settlementWindows and participantCurrencies
        activate SETTLE_DAO
        SETTLE_DAO -> DB: Retrive list\n<color #FF0000><b>Error code:</b> 2001</color>
        activate DB
        hnote over DB #LightYellow
            SELECT ssw.settlementWindowId, tp.participantCurrencyId
            FROM **settlementSettlementWindow** ssw
            JOIN **transferFulfilment** tf
            ON tf.settlementWindowId = ssw.settlementWindowId
            JOIN **transferParticipant** tp
            ON tp.transferId = tf.transferId
            WHERE settlementId = {id}
            GROUP BY ssw.settlementWindowId, tp.participantCurrencyId
        end hnote
        SETTLE_DAO <- - DB: Return list
        deactivate DB
        SSAPI <- - SETTLE_DAO: Return **settlementWindowsParticipantCurrencyList**
        deactivate SETTLE_DAO

        SSAPI -> SETTLE_DAO: Get list of NOT SETTLED participantCurrencies in settlement
        activate SETTLE_DAO
        SETTLE_DAO -> DB: Retrive list\n<color #FF0000><b>Error code:</b> 2001</color>
        activate DB
        hnote over DB #LightYellow
            SELECT spc.participantCurrencyId
            FROM **settlementParticipantCurrency** spc
            JOIN (SELECT spc.settlementParticipantCurrencyId, 
                         MAX(settlementParticipantCurrencyStateChangeId) AS
                         maxSettlementParticipantCurrencyStateChangeId
                  FROM **settlementParticipantCurrencyStateChange** spcsc
                  JOIN **settlementParticipantCurrency** spc
                  ON spc.settlementParticipantCurrencyId = spcsc.settlementParticipantCurrencyId
                  WHERE spc.settlementId = {id}) AS mx
            ON mx.settlementParticipantCurrencyId = spc.settlementParticipantCurrencyId
            JOIN **settlementParticipantCurrencyStateChange** spcsc
            ON spcsc.settlementParticipantCurrencyStateChangeId = 
               mx.maxSettlementParticipantCurrencyStateChangeId
            WHERE spc.settlementId = {id}
            AND spcsc.settlementStateId != 'SETTLED'
        end hnote
        SETTLE_DAO <- - DB: Return list
        deactivate DB
        SSAPI <- - SETTLE_DAO: Return **settlementParticipantCurrencyList**
        deactivate SETTLE_DAO

        group Settle settlementWindows
            SSAPI -> SSAPI: allWindowsList = []\nnotSettledWindowsList = []
            loop settlementWindowsParticipantCurrencyList as window
                opt window.settlementWindowId NOT IN allWindowsList
                    SSAPI -> SSAPI: allWindowsList.push(window.settlementWindowId)
                end
                loop settlementParticipantCurrencyList as pc
                    opt pc.participantCurrencyId == window.participantCurrencyId
                        SSAPI -> SSAPI: notSettledWindowsList.push(window.settlementWindowId)
                    end
                end
            end
            SSAPI -> SSAPI: settledWindowsList = _.difference(allWindowsList, notSettledWindowsList)

            group <color #blue>DB TRANSACTION</color>
                loop settledWindowsList as record
                    SSAPI -> SETTLE_DAO: Change settlement window state for record.settlementWindowId
                    activate SETTLE_DAO
                    SETTLE_DAO -> DB: Insert new state 'SETTLED'\n<color #FF0000><b>Error code:</b> 2001</color>
                    activate DB
                    hnote over DB #LightYellow
                        settlementWindowStateChange
                    end hnote
                    deactivate DB
                    deactivate SETTLE_DAO
                end
            end
        end


    else settlementStateChange IN ['NOT_SETTLED', 'SETTLED']
        |||
    end

    note left of SSAPI #LightYellow
        [
          {
            "id": 0,
            "state": "string",
            "settlementWindows": [
              [
                {
                  "id": 0,
                  "reason": "string",
                  "state": "string",
                  "createdDate": "string",
                }
              ]
            ],
            "participants": [
              {
                "id": 0,
                "accounts": [
                  {
                    "id": "string",
                    "reason": "string",
                    "state": "SETTLED",
                    "netSettlementAmount": {
                      "amount": 0,
                      "currency": "string"
                    }
                  }
                ]
              }
            ]
          }
        ]
    end note
    deactivate SSAPI
end
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>