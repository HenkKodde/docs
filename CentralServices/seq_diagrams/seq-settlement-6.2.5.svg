<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="4783px" preserveAspectRatio="none" style="width:1443px;height:4783px;" version="1.1" viewBox="0 0 1443 4783" width="1443px" zoomAndPan="magnify"><defs><filter height="300%" id="f902e2a7azary" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="342" x="551.5" y="23.5352">6.2.5. Acknowledgement of Settlement Transfer</text><rect fill="#FFB6C1" height="4737.6328" style="stroke: #A80036; stroke-width: 1.0;" width="112" x="43" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="58.5" y="47.0566">Central HUB</text><rect fill="#90EE90" height="4737.6328" style="stroke: #A80036; stroke-width: 1.0;" width="656.5" x="199.5" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="465.75" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="4737.6328" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="1075" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="1078" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="4529.3457" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="94" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="3937.7871" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="277" y="730.8457"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="790" y="760.1563"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="442.7637" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="790" y="1007.9512"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="74.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="790" y="2569.2441"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="243.7266" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="790" y="2720.4863"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="350.9004" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="790" y="3008.834"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="74.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="790" y="3771.7715"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1127" y="804.7773"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="368.832" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1127" y="1052.5723"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1127" y="2613.8652"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="169.7949" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1127" y="2765.1074"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="276.9688" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1127" y="3053.4551"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1127" y="3816.3926"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="4514.3457" style="stroke: #000000; stroke-width: 2.0;" width="1419" x="13" y="154.2871"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="3021.6387" style="stroke: #000000; stroke-width: 2.0;" width="1278.5" x="143.5" y="927.0195"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="968.9766" style="stroke: #000000; stroke-width: 2.0;" width="637.5" x="153.5" y="1523.3359"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="895.3555" style="stroke: #000000; stroke-width: 2.0;" width="604.5" x="163.5" y="1589.957"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="615.9395" style="stroke: #000000; stroke-width: 2.0;" width="584.5" x="173.5" y="1656.5781"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="559.6289" style="stroke: #000000; stroke-width: 2.0;" width="564.5" x="183.5" y="1680.8887"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="450.0977" style="stroke: #000000; stroke-width: 2.0;" width="544.5" x="193.5" y="1758.4199"/><rect fill="#FFFFFF" height="164.4395" style="stroke: none; stroke-width: 1.0;" width="544.5" x="193.5" y="2044.0781"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="166.7949" style="stroke: #000000; stroke-width: 2.0;" width="488.5" x="193.5" y="2286.5176"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="185.8633" style="stroke: #000000; stroke-width: 2.0;" width="1114.5" x="183.5" y="2506.3125"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="154.5527" style="stroke: #000000; stroke-width: 2.0;" width="1094.5" x="193.5" y="2530.623"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="526.9688" style="stroke: #000000; stroke-width: 2.0;" width="1107.5" x="163.5" y="3374.7344"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="195.8633" style="stroke: #000000; stroke-width: 2.0;" width="540.5" x="173.5" y="3456.666"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="451.5" x="193.5" y="3480.9766"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="90.9316" style="stroke: #000000; stroke-width: 2.0;" width="520.5" x="183.5" y="3554.5977"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="500.5" x="193.5" y="3578.9082"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="185.8633" style="stroke: #000000; stroke-width: 2.0;" width="1077.5" x="183.5" y="3708.8398"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="154.5527" style="stroke: #000000; stroke-width: 2.0;" width="1057.5" x="193.5" y="3733.1504"/><rect fill="#FFFFFF" height="39.9551" style="stroke: none; stroke-width: 1.0;" width="1278.5" x="143.5" y="3908.7031"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="99" x2="99" y1="137.2871" y2="4685.6328"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="281.5" x2="281.5" y1="137.2871" y2="4685.6328"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="795" x2="795" y1="137.2871" y2="4685.6328"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1132" x2="1132" y1="137.2871" y2="4685.6328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="47" y="134.334">Hub Employee</text><ellipse cx="99" cy="63.7988" fill="#FEFECE" filter="url(#f902e2a7azary)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M99,71.7988 L99,98.7988 M86,79.7988 L112,79.7988 M99,98.7988 L86,113.7988 M99,98.7988 L112,113.7988 " fill="none" filter="url(#f902e2a7azary)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="47" y="4698.168">Hub Employee</text><ellipse cx="99" cy="4711.1211" fill="#FEFECE" filter="url(#f902e2a7azary)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M99,4719.1211 L99,4746.1211 M86,4727.1211 L112,4727.1211 M99,4746.1211 L86,4761.1211 M99,4746.1211 L112,4761.1211 " fill="none" filter="url(#f902e2a7azary)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="203.5" y="134.334">Settlement Service API</text><path d="M261.5,92.7988 L261.5,116.7988 M261.5,104.7988 L278.5,104.7988 " fill="none" filter="url(#f902e2a7azary)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="290.5" cy="104.7988" fill="#FEFECE" filter="url(#f902e2a7azary)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="203.5" y="4698.168">Settlement Service API</text><path d="M261.5,4705.1211 L261.5,4729.1211 M261.5,4717.1211 L278.5,4717.1211 " fill="none" filter="url(#f902e2a7azary)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="290.5" cy="4717.1211" fill="#FEFECE" filter="url(#f902e2a7azary)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="738" y="134.334">Settlement DAO</text><ellipse cx="795" cy="104.7988" fill="#FEFECE" filter="url(#f902e2a7azary)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="783" x2="807" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="738" y="4698.168">Settlement DAO</text><ellipse cx="795" cy="4717.1211" fill="#FEFECE" filter="url(#f902e2a7azary)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="783" x2="807" y1="4731.1211" y2="4731.1211"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1084" y="134.334">Central Store</text><path d="M1114,84.7988 C1114,74.7988 1132,74.7988 1132,74.7988 C1132,74.7988 1150,74.7988 1150,84.7988 L1150,110.7988 C1150,120.7988 1132,120.7988 1132,120.7988 C1132,120.7988 1114,120.7988 1114,110.7988 L1114,84.7988 " fill="#FEFECE" filter="url(#f902e2a7azary)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1114,84.7988 C1114,94.7988 1132,94.7988 1132,94.7988 C1132,94.7988 1150,94.7988 1150,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1084" y="4698.168">Central Store</text><path d="M1114,4711.1211 C1114,4701.1211 1132,4701.1211 1132,4701.1211 C1132,4701.1211 1150,4701.1211 1150,4711.1211 L1150,4737.1211 C1150,4747.1211 1132,4747.1211 1132,4747.1211 C1132,4747.1211 1114,4747.1211 1114,4737.1211 L1114,4711.1211 " fill="#FEFECE" filter="url(#f902e2a7azary)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1114,4711.1211 C1114,4721.1211 1132,4721.1211 1132,4721.1211 C1132,4721.1211 1150,4721.1211 1150,4711.1211 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="4529.3457" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="94" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="3937.7871" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="277" y="730.8457"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="790" y="760.1563"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="442.7637" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="790" y="1007.9512"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="74.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="790" y="2569.2441"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="243.7266" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="790" y="2720.4863"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="350.9004" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="790" y="3008.834"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="74.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="790" y="3771.7715"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1127" y="804.7773"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="368.832" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1127" y="1052.5723"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1127" y="2613.8652"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="169.7949" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1127" y="2765.1074"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="276.9688" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1127" y="3053.4551"/><rect fill="#FFFFFF" filter="url(#f902e2a7azary)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1127" y="3816.3926"/><path d="M13,154.2871 L339,154.2871 L339,161.2871 L329,171.2871 L13,171.2871 L13,154.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="4514.3457" style="stroke: #000000; stroke-width: 2.0;" width="1419" x="13" y="154.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="281" x="28" y="167.8555">Acknowledgement of Settlement Transfer</text><path d="M109,176.5977 L109,630.5977 L413,630.5977 L413,186.5977 L403,176.5977 L109,176.5977 " fill="#FFFF00" filter="url(#f902e2a7azary)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M403,176.5977 L403,186.5977 L413,186.5977 L403,176.5977 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="115" y="194.166">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="131" y="209.4766">"participants": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="147" y="224.7871">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="163" y="240.0977">"id": 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="163" y="255.4082">"accounts" : [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="270.7188">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="195" y="286.0293">"id": 1,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="195" y="301.3398">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="203" x="195" y="316.6504">"state": "PENDING_SETTLEMENT"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="179" y="331.9609">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="347.2715">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="195" y="362.582">"id": 2,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="195" y="377.8926">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="195" y="393.2031">"state": "SETTLED"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="408.5137">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="163" y="423.8242">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="147" y="439.1348">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="147" y="454.4453">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="163" y="469.7559">"id": 2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="163" y="485.0664">"accounts" : [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="500.377">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="195" y="515.6875">"id": 3,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="195" y="530.998">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="195" y="546.3086">"state": "NOT_SETTLED"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="561.6191">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="163" y="576.9297">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="147" y="592.2402">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="131" y="607.5508">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="115" y="622.8613">}</text><path d="M109,644.6035 L109,699.6035 L393,699.6035 L393,654.6035 L383,644.6035 L109,644.6035 " fill="#D3D3D3" filter="url(#f902e2a7azary)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M383,644.6035 L383,654.6035 L393,654.6035 L383,644.6035 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="215" x="115" y="662.1719">In the sequence below we refer to:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="115" y="677.4824">- participants[N].id AS participantId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="115" y="692.793">- accounts[N].id AS participantCurrencyId</text><polygon fill="#A80036" points="265,726.8457,275,730.8457,265,734.8457,269,730.8457" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="104" x2="271" y1="730.8457" y2="730.8457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="111" y="726.1035">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="124" y="726.1035">PUT - /settlement/{id}</text><polygon fill="#A80036" points="778,756.1563,788,760.1563,778,764.1563,782,760.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="287" x2="784" y1="760.1563" y2="760.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="294" y="755.4141">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="307" y="755.4141">Lookup settlement</text><polygon fill="#A80036" points="1115,800.7773,1125,804.7773,1115,808.7773,1119,804.7773" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="800" x2="1121" y1="804.7773" y2="804.7773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="807" y="792.3799">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="820" y="784.7246">Lookup settlement and settlement state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="820" y="800.0352">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="897" y="800.0352">2001</text><polygon fill="#FFFFE0" filter="url(#f902e2a7azary)" points="1057,817.7773,1206,817.7773,1216,836.7773,1206,855.7773,1057,855.7773,1047,836.7773,1057,817.7773" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="67" x="1059" y="834.3457">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="1059" y="849.6563">settlementStateChange</text><polygon fill="#A80036" points="811,878.709,801,882.709,811,886.709,807,882.709" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="805" x2="1131" y1="882.709" y2="882.709"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="817" y="877.9668">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="830" y="877.9668">Return data</text><polygon fill="#A80036" points="298,908.0195,288,912.0195,298,916.0195,294,912.0195" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="292" x2="794" y1="912.0195" y2="912.0195"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="304" y="907.2773">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="317" y="907.2773">Return data</text><path d="M143.5,927.0195 L205.5,927.0195 L205.5,934.0195 L195.5,944.0195 L143.5,944.0195 L143.5,927.0195 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3021.6387" style="stroke: #000000; stroke-width: 2.0;" width="1278.5" x="143.5" y="927.0195"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="158.5" y="940.5879">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="297" x="220.5" y="939.6543">[settlementStateChange == 'PENDING_SETTLEMENT']</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="287" x2="329" y1="965.6406" y2="965.6406"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="329" x2="329" y1="965.6406" y2="978.6406"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="288" x2="329" y1="978.6406" y2="978.6406"/><polygon fill="#A80036" points="298,974.6406,288,978.6406,298,982.6406,294,978.6406" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="294" y="960.8984">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="307" y="960.8984">Create</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="111" x="351" y="960.8984">participantIdList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="81" x="466" y="960.8984">from request</text><polygon fill="#A80036" points="778,1003.9512,788,1007.9512,778,1011.9512,782,1007.9512" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="287" x2="784" y1="1007.9512" y2="1007.9512"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="294" y="1003.209">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="352" x="307" y="1003.209">Retrive participant details and state for participantIdList</text><polygon fill="#A80036" points="1115,1048.5723,1125,1052.5723,1115,1056.5723,1119,1052.5723" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="800" x2="1121" y1="1052.5723" y2="1052.5723"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="807" y="1040.1748">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="820" y="1032.5195">Select from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="820" y="1047.8301">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="897" y="1047.8301">2001</text><polygon fill="#FFFFE0" filter="url(#f902e2a7azary)" points="866,1065.5723,1398,1065.5723,1408,1229.5723,1398,1394.5723,866,1394.5723,856,1229.5723,866,1065.5723" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="480" x="868" y="1082.1406">SELECT pc.participantId, spc.participantCurrencyId, spcsc.settlementStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="425" x="884" y="1097.4512">spc.settlementParticipantCurrencyId, spc.netAmount, pc.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="868" y="1112.7617">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="908" y="1112.7617">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="1048" y="1112.7617">pc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="868" y="1128.0723">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="900" y="1128.0723">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1111" y="1128.0723">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="868" y="1143.3828">ON spc.participantCurrencyId = pc.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="317" x="868" y="1158.6934">JOIN (SELECT spc.settlementParticipantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="336" x="916" y="1174.0039">MAX(settlementParticipantCurrencyStateChangeId) AS</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="307" x="916" y="1189.3145">maxSettlementParticipantCurrencyStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="884" y="1204.625">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="924" y="1204.625">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1220" y="1204.625">spcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="884" y="1219.9355">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="916" y="1219.9355">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1127" y="1219.9355">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="512" x="884" y="1235.2461">ON spc.settlementParticipantCurrencyId = spcsc.settlementParticipantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="884" y="1250.5566">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="916" y="1250.5566">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="1056" y="1250.5566">pc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="884" y="1265.8672">ON pc.participantCurrencyId = spc.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="884" y="1281.1777">WHERE spc.settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="313" x="884" y="1296.4883">AND pc.participantId IN {participantIdList}) AS mx</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="496" x="868" y="1311.7988">ON mx.settlementParticipantCurrencyId = spc.settlementParticipantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="868" y="1327.1094">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="900" y="1327.1094">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1196" y="1327.1094">spcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="868" y="1342.4199">ON spcsc.settlementParticipantCurrencyStateChangeId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="331" x="880" y="1357.7305">mx.maxSettlementParticipantCurrencyStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="868" y="1373.041">WHERE spc.settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="868" y="1388.3516">AND pc.participantId IN {participantIdList}</text><polygon fill="#A80036" points="811,1417.4043,801,1421.4043,811,1425.4043,807,1421.4043" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="805" x2="1131" y1="1421.4043" y2="1421.4043"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="817" y="1416.6621">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="830" y="1416.6621">Return data</text><polygon fill="#A80036" points="298,1446.7148,288,1450.7148,298,1454.7148,294,1450.7148" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="292" x2="794" y1="1450.7148" y2="1450.7148"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="1445.9727">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="326" y="1445.9727">Return spcStateChangeList</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="287" x2="329" y1="1495.3359" y2="1495.3359"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="329" x2="329" y1="1495.3359" y2="1508.3359"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="288" x2="329" y1="1508.3359" y2="1508.3359"/><polygon fill="#A80036" points="298,1504.3359,288,1508.3359,298,1512.3359,294,1508.3359" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="294" y="1482.9385">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="316" y="1475.2832">participantList = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="316" y="1490.5938">settlementParticipantCurrencyIdList = []</text><path d="M153.5,1523.3359 L227.5,1523.3359 L227.5,1530.3359 L217.5,1540.3359 L153.5,1540.3359 L153.5,1523.3359 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="968.9766" style="stroke: #000000; stroke-width: 2.0;" width="637.5" x="153.5" y="1523.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="168.5" y="1536.9043">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="200" x="242.5" y="1535.9707">[payload.participants as participant]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="287" x2="329" y1="1561.957" y2="1561.957"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="329" x2="329" y1="1561.957" y2="1574.957"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="288" x2="329" y1="1574.957" y2="1574.957"/><polygon fill="#A80036" points="298,1570.957,288,1574.957,298,1578.957,294,1574.957" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="294" y="1557.2148">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="463" x="316" y="1557.2148">participantList.push({participantId: participant.participantId, accounts: []})</text><path d="M163.5,1589.957 L237.5,1589.957 L237.5,1596.957 L227.5,1606.957 L163.5,1606.957 L163.5,1589.957 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="895.3555" style="stroke: #000000; stroke-width: 2.0;" width="604.5" x="163.5" y="1589.957"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="178.5" y="1603.5254">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="183" x="252.5" y="1602.5918">[participant.accounts as account]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="287" x2="329" y1="1628.5781" y2="1628.5781"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="329" x2="329" y1="1628.5781" y2="1641.5781"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="288" x2="329" y1="1641.5781" y2="1641.5781"/><polygon fill="#A80036" points="298,1637.5781,288,1641.5781,298,1645.5781,294,1641.5781" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="294" y="1623.8359">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="316" y="1623.8359">accountIsFound = false</text><path d="M173.5,1656.5781 L247.5,1656.5781 L247.5,1663.5781 L237.5,1673.5781 L173.5,1673.5781 L173.5,1656.5781 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="615.9395" style="stroke: #000000; stroke-width: 2.0;" width="584.5" x="173.5" y="1656.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="188.5" y="1670.1465">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="262.5" y="1669.2129">[spcStateChangeList as record]</text><path d="M183.5,1680.8887 L245.5,1680.8887 L245.5,1687.8887 L235.5,1697.8887 L183.5,1697.8887 L183.5,1680.8887 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="559.6289" style="stroke: #000000; stroke-width: 2.0;" width="564.5" x="183.5" y="1680.8887"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="198.5" y="1694.457">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="274" x="260.5" y="1693.5234">[participant.participantId == record.participantId</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="381" x="260.5" y="1706.4785">and account.participantCurrencyId == record.participantCurrencyId]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="287" x2="329" y1="1730.4199" y2="1730.4199"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="329" x2="329" y1="1730.4199" y2="1743.4199"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="288" x2="329" y1="1743.4199" y2="1743.4199"/><polygon fill="#A80036" points="298,1739.4199,288,1743.4199,298,1747.4199,294,1743.4199" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="294" y="1725.6777">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="316" y="1725.6777">accountIsFound = true</text><path d="M193.5,1758.4199 L255.5,1758.4199 L255.5,1765.4199 L245.5,1775.4199 L193.5,1775.4199 L193.5,1758.4199 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="450.0977" style="stroke: #000000; stroke-width: 2.0;" width="544.5" x="193.5" y="1758.4199"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="208.5" y="1771.9883">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="306" x="270.5" y="1771.0547">[record.settlementStateId == 'PENDING_SETTLEMENT']</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="287" x2="329" y1="1842.9727" y2="1842.9727"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="329" x2="329" y1="1842.9727" y2="1855.9727"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="288" x2="329" y1="1855.9727" y2="1855.9727"/><polygon fill="#A80036" points="298,1851.9727,288,1855.9727,298,1859.9727,294,1855.9727" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="294" y="1815.2646">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="316" y="1792.2988">settlementParticipantCurrencyIdList.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="394" x="332" y="1807.6094">participantCurrencyId: record.settlementParticipantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="332" y="1822.9199">reason: 'string'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="316" y="1838.2305">})</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="287" x2="329" y1="2023.0781" y2="2023.0781"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="329" x2="329" y1="2023.0781" y2="2036.0781"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="288" x2="329" y1="2036.0781" y2="2036.0781"/><polygon fill="#A80036" points="298,2032.0781,288,2036.0781,298,2040.0781,294,2036.0781" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="294" y="1949.4385">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="316" y="1880.541">participantList[participantList.length-1].accounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="316" y="1895.8516">.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="332" y="1911.1621">participantCurrencyId: account.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="332" y="1926.4727">reason: 'string',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103" x="332" y="1941.7832">state: 'SETTLED',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="332" y="1957.0938">netSettlementAmount: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="348" y="1972.4043">amount: record.netAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="348" y="1987.7148">currency: record.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="332" y="2003.0254">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="316" y="2018.3359">})</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="193.5" x2="738" y1="2045.0781" y2="2045.0781"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="225" x="198.5" y="2055.7129">[record.settlementStateId == 'SETTLED']</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="287" x2="329" y1="2187.5176" y2="2187.5176"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="329" x2="329" y1="2187.5176" y2="2200.5176"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="288" x2="329" y1="2200.5176" y2="2200.5176"/><polygon fill="#A80036" points="298,2196.5176,288,2200.5176,298,2204.5176,294,2200.5176" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="294" y="2129.1885">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="316" y="2075.6016">participantList[participantList.length-1].accounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="316" y="2090.9121">.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="332" y="2106.2227">participantCurrencyId: account.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="332" y="2121.5332">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="348" y="2136.8438">errorCode: 'code',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="348" y="2152.1543">errorDescription: 'Already settled'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="332" y="2167.4648">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="316" y="2182.7754">})</text><path d="M193.5,2286.5176 L260.5,2286.5176 L260.5,2293.5176 L250.5,2303.5176 L193.5,2303.5176 L193.5,2286.5176 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="166.7949" style="stroke: #000000; stroke-width: 2.0;" width="488.5" x="193.5" y="2286.5176"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="208.5" y="2300.0859">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="148" x="275.5" y="2299.1523">[accountIsFound == false]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="287" x2="329" y1="2432.3125" y2="2432.3125"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="329" x2="329" y1="2432.3125" y2="2445.3125"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="288" x2="329" y1="2445.3125" y2="2445.3125"/><polygon fill="#A80036" points="298,2441.3125,288,2445.3125,298,2449.3125,294,2445.3125" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="294" y="2373.9834">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="316" y="2320.3965">participantList[participantList.length-1].accounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="316" y="2335.707">.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="332" y="2351.0176">participantCurrencyId: account.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="332" y="2366.3281">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="348" y="2381.6387">errorCode: 'code',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="348" y="2396.9492">errorDescription: 'Account not found'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="332" y="2412.2598">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="316" y="2427.5703">})</text><path d="M183.5,2506.3125 L348.5,2506.3125 L348.5,2513.3125 L338.5,2523.3125 L183.5,2523.3125 L183.5,2506.3125 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="185.8633" style="stroke: #000000; stroke-width: 2.0;" width="1114.5" x="183.5" y="2506.3125"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="198.5" y="2519.8809">DB TRANSACTION</text><path d="M193.5,2530.623 L267.5,2530.623 L267.5,2537.623 L257.5,2547.623 L193.5,2547.623 L193.5,2530.623 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="154.5527" style="stroke: #000000; stroke-width: 2.0;" width="1094.5" x="193.5" y="2530.623"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="208.5" y="2544.1914">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="263" x="282.5" y="2543.2578">[settlementParticipantCurrencyIdList as record]</text><polygon fill="#A80036" points="778,2565.2441,788,2569.2441,778,2573.2441,782,2569.2441" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="287" x2="784" y1="2569.2441" y2="2569.2441"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="294" y="2564.502">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="283" x="316" y="2564.502">Change settlement participant currency state</text><polygon fill="#A80036" points="1115,2609.8652,1125,2613.8652,1115,2617.8652,1119,2613.8652" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="800" x2="1121" y1="2613.8652" y2="2613.8652"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="807" y="2601.4678">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="281" x="829" y="2593.8125">Insert new state 'SETTLED' and record.reason</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="829" y="2609.123">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="906" y="2609.123">2001</text><polygon fill="#FFFFE0" filter="url(#f902e2a7azary)" points="996,2656.8652,1268,2656.8652,1278,2667.8652,1268,2679.8652,996,2679.8652,986,2667.8652,996,2656.8652" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="998" y="2673.4336">settlementParticipantCurrencyStateChange</text><polygon fill="#A80036" points="778,2716.4863,788,2720.4863,778,2724.4863,782,2720.4863" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="287" x2="784" y1="2720.4863" y2="2720.4863"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="294" y="2715.7441">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="355" x="316" y="2715.7441">Get list of settlementWindows and participantCurrencies</text><polygon fill="#A80036" points="1115,2761.1074,1125,2765.1074,1115,2769.1074,1119,2765.1074" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="800" x2="1121" y1="2765.1074" y2="2765.1074"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="807" y="2752.71">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="67" x="829" y="2745.0547">Retrive list</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="829" y="2760.3652">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="906" y="2760.3652">2001</text><polygon fill="#FFFFE0" filter="url(#f902e2a7azary)" points="938,2778.1074,1325,2778.1074,1335,2843.1074,1325,2908.1074,938,2908.1074,928,2843.1074,938,2778.1074" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="366" x="940" y="2794.6758">SELECT ssw.settlementWindowId, tp.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="940" y="2809.9863">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="197" x="980" y="2809.9863">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="1181" y="2809.9863">ssw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="940" y="2825.2969">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="972" y="2825.2969">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="1098" y="2825.2969">tf</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="340" x="940" y="2840.6074">ON tf.settlementWindowId = ssw.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="940" y="2855.918">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="972" y="2855.918">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="13" x="1103" y="2855.918">tp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="940" y="2871.2285">ON tp.transferId = tf.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="940" y="2886.5391">WHERE settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="383" x="940" y="2901.8496">GROUP BY ssw.settlementWindowId, tp.participantCurrencyId</text><polygon fill="#A80036" points="811,2930.9023,801,2934.9023,811,2938.9023,807,2934.9023" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="805" x2="1131" y1="2934.9023" y2="2934.9023"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="817" y="2930.1602">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="839" y="2930.1602">Return list</text><polygon fill="#A80036" points="298,2960.2129,288,2964.2129,298,2968.2129,294,2964.2129" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="292" x2="794" y1="2964.2129" y2="2964.2129"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="2959.4707">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="326" y="2959.4707">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="291" x="371" y="2959.4707">settlementWindowsParticipantCurrencyList</text><polygon fill="#A80036" points="778,3004.834,788,3008.834,778,3012.834,782,3008.834" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="287" x2="784" y1="3008.834" y2="3008.834"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="294" y="2996.4365">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="346" x="316" y="2988.7813">Get list of all NOT_SETTELED or PENDING_SETTLEMENT</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="222" x="316" y="3004.0918">participantCurrencies in settlement</text><polygon fill="#A80036" points="1115,3049.4551,1125,3053.4551,1115,3057.4551,1119,3053.4551" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="800" x2="1121" y1="3053.4551" y2="3053.4551"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="807" y="3041.0576">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="67" x="829" y="3033.4023">Retrive list</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="829" y="3048.7129">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="906" y="3048.7129">2001</text><polygon fill="#FFFFE0" filter="url(#f902e2a7azary)" points="862,3066.4551,1402,3066.4551,1412,3184.4551,1402,3303.4551,862,3303.4551,852,3184.4551,862,3066.4551" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="864" y="3083.0234">SELECT spc.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="864" y="3098.334">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="904" y="3098.334">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1115" y="3098.334">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="317" x="864" y="3113.6445">JOIN (SELECT spc.settlementParticipantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="336" x="916" y="3128.9551">MAX(settlementParticipantCurrencyStateChangeId) AS</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="307" x="916" y="3144.2656">maxSettlementParticipantCurrencyStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="888" y="3159.5762">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="928" y="3159.5762">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1224" y="3159.5762">spcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="888" y="3174.8867">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="920" y="3174.8867">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1131" y="3174.8867">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="512" x="888" y="3190.1973">ON spc.settlementParticipantCurrencyId = spcsc.settlementParticipantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="888" y="3205.5078">WHERE spc.settlementId = {id}) AS mx</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="496" x="864" y="3220.8184">ON mx.settlementParticipantCurrencyId = spc.settlementParticipantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="864" y="3236.1289">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="896" y="3236.1289">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1192" y="3236.1289">spcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="864" y="3251.4395">ON spcsc.settlementParticipantCurrencyStateChangeId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="331" x="876" y="3266.75">mx.maxSettlementParticipantCurrencyStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="864" y="3282.0605">WHERE spc.settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="864" y="3297.3711">AND spcsc.settlementStateId != 'SETTLED'</text><polygon fill="#A80036" points="811,3326.4238,801,3330.4238,811,3334.4238,807,3330.4238" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="805" x2="1131" y1="3330.4238" y2="3330.4238"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="817" y="3325.6816">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="839" y="3325.6816">Return list</text><polygon fill="#A80036" points="298,3355.7344,288,3359.7344,298,3363.7344,294,3359.7344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="292" x2="794" y1="3359.7344" y2="3359.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="3354.9922">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="326" y="3354.9922">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="231" x="371" y="3354.9922">settlementParticipantCurrencyList</text><path d="M163.5,3374.7344 L381.5,3374.7344 L381.5,3381.7344 L371.5,3391.7344 L163.5,3391.7344 L163.5,3374.7344 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="526.9688" style="stroke: #000000; stroke-width: 2.0;" width="1107.5" x="163.5" y="3374.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="173" x="178.5" y="3388.3027">Settle settlementWindows</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="287" x2="329" y1="3428.666" y2="3428.666"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="329" x2="329" y1="3428.666" y2="3441.666"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="288" x2="329" y1="3441.666" y2="3441.666"/><polygon fill="#A80036" points="298,3437.666,288,3441.666,298,3445.666,294,3441.666" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="294" y="3416.2686">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="316" y="3408.6133">allWindowsList = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="316" y="3423.9238">notSettledWindowsList = []</text><path d="M173.5,3456.666 L247.5,3456.666 L247.5,3463.666 L237.5,3473.666 L173.5,3473.666 L173.5,3456.666 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="195.8633" style="stroke: #000000; stroke-width: 2.0;" width="540.5" x="173.5" y="3456.666"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="188.5" y="3470.2344">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="309" x="262.5" y="3469.3008">[settlementWindowsParticipantCurrencyList as window]</text><path d="M193.5,3480.9766 L260.5,3480.9766 L260.5,3487.9766 L250.5,3497.9766 L193.5,3497.9766 L193.5,3480.9766 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="451.5" x="193.5" y="3480.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="208.5" y="3494.5449">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="300" x="275.5" y="3493.6113">[window.settlementWindowId NOT IN allWindowsList]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="287" x2="329" y1="3519.5977" y2="3519.5977"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="329" x2="329" y1="3519.5977" y2="3532.5977"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="288" x2="329" y1="3532.5977" y2="3532.5977"/><polygon fill="#A80036" points="298,3528.5977,288,3532.5977,298,3536.5977,294,3532.5977" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="294" y="3514.8555">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="317" x="316" y="3514.8555">allWindowsList.push(window.settlementWindowId)</text><path d="M183.5,3554.5977 L257.5,3554.5977 L257.5,3561.5977 L247.5,3571.5977 L183.5,3571.5977 L183.5,3554.5977 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="90.9316" style="stroke: #000000; stroke-width: 2.0;" width="520.5" x="183.5" y="3554.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="198.5" y="3568.166">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="229" x="272.5" y="3567.2324">[settlementParticipantCurrencyList as pc]</text><path d="M193.5,3578.9082 L260.5,3578.9082 L260.5,3585.9082 L250.5,3595.9082 L193.5,3595.9082 L193.5,3578.9082 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="500.5" x="193.5" y="3578.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="208.5" y="3592.4766">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="338" x="275.5" y="3591.543">[pc.participantCurrencyId == window.participantCurrencyId]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="287" x2="329" y1="3617.5293" y2="3617.5293"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="329" x2="329" y1="3617.5293" y2="3630.5293"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="288" x2="329" y1="3630.5293" y2="3630.5293"/><polygon fill="#A80036" points="298,3626.5293,288,3630.5293,298,3634.5293,294,3630.5293" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="294" y="3612.7871">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="366" x="316" y="3612.7871">notSettledWindowsList.push(window.settlementWindowId)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="287" x2="329" y1="3680.8398" y2="3680.8398"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="329" x2="329" y1="3680.8398" y2="3693.8398"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="288" x2="329" y1="3693.8398" y2="3693.8398"/><polygon fill="#A80036" points="298,3689.8398,288,3693.8398,298,3697.8398,294,3693.8398" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="294" y="3676.0977">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="467" x="316" y="3676.0977">settledWindowsList = _.difference(allWindowsList, notSettledWindowsList)</text><path d="M183.5,3708.8398 L348.5,3708.8398 L348.5,3715.8398 L338.5,3725.8398 L183.5,3725.8398 L183.5,3708.8398 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="185.8633" style="stroke: #000000; stroke-width: 2.0;" width="1077.5" x="183.5" y="3708.8398"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="198.5" y="3722.4082">DB TRANSACTION</text><path d="M193.5,3733.1504 L267.5,3733.1504 L267.5,3740.1504 L257.5,3750.1504 L193.5,3750.1504 L193.5,3733.1504 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="154.5527" style="stroke: #000000; stroke-width: 2.0;" width="1057.5" x="193.5" y="3733.1504"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="208.5" y="3746.7188">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="171" x="282.5" y="3745.7852">[settledWindowsList as record]</text><polygon fill="#A80036" points="778,3767.7715,788,3771.7715,778,3775.7715,782,3771.7715" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="287" x2="784" y1="3771.7715" y2="3771.7715"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="294" y="3767.0293">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="403" x="316" y="3767.0293">Change settlement window state for record.settlementWindowId</text><polygon fill="#A80036" points="1115,3812.3926,1125,3816.3926,1115,3820.3926,1119,3816.3926" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="800" x2="1121" y1="3816.3926" y2="3816.3926"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="807" y="3803.9951">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="829" y="3796.3398">Insert new state 'SETTLED'</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="829" y="3811.6504">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="906" y="3811.6504">2001</text><polygon fill="#FFFFE0" filter="url(#f902e2a7azary)" points="1033,3859.3926,1231,3859.3926,1241,3870.3926,1231,3882.3926,1033,3882.3926,1023,3870.3926,1033,3859.3926" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1035" y="3875.9609">settlementWindowStateChange</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="143.5" x2="1422" y1="3909.7031" y2="3909.7031"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="313" x="148.5" y="3920.3379">[settlementStateChange IN ['NOT_SETTLED', 'SETTLED']]</text><path d="M23,3960.6582 L23,4658.6582 L268,4658.6582 L268,3970.6582 L258,3960.6582 L23,3960.6582 " fill="#FFFFE0" filter="url(#f902e2a7azary)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M258,3960.6582 L258,3970.6582 L268,3970.6582 L258,3960.6582 " fill="#FFFFE0" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="29" y="3978.2266">[</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="37" y="3993.5371">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="45" y="4008.8477">"id": 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="45" y="4024.1582">"state": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="45" y="4039.4688">"settlementWindows": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="53" y="4054.7793">[</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="61" y="4070.0898">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="69" y="4085.4004">"id": 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="69" y="4100.7109">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="69" y="4116.0215">"state": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="69" y="4131.332">"createdDate": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="61" y="4146.6426">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="53" y="4161.9531">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="45" y="4177.2637">],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="45" y="4192.5742">"participants": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="53" y="4207.8848">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="61" y="4223.1953">"id": 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="61" y="4238.5059">"accounts": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="69" y="4253.8164">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="77" y="4269.127">"id": 1,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="77" y="4284.4375">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="77" y="4299.748">"state": "SETTLED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="77" y="4315.0586">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="85" y="4330.3691">"amount": 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="85" y="4345.6797">"currency": "string"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="77" y="4360.9902">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="69" y="4376.3008">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="69" y="4391.6113">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="77" y="4406.9219">"id": 2,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="77" y="4422.2324">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="77" y="4437.543">"state": "SETTLED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="77" y="4452.8535">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="85" y="4468.1641">"amount": 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="85" y="4483.4746">"currency": "string"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="77" y="4498.7852">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="77" y="4514.0957">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="85" y="4529.4063">"errorCode": 8001,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="85" y="4544.7168">"errorDescription": "string"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="77" y="4560.0273">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="69" y="4575.3379">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="61" y="4590.6484">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="53" y="4605.959">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="45" y="4621.2695">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="37" y="4636.5801">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="29" y="4651.8906">]</text><!--
@startuml
title 6.2.5. Acknowledgement of Settlement Transfer
autonumber

actor "Hub Employee" as OPERATOR
boundary "Settlement Service API" as SSAPI
entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Central HUB" #lightpink
    participant OPERATOR
end box

box "Settlement Service" #lightgreen
    participant SSAPI
    participant SETTLE_DAO
end box

box "Central Services" #lightyellow
    participant DB
end box

group Acknowledgement of Settlement Transfer
    activate OPERATOR
    note right of OPERATOR #yellow
        {
            "participants": [
                {
                    "id": 1
                    "accounts" : [
                        {
                            "id": 1,
                            "reason": "string",
                            "state": "PENDING_SETTLEMENT"
                        },
                        {
                            "id": 2,
                            "reason": "string",
                            "state": "SETTLED"
                        }
                    ]
                },
                {
                    "id": 2
                    "accounts" : [
                        {
                            "id": 3,
                            "reason": "string",
                            "state": "NOT_SETTLED"
                        }
                    ]
                }
            ]
        }
    end note
    
    note right of OPERATOR #lightgray
        In the sequence below we refer to:
        - participants[N].id AS participantId
        - accounts[N].id AS participantCurrencyId
    end note

    OPERATOR -> SSAPI: PUT - /settlement/{id}
    activate SSAPI
    SSAPI -> SETTLE_DAO: Lookup settlement
    activate SETTLE_DAO
    SETTLE_DAO -> DB: Lookup settlement and settlement state\n<color #FF0000><b>Error code:</b> 2001</color>
    activate DB
    hnote over DB #lightyellow
        settlement
        settlementStateChange
    end hnote
    SETTLE_DAO <- - DB: Return data
    deactivate DB
    SSAPI <- - SETTLE_DAO: Return data
    deactivate SETTLE_DAO

    alt settlementStateChange == 'PENDING_SETTLEMENT'
        SSAPI -> SSAPI: Create **participantIdList** from request

        SSAPI -> SETTLE_DAO: Retrive participant details and state for participantIdList
        activate SETTLE_DAO
        SETTLE_DAO -> DB: Select from DB\n<color #FF0000><b>Error code:</b> 2001</color>
        activate DB
        hnote over DB #lightyellow
            SELECT pc.participantId, spc.participantCurrencyId, spcsc.settlementStateId, 
                spc.settlementParticipantCurrencyId, spc.netAmount, pc.currencyId
            FROM **participantCurrency** pc
            JOIN **settlementParticipantCurrency** spc
            ON spc.participantCurrencyId = pc.participantCurrencyId
            JOIN (SELECT spc.settlementParticipantCurrencyId, 
                        MAX(settlementParticipantCurrencyStateChangeId) AS
                        maxSettlementParticipantCurrencyStateChangeId
                FROM **settlementParticipantCurrencyStateChange** spcsc
                JOIN **settlementParticipantCurrency** spc
                ON spc.settlementParticipantCurrencyId = spcsc.settlementParticipantCurrencyId
                JOIN **participantCurrency** pc
                ON pc.participantCurrencyId = spc.participantCurrencyId
                WHERE spc.settlementId = {id}
                AND pc.participantId IN {participantIdList}) AS mx
            ON mx.settlementParticipantCurrencyId = spc.settlementParticipantCurrencyId
            JOIN **settlementParticipantCurrencyStateChange** spcsc
            ON spcsc.settlementParticipantCurrencyStateChangeId = 
               mx.maxSettlementParticipantCurrencyStateChangeId
            WHERE spc.settlementId = {id}
            AND pc.participantId IN {participantIdList}
        end hnote
        SETTLE_DAO <- - DB: Return data
        deactivate DB
        SSAPI <- - SETTLE_DAO: Return spcStateChangeList
        deactivate SETTLE_DAO

        SSAPI -> SSAPI: participantList = []\nsettlementParticipantCurrencyIdList = []
        loop payload.participants as participant
            SSAPI -> SSAPI: participantList.push({participantId: participant.participantId, accounts: []})
            loop participant.accounts as account
                SSAPI -> SSAPI: accountIsFound = false
                loop spcStateChangeList as record
                    alt participant.participantId == record.participantId\nand account.participantCurrencyId == record.participantCurrencyId
                        SSAPI -> SSAPI: accountIsFound = true
                        alt record.settlementStateId == 'PENDING_SETTLEMENT'
                            SSAPI -> SSAPI: settlementParticipantCurrencyIdList.push({\n    participantCurrencyId: record.settlementParticipantCurrencyId,\n    reason: 'string'\n})
                            SSAPI -> SSAPI: participantList[participantList.length-1].accounts\n.push({\n    participantCurrencyId: account.participantCurrencyId,\n    reason: 'string',\n    state: 'SETTLED',\n    netSettlementAmount: {\n        amount: record.netAmount\n        currency: record.currencyId\n    }\n})
                        else record.settlementStateId == 'SETTLED'
                            SSAPI -> SSAPI: participantList[participantList.length-1].accounts\n.push({\n    participantCurrencyId: account.participantCurrencyId,\n    errorInformation: {\n        errorCode: 'code',\n        errorDescription: 'Already settled'\n    }\n})
                        end
                        |||
                    end
                    |||
                end
                opt accountIsFound == false
                    SSAPI -> SSAPI: participantList[participantList.length-1].accounts\n.push({\n    participantCurrencyId: account.participantCurrencyId,\n    errorInformation: {\n        errorCode: 'code',\n        errorDescription: 'Account not found'\n    }\n})
                end
                |||
            end
        end
        group <color #blue>DB TRANSACTION</color>
            loop settlementParticipantCurrencyIdList as record
                SSAPI -> SETTLE_DAO: Change settlement participant currency state
                activate SETTLE_DAO
                SETTLE_DAO -> DB: Insert new state 'SETTLED' and record.reason\n<color #FF0000><b>Error code:</b> 2001</color>
                activate DB
                hnote over DB #lightyellow
                    settlementParticipantCurrencyStateChange
                end hnote
                deactivate DB
                deactivate SETTLE_DAO
            end
        end

        SSAPI -> SETTLE_DAO: Get list of settlementWindows and participantCurrencies
        activate SETTLE_DAO
        SETTLE_DAO -> DB: Retrive list\n<color #FF0000><b>Error code:</b> 2001</color>
        activate DB
        hnote over DB #lightyellow
            SELECT ssw.settlementWindowId, tp.participantCurrencyId
            FROM **settlementSettlementWindow** ssw
            JOIN **transferFulfilment** tf
            ON tf.settlementWindowId = ssw.settlementWindowId
            JOIN **transferParticipant** tp
            ON tp.transferId = tf.transferId
            WHERE settlementId = {id}
            GROUP BY ssw.settlementWindowId, tp.participantCurrencyId
        end hnote
        SETTLE_DAO <- - DB: Return list
        deactivate DB
        SSAPI <- - SETTLE_DAO: Return **settlementWindowsParticipantCurrencyList**
        deactivate SETTLE_DAO

        SSAPI -> SETTLE_DAO: Get list of all NOT_SETTELED or PENDING_SETTLEMENT\nparticipantCurrencies in settlement
        activate SETTLE_DAO
        SETTLE_DAO -> DB: Retrive list\n<color #FF0000><b>Error code:</b> 2001</color>
        activate DB
        hnote over DB #lightyellow
            SELECT spc.participantCurrencyId
            FROM **settlementParticipantCurrency** spc
            JOIN (SELECT spc.settlementParticipantCurrencyId, 
                         MAX(settlementParticipantCurrencyStateChangeId) AS
                         maxSettlementParticipantCurrencyStateChangeId
                  FROM **settlementParticipantCurrencyStateChange** spcsc
                  JOIN **settlementParticipantCurrency** spc
                  ON spc.settlementParticipantCurrencyId = spcsc.settlementParticipantCurrencyId
                  WHERE spc.settlementId = {id}) AS mx
            ON mx.settlementParticipantCurrencyId = spc.settlementParticipantCurrencyId
            JOIN **settlementParticipantCurrencyStateChange** spcsc
            ON spcsc.settlementParticipantCurrencyStateChangeId = 
               mx.maxSettlementParticipantCurrencyStateChangeId
            WHERE spc.settlementId = {id}
            AND spcsc.settlementStateId != 'SETTLED'
        end hnote
        SETTLE_DAO <- - DB: Return list
        deactivate DB
        SSAPI <- - SETTLE_DAO: Return **settlementParticipantCurrencyList**
        deactivate SETTLE_DAO

        group Settle settlementWindows
            SSAPI -> SSAPI: allWindowsList = []\nnotSettledWindowsList = []
            loop settlementWindowsParticipantCurrencyList as window
                opt window.settlementWindowId NOT IN allWindowsList
                    SSAPI -> SSAPI: allWindowsList.push(window.settlementWindowId)
                end
                loop settlementParticipantCurrencyList as pc
                    opt pc.participantCurrencyId == window.participantCurrencyId
                        SSAPI -> SSAPI: notSettledWindowsList.push(window.settlementWindowId)
                    end
                end
            end
            SSAPI -> SSAPI: settledWindowsList = _.difference(allWindowsList, notSettledWindowsList)

            group <color #blue>DB TRANSACTION</color>
                loop settledWindowsList as record
                    SSAPI -> SETTLE_DAO: Change settlement window state for record.settlementWindowId
                    activate SETTLE_DAO
                    SETTLE_DAO -> DB: Insert new state 'SETTLED'\n<color #FF0000><b>Error code:</b> 2001</color>
                    activate DB
                    hnote over DB #lightyellow
                        settlementWindowStateChange
                    end hnote
                    deactivate DB
                    deactivate SETTLE_DAO
                end
            end
        end


    else settlementStateChange IN ['NOT_SETTLED', 'SETTLED']
        |||
    end

    note left of SSAPI #lightyellow
        [
          {
            "id": 0,
            "state": "string",
            "settlementWindows": [
              [
                {
                  "id": 0,
                  "reason": "string",
                  "state": "string",
                  "createdDate": "string",
                }
              ]
            ],
            "participants": [
              {
                "id": 0,
                "accounts": [
                  {
                    "id": 1,
                    "reason": "string",
                    "state": "SETTLED",
                    "netSettlementAmount": {
                      "amount": 0,
                      "currency": "string"
                    }
                  },
                  {
                    "id": 2,
                    "reason": "string",
                    "state": "SETTLED",
                    "netSettlementAmount": {
                      "amount": 0,
                      "currency": "string"
                    },
                    "errorInformation": {
                      "errorCode": 8001,
                      "errorDescription": "string"
                    }
                  }
                ]
              }
            ]
          }
        ]
    end note
    deactivate SSAPI
end
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>