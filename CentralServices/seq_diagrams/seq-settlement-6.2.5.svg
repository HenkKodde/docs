<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="7918px" preserveAspectRatio="none" style="width:1500px;height:7918px;" version="1.1" viewBox="0 0 1500 7918" width="1500px" zoomAndPan="magnify"><defs><filter height="300%" id="f1anpngzq6ubl8" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="342" x="580" y="23.5352">6.2.5. Acknowledgement of Settlement Transfer</text><rect fill="#FFB6C1" height="7872.8301" style="stroke: #A80036; stroke-width: 1.0;" width="112" x="53" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="68.5" y="47.0566">Central HUB</text><rect fill="#90EE90" height="7872.8301" style="stroke: #A80036; stroke-width: 1.0;" width="656.5" x="209.5" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="475.75" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="7872.8301" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="1085" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="1088" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="7664.543" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="104" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="7072.9844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="287" y="730.8457"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="243.7266" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="800" y="775.4668"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="366.2109" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="800" y="1088.125"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="320.2793" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="800" y="1498.957"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="228.416" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="800" y="1863.8574"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="74.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="800" y="5931.5469"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="350.9004" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="800" y="6098.0996"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="74.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="800" y="6861.0371"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="185.1055" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1137" y="804.7773"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="307.5898" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1137" y="1117.4355"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="261.6582" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1137" y="1528.2676"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="169.7949" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1137" y="1893.168"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1137" y="5976.168"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="276.9688" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1137" y="6142.7207"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1137" y="6905.6582"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="7649.543" style="stroke: #000000; stroke-width: 2.0;" width="1476" x="13" y="154.2871"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="6003.7305" style="stroke: #000000; stroke-width: 2.0;" width="1325.5" x="153.5" y="1034.1934"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="480.7422" style="stroke: #000000; stroke-width: 2.0;" width="641" x="282" y="3401.4961"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="165.1523" style="stroke: #000000; stroke-width: 2.0;" width="414" x="292" y="3710.0859"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="414" x="292" y="3766.707"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="414" x="292" y="3820.9727"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="179.1055" style="stroke: #000000; stroke-width: 2.0;" width="297" x="292" y="3975.8594"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="465.4316" style="stroke: #000000; stroke-width: 2.0;" width="534" x="282" y="4248.5859"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="165.1523" style="stroke: #000000; stroke-width: 2.0;" width="432" x="292" y="4541.8652"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="432" x="292" y="4598.4863"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="432" x="292" y="4652.752"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="968.9766" style="stroke: #000000; stroke-width: 2.0;" width="637.5" x="163.5" y="4885.6387"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="895.3555" style="stroke: #000000; stroke-width: 2.0;" width="604.5" x="173.5" y="4952.2598"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="615.9395" style="stroke: #000000; stroke-width: 2.0;" width="584.5" x="183.5" y="5018.8809"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="559.6289" style="stroke: #000000; stroke-width: 2.0;" width="564.5" x="193.5" y="5043.1914"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="450.0977" style="stroke: #000000; stroke-width: 2.0;" width="544.5" x="203.5" y="5120.7227"/><rect fill="#FFFFFF" height="164.4395" style="stroke: none; stroke-width: 1.0;" width="544.5" x="203.5" y="5406.3809"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="166.7949" style="stroke: #000000; stroke-width: 2.0;" width="488.5" x="203.5" y="5648.8203"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="185.8633" style="stroke: #000000; stroke-width: 2.0;" width="1114.5" x="193.5" y="5868.6152"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="154.5527" style="stroke: #000000; stroke-width: 2.0;" width="1094.5" x="203.5" y="5892.9258"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="526.9688" style="stroke: #000000; stroke-width: 2.0;" width="1107.5" x="173.5" y="6464"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="195.8633" style="stroke: #000000; stroke-width: 2.0;" width="540.5" x="183.5" y="6545.9316"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="451.5" x="203.5" y="6570.2422"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="90.9316" style="stroke: #000000; stroke-width: 2.0;" width="520.5" x="193.5" y="6643.8633"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="500.5" x="203.5" y="6668.1738"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="185.8633" style="stroke: #000000; stroke-width: 2.0;" width="1077.5" x="193.5" y="6798.1055"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="154.5527" style="stroke: #000000; stroke-width: 2.0;" width="1057.5" x="203.5" y="6822.416"/><rect fill="#FFFFFF" height="39.9551" style="stroke: none; stroke-width: 1.0;" width="1325.5" x="153.5" y="6997.9688"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="109" x2="109" y1="137.2871" y2="7820.8301"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="291.5" x2="291.5" y1="137.2871" y2="7820.8301"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="805" x2="805" y1="137.2871" y2="7820.8301"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1142" x2="1142" y1="137.2871" y2="7820.8301"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="57" y="134.334">Hub Employee</text><ellipse cx="109" cy="63.7988" fill="#FEFECE" filter="url(#f1anpngzq6ubl8)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M109,71.7988 L109,98.7988 M96,79.7988 L122,79.7988 M109,98.7988 L96,113.7988 M109,98.7988 L122,113.7988 " fill="none" filter="url(#f1anpngzq6ubl8)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="57" y="7833.3652">Hub Employee</text><ellipse cx="109" cy="7846.3184" fill="#FEFECE" filter="url(#f1anpngzq6ubl8)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M109,7854.3184 L109,7881.3184 M96,7862.3184 L122,7862.3184 M109,7881.3184 L96,7896.3184 M109,7881.3184 L122,7896.3184 " fill="none" filter="url(#f1anpngzq6ubl8)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="213.5" y="134.334">Settlement Service API</text><path d="M271.5,92.7988 L271.5,116.7988 M271.5,104.7988 L288.5,104.7988 " fill="none" filter="url(#f1anpngzq6ubl8)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="300.5" cy="104.7988" fill="#FEFECE" filter="url(#f1anpngzq6ubl8)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="213.5" y="7833.3652">Settlement Service API</text><path d="M271.5,7840.3184 L271.5,7864.3184 M271.5,7852.3184 L288.5,7852.3184 " fill="none" filter="url(#f1anpngzq6ubl8)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="300.5" cy="7852.3184" fill="#FEFECE" filter="url(#f1anpngzq6ubl8)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="748" y="134.334">Settlement DAO</text><ellipse cx="805" cy="104.7988" fill="#FEFECE" filter="url(#f1anpngzq6ubl8)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="793" x2="817" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="748" y="7833.3652">Settlement DAO</text><ellipse cx="805" cy="7852.3184" fill="#FEFECE" filter="url(#f1anpngzq6ubl8)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="793" x2="817" y1="7866.3184" y2="7866.3184"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1094" y="134.334">Central Store</text><path d="M1124,84.7988 C1124,74.7988 1142,74.7988 1142,74.7988 C1142,74.7988 1160,74.7988 1160,84.7988 L1160,110.7988 C1160,120.7988 1142,120.7988 1142,120.7988 C1142,120.7988 1124,120.7988 1124,110.7988 L1124,84.7988 " fill="#FEFECE" filter="url(#f1anpngzq6ubl8)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1124,84.7988 C1124,94.7988 1142,94.7988 1142,94.7988 C1142,94.7988 1160,94.7988 1160,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1094" y="7833.3652">Central Store</text><path d="M1124,7846.3184 C1124,7836.3184 1142,7836.3184 1142,7836.3184 C1142,7836.3184 1160,7836.3184 1160,7846.3184 L1160,7872.3184 C1160,7882.3184 1142,7882.3184 1142,7882.3184 C1142,7882.3184 1124,7882.3184 1124,7872.3184 L1124,7846.3184 " fill="#FEFECE" filter="url(#f1anpngzq6ubl8)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1124,7846.3184 C1124,7856.3184 1142,7856.3184 1142,7856.3184 C1142,7856.3184 1160,7856.3184 1160,7846.3184 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="7664.543" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="104" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="7072.9844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="287" y="730.8457"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="243.7266" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="800" y="775.4668"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="366.2109" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="800" y="1088.125"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="320.2793" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="800" y="1498.957"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="228.416" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="800" y="1863.8574"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="74.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="800" y="5931.5469"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="350.9004" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="800" y="6098.0996"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="74.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="800" y="6861.0371"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="185.1055" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1137" y="804.7773"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="307.5898" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1137" y="1117.4355"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="261.6582" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1137" y="1528.2676"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="169.7949" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1137" y="1893.168"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1137" y="5976.168"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="276.9688" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1137" y="6142.7207"/><rect fill="#FFFFFF" filter="url(#f1anpngzq6ubl8)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1137" y="6905.6582"/><path d="M13,154.2871 L339,154.2871 L339,161.2871 L329,171.2871 L13,171.2871 L13,154.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="7649.543" style="stroke: #000000; stroke-width: 2.0;" width="1476" x="13" y="154.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="281" x="28" y="167.8555">Acknowledgement of Settlement Transfer</text><path d="M119,176.5977 L119,630.5977 L427,630.5977 L427,186.5977 L417,176.5977 L119,176.5977 " fill="#FFFF00" filter="url(#f1anpngzq6ubl8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M417,176.5977 L417,186.5977 L427,186.5977 L417,176.5977 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="125" y="194.166">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="141" y="209.4766">"participants": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="157" y="224.7871">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="173" y="240.0977">"id": 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="173" y="255.4082">"accounts" : [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="189" y="270.7188">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="205" y="286.0293">"id": 1,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="205" y="301.3398">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="205" y="316.6504">"reason": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="189" y="331.9609">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="189" y="347.2715">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="205" y="362.582">"id": 2,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="205" y="377.8926">"state": "SETTLED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="205" y="393.2031">"reason": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="189" y="408.5137">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="173" y="423.8242">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="157" y="439.1348">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="157" y="454.4453">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="173" y="469.7559">"id": 2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="173" y="485.0664">"accounts" : [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="189" y="500.377">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="205" y="515.6875">"id": 3,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="152" x="205" y="530.998">"state": "NOT_SETTLED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="205" y="546.3086">"reason": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="189" y="561.6191">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="173" y="576.9297">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="157" y="592.2402">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="141" y="607.5508">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="125" y="622.8613">}</text><path d="M119,644.6035 L119,699.6035 L399,699.6035 L399,654.6035 L389,644.6035 L119,644.6035 " fill="#D3D3D3" filter="url(#f1anpngzq6ubl8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M389,644.6035 L389,654.6035 L399,654.6035 L389,644.6035 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="125" y="662.1719">In the sequence diagram below:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="87" x="125" y="677.4824">participantId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="216" y="677.4824">is participants[N].id</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="149" x="125" y="692.793">participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="278" y="692.793">is accounts[N].id</text><polygon fill="#A80036" points="275,726.8457,285,730.8457,275,734.8457,279,730.8457" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="114" x2="281" y1="730.8457" y2="730.8457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="121" y="726.1035">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="134" y="726.1035">PUT - /settlement/{id}</text><polygon fill="#A80036" points="788,771.4668,798,775.4668,788,779.4668,792,775.4668" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="794" y1="775.4668" y2="775.4668"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="304" y="763.0693">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="239" x="317" y="755.4141">Retrive full information for settlement</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="317" y="770.7246">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="394" y="770.7246">2001</text><polygon fill="#A80036" points="1125,800.7773,1135,804.7773,1125,808.7773,1129,804.7773" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="810" x2="1131" y1="804.7773" y2="804.7773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="817" y="800.0352">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="830" y="800.0352">Select from DB</text><polygon fill="#FFFFE0" filter="url(#f1anpngzq6ubl8)" points="907,817.7773,1376,817.7773,1386,889.7773,1376,962.7773,907,962.7773,897,889.7773,907,817.7773" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="465" x="909" y="834.3457">SELECT s.settlementId, ssc.settlementStateId, ssc.reason, ssc.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="909" y="849.6563">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="949" y="849.6563">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="7" x="1025" y="849.6563">s</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="909" y="864.9668">LEFT JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="157" x="974" y="864.9668">settlementStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="1135" y="864.9668">ssc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="909" y="880.2773">ON ssc.settlementId = s.settlementId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="909" y="895.5879">AND ssc.settelementStateChangeId = (</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="282" x="925" y="910.8984">SELECT MAX(ssc1.settelementStateChangeId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="925" y="926.209">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="157" x="965" y="926.209">settlementStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="29" x="1126" y="926.209">ssc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="925" y="941.5195">WHERE ssc1.settlementId = {id})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="909" y="956.8301">WHERE s.settlementId = {id}</text><polygon fill="#A80036" points="821,985.8828,811,989.8828,821,993.8828,817,989.8828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="815" x2="1141" y1="989.8828" y2="989.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="827" y="985.1406">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="840" y="985.1406">Return data</text><polygon fill="#A80036" points="308,1015.1934,298,1019.1934,308,1023.1934,304,1019.1934" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="302" x2="804" y1="1019.1934" y2="1019.1934"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="314" y="1014.4512">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="327" y="1014.4512">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="103" x="372" y="1014.4512">settlementData</text><path d="M153.5,1034.1934 L215.5,1034.1934 L215.5,1041.1934 L205.5,1051.1934 L153.5,1051.1934 L153.5,1034.1934 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="6003.7305" style="stroke: #000000; stroke-width: 2.0;" width="1325.5" x="153.5" y="1034.1934"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="168.5" y="1047.7617">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="297" x="230.5" y="1046.8281">[settlementStateChange == 'PENDING_SETTLEMENT']</text><polygon fill="#A80036" points="788,1084.125,798,1088.125,788,1092.125,792,1088.125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="794" y1="1088.125" y2="1088.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="304" y="1075.7275">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="300" x="317" y="1068.0723">Retrive full information for settlement accounts</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="317" y="1083.3828">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="394" y="1083.3828">2001</text><polygon fill="#A80036" points="1125,1113.4355,1135,1117.4355,1125,1121.4355,1129,1117.4355" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="810" x2="1131" y1="1117.4355" y2="1117.4355"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="817" y="1112.6934">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="830" y="1112.6934">Select from DB</text><polygon fill="#FFFFE0" filter="url(#f1anpngzq6ubl8)" points="829,1130.4355,1455,1130.4355,1465,1264.4355,1455,1398.4355,829,1398.4355,819,1264.4355,829,1130.4355" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="570" x="831" y="1147.0039">SELECT pc.participantId, spc.participantCurrencyId, spcsc.settlementStateId, spcsc.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="568" x="859" y="1162.3145">spcsc.createdDate, spc.netAmount, pc.currencyId, spc.settlementParticipantCurrencyId AS</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1431" y="1162.3145">key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="831" y="1177.625">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="871" y="1177.625">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1082" y="1177.625">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="339" x="831" y="1192.9355">JOIN (SELECT spcsc1.settlementParticipantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="384" x="883" y="1208.2461">MAX(spcsc1.settlementParticipantCurrencyStateChangeId) AS</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="307" x="883" y="1223.5566">maxSettlementParticipantCurrencyStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="855" y="1238.8672">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="895" y="1238.8672">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="30" x="1106" y="1238.8672">spc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="855" y="1254.1777">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="887" y="1254.1777">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="1183" y="1254.1777">spcsc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="528" x="855" y="1269.4883">ON spcsc1.settlementParticipantCurrencyId = spc1.settlementParticipantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="855" y="1284.7988">WHERE spc1.settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="353" x="855" y="1300.1094">GROUP BY spcsc1.settlementParticipantCurrencyId) spcs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="831" y="1315.4199">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="863" y="1315.4199">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1159" y="1315.4199">spcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="831" y="1330.7305">ON spcsc.settlementParticipantCurrencyStateChangeId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="340" x="843" y="1346.041">spcs.maxSettlementParticipantCurrencyStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="831" y="1361.3516">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="863" y="1361.3516">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="1003" y="1361.3516">pc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="831" y="1376.6621">ON pc.participantCurrencyId = spc.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="831" y="1391.9727">WHERE spc.settlementId = {id}</text><polygon fill="#A80036" points="821,1421.0254,811,1425.0254,821,1429.0254,817,1425.0254" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="815" x2="1141" y1="1425.0254" y2="1425.0254"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="827" y="1420.2832">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="840" y="1420.2832">Return data</text><polygon fill="#A80036" points="308,1450.3359,298,1454.3359,308,1458.3359,304,1454.3359" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="302" x2="804" y1="1454.3359" y2="1454.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="314" y="1449.5938">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="327" y="1449.5938">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158" x="372" y="1449.5938">settlementAccountsList</text><polygon fill="#A80036" points="788,1494.957,798,1498.957,788,1502.957,792,1498.957" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="794" y1="1498.957" y2="1498.957"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="1486.5596">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="298" x="326" y="1478.9043">Retrive full information for settlement windows</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="326" y="1494.2148">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="403" y="1494.2148">2001</text><polygon fill="#A80036" points="1125,1524.2676,1135,1528.2676,1125,1532.2676,1129,1528.2676" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="810" x2="1131" y1="1528.2676" y2="1528.2676"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="817" y="1523.5254">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="839" y="1523.5254">Select from DB</text><polygon fill="#FFFFE0" filter="url(#f1anpngzq6ubl8)" points="824,1541.2676,1459,1541.2676,1469,1652.2676,1459,1763.2676,824,1763.2676,814,1652.2676,824,1541.2676" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="631" x="826" y="1557.8359">SELECT ssw.settlementWindowId, sswsc.settlementWindowStateId, sswsc.reason, sswsc.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="826" y="1573.1465">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="197" x="866" y="1573.1465">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="1067" y="1573.1465">ssw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="583" x="826" y="1588.457">JOIN (SELECT sswsc1.settlementWindowId, MAX(sswsc1.settlementWindowStateChangeId) AS</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="878" y="1603.7676">maxSettlementWindowStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="850" y="1619.0781">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="282" x="890" y="1619.0781">settlementSettlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="1176" y="1619.0781">sswsc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="850" y="1634.3887">WHERE sswsc1.settlementWindowId IN (</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="866" y="1649.6992">SELECT ssw1.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="866" y="1665.0098">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="197" x="906" y="1665.0098">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="1107" y="1665.0098">ssw1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="866" y="1680.3203">WHERE ssw1.settlementId = {id})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="283" x="850" y="1695.6309">GROUP BY sswsc1.settlementWindowId) ssws</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="361" x="826" y="1710.9414">ON ssws.settlementWindowId = ssw.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="826" y="1726.252">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="282" x="858" y="1726.252">settlementSettlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="1144" y="1726.252">sswsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="558" x="826" y="1741.5625">ON sswsc.settlementWindowStateChangeId = ssws.maxSettlementWindowStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="826" y="1756.873">WHERE ssw.settlementId = {id}</text><polygon fill="#A80036" points="821,1785.9258,811,1789.9258,821,1793.9258,817,1789.9258" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="815" x2="1141" y1="1789.9258" y2="1789.9258"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="827" y="1785.1836">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="849" y="1785.1836">Return data</text><polygon fill="#A80036" points="308,1815.2363,298,1819.2363,308,1823.2363,304,1819.2363" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="302" x2="804" y1="1819.2363" y2="1819.2363"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="314" y="1814.4941">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="336" y="1814.4941">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="83" x="381" y="1814.4941">windowsList</text><polygon fill="#A80036" points="788,1859.8574,798,1863.8574,788,1867.8574,792,1863.8574" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="794" y1="1863.8574" y2="1863.8574"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="1851.46">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="326" y="1843.8047">Retrive full information for settlement windows accounts</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="326" y="1859.1152">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="403" y="1859.1152">2001</text><polygon fill="#A80036" points="1125,1889.168,1135,1893.168,1125,1897.168,1129,1893.168" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="810" x2="1131" y1="1893.168" y2="1893.168"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="817" y="1888.4258">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="839" y="1888.4258">Select from DB</text><polygon fill="#FFFFE0" filter="url(#f1anpngzq6ubl8)" points="948,1906.168,1335,1906.168,1345,1971.168,1335,2036.168,948,2036.168,938,1971.168,948,1906.168" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="366" x="950" y="1922.7363">SELECT ssw.settlementWindowId, tp.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="950" y="1938.0469">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="197" x="990" y="1938.0469">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="1191" y="1938.0469">ssw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="950" y="1953.3574">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="982" y="1953.3574">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="1108" y="1953.3574">tf</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="340" x="950" y="1968.668">ON tf.settlementWindowId = ssw.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="950" y="1983.9785">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="982" y="1983.9785">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="13" x="1113" y="1983.9785">tp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="950" y="1999.2891">ON tp.transferId = tf.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="950" y="2014.5996">WHERE settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="383" x="950" y="2029.9102">GROUP BY ssw.settlementWindowId, tp.participantCurrencyId</text><polygon fill="#A80036" points="821,2058.9629,811,2062.9629,821,2066.9629,817,2062.9629" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="815" x2="1141" y1="2062.9629" y2="2062.9629"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="827" y="2058.2207">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="849" y="2058.2207">Return data</text><polygon fill="#A80036" points="308,2088.2734,298,2092.2734,308,2096.2734,304,2092.2734" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="302" x2="804" y1="2092.2734" y2="2092.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="314" y="2087.5313">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="336" y="2087.5313">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="145" x="381" y="2087.5313">windowsAccountsList</text><path d="M302,2105.2734 L302,3125.2734 L1095,3125.2734 L1095,2115.2734 L1085,2105.2734 L302,2105.2734 " fill="#D3D3D3" filter="url(#f1anpngzq6ubl8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1085,2105.2734 L1085,2115.2734 L1095,2115.2734 L1085,2105.2734 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="308" y="2122.8418">Available raw datasets from DB:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="103" x="308" y="2138.1523">settlementData</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="423" x="415" y="2138.1523">contains information about settlement and its current state/reason</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158" x="308" y="2153.4629">settlementAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="426" x="470" y="2153.4629">holds information about all accounts and their current state/reason</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="83" x="308" y="2168.7734">windowsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="411" x="395" y="2168.7734">has information about all windows and their current state/reason</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="145" x="308" y="2184.084">windowsAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="457" y="2184.084">has information about all accounts and windows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="312" y="2199.3945"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="308" y="2214.7051">Local variables and objects:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="308" y="2230.0156">settlementAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="442" y="2230.0156">: { // (derived from</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="564" y="2230.0156">settlementAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="713" y="2230.0156">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="527" x="324" y="2245.3262">pendingSettlementAccounts: [], // array of accounts in PENDING_SETTLEMENT state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="362" x="324" y="2260.6367">settledAccounts: [], // array of accounts in SETTLED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="414" x="324" y="2275.9473">notSettledAccounts: [] // array of accounts in NOT_SETTLED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="308" y="2291.2578">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118" x="308" y="2306.5684">allParticipantsInit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="497" x="426" y="2306.5684">: { // same as participants response object with initial data &amp; key (derived from</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="927" y="2306.5684">settlementAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1076" y="2306.5684">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="471" x="324" y="2321.8789">participantId_key: { // number used to access the object in array-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="340" y="2337.1895">id: participantId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="69" x="340" y="2352.5">accounts: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="527" x="356" y="2367.8105">participantCurrencyId_key: { // number used to access the object in array-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="372" y="2383.1211">id: participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="372" y="2398.4316">state: settlementStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="372" y="2413.7422">reason: reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="372" y="2429.0527">createdDate: createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="372" y="2444.3633">netSettlementAmount: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="388" y="2459.6738">amount: netAmount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="388" y="2474.9844">currency: currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="372" y="2490.2949">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="372" y="2505.6055">key:</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="402" y="2505.6055">key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="430" x="428" y="2505.6055">// will be used to insert new state for settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="356" y="2520.916">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="340" y="2536.2266">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="324" y="2551.5371">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="308" y="2566.8477">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="100" x="308" y="2582.1582">allAccountsInit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="408" y="2582.1582">: { // same as previous, but without participant id</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="527" x="324" y="2597.4688">participantCurrencyId_key: { // number used to access the object in array-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="340" y="2612.7793">id: participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="340" y="2628.0898">state: settlementStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="340" y="2643.4004">reason: reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="340" y="2658.7109">createdDate: createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="340" y="2674.0215">netSettlementAmount: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="356" y="2689.332">amount: netAmount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="356" y="2704.6426">currency: currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="340" y="2719.9531">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="340" y="2735.2637">key:</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="370" y="2735.2637">key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="430" x="396" y="2735.2637">// will be used to insert new state for settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="324" y="2750.5742">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="308" y="2765.8848">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="308" y="2781.1953">allWindowsInit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="498" x="410" y="2781.1953">{ // same as settlementWindows response object with initial data (derived from</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="912" y="2781.1953">windowsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="990" y="2781.1953">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="519" x="324" y="2796.5059">settlementWindowId_key: { // number used to access the object in array-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="340" y="2811.8164">id: settlementWindowId, // same as key value</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="340" y="2827.127">state: settlementWindowStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="340" y="2842.4375">reason: reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="340" y="2857.748">createdDate: createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="324" y="2873.0586">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="308" y="2888.3691">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="121" x="308" y="2903.6797">windowsAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="429" y="2903.6797">: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="519" x="324" y="2918.9902">settlementWindowId_key: { // number used to access the object in array-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="340" y="2934.3008">id: settlementWindowId // same as key value</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="527" x="340" y="2949.6113">pendingSettlementAccounts: [], // array of accounts in PENDING_SETTLEMENT state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="362" x="340" y="2964.9219">settledAccounts: [], // array of accounts in SETTLED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="414" x="340" y="2980.2324">notSettledAccounts: [] // array of accounts in NOT_SETTLED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="324" y="2995.543">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="308" y="3010.8535">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="308" y="3026.1641">accountsWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="428" y="3026.1641">: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="527" x="324" y="3041.4746">participantCurrencyId_key: { // number used to access the object in array-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="340" y="3056.7852">id: participantCurrencyId, // same as key value</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="448" x="340" y="3072.0957">windows: [] // array of windows to which the account settlement spans</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="324" y="3087.4063">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="308" y="3102.7168">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="308" y="3118.0273">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="328" y="3118.0273">transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="484" y="3118.0273">= now()</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="339" y1="3196.3906" y2="3196.3906"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="339" x2="339" y1="3196.3906" y2="3209.3906"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="298" x2="339" y1="3209.3906" y2="3209.3906"/><polygon fill="#A80036" points="308,3205.3906,298,3209.3906,308,3213.3906,304,3209.3906" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="3183.9932">18</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="326" y="3176.3379">Acquire DB lock</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="292" x="430" y="3176.3379">on settlementParticipantCurrencyStateChange,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="370" x="326" y="3191.6484">settlementWindowStateChange and settlementStateChange</text><path d="M302,3222.3906 L302,3385.3906 L626,3385.3906 L626,3232.3906 L616,3222.3906 L302,3222.3906 " fill="#D3D3D3" filter="url(#f1anpngzq6ubl8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M616,3222.3906 L616,3232.3906 L626,3232.3906 L616,3222.3906 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="308" y="3239.959">let settlementAccounts = {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="324" y="3255.2695">pendingSettlementAccounts: [],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="324" y="3270.5801">settledAccounts: [],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="324" y="3285.8906">notSettledAccounts: [],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="308" y="3301.2012">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="303" x="308" y="3316.5117">let allParticipantsInit = {} // declare sparse array</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="308" y="3331.8223">let allAccountsInit = {} // declare sparse array</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="308" y="3347.1328">let pid // participantId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="308" y="3362.4434">let aid // accountId = participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="51" x="308" y="3377.7539">let state</text><path d="M282,3401.4961 L356,3401.4961 L356,3408.4961 L346,3418.4961 L282,3418.4961 L282,3401.4961 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="480.7422" style="stroke: #000000; stroke-width: 2.0;" width="641" x="282" y="3401.4961"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="297" y="3415.0645">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="193" x="371" y="3414.1309">[settlementAccountsList as record]</text><path d="M302,3423.8066 L302,3693.8066 L909,3693.8066 L909,3433.8066 L899,3423.8066 L302,3423.8066 " fill="#D3D3D3" filter="url(#f1anpngzq6ubl8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M899,3423.8066 L899,3433.8066 L909,3433.8066 L899,3423.8066 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="308" y="3441.375">pid = record.participantId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="308" y="3456.6855">aid = record.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="203" x="308" y="3471.9961">state = record.settlementStateId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="312" y="3487.3066"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="308" y="3502.6172">allAccountsInit[aid] = {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="324" y="3517.9277">id: aid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="324" y="3533.2383">state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="324" y="3548.5488">reason: record.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="324" y="3563.8594">createDate: record.createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="324" y="3579.1699">netSettlementAmount: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="340" y="3594.4805">amount: record.netAmount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="340" y="3609.791">currency: record.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="324" y="3625.1016">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="324" y="3640.4121">key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="308" y="3655.7227">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="586" x="308" y="3671.0332">allParticipantsInit[pid] = allParticipantsInit[pid] ? allParticipantsInit[pid] : {id: pid, accounts: {}}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="366" x="308" y="3686.3438">allParticipantsInit[pid].accounts[aid] = allAccountsInit[aid]</text><path d="M292,3710.0859 L354,3710.0859 L354,3717.0859 L344,3727.0859 L292,3727.0859 L292,3710.0859 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="165.1523" style="stroke: #000000; stroke-width: 2.0;" width="414" x="292" y="3710.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="307" y="3723.6543">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="198" x="369" y="3722.7207">[state == 'PENDING_SETTLEMENT']</text><path d="M302,3732.3965 L302,3757.3965 L692,3757.3965 L692,3742.3965 L682,3732.3965 L302,3732.3965 " fill="#D3D3D3" filter="url(#f1anpngzq6ubl8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M682,3732.3965 L682,3742.3965 L692,3742.3965 L682,3732.3965 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="369" x="308" y="3749.9648">settlementAccounts.pendingSettlementAccounts.push(aid)</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="292" x2="706" y1="3767.707" y2="3767.707"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="117" x="297" y="3778.3418">[state == 'SETTLED']</text><path d="M302,3786.6621 L302,3811.6621 L617,3811.6621 L617,3796.6621 L607,3786.6621 L302,3786.6621 " fill="#D3D3D3" filter="url(#f1anpngzq6ubl8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M607,3786.6621 L607,3796.6621 L617,3796.6621 L607,3786.6621 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="294" x="308" y="3804.2305">settlementAccounts.settledAccounts.push(aid)</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="292" x2="706" y1="3821.9727" y2="3821.9727"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="148" x="297" y="3832.6074">[state == 'NOT_SETTLED']</text><path d="M302,3840.9277 L302,3865.9277 L638,3865.9277 L638,3850.9277 L628,3840.9277 L302,3840.9277 " fill="#D3D3D3" filter="url(#f1anpngzq6ubl8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M628,3840.9277 L628,3850.9277 L638,3850.9277 L628,3840.9277 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="308" y="3858.4961">settlementAccounts.notSettledAccounts.push(aid)</text><path d="M302,3919.2383 L302,3959.2383 L608,3959.2383 L608,3929.2383 L598,3919.2383 L302,3919.2383 " fill="#D3D3D3" filter="url(#f1anpngzq6ubl8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M598,3919.2383 L598,3929.2383 L608,3929.2383 L598,3919.2383 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="285" x="308" y="3936.8066">let allWindowsInit = {} // declare sparse array</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="308" y="3952.1172">let wid // settlementWindowId</text><path d="M292,3975.8594 L366,3975.8594 L366,3982.8594 L356,3992.8594 L292,3992.8594 L292,3975.8594 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="179.1055" style="stroke: #000000; stroke-width: 2.0;" width="297" x="292" y="3975.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="307" y="3989.4277">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="133" x="381" y="3988.4941">[windowsList as record]</text><path d="M302,3998.1699 L302,4145.1699 L575,4145.1699 L575,4008.1699 L565,3998.1699 L302,3998.1699 " fill="#D3D3D3" filter="url(#f1anpngzq6ubl8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M565,3998.1699 L565,4008.1699 L575,4008.1699 L565,3998.1699 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212" x="308" y="4015.7383">wid = record.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="308" y="4031.0488">state = record.settlementWindowStateId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="312" y="4046.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="308" y="4061.6699">allWindowsInit[wid] = {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="324" y="4076.9805">id: wid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="324" y="4092.291">state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="324" y="4107.6016">reason: record.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="324" y="4122.9121">createDate: record.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="308" y="4138.2227">}</text><path d="M302,4191.9648 L302,4231.9648 L630,4231.9648 L630,4201.9648 L620,4191.9648 L302,4191.9648 " fill="#D3D3D3" filter="url(#f1anpngzq6ubl8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M620,4191.9648 L620,4201.9648 L630,4201.9648 L620,4191.9648 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="307" x="308" y="4209.5332">let windowsAccounts = {} // declare sparse array</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="308" y="4224.8438">let accountsWindows = {} // declare sparse array</text><path d="M282,4248.5859 L356,4248.5859 L356,4255.5859 L346,4265.5859 L282,4265.5859 L282,4248.5859 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="465.4316" style="stroke: #000000; stroke-width: 2.0;" width="534" x="282" y="4248.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="297" y="4262.1543">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="184" x="371" y="4261.2207">[windowsAccountsList as record]</text><path d="M302,4270.8965 L302,4524.8965 L802,4524.8965 L802,4280.8965 L792,4270.8965 L302,4270.8965 " fill="#D3D3D3" filter="url(#f1anpngzq6ubl8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M792,4270.8965 L792,4280.8965 L802,4280.8965 L792,4270.8965 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212" x="308" y="4288.4648">wid = record.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="308" y="4303.7754">aid = record.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="308" y="4319.0859">state = allAccountsInit[aid]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="312" y="4334.3965"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="467" x="308" y="4349.707">accountsWindows[aid] = accountsWindows[aid] ? accountsWindows[aid] : {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="324" y="4365.0176">id: aid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="71" x="324" y="4380.3281">windows: []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="308" y="4395.6387">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="308" y="4410.9492">accountsWindows[aid].windows.push(wid)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="312" y="4426.2598"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="479" x="308" y="4441.5703">windowsAccounts[wid] = windowsAccounts[wid] ? windowsAccounts[wid] : {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="324" y="4456.8809">id: wid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="324" y="4472.1914">pendingSettlementAccounts: [],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="324" y="4487.502">settledAccounts: [],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="324" y="4502.8125">notSettledAccounts: []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="308" y="4518.123">}</text><path d="M292,4541.8652 L354,4541.8652 L354,4548.8652 L344,4558.8652 L292,4558.8652 L292,4541.8652 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="165.1523" style="stroke: #000000; stroke-width: 2.0;" width="432" x="292" y="4541.8652"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="307" y="4555.4336">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="198" x="369" y="4554.5">[state == 'PENDING_SETTLEMENT']</text><path d="M302,4564.1758 L302,4589.1758 L710,4589.1758 L710,4574.1758 L700,4564.1758 L302,4564.1758 " fill="#D3D3D3" filter="url(#f1anpngzq6ubl8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M700,4564.1758 L700,4574.1758 L710,4574.1758 L700,4564.1758 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="387" x="308" y="4581.7441">windowsAccounts[wid].pendingSettlementAccounts.push(aid)</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="292" x2="724" y1="4599.4863" y2="4599.4863"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="117" x="297" y="4610.1211">[state == 'SETTLED']</text><path d="M302,4618.4414 L302,4643.4414 L635,4643.4414 L635,4628.4414 L625,4618.4414 L302,4618.4414 " fill="#D3D3D3" filter="url(#f1anpngzq6ubl8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M625,4618.4414 L625,4628.4414 L635,4628.4414 L625,4618.4414 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="308" y="4636.0098">windowsAccounts[wid].settledAccounts.push(aid)</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="292" x2="724" y1="4653.752" y2="4653.752"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="148" x="297" y="4664.3867">[state == 'NOT_SETTLED']</text><path d="M302,4672.707 L302,4697.707 L656,4697.707 L656,4682.707 L646,4672.707 L302,4672.707 " fill="#D3D3D3" filter="url(#f1anpngzq6ubl8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M646,4672.707 L646,4682.707 L656,4682.707 L646,4672.707 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="308" y="4690.2754">windowsAccounts[wid].notSettledAccounts.push(aid)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="339" y1="4857.6387" y2="4857.6387"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="339" x2="339" y1="4857.6387" y2="4870.6387"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="298" x2="339" y1="4870.6387" y2="4870.6387"/><polygon fill="#A80036" points="308,4866.6387,298,4870.6387,308,4874.6387,304,4870.6387" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="4845.2412">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="326" y="4837.5859">participantList = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="326" y="4852.8965">settlementParticipantCurrencyIdList = []</text><path d="M163.5,4885.6387 L237.5,4885.6387 L237.5,4892.6387 L227.5,4902.6387 L163.5,4902.6387 L163.5,4885.6387 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="968.9766" style="stroke: #000000; stroke-width: 2.0;" width="637.5" x="163.5" y="4885.6387"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="178.5" y="4899.207">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="200" x="252.5" y="4898.2734">[payload.participants as participant]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="339" y1="4924.2598" y2="4924.2598"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="339" x2="339" y1="4924.2598" y2="4937.2598"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="298" x2="339" y1="4937.2598" y2="4937.2598"/><polygon fill="#A80036" points="308,4933.2598,298,4937.2598,308,4941.2598,304,4937.2598" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="4919.5176">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="463" x="326" y="4919.5176">participantList.push({participantId: participant.participantId, accounts: []})</text><path d="M173.5,4952.2598 L247.5,4952.2598 L247.5,4959.2598 L237.5,4969.2598 L173.5,4969.2598 L173.5,4952.2598 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="895.3555" style="stroke: #000000; stroke-width: 2.0;" width="604.5" x="173.5" y="4952.2598"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="188.5" y="4965.8281">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="183" x="262.5" y="4964.8945">[participant.accounts as account]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="339" y1="4990.8809" y2="4990.8809"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="339" x2="339" y1="4990.8809" y2="5003.8809"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="298" x2="339" y1="5003.8809" y2="5003.8809"/><polygon fill="#A80036" points="308,4999.8809,298,5003.8809,308,5007.8809,304,5003.8809" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="4986.1387">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="326" y="4986.1387">accountIsFound = false</text><path d="M183.5,5018.8809 L257.5,5018.8809 L257.5,5025.8809 L247.5,5035.8809 L183.5,5035.8809 L183.5,5018.8809 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="615.9395" style="stroke: #000000; stroke-width: 2.0;" width="584.5" x="183.5" y="5018.8809"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="198.5" y="5032.4492">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="272.5" y="5031.5156">[spcStateChangeList as record]</text><path d="M193.5,5043.1914 L255.5,5043.1914 L255.5,5050.1914 L245.5,5060.1914 L193.5,5060.1914 L193.5,5043.1914 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="559.6289" style="stroke: #000000; stroke-width: 2.0;" width="564.5" x="193.5" y="5043.1914"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="208.5" y="5056.7598">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="274" x="270.5" y="5055.8262">[participant.participantId == record.participantId</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="381" x="270.5" y="5068.7813">and account.participantCurrencyId == record.participantCurrencyId]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="339" y1="5092.7227" y2="5092.7227"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="339" x2="339" y1="5092.7227" y2="5105.7227"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="298" x2="339" y1="5105.7227" y2="5105.7227"/><polygon fill="#A80036" points="308,5101.7227,298,5105.7227,308,5109.7227,304,5105.7227" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="5087.9805">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="326" y="5087.9805">accountIsFound = true</text><path d="M203.5,5120.7227 L265.5,5120.7227 L265.5,5127.7227 L255.5,5137.7227 L203.5,5137.7227 L203.5,5120.7227 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="450.0977" style="stroke: #000000; stroke-width: 2.0;" width="544.5" x="203.5" y="5120.7227"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="218.5" y="5134.291">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="306" x="280.5" y="5133.3574">[record.settlementStateId == 'PENDING_SETTLEMENT']</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="339" y1="5205.2754" y2="5205.2754"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="339" x2="339" y1="5205.2754" y2="5218.2754"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="298" x2="339" y1="5218.2754" y2="5218.2754"/><polygon fill="#A80036" points="308,5214.2754,298,5218.2754,308,5222.2754,304,5218.2754" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="5177.5674">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="326" y="5154.6016">settlementParticipantCurrencyIdList.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="394" x="342" y="5169.9121">participantCurrencyId: record.settlementParticipantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="342" y="5185.2227">reason: 'string'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="326" y="5200.5332">})</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="339" y1="5385.3809" y2="5385.3809"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="339" x2="339" y1="5385.3809" y2="5398.3809"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="298" x2="339" y1="5398.3809" y2="5398.3809"/><polygon fill="#A80036" points="308,5394.3809,298,5398.3809,308,5402.3809,304,5398.3809" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="5311.7412">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="326" y="5242.8438">participantList[participantList.length-1].accounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="326" y="5258.1543">.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="342" y="5273.4648">participantCurrencyId: account.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="342" y="5288.7754">reason: 'string',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103" x="342" y="5304.0859">state: 'SETTLED',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="342" y="5319.3965">netSettlementAmount: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="358" y="5334.707">amount: record.netAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="358" y="5350.0176">currency: record.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="342" y="5365.3281">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="326" y="5380.6387">})</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="203.5" x2="748" y1="5407.3809" y2="5407.3809"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="225" x="208.5" y="5418.0156">[record.settlementStateId == 'SETTLED']</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="339" y1="5549.8203" y2="5549.8203"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="339" x2="339" y1="5549.8203" y2="5562.8203"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="298" x2="339" y1="5562.8203" y2="5562.8203"/><polygon fill="#A80036" points="308,5558.8203,298,5562.8203,308,5566.8203,304,5562.8203" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="5491.4912">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="326" y="5437.9043">participantList[participantList.length-1].accounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="326" y="5453.2148">.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="342" y="5468.5254">participantCurrencyId: account.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="342" y="5483.8359">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="358" y="5499.1465">errorCode: 'code',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="358" y="5514.457">errorDescription: 'Already settled'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="342" y="5529.7676">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="326" y="5545.0781">})</text><path d="M203.5,5648.8203 L270.5,5648.8203 L270.5,5655.8203 L260.5,5665.8203 L203.5,5665.8203 L203.5,5648.8203 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="166.7949" style="stroke: #000000; stroke-width: 2.0;" width="488.5" x="203.5" y="5648.8203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="218.5" y="5662.3887">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="148" x="285.5" y="5661.4551">[accountIsFound == false]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="339" y1="5794.6152" y2="5794.6152"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="339" x2="339" y1="5794.6152" y2="5807.6152"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="298" x2="339" y1="5807.6152" y2="5807.6152"/><polygon fill="#A80036" points="308,5803.6152,298,5807.6152,308,5811.6152,304,5807.6152" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="5736.2861">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="326" y="5682.6992">participantList[participantList.length-1].accounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="326" y="5698.0098">.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="342" y="5713.3203">participantCurrencyId: account.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="342" y="5728.6309">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="358" y="5743.9414">errorCode: 'code',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="358" y="5759.252">errorDescription: 'Account not found'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="342" y="5774.5625">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="326" y="5789.873">})</text><path d="M193.5,5868.6152 L358.5,5868.6152 L358.5,5875.6152 L348.5,5885.6152 L193.5,5885.6152 L193.5,5868.6152 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="185.8633" style="stroke: #000000; stroke-width: 2.0;" width="1114.5" x="193.5" y="5868.6152"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="208.5" y="5882.1836">DB TRANSACTION</text><path d="M203.5,5892.9258 L277.5,5892.9258 L277.5,5899.9258 L267.5,5909.9258 L203.5,5909.9258 L203.5,5892.9258 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="154.5527" style="stroke: #000000; stroke-width: 2.0;" width="1094.5" x="203.5" y="5892.9258"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="218.5" y="5906.4941">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="263" x="292.5" y="5905.5605">[settlementParticipantCurrencyIdList as record]</text><polygon fill="#A80036" points="788,5927.5469,798,5931.5469,788,5935.5469,792,5931.5469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="794" y1="5931.5469" y2="5931.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="5926.8047">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="283" x="326" y="5926.8047">Change settlement participant currency state</text><polygon fill="#A80036" points="1125,5972.168,1135,5976.168,1125,5980.168,1129,5976.168" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="810" x2="1131" y1="5976.168" y2="5976.168"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="817" y="5963.7705">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="281" x="839" y="5956.1152">Insert new state 'SETTLED' and record.reason</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="839" y="5971.4258">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="916" y="5971.4258">2001</text><polygon fill="#FFFFE0" filter="url(#f1anpngzq6ubl8)" points="1006,6019.168,1278,6019.168,1288,6030.168,1278,6042.168,1006,6042.168,996,6030.168,1006,6019.168" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="1008" y="6035.7363">settlementParticipantCurrencyStateChange</text><polygon fill="#A80036" points="788,6094.0996,798,6098.0996,788,6102.0996,792,6098.0996" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="794" y1="6098.0996" y2="6098.0996"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="6085.7021">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="346" x="326" y="6078.0469">Get list of all NOT_SETTELED or PENDING_SETTLEMENT</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="222" x="326" y="6093.3574">participantCurrencies in settlement</text><polygon fill="#A80036" points="1125,6138.7207,1135,6142.7207,1125,6146.7207,1129,6142.7207" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="810" x2="1131" y1="6142.7207" y2="6142.7207"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="817" y="6130.3232">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="67" x="839" y="6122.668">Retrive list</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="839" y="6137.9785">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="916" y="6137.9785">2001</text><polygon fill="#FFFFE0" filter="url(#f1anpngzq6ubl8)" points="872,6155.7207,1412,6155.7207,1422,6273.7207,1412,6392.7207,872,6392.7207,862,6273.7207,872,6155.7207" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="874" y="6172.2891">SELECT spc.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="874" y="6187.5996">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="914" y="6187.5996">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1125" y="6187.5996">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="317" x="874" y="6202.9102">JOIN (SELECT spc.settlementParticipantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="336" x="926" y="6218.2207">MAX(settlementParticipantCurrencyStateChangeId) AS</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="307" x="926" y="6233.5313">maxSettlementParticipantCurrencyStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="898" y="6248.8418">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="938" y="6248.8418">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1234" y="6248.8418">spcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="898" y="6264.1523">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="930" y="6264.1523">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1141" y="6264.1523">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="512" x="898" y="6279.4629">ON spc.settlementParticipantCurrencyId = spcsc.settlementParticipantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="898" y="6294.7734">WHERE spc.settlementId = {id}) AS mx</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="496" x="874" y="6310.084">ON mx.settlementParticipantCurrencyId = spc.settlementParticipantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="874" y="6325.3945">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="906" y="6325.3945">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1202" y="6325.3945">spcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="874" y="6340.7051">ON spcsc.settlementParticipantCurrencyStateChangeId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="331" x="886" y="6356.0156">mx.maxSettlementParticipantCurrencyStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="874" y="6371.3262">WHERE spc.settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="874" y="6386.6367">AND spcsc.settlementStateId != 'SETTLED'</text><polygon fill="#A80036" points="821,6415.6895,811,6419.6895,821,6423.6895,817,6419.6895" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="815" x2="1141" y1="6419.6895" y2="6419.6895"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="827" y="6414.9473">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="849" y="6414.9473">Return list</text><polygon fill="#A80036" points="308,6445,298,6449,308,6453,304,6449" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="302" x2="804" y1="6449" y2="6449"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="314" y="6444.2578">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="336" y="6444.2578">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="231" x="381" y="6444.2578">settlementParticipantCurrencyList</text><path d="M173.5,6464 L391.5,6464 L391.5,6471 L381.5,6481 L173.5,6481 L173.5,6464 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="526.9688" style="stroke: #000000; stroke-width: 2.0;" width="1107.5" x="173.5" y="6464"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="173" x="188.5" y="6477.5684">Settle settlementWindows</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="339" y1="6517.9316" y2="6517.9316"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="339" x2="339" y1="6517.9316" y2="6530.9316"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="298" x2="339" y1="6530.9316" y2="6530.9316"/><polygon fill="#A80036" points="308,6526.9316,298,6530.9316,308,6534.9316,304,6530.9316" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="6505.5342">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="326" y="6497.8789">allWindowsList = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="326" y="6513.1895">notSettledWindowsList = []</text><path d="M183.5,6545.9316 L257.5,6545.9316 L257.5,6552.9316 L247.5,6562.9316 L183.5,6562.9316 L183.5,6545.9316 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="195.8633" style="stroke: #000000; stroke-width: 2.0;" width="540.5" x="183.5" y="6545.9316"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="198.5" y="6559.5">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="309" x="272.5" y="6558.5664">[settlementWindowsParticipantCurrencyList as window]</text><path d="M203.5,6570.2422 L270.5,6570.2422 L270.5,6577.2422 L260.5,6587.2422 L203.5,6587.2422 L203.5,6570.2422 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="451.5" x="203.5" y="6570.2422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="218.5" y="6583.8105">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="300" x="285.5" y="6582.877">[window.settlementWindowId NOT IN allWindowsList]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="339" y1="6608.8633" y2="6608.8633"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="339" x2="339" y1="6608.8633" y2="6621.8633"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="298" x2="339" y1="6621.8633" y2="6621.8633"/><polygon fill="#A80036" points="308,6617.8633,298,6621.8633,308,6625.8633,304,6621.8633" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="6604.1211">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="317" x="326" y="6604.1211">allWindowsList.push(window.settlementWindowId)</text><path d="M193.5,6643.8633 L267.5,6643.8633 L267.5,6650.8633 L257.5,6660.8633 L193.5,6660.8633 L193.5,6643.8633 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="90.9316" style="stroke: #000000; stroke-width: 2.0;" width="520.5" x="193.5" y="6643.8633"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="208.5" y="6657.4316">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="229" x="282.5" y="6656.498">[settlementParticipantCurrencyList as pc]</text><path d="M203.5,6668.1738 L270.5,6668.1738 L270.5,6675.1738 L260.5,6685.1738 L203.5,6685.1738 L203.5,6668.1738 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="500.5" x="203.5" y="6668.1738"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="218.5" y="6681.7422">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="338" x="285.5" y="6680.8086">[pc.participantCurrencyId == window.participantCurrencyId]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="339" y1="6706.7949" y2="6706.7949"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="339" x2="339" y1="6706.7949" y2="6719.7949"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="298" x2="339" y1="6719.7949" y2="6719.7949"/><polygon fill="#A80036" points="308,6715.7949,298,6719.7949,308,6723.7949,304,6719.7949" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="6702.0527">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="366" x="326" y="6702.0527">notSettledWindowsList.push(window.settlementWindowId)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="339" y1="6770.1055" y2="6770.1055"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="339" x2="339" y1="6770.1055" y2="6783.1055"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="298" x2="339" y1="6783.1055" y2="6783.1055"/><polygon fill="#A80036" points="308,6779.1055,298,6783.1055,308,6787.1055,304,6783.1055" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="6765.3633">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="467" x="326" y="6765.3633">settledWindowsList = _.difference(allWindowsList, notSettledWindowsList)</text><path d="M193.5,6798.1055 L358.5,6798.1055 L358.5,6805.1055 L348.5,6815.1055 L193.5,6815.1055 L193.5,6798.1055 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="185.8633" style="stroke: #000000; stroke-width: 2.0;" width="1077.5" x="193.5" y="6798.1055"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="208.5" y="6811.6738">DB TRANSACTION</text><path d="M203.5,6822.416 L277.5,6822.416 L277.5,6829.416 L267.5,6839.416 L203.5,6839.416 L203.5,6822.416 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="154.5527" style="stroke: #000000; stroke-width: 2.0;" width="1057.5" x="203.5" y="6822.416"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="218.5" y="6835.9844">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="171" x="292.5" y="6835.0508">[settledWindowsList as record]</text><polygon fill="#A80036" points="788,6857.0371,798,6861.0371,788,6865.0371,792,6861.0371" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="297" x2="794" y1="6861.0371" y2="6861.0371"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="304" y="6856.2949">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="403" x="326" y="6856.2949">Change settlement window state for record.settlementWindowId</text><polygon fill="#A80036" points="1125,6901.6582,1135,6905.6582,1125,6909.6582,1129,6905.6582" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="810" x2="1131" y1="6905.6582" y2="6905.6582"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="817" y="6893.2607">38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="839" y="6885.6055">Insert new state 'SETTLED'</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="839" y="6900.916">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="916" y="6900.916">2001</text><polygon fill="#FFFFE0" filter="url(#f1anpngzq6ubl8)" points="1043,6948.6582,1241,6948.6582,1251,6959.6582,1241,6971.6582,1043,6971.6582,1033,6959.6582,1043,6948.6582" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1045" y="6965.2266">settlementWindowStateChange</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="153.5" x2="1479" y1="6998.9688" y2="6998.9688"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="313" x="158.5" y="7009.6035">[settlementStateChange IN ['NOT_SETTLED', 'SETTLED']]</text><path d="M23,7049.9238 L23,7793.9238 L278,7793.9238 L278,7059.9238 L268,7049.9238 L23,7049.9238 " fill="#FFFFE0" filter="url(#f1anpngzq6ubl8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M268,7049.9238 L268,7059.9238 L278,7059.9238 L268,7049.9238 " fill="#FFFFE0" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="29" y="7067.4922">[</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="37" y="7082.8027">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="45" y="7098.1133">"id": 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="45" y="7113.4238">"state": &lt;enum&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="45" y="7128.7344">"createdDate": &lt;date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="45" y="7144.0449">"settlementWindows": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="53" y="7159.3555">[</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="61" y="7174.666">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="69" y="7189.9766">"id": 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="69" y="7205.2871">"state": &lt;enum&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="69" y="7220.5977">"reason": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="69" y="7235.9082">"createdDate": &lt;date&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="61" y="7251.2188">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="53" y="7266.5293">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="45" y="7281.8398">],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="45" y="7297.1504">"participants": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="53" y="7312.4609">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="61" y="7327.7715">"id": 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="61" y="7343.082">"accounts": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="69" y="7358.3926">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="77" y="7373.7031">"id": 1,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="77" y="7389.0137">"state": "SETTLED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="77" y="7404.3242">"reason": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="77" y="7419.6348">"createdDate": &lt;date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="77" y="7434.9453">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="85" y="7450.2559">"amount": 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="85" y="7465.5664">"currency": &lt;enum&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="77" y="7480.877">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="69" y="7496.1875">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="69" y="7511.498">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="77" y="7526.8086">"id": 2,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="77" y="7542.1191">"state": "SETTLED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="77" y="7557.4297">"reason": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="77" y="7572.7402">"createdDate": &lt;date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="77" y="7588.0508">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="85" y="7603.3613">"amount": 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="85" y="7618.6719">"currency": &lt;enum&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="77" y="7633.9824">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="77" y="7649.293">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="85" y="7664.6035">"errorCode": 8001,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="85" y="7679.9141">"errorDescription": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="77" y="7695.2246">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="69" y="7710.5352">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="61" y="7725.8457">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="53" y="7741.1563">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="45" y="7756.4668">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="37" y="7771.7773">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="29" y="7787.0879">]</text><!--
@startuml
title 6.2.5. Acknowledgement of Settlement Transfer
autonumber

actor "Hub Employee" as OPERATOR
boundary "Settlement Service API" as SSAPI
entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Central HUB" #lightpink
    participant OPERATOR
end box

box "Settlement Service" #lightgreen
    participant SSAPI
    participant SETTLE_DAO
end box

box "Central Services" #lightyellow
    participant DB
end box

group Acknowledgement of Settlement Transfer
    activate OPERATOR
    note right of OPERATOR #yellow
        {
            "participants": [
                {
                    "id": 1
                    "accounts" : [
                        {
                            "id": 1,
                            "state": "PENDING_SETTLEMENT",
                            "reason": <string>
                        },
                        {
                            "id": 2,
                            "state": "SETTLED",
                            "reason": <string>
                        }
                    ]
                },
                {
                    "id": 2
                    "accounts" : [
                        {
                            "id": 3,
                            "state": "NOT_SETTLED",
                            "reason": <string>
                        }
                    ]
                }
            ]
        }
    end note
    
    note right of OPERATOR #lightgray
        In the sequence diagram below:
        **participantId** is participants[N].id
        **participantCurrencyId** is accounts[N].id
    end note

    OPERATOR -> SSAPI: PUT - /settlement/{id}
    activate SSAPI
    SSAPI -> SETTLE_DAO: Retrive full information for settlement\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    SETTLE_DAO -> DB: Select from DB
    activate DB
    hnote over DB #lightyellow
        SELECT s.settlementId, ssc.settlementStateId, ssc.reason, ssc.createdDate
        FROM **settlement** s
        LEFT JOIN **settlementStateChange** ssc
        ON ssc.settlementId = s.settlementId
        AND ssc.settelementStateChangeId = (
            SELECT MAX(ssc1.settelementStateChangeId)
            FROM **settlementStateChange** ssc1
            WHERE ssc1.settlementId = {id})
        WHERE s.settlementId = {id}
    end hnote
    SETTLE_DAO <- - DB: Return data
    deactivate DB
    SSAPI <- - SETTLE_DAO: Return **settlementData**
    deactivate SETTLE_DAO

    alt settlementStateChange == 'PENDING_SETTLEMENT'
        SSAPI -> SETTLE_DAO: Retrive full information for settlement accounts\n<color #FF0000><b>Error code:</b> 2001</color>
        activate SETTLE_DAO
        SETTLE_DAO -> DB: Select from DB
        activate DB
        hnote over DB #lightyellow
            SELECT pc.participantId, spc.participantCurrencyId, spcsc.settlementStateId, spcsc.reason,
                   spcsc.createdDate, spc.netAmount, pc.currencyId, spc.settlementParticipantCurrencyId AS <color #0000FF>key</color>
            FROM **settlementParticipantCurrency** spc
            JOIN (SELECT spcsc1.settlementParticipantCurrencyId, 
                         MAX(spcsc1.settlementParticipantCurrencyStateChangeId) AS
                         maxSettlementParticipantCurrencyStateChangeId
                  FROM **settlementParticipantCurrency** spc1
                  JOIN **settlementParticipantCurrencyStateChange** spcsc1
                  ON spcsc1.settlementParticipantCurrencyId = spc1.settlementParticipantCurrencyId
                  WHERE spc1.settlementId = {id}
                  GROUP BY spcsc1.settlementParticipantCurrencyId) spcs
            JOIN **settlementParticipantCurrencyStateChange** spcsc
            ON spcsc.settlementParticipantCurrencyStateChangeId =
               spcs.maxSettlementParticipantCurrencyStateChangeId
            JOIN **participantCurrency** pc
            ON pc.participantCurrencyId = spc.participantCurrencyId
            WHERE spc.settlementId = {id}
        end hnote
        SETTLE_DAO <- - DB: Return data
        deactivate DB
        SSAPI <- - SETTLE_DAO: Return **settlementAccountsList**
        deactivate SETTLE_DAO

        SSAPI -> SETTLE_DAO: Retrive full information for settlement windows\n<color #FF0000><b>Error code:</b> 2001</color>
        activate SETTLE_DAO
        SETTLE_DAO -> DB: Select from DB
        activate DB
        hnote over DB #lightyellow
            SELECT ssw.settlementWindowId, sswsc.settlementWindowStateId, sswsc.reason, sswsc.createdDate
            FROM **settlementSettlementWindow** ssw
            JOIN (SELECT sswsc1.settlementWindowId, MAX(sswsc1.settlementWindowStateChangeId) AS
                         maxSettlementWindowStateChangeId
                  FROM **settlementSettlementWindowStateChange** sswsc1
                  WHERE sswsc1.settlementWindowId IN (
                      SELECT ssw1.settlementWindowId
                      FROM **settlementSettlementWindow** ssw1
                      WHERE ssw1.settlementId = {id})
                  GROUP BY sswsc1.settlementWindowId) ssws
            ON ssws.settlementWindowId = ssw.settlementWindowId
            JOIN **settlementSettlementWindowStateChange** sswsc
            ON sswsc.settlementWindowStateChangeId = ssws.maxSettlementWindowStateChangeId
            WHERE ssw.settlementId = {id}
        end hnote
        SETTLE_DAO <- - DB: Return data
        deactivate DB
        SSAPI <- - SETTLE_DAO: Return **windowsList**
        deactivate SETTLE_DAO

        SSAPI -> SETTLE_DAO: Retrive full information for settlement windows accounts\n<color #FF0000><b>Error code:</b> 2001</color>
        activate SETTLE_DAO
        SETTLE_DAO -> DB: Select from DB
        activate DB
        hnote over DB #lightyellow
            SELECT ssw.settlementWindowId, tp.participantCurrencyId
            FROM **settlementSettlementWindow** ssw
            JOIN **transferFulfilment** tf
            ON tf.settlementWindowId = ssw.settlementWindowId
            JOIN **transferParticipant** tp
            ON tp.transferId = tf.transferId
            WHERE settlementId = {id}
            GROUP BY ssw.settlementWindowId, tp.participantCurrencyId
        end hnote
        SETTLE_DAO <- - DB: Return data
        deactivate DB
        SSAPI <- - SETTLE_DAO: Return **windowsAccountsList**
        deactivate SETTLE_DAO

        note right of SSAPI #lightgray
            Available raw datasets from DB:
            **settlementData** contains information about settlement and its current state/reason
            **settlementAccountsList** holds information about all accounts and their current state/reason
            **windowsList** has information about all windows and their current state/reason
            **windowsAccountsList** has information about all accounts and windows

            Local variables and objects:
            **settlementAccounts**: { // (derived from <color 0000FF>settlementAccountsList</color>)
                pendingSettlementAccounts: [], // array of accounts in PENDING_SETTLEMENT state
                settledAccounts: [], // array of accounts in SETTLED state
                notSettledAccounts: [] // array of accounts in NOT_SETTLED state
            }
            **allParticipantsInit**: { // same as participants response object with initial data & key (derived from <color 0000FF>settlementAccountsList</color>)
                participantId_key: { // number used to access the object in array-like style
                    id: participantId,
                    accounts: {
                        participantCurrencyId_key: { // number used to access the object in array-like style
                            id: participantCurrencyId,
                            state: settlementStateId,
                            reason: reason,
                            createdDate: createdDate,
                            netSettlementAmount: {
                                amount: netAmount,
                                currency: currencyId
                            },
                            key: <color 0000FF>key</color> // will be used to insert new state for settlementParticipantCurrency
                        }
                    }
                }
            }
            **allAccountsInit**: { // same as previous, but without participant id
                participantCurrencyId_key: { // number used to access the object in array-like style
                    id: participantCurrencyId,
                    state: settlementStateId,
                    reason: reason,
                    createdDate: createdDate,
                    netSettlementAmount: {
                        amount: netAmount,
                        currency: currencyId
                    },
                    key: <color 0000FF>key</color> // will be used to insert new state for settlementParticipantCurrency
                }
            }
            **allWindowsInit** { // same as settlementWindows response object with initial data (derived from <color 0000FF>windowsList</color>)
                settlementWindowId_key: { // number used to access the object in array-like style
                    id: settlementWindowId, // same as key value
                    state: settlementWindowStateId, 
                    reason: reason, 
                    createdDate: createdDate
                }
            }
            **windowsAccounts**: {
                settlementWindowId_key: { // number used to access the object in array-like style
                    id: settlementWindowId // same as key value
                    pendingSettlementAccounts: [], // array of accounts in PENDING_SETTLEMENT state
                    settledAccounts: [], // array of accounts in SETTLED state
                    notSettledAccounts: [] // array of accounts in NOT_SETTLED state
                }
            }
            **accountsWindows**: {
                participantCurrencyId_key: { // number used to access the object in array-like style
                    id: participantCurrencyId, // same as key value
                    windows: [] // array of windows to which the account settlement spans
                }
            }
            let **transactionTimestamp** = now()
        end note
        |||
        SSAPI -> SSAPI: <color FF0000>Acquire DB lock</color> on settlementParticipantCurrencyStateChange,\nsettlementWindowStateChange and settlementStateChange
        note right of SSAPI #lightgray
            let settlementAccounts = {
                pendingSettlementAccounts: [],
                settledAccounts: [],
                notSettledAccounts: [],
            }
            let allParticipantsInit = {} // declare sparse array
            let allAccountsInit = {} // declare sparse array
            let pid // participantId
            let aid // accountId = participantCurrencyId
            let state
        end note
        loop settlementAccountsList as record
            note right of SSAPI #lightgray
                pid = record.participantId
                aid = record.participantCurrencyId
                state = record.settlementStateId

                allAccountsInit[aid] = {
                    id: aid,
                    state,
                    reason: record.reason,
                    createDate: record.createdDate,
                    netSettlementAmount: {
                        amount: record.netAmount,
                        currency: record.currencyId
                    },
                    key
                }
                allParticipantsInit[pid] = allParticipantsInit[pid] ? allParticipantsInit[pid] : {id: pid, accounts: {}}
                allParticipantsInit[pid].accounts[aid] = allAccountsInit[aid]
            end note
            alt state == 'PENDING_SETTLEMENT'
                note right of SSAPI #lightgray
                    settlementAccounts.pendingSettlementAccounts.push(aid)
                end note
            else state == 'SETTLED'
                note right of SSAPI #lightgray
                    settlementAccounts.settledAccounts.push(aid)
                end note
            else state == 'NOT_SETTLED'
                note right of SSAPI #lightgray
                    settlementAccounts.notSettledAccounts.push(aid)
                end note
            end
        end 
        |||
        note right of SSAPI #lightgray
            let allWindowsInit = {} // declare sparse array
            let wid // settlementWindowId
        end note
        loop windowsList as record
            note right of SSAPI #lightgray
                wid = record.settlementWindowId
                state = record.settlementWindowStateId

                allWindowsInit[wid] = {
                    id: wid,
                    state,
                    reason: record.reason,
                    createDate: record.createdDate
                }
            end note
        end 
        |||
        note right of SSAPI #lightgray
            let windowsAccounts = {} // declare sparse array
            let accountsWindows = {} // declare sparse array
        end note
        loop windowsAccountsList as record
            note right of SSAPI #lightgray
                wid = record.settlementWindowId
                aid = record.participantCurrencyId
                state = allAccountsInit[aid]

                accountsWindows[aid] = accountsWindows[aid] ? accountsWindows[aid] : {
                    id: aid,
                    windows: []
                }
                accountsWindows[aid].windows.push(wid)

                windowsAccounts[wid] = windowsAccounts[wid] ? windowsAccounts[wid] : {
                    id: wid, 
                    pendingSettlementAccounts: [],
                    settledAccounts: [],
                    notSettledAccounts: []
                }
            end note
            alt state == 'PENDING_SETTLEMENT'
                note right of SSAPI #lightgray
                    windowsAccounts[wid].pendingSettlementAccounts.push(aid)
                end note
            else state == 'SETTLED'
                note right of SSAPI #lightgray
                    windowsAccounts[wid].settledAccounts.push(aid)
                end note
            else state == 'NOT_SETTLED'
                note right of SSAPI #lightgray
                    windowsAccounts[wid].notSettledAccounts.push(aid)
                end note
            end
        end 
        |||


        |||
        |||
        |||
        SSAPI -> SSAPI: participantList = []\nsettlementParticipantCurrencyIdList = []
        loop payload.participants as participant
            SSAPI -> SSAPI: participantList.push({participantId: participant.participantId, accounts: []})
            loop participant.accounts as account
                SSAPI -> SSAPI: accountIsFound = false
                loop spcStateChangeList as record
                    alt participant.participantId == record.participantId\nand account.participantCurrencyId == record.participantCurrencyId
                        SSAPI -> SSAPI: accountIsFound = true
                        alt record.settlementStateId == 'PENDING_SETTLEMENT'
                            SSAPI -> SSAPI: settlementParticipantCurrencyIdList.push({\n    participantCurrencyId: record.settlementParticipantCurrencyId,\n    reason: 'string'\n})
                            SSAPI -> SSAPI: participantList[participantList.length-1].accounts\n.push({\n    participantCurrencyId: account.participantCurrencyId,\n    reason: 'string',\n    state: 'SETTLED',\n    netSettlementAmount: {\n        amount: record.netAmount\n        currency: record.currencyId\n    }\n})
                        else record.settlementStateId == 'SETTLED'
                            SSAPI -> SSAPI: participantList[participantList.length-1].accounts\n.push({\n    participantCurrencyId: account.participantCurrencyId,\n    errorInformation: {\n        errorCode: 'code',\n        errorDescription: 'Already settled'\n    }\n})
                        end
                        |||
                    end
                    |||
                end
                opt accountIsFound == false
                    SSAPI -> SSAPI: participantList[participantList.length-1].accounts\n.push({\n    participantCurrencyId: account.participantCurrencyId,\n    errorInformation: {\n        errorCode: 'code',\n        errorDescription: 'Account not found'\n    }\n})
                end
                |||
            end
        end
        group <color #blue>DB TRANSACTION</color>
            loop settlementParticipantCurrencyIdList as record
                SSAPI -> SETTLE_DAO: Change settlement participant currency state
                activate SETTLE_DAO
                SETTLE_DAO -> DB: Insert new state 'SETTLED' and record.reason\n<color #FF0000><b>Error code:</b> 2001</color>
                activate DB
                hnote over DB #lightyellow
                    settlementParticipantCurrencyStateChange
                end hnote
                deactivate DB
                deactivate SETTLE_DAO
            end
        end



        SSAPI -> SETTLE_DAO: Get list of all NOT_SETTELED or PENDING_SETTLEMENT\nparticipantCurrencies in settlement
        activate SETTLE_DAO
        SETTLE_DAO -> DB: Retrive list\n<color #FF0000><b>Error code:</b> 2001</color>
        activate DB
        hnote over DB #lightyellow
            SELECT spc.participantCurrencyId
            FROM **settlementParticipantCurrency** spc
            JOIN (SELECT spc.settlementParticipantCurrencyId, 
                         MAX(settlementParticipantCurrencyStateChangeId) AS
                         maxSettlementParticipantCurrencyStateChangeId
                  FROM **settlementParticipantCurrencyStateChange** spcsc
                  JOIN **settlementParticipantCurrency** spc
                  ON spc.settlementParticipantCurrencyId = spcsc.settlementParticipantCurrencyId
                  WHERE spc.settlementId = {id}) AS mx
            ON mx.settlementParticipantCurrencyId = spc.settlementParticipantCurrencyId
            JOIN **settlementParticipantCurrencyStateChange** spcsc
            ON spcsc.settlementParticipantCurrencyStateChangeId = 
               mx.maxSettlementParticipantCurrencyStateChangeId
            WHERE spc.settlementId = {id}
            AND spcsc.settlementStateId != 'SETTLED'
        end hnote
        SETTLE_DAO <- - DB: Return list
        deactivate DB
        SSAPI <- - SETTLE_DAO: Return **settlementParticipantCurrencyList**
        deactivate SETTLE_DAO

        group Settle settlementWindows
            SSAPI -> SSAPI: allWindowsList = []\nnotSettledWindowsList = []
            loop settlementWindowsParticipantCurrencyList as window
                opt window.settlementWindowId NOT IN allWindowsList
                    SSAPI -> SSAPI: allWindowsList.push(window.settlementWindowId)
                end
                loop settlementParticipantCurrencyList as pc
                    opt pc.participantCurrencyId == window.participantCurrencyId
                        SSAPI -> SSAPI: notSettledWindowsList.push(window.settlementWindowId)
                    end
                end
            end
            SSAPI -> SSAPI: settledWindowsList = _.difference(allWindowsList, notSettledWindowsList)

            group <color #blue>DB TRANSACTION</color>
                loop settledWindowsList as record
                    SSAPI -> SETTLE_DAO: Change settlement window state for record.settlementWindowId
                    activate SETTLE_DAO
                    SETTLE_DAO -> DB: Insert new state 'SETTLED'\n<color #FF0000><b>Error code:</b> 2001</color>
                    activate DB
                    hnote over DB #lightyellow
                        settlementWindowStateChange
                    end hnote
                    deactivate DB
                    deactivate SETTLE_DAO
                end
            end
        end


    else settlementStateChange IN ['NOT_SETTLED', 'SETTLED']
        |||
    end

    note left of SSAPI #lightyellow
        [
          {
            "id": 0,
            "state": <enum>,
            "createdDate": <date>,
            "settlementWindows": [
              [
                {
                  "id": 0,
                  "state": <enum>,
                  "reason": <string>,
                  "createdDate": <date>
                }
              ]
            ],
            "participants": [
              {
                "id": 0,
                "accounts": [
                  {
                    "id": 1,
                    "state": "SETTLED",
                    "reason": <string>,
                    "createdDate": <date>,
                    "netSettlementAmount": {
                      "amount": 0,
                      "currency": <enum>
                    }
                  },
                  {
                    "id": 2,
                    "state": "SETTLED",
                    "reason": <string>,
                    "createdDate": <date>,
                    "netSettlementAmount": {
                      "amount": 0,
                      "currency": <enum>
                    },
                    "errorInformation": {
                      "errorCode": 8001,
                      "errorDescription": <string>
                    }
                  }
                ]
              }
            ]
          }
        ]
    end note
    deactivate SSAPI
end
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>