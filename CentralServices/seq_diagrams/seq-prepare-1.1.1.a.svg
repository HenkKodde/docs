<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3415px" preserveAspectRatio="none" style="width:1825px;height:3415px;" version="1.1" viewBox="0 0 1825 3415" width="1825px" zoomAndPan="magnify"><defs><filter height="300%" id="f254pxis4rtks" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="366" x="730.5" y="23.5352">1.1.1.a. Prepare Handler Consume (single message)</text><rect fill="#FFFFE0" height="3370.2129" style="stroke: #A80036; stroke-width: 1.0;" width="1721" x="19" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="829" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="102" y="171.9082"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="3202.9258" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="409" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="868" y="2704.3203"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1151.5" y="3277.2129"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1284.5" y="726.1875"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1284.5" y="901.0508"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1284.5" y="1274.6875"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="183.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1284.5" y="2078.0723"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1401" y="1464.2402"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1401" y="1719.0352"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1683" y="755.498"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1683" y="930.3613"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1683" y="1303.998"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1683" y="1493.5508"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1683" y="1748.3457"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1683" y="2107.3828"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="3188.9258" style="stroke: #000000; stroke-width: 2.0;" width="1801" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="539" x="315" y="216.9082"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="519" x="325" y="241.2188"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="758" x="325" y="337.1504"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="1477.127" style="stroke: #000000; stroke-width: 2.0;" width="1509" x="295" y="508.7031"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="724.0527" style="stroke: #000000; stroke-width: 2.0;" width="1489" x="305" y="687.5664"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="542.1895" style="stroke: #000000; stroke-width: 2.0;" width="1469" x="315" y="862.4297"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="518" x="325" y="1052.6035"/><rect fill="#FFFFFF" height="88.5762" style="stroke: none; stroke-width: 1.0;" width="1469" x="315" y="1134.5352"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="244" x="325" y="1156.4902"/><rect fill="#FFFFFF" height="181.5078" style="stroke: none; stroke-width: 1.0;" width="1469" x="315" y="1223.1113"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="240.7949" style="stroke: #000000; stroke-width: 2.0;" width="1447" x="325" y="1425.6191"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="240.7949" style="stroke: #000000; stroke-width: 2.0;" width="1447" x="325" y="1680.4141"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="1315.3828" style="stroke: #000000; stroke-width: 2.0;" width="1468" x="315" y="1999.8301"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="245.1055" style="stroke: #000000; stroke-width: 2.0;" width="1448" x="325" y="2024.1406"/><rect fill="#FFFFFF" height="572.8926" style="stroke: none; stroke-width: 1.0;" width="1468" x="315" y="2742.3203"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="107" x2="107" y1="116.2871" y2="3339.2129"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="414" x2="414" y1="116.2871" y2="3339.2129"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="873" x2="873" y1="116.2871" y2="3339.2129"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1020" x2="1020" y1="116.2871" y2="3339.2129"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1156" x2="1156" y1="116.2871" y2="3339.2129"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1289" x2="1289" y1="116.2871" y2="3339.2129"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1406" x2="1406" y1="116.2871" y2="3339.2129"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1688" x2="1688" y1="116.2871" y2="3339.2129"/><rect fill="#FEFECE" filter="url(#f254pxis4rtks)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="160" x="27" y="76.7988"/><rect fill="#FEFECE" filter="url(#f254pxis4rtks)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="160" x="23" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="146" x="30" y="101.334">Prepare-Topic-dfsp1</text><rect fill="#FEFECE" filter="url(#f254pxis4rtks)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="160" x="27" y="3338.2129"/><rect fill="#FEFECE" filter="url(#f254pxis4rtks)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="160" x="23" y="3342.2129"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="146" x="30" y="3362.748">Prepare-Topic-dfsp1</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="335" y="113.334">Prepare Event Handler</text><ellipse cx="414" cy="83.7988" fill="#FEFECE" filter="url(#f254pxis4rtks)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="410,71.7988,416,66.7988,414,71.7988,416,76.7988,410,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="335" y="3351.748">Prepare Event Handler</text><ellipse cx="414" cy="3370.7012" fill="#FEFECE" filter="url(#f254pxis4rtks)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="410,3358.7012,416,3353.7012,414,3358.7012,416,3363.7012,410,3358.7012" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f254pxis4rtks)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="792" y="76.7988"/><rect fill="#FEFECE" filter="url(#f254pxis4rtks)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="788" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="795" y="101.334">Position-Topic-dfsp1</text><rect fill="#FEFECE" filter="url(#f254pxis4rtks)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="792" y="3338.2129"/><rect fill="#FEFECE" filter="url(#f254pxis4rtks)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="788" y="3342.2129"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="795" y="3362.748">Position-Topic-dfsp1</text><rect fill="#FEFECE" filter="url(#f254pxis4rtks)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="972" y="76.7988"/><rect fill="#FEFECE" filter="url(#f254pxis4rtks)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="968" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="975" y="101.334">Event-Topic</text><rect fill="#FEFECE" filter="url(#f254pxis4rtks)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="972" y="3338.2129"/><rect fill="#FEFECE" filter="url(#f254pxis4rtks)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="968" y="3342.2129"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="975" y="3362.748">Event-Topic</text><rect fill="#FEFECE" filter="url(#f254pxis4rtks)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1087" y="76.7988"/><rect fill="#FEFECE" filter="url(#f254pxis4rtks)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1083" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1090" y="101.334">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f254pxis4rtks)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1087" y="3338.2129"/><rect fill="#FEFECE" filter="url(#f254pxis4rtks)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1083" y="3342.2129"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1090" y="3362.748">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1240" y="113.334">Transfer DAO</text><ellipse cx="1289.5" cy="83.7988" fill="#FEFECE" filter="url(#f254pxis4rtks)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1277.5" x2="1301.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1240" y="3351.748">Transfer DAO</text><ellipse cx="1289.5" cy="3370.7012" fill="#FEFECE" filter="url(#f254pxis4rtks)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1277.5" x2="1301.5" y1="3384.7012" y2="3384.7012"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="1349" y="113.334">Participant DAO</text><ellipse cx="1406" cy="83.7988" fill="#FEFECE" filter="url(#f254pxis4rtks)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1394" x2="1418" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="1349" y="3351.748">Participant DAO</text><ellipse cx="1406" cy="3370.7012" fill="#FEFECE" filter="url(#f254pxis4rtks)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1394" x2="1418" y1="3384.7012" y2="3384.7012"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1640" y="113.334">Central Store</text><path d="M1670,63.7988 C1670,53.7988 1688,53.7988 1688,53.7988 C1688,53.7988 1706,53.7988 1706,63.7988 L1706,89.7988 C1706,99.7988 1688,99.7988 1688,99.7988 C1688,99.7988 1670,99.7988 1670,89.7988 L1670,63.7988 " fill="#FEFECE" filter="url(#f254pxis4rtks)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1670,63.7988 C1670,73.7988 1688,73.7988 1688,73.7988 C1688,73.7988 1706,73.7988 1706,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1640" y="3351.748">Central Store</text><path d="M1670,3364.7012 C1670,3354.7012 1688,3354.7012 1688,3354.7012 C1688,3354.7012 1706,3354.7012 1706,3364.7012 L1706,3390.7012 C1706,3400.7012 1688,3400.7012 1688,3400.7012 C1688,3400.7012 1670,3400.7012 1670,3390.7012 L1670,3364.7012 " fill="#FEFECE" filter="url(#f254pxis4rtks)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1670,3364.7012 C1670,3374.7012 1688,3374.7012 1688,3374.7012 C1688,3374.7012 1706,3374.7012 1706,3364.7012 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="102" y="171.9082"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="3202.9258" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="409" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="868" y="2704.3203"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1151.5" y="3277.2129"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1284.5" y="726.1875"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1284.5" y="901.0508"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1284.5" y="1274.6875"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="183.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1284.5" y="2078.0723"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1401" y="1464.2402"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1401" y="1719.0352"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1683" y="755.498"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1683" y="930.3613"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1683" y="1303.998"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1683" y="1493.5508"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1683" y="1748.3457"/><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1683" y="2107.3828"/><path d="M13,133.2871 L236,133.2871 L236,140.2871 L226,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3188.9258" style="stroke: #000000; stroke-width: 2.0;" width="1801" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="28" y="146.8555">Prepare Handler Consume</text><polygon fill="#A80036" points="123,167.9082,113,171.9082,123,175.9082,119,171.9082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="117" x2="408" y1="171.9082" y2="171.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="129" y="167.166">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="142" y="167.166">Consume Prepare event message for Payer</text><path d="M315,216.9082 L399,216.9082 L399,223.9082 L389,233.9082 L315,233.9082 L315,216.9082 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="539" x="315" y="216.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="330" y="230.4766">break</text><path d="M325,241.2188 L467,241.2188 L467,248.2188 L457,258.2188 L325,258.2188 L325,241.2188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="519" x="325" y="241.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="340" y="254.7871">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="461" y1="295.1504" y2="295.1504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="461" x2="461" y1="295.1504" y2="308.1504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="461" y1="308.1504" y2="308.1504"/><polygon fill="#A80036" points="430,304.1504,420,308.1504,430,312.1504,426,308.1504" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="426" y="282.7529">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="393" x="439" y="275.0977">Validate event - Rule: type == 'prepare' &amp;&amp; action == 'prepare'</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="439" y="290.4082">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="523" y="290.4082">2001</text><path d="M325,337.1504 L540,337.1504 L540,344.1504 L530,354.1504 L325,354.1504 L325,337.1504 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="758" x="325" y="337.1504"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="340" y="350.7188">Persist Event Information</text><polygon fill="#A80036" points="1008.5,396.7715,1018.5,400.7715,1008.5,404.7715,1012.5,400.7715" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1014.5" y1="400.7715" y2="400.7715"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="426" y="396.0293">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="439" y="396.0293">Publish event information</text><rect fill="#FFFFFF" filter="url(#f254pxis4rtks)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="740" x="332" y="408.7715"/><polygon fill="#EEEEEE" points="332,408.7715,396,408.7715,396,415.7715,386,425.7715,332,425.7715,332,408.7715" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="345" y="423.3398">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="603" y="442.3398">Event Handler Consume {9.1.0.}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="607" y="457.6504"/><path d="M295,508.7031 L514,508.7031 L514,515.7031 L504,525.7031 L295,525.7031 L295,508.7031 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1477.127" style="stroke: #000000; stroke-width: 2.0;" width="1509" x="295" y="508.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="174" x="310" y="522.2715">Validate Prepare Transfer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="461" y1="547.3242" y2="547.3242"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="461" x2="461" y1="547.3242" y2="560.3242"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="461" y1="560.3242" y2="560.3242"/><polygon fill="#A80036" points="430,556.3242,420,560.3242,430,564.3242,426,560.3242" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="426" y="542.582">4</text><text fill="#AAAAAA" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="439" y="542.582">Validate incoming message against ML schema</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="461" y1="589.6348" y2="589.6348"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="461" x2="461" y1="589.6348" y2="602.6348"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="461" y1="602.6348" y2="602.6348"/><polygon fill="#A80036" points="430,598.6348,420,602.6348,430,606.6348,426,602.6348" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="426" y="584.8926">5</text><text fill="#AAAAAA" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="422" x="439" y="584.8926">Validate message signature (to be confirmed in future requirement)</text><path d="M424,615.6348 L424,670.6348 L789,670.6348 L789,625.6348 L779,615.6348 L424,615.6348 " fill="#D3D3D3" filter="url(#f254pxis4rtks)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M779,615.6348 L779,625.6348 L789,625.6348 L779,615.6348 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="313" x="430" y="633.2031">The above validation steps are already handled by</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="430" y="648.5137">the ML-Adapter for the open source implementation.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="344" x="430" y="663.8242">It may need to be added in future for custom adapters.</text><path d="M305,687.5664 L516,687.5664 L516,694.5664 L506,704.5664 L305,704.5664 L305,687.5664 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="724.0527" style="stroke: #000000; stroke-width: 2.0;" width="1489" x="305" y="687.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="166" x="320" y="701.1348">Validate Duplicate check</text><polygon fill="#A80036" points="1272.5,722.1875,1282.5,726.1875,1272.5,730.1875,1276.5,726.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1278.5" y1="726.1875" y2="726.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="426" y="721.4453">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="343" x="439" y="721.4453">Request to retrieve Transfer message hash (if it exists)</text><polygon fill="#A80036" points="1671,751.498,1681,755.498,1671,759.498,1675,755.498" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1294.5" x2="1677" y1="755.498" y2="755.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1301.5" y="750.7559">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="1314.5" y="750.7559">Request Transfer message hash</text><polygon fill="#FFFFE0" filter="url(#f254pxis4rtks)" points="1612,768.498,1764,768.498,1774,779.498,1764,791.498,1612,791.498,1602,779.498,1612,768.498" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="1614" y="785.0664">transferDuplicateCheck</text><polygon fill="#A80036" points="1305.5,814.1191,1295.5,818.1191,1305.5,822.1191,1301.5,818.1191" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1299.5" x2="1687" y1="818.1191" y2="818.1191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1311.5" y="813.377">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="1324.5" y="813.377">Return hash if it exists</text><polygon fill="#A80036" points="430,843.4297,420,847.4297,430,851.4297,426,847.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="424" x2="1288.5" y1="847.4297" y2="847.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="436" y="842.6875">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="449" y="842.6875">Return transfer message hash if it exists</text><path d="M315,862.4297 L377,862.4297 L377,869.4297 L367,879.4297 L315,879.4297 L315,862.4297 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="542.1895" style="stroke: #000000; stroke-width: 2.0;" width="1469" x="315" y="862.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="330" y="875.998">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="175" x="392" y="875.0645">[Transfer exists, hash matches]</text><polygon fill="#A80036" points="1272.5,897.0508,1282.5,901.0508,1272.5,905.0508,1276.5,901.0508" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1278.5" y1="901.0508" y2="901.0508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="896.3086">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="448" y="896.3086">Request to retrieve Transfer state</text><polygon fill="#A80036" points="1671,926.3613,1681,930.3613,1671,934.3613,1675,930.3613" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1294.5" x2="1677" y1="930.3613" y2="930.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1301.5" y="925.6191">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="1323.5" y="925.6191">Request Transfer state</text><polygon fill="#FFFFE0" filter="url(#f254pxis4rtks)" points="1622,943.3613,1753,943.3613,1763,962.3613,1753,981.3613,1622,981.3613,1612,962.3613,1622,943.3613" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1624" y="959.9297">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1624" y="975.2402">transferStateChange</text><polygon fill="#A80036" points="1305.5,1004.293,1295.5,1008.293,1305.5,1012.293,1301.5,1008.293" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1299.5" x2="1687" y1="1008.293" y2="1008.293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1311.5" y="1003.5508">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="1333.5" y="1003.5508">Return Transfer state</text><polygon fill="#A80036" points="430,1033.6035,420,1037.6035,430,1041.6035,426,1037.6035" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="424" x2="1288.5" y1="1037.6035" y2="1037.6035"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="436" y="1032.8613">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="458" y="1032.8613">Return Transfer state</text><path d="M325,1052.6035 L409,1052.6035 L409,1059.6035 L399,1069.6035 L325,1069.6035 L325,1052.6035 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="518" x="325" y="1052.6035"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="340" y="1066.1719">break</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="461" y1="1106.5352" y2="1106.5352"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="461" x2="461" y1="1106.5352" y2="1119.5352"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="461" y1="1119.5352" y2="1119.5352"/><polygon fill="#A80036" points="430,1115.5352,420,1119.5352,430,1123.5352,426,1119.5352" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="1094.1377">14</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="102" x="448" y="1086.4824">Error handling:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="554" y="1086.4824">If transferState is ['COMMITTED', 'ABORTED']</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="339" x="448" y="1101.793">then send notification to Payer with complete transfer</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="315" x2="1784" y1="1135.5352" y2="1135.5352"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="215" x="320" y="1146.1699">[Transfer exists, hash does not match]</text><path d="M325,1156.4902 L409,1156.4902 L409,1163.4902 L399,1173.4902 L325,1173.4902 L325,1156.4902 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="244" x="325" y="1156.4902"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="340" y="1170.0586">break</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="461" y1="1195.1113" y2="1195.1113"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="461" x2="461" y1="1195.1113" y2="1208.1113"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="461" y1="1208.1113" y2="1208.1113"/><polygon fill="#A80036" points="430,1204.1113,420,1208.1113,430,1212.1113,426,1208.1113" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="1190.3691">15</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="448" y="1190.3691">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="525" y="1190.3691">3100</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="315" x2="1784" y1="1224.1113" y2="1224.1113"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="168" x="320" y="1234.7461">[Transfer hash does not exist]</text><polygon fill="#A80036" points="1272.5,1270.6875,1282.5,1274.6875,1272.5,1278.6875,1276.5,1274.6875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1278.5" y1="1274.6875" y2="1274.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="1262.29">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="448" y="1254.6348">Request to persist transfer hash</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="448" y="1269.9453">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="532" y="1269.9453">2003</text><polygon fill="#A80036" points="1671,1299.998,1681,1303.998,1671,1307.998,1675,1303.998" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1294.5" x2="1677" y1="1303.998" y2="1303.998"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1301.5" y="1299.2559">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="76" x="1323.5" y="1299.2559">Persist hash</text><polygon fill="#FFFFE0" filter="url(#f254pxis4rtks)" points="1612,1346.998,1764,1346.998,1774,1357.998,1764,1369.998,1612,1369.998,1602,1357.998,1612,1346.998" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="1614" y="1363.5664">transferDuplicateCheck</text><polygon fill="#A80036" points="430,1392.6191,420,1396.6191,430,1400.6191,426,1396.6191" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="424" x2="1288.5" y1="1396.6191" y2="1396.6191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="436" y="1391.877">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="458" y="1391.877">Return success</text><path d="M325,1425.6191 L467,1425.6191 L467,1432.6191 L457,1442.6191 L325,1442.6191 L325,1425.6191 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="240.7949" style="stroke: #000000; stroke-width: 2.0;" width="1447" x="325" y="1425.6191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="340" y="1439.1875">Validate Payer</text><polygon fill="#A80036" points="1389,1460.2402,1399,1464.2402,1389,1468.2402,1393,1464.2402" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1395" y1="1464.2402" y2="1464.2402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="1459.498">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="348" x="448" y="1459.498">Request to retrieve Payer Participant details (if it exists)</text><polygon fill="#A80036" points="1671,1489.5508,1681,1493.5508,1671,1497.5508,1675,1493.5508" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1411" x2="1677" y1="1493.5508" y2="1493.5508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1418" y="1488.8086">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="1440" y="1488.8086">Request Participant details</text><polygon fill="#FFFFE0" filter="url(#f254pxis4rtks)" points="1624,1506.5508,1752,1506.5508,1762,1525.5508,1752,1544.5508,1624,1544.5508,1614,1525.5508,1624,1506.5508" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="1626" y="1523.1191">participant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="1626" y="1538.4297">participantCurrency</text><polygon fill="#A80036" points="1422,1567.4824,1412,1571.4824,1422,1575.4824,1418,1571.4824" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1416" x2="1687" y1="1571.4824" y2="1571.4824"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1428" y="1566.7402">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="1450" y="1566.7402">Return Participant details if it exists</text><polygon fill="#A80036" points="430,1596.793,420,1600.793,430,1604.793,426,1600.793" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="424" x2="1405" y1="1600.793" y2="1600.793"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="436" y="1596.0508">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="458" y="1596.0508">Return Participant details if it exists</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="461" y1="1645.4141" y2="1645.4141"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="461" x2="461" y1="1645.4141" y2="1658.4141"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="461" y1="1658.4141" y2="1658.4141"/><polygon fill="#A80036" points="430,1654.4141,420,1658.4141,430,1662.4141,426,1658.4141" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="1633.0166">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="448" y="1625.3613">Validate Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="448" y="1640.6719">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="532" y="1640.6719">3202</text><path d="M325,1680.4141 L469,1680.4141 L469,1687.4141 L459,1697.4141 L325,1697.4141 L325,1680.4141 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="240.7949" style="stroke: #000000; stroke-width: 2.0;" width="1447" x="325" y="1680.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="99" x="340" y="1693.9824">Validate Payee</text><polygon fill="#A80036" points="1389,1715.0352,1399,1719.0352,1389,1723.0352,1393,1719.0352" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1395" y1="1719.0352" y2="1719.0352"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="1714.293">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="350" x="448" y="1714.293">Request to retrieve Payee Participant details (if it exists)</text><polygon fill="#A80036" points="1671,1744.3457,1681,1748.3457,1671,1752.3457,1675,1748.3457" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1411" x2="1677" y1="1748.3457" y2="1748.3457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1418" y="1743.6035">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="1440" y="1743.6035">Request Participant details</text><polygon fill="#FFFFE0" filter="url(#f254pxis4rtks)" points="1624,1761.3457,1752,1761.3457,1762,1780.3457,1752,1799.3457,1624,1799.3457,1614,1780.3457,1624,1761.3457" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="1626" y="1777.9141">participant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="1626" y="1793.2246">participantCurrency</text><polygon fill="#A80036" points="1422,1822.2773,1412,1826.2773,1422,1830.2773,1418,1826.2773" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1416" x2="1687" y1="1826.2773" y2="1826.2773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1428" y="1821.5352">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="1450" y="1821.5352">Return Participant details if it exists</text><polygon fill="#A80036" points="430,1851.5879,420,1855.5879,430,1859.5879,426,1855.5879" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="424" x2="1405" y1="1855.5879" y2="1855.5879"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="436" y="1850.8457">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="458" y="1850.8457">Return Participant details if it exists</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="461" y1="1900.209" y2="1900.209"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="461" x2="461" y1="1900.209" y2="1913.209"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="461" y1="1913.209" y2="1913.209"/><polygon fill="#A80036" points="430,1909.209,420,1913.209,430,1917.209,426,1913.209" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="1887.8115">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="448" y="1880.1563">Validate Payee</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="448" y="1895.4668">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="532" y="1895.4668">3203</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="461" y1="1964.8301" y2="1964.8301"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="461" x2="461" y1="1964.8301" y2="1977.8301"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="461" y1="1977.8301" y2="1977.8301"/><polygon fill="#A80036" points="430,1973.8301,420,1977.8301,430,1981.8301,426,1977.8301" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="1952.4326">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="448" y="1944.7773">Validate crypto-condition</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="448" y="1960.0879">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="532" y="1960.0879">3100</text><path d="M315,1999.8301 L377,1999.8301 L377,2006.8301 L367,2016.8301 L315,2016.8301 L315,1999.8301 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1315.3828" style="stroke: #000000; stroke-width: 2.0;" width="1468" x="315" y="1999.8301"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="330" y="2013.3984">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="206" x="392" y="2012.4648">[Validate Prepare Transfer (success)]</text><path d="M325,2024.1406 L797,2024.1406 L797,2031.1406 L787,2041.1406 L325,2041.1406 L325,2024.1406 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="245.1055" style="stroke: #000000; stroke-width: 2.0;" width="1448" x="325" y="2024.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="427" x="340" y="2037.709">Persist Transfer State (with transferState='RECEIVED-PREPARE')</text><polygon fill="#A80036" points="1272.5,2074.0723,1282.5,2078.0723,1272.5,2082.0723,1276.5,2078.0723" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1278.5" y1="2078.0723" y2="2078.0723"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="2065.6748">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="448" y="2058.0195">Request to persist transfer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="448" y="2073.3301">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="532" y="2073.3301">2003</text><polygon fill="#A80036" points="1671,2103.3828,1681,2107.3828,1671,2111.3828,1675,2107.3828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1294.5" x2="1677" y1="2107.3828" y2="2107.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1301.5" y="2102.6406">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="1323.5" y="2102.6406">Persist transfer</text><polygon fill="#FFFFE0" filter="url(#f254pxis4rtks)" points="1622,2150.3828,1753,2150.3828,1763,2192.3828,1753,2234.3828,1622,2234.3828,1612,2192.3828,1622,2150.3828" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1624" y="2166.9512">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1624" y="2182.2617">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1624" y="2197.5723">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="1624" y="2212.8828">transferExtension</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="57" x="1624" y="2228.1934">ilpPacket</text><polygon fill="#A80036" points="430,2257.2461,420,2261.2461,430,2265.2461,426,2261.2461" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="424" x2="1288.5" y1="2261.2461" y2="2261.2461"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="436" y="2256.5039">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="458" y="2256.5039">Return success</text><path d="M424,2281.2461 L424,2658.2461 L686,2658.2461 L686,2291.2461 L676,2281.2461 L424,2281.2461 " fill="#FFFF00" filter="url(#f254pxis4rtks)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M676,2281.2461 L676,2291.2461 L686,2291.2461 L676,2281.2461 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="430" y="2298.8145">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="430" y="2314.125">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="446" y="2329.4355">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="446" y="2344.7461">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="446" y="2360.0566">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="446" y="2375.3672">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="446" y="2390.6777">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="462" y="2405.9883">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="462" y="2421.2988">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="446" y="2436.6094">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="446" y="2451.9199">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="462" y="2467.2305">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="478" y="2482.541">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="478" y="2497.8516">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="478" y="2513.1621">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="478" y="2528.4727">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="478" y="2543.7832">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="478" y="2559.0938">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="494" y="2574.4043">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="494" y="2589.7148">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="478" y="2605.0254">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="462" y="2620.3359">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="446" y="2635.6465">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="430" y="2650.957">}</text><polygon fill="#A80036" points="856,2700.3203,866,2704.3203,856,2708.3203,860,2704.3203" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="862" y1="2704.3203" y2="2704.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="2691.9229">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="448" y="2684.2676">Route &amp; Publish Position event for Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="448" y="2699.5781">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="532" y="2699.5781">2003</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="315" x2="1783" y1="2743.3203" y2="2743.3203"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="200" x="320" y="2753.9551">[Validate Prepare Transfer (failure)]</text><path d="M424,2762.2754 L424,3231.2754 L1031,3231.2754 L1031,2772.2754 L1021,2762.2754 L424,2762.2754 " fill="#FFFF00" filter="url(#f254pxis4rtks)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1021,2762.2754 L1021,2772.2754 L1031,2772.2754 L1021,2762.2754 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="430" y="2779.8438">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="430" y="2795.1543">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="446" y="2810.4648">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="446" y="2825.7754">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="446" y="2841.0859">to: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="446" y="2856.3965">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="446" y="2871.707">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="462" y="2887.0176">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="462" y="2902.3281">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="478" y="2917.6387">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="522" x="494" y="2932.9492">"errorCode": &lt;possible codes: [2003, 3100, 3105, 3106, 3202, 3203, 3300, 3301]&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="392" x="494" y="2948.2598">"errorDescription": "&lt;refer to section 35.1.3 for description&gt;",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="494" y="2963.5703">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="462" y="2978.8809">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="446" y="2994.1914">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="446" y="3009.502">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="462" y="3024.8125">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="478" y="3040.123">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="478" y="3055.4336">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="478" y="3070.7441">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="478" y="3086.0547">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="478" y="3101.3652">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="478" y="3116.6758">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="494" y="3131.9863">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="494" y="3147.2969">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="494" y="3162.6074">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="478" y="3177.918">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="462" y="3193.2285">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="446" y="3208.5391">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="430" y="3223.8496">}</text><polygon fill="#A80036" points="1139.5,3273.2129,1149.5,3277.2129,1139.5,3281.2129,1143.5,3277.2129" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1145.5" y1="3277.2129" y2="3277.2129"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="3264.8154">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="448" y="3257.1602">Publish Notification (failure) event for Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="448" y="3272.4707">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="532" y="3272.4707">2003</text><!--
@startuml
title 1.1.1.a. Prepare Handler Consume (single message)

autonumber


collections "Prepare-Topic-dfsp1" as TOPIC_PREPARE_DFSP1
control "Prepare Event Handler" as PREP_HANDLER
collections "Position-Topic-dfsp1" as TOPIC_POSITION_DFSP1
collections "Event-Topic" as TOPIC_EVENTS
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Transfer DAO" as TRANS_DAO
entity "Participant DAO" as PARTICIPANT_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TOPIC_PREPARE_DFSP1
    participant PREP_HANDLER
    participant TOPIC_POSITION_DFSP1
    participant TOPIC_EVENTS
    participant TOPIC_NOTIFICATIONS
    participant TRANS_DAO
    participant PARTICIPANT_DAO
    participant DB
end box

activate PREP_HANDLER
group Prepare Handler Consume
    TOPIC_PREPARE_DFSP1 <- PREP_HANDLER: Consume Prepare event message for Payer
    activate TOPIC_PREPARE_DFSP1
    deactivate TOPIC_PREPARE_DFSP1

    break
        group Validate Event
            PREP_HANDLER <-> PREP_HANDLER: Validate event - Rule: type == 'prepare' && action == 'prepare'\n<color #FF0000><b>Error codes:</b> 2001</color>
        end
    end

    group Persist Event Information
        |||
        PREP_HANDLER -> TOPIC_EVENTS: Publish event information
        ref over PREP_HANDLER, TOPIC_EVENTS :  Event Handler Consume {9.1.0.} \n
        |||
    end

    group Validate Prepare Transfer
        PREP_HANDLER <-> PREP_HANDLER: <color #AAA>Validate incoming message against ML schema</color>
        PREP_HANDLER <-> PREP_HANDLER: <color #AAA>Validate message signature (to be confirmed in future requirement)</color>
        note right of PREP_HANDLER #lightgrey
            The above validation steps are already handled by
            the ML-Adapter for the open source implementation.
            It may need to be added in future for custom adapters.
        end note
        group Validate Duplicate check
            PREP_HANDLER -> TRANS_DAO: Request to retrieve Transfer message hash (if it exists)
            activate TRANS_DAO
            TRANS_DAO -> DB: Request Transfer message hash
            hnote over DB #lightyellow
                transferDuplicateCheck
            end note
            activate DB
            TRANS_DAO <- - DB: Return hash if it exists 
            deactivate DB
            TRANS_DAO - -> PREP_HANDLER: Return transfer message hash if it exists
            deactivate TRANS_DAO
            alt Transfer exists, hash matches
                PREP_HANDLER -> TRANS_DAO: Request to retrieve Transfer state
                activate TRANS_DAO
                TRANS_DAO -> DB: Request Transfer state
                hnote over DB #lightyellow
                    transfer
                    transferStateChange
                end note
                activate DB
                TRANS_DAO <- - DB: Return Transfer state
                deactivate DB
                TRANS_DAO - -> PREP_HANDLER: Return Transfer state
                deactivate TRANS_DAO
                break
                    PREP_HANDLER <-> PREP_HANDLER: <color #FF0000><b>Error handling:</b></color> If transferState is ['COMMITTED', 'ABORTED']\nthen send notification to Payer with complete transfer
                end
            else Transfer exists, hash does not match
                break
                    PREP_HANDLER <-> PREP_HANDLER: <color #FF0000><b>Error code:</b> 3100</color>
                end
            else Transfer hash does not exist
                PREP_HANDLER -> TRANS_DAO: Request to persist transfer hash\n<color #FF0000><b>Error codes:</b> 2003</color>
                activate TRANS_DAO
                TRANS_DAO -> DB: Persist hash
                hnote over DB #lightyellow
                    transferDuplicateCheck
                end note
                activate DB
                deactivate DB
                TRANS_DAO - -> PREP_HANDLER: Return success
                deactivate TRANS_DAO 
            end
        end
        group Validate Payer
            PREP_HANDLER -> PARTICIPANT_DAO: Request to retrieve Payer Participant details (if it exists)
            activate PARTICIPANT_DAO
            PARTICIPANT_DAO -> DB: Request Participant details
            hnote over DB #lightyellow
                participant
                participantCurrency
            end note
            activate DB
            PARTICIPANT_DAO <- - DB: Return Participant details if it exists
            deactivate DB
            PARTICIPANT_DAO - -> PREP_HANDLER: Return Participant details if it exists
            deactivate PARTICIPANT_DAO
            PREP_HANDLER <-> PREP_HANDLER: Validate Payer\n<color #FF0000><b>Error codes:</b> 3202</color>
        end
        group Validate Payee
            PREP_HANDLER -> PARTICIPANT_DAO: Request to retrieve Payee Participant details (if it exists)
            activate PARTICIPANT_DAO
            PARTICIPANT_DAO -> DB: Request Participant details
            hnote over DB #lightyellow
                participant
                participantCurrency
            end note
            activate DB
            PARTICIPANT_DAO <- - DB: Return Participant details if it exists
            deactivate DB
            PARTICIPANT_DAO - -> PREP_HANDLER: Return Participant details if it exists
            deactivate PARTICIPANT_DAO
            PREP_HANDLER <-> PREP_HANDLER: Validate Payee\n<color #FF0000><b>Error codes:</b> 3203</color>
        end
        PREP_HANDLER <-> PREP_HANDLER: Validate crypto-condition\n<color #FF0000><b>Error codes:</b> 3100</color>
    end
    alt Validate Prepare Transfer (success)
        group Persist Transfer State (with transferState='RECEIVED-PREPARE')
            PREP_HANDLER -> TRANS_DAO: Request to persist transfer\n<color #FF0000><b>Error codes:</b> 2003</color>
            activate TRANS_DAO
            TRANS_DAO -> DB: Persist transfer
            hnote over DB #lightyellow
                transfer
                transferParticipant
                transferStateChange
                transferExtension
                ilpPacket
            end note
            activate DB
            deactivate DB
            TRANS_DAO - -> PREP_HANDLER: Return success
            deactivate TRANS_DAO
        end

        note right of PREP_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: position,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        PREP_HANDLER -> TOPIC_POSITION_DFSP1: Route & Publish Position event for Payer\n<color #FF0000><b>Error codes:</b> 2003</color>
        activate TOPIC_POSITION_DFSP1
        deactivate TOPIC_POSITION_DFSP1
    else Validate Prepare Transfer (failure)
        note right of PREP_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <ledgerName>,
                to: <transferMessage.payerFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                        "errorInformation": {
                            "errorCode": <possible codes: [2003, 3100, 3105, 3106, 3202, 3203, 3300, 3301]>
                            "errorDescription": "<refer to section 35.1.3 for description>",
                            "extensionList": <transferMessage.extensionList>
                    }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: notification,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
        PREP_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification (failure) event for Payer\n<color #FF0000><b>Error codes:</b> 2003</color>
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS
    end
end
deactivate PREP_HANDLER
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.5
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>