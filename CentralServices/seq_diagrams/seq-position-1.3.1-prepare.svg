<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3505px" preserveAspectRatio="none" style="width:2124px;height:3505px;" version="1.1" viewBox="0 0 2124 3505" width="2124px" zoomAndPan="magnify"><defs><filter height="300%" id="f12omzljt8o3p5" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="290" x="918" y="23.5352">1.3.1 Prepare Position Handler Consume</text><rect fill="#FFFFE0" height="3459.8457" style="stroke: #A80036; stroke-width: 1.0;" width="1848" x="39" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="912.5" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="3232.6055" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="97.5" y="145.2637"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="658.5" y="2483.1816"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="805" y="3347.8691"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="398.9688" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="936" y="1641.1387"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="464.5898" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1041.5" y="429.6797"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="167.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1412.5" y="938.8906"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1529" y="206.1953"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="176.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1529" y="2636.3789"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1830" y="235.5059"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1830" y="629.7852"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1830" y="779.3379"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1830" y="968.2012"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1830" y="1694.7598"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1830" y="1818.002"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1830" y="2720.3105"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="3240.6055" style="stroke: #000000; stroke-width: 2.0;" width="2100" x="13" y="152.2637"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="274.7949" style="stroke: #000000; stroke-width: 2.0;" width="1004.5" x="988.5" y="591.1641"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="1853.5938" style="stroke: #000000; stroke-width: 2.0;" width="2080" x="23" y="1532.2754"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="491.5215" style="stroke: #000000; stroke-width: 2.0;" width="2060" x="33" y="1556.5859"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="355.6582" style="stroke: #000000; stroke-width: 2.0;" width="1199.5" x="883.5" y="1656.1387"/><rect fill="#FFFFFF" height="864.6875" style="stroke: none; stroke-width: 1.0;" width="2080" x="23" y="2521.1816"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="238.4844" style="stroke: #000000; stroke-width: 2.0;" width="1887" x="33" y="2582.4473"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="102" x2="102" y1="135.2637" y2="3409.8691"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="663.5" x2="663.5" y1="135.2637" y2="3409.8691"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="809.5" x2="809.5" y1="135.2637" y2="3409.8691"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="940.5" x2="940.5" y1="135.2637" y2="3409.8691"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1046.5" x2="1046.5" y1="135.2637" y2="3409.8691"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1417.5" x2="1417.5" y1="135.2637" y2="3409.8691"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1533.5" x2="1533.5" y1="135.2637" y2="3409.8691"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1835" x2="1835" y1="135.2637" y2="3409.8691"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="43" y="132.3105">Position Handler</text><ellipse cx="102.5" cy="102.7754" fill="#FEFECE" filter="url(#f12omzljt8o3p5)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="98.5,90.7754,104.5,85.7754,102.5,90.7754,104.5,95.7754,98.5,90.7754" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="43" y="3422.4043">Position Handler</text><ellipse cx="102.5" cy="3441.3574" fill="#FEFECE" filter="url(#f12omzljt8o3p5)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="98.5,3429.3574,104.5,3424.3574,102.5,3429.3574,104.5,3434.3574,98.5,3429.3574" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f12omzljt8o3p5)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="604.5" y="95.7754"/><rect fill="#FEFECE" filter="url(#f12omzljt8o3p5)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="600.5" y="99.7754"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="607.5" y="120.3105">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#f12omzljt8o3p5)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="604.5" y="3408.8691"/><rect fill="#FEFECE" filter="url(#f12omzljt8o3p5)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="600.5" y="3412.8691"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="607.5" y="3433.4043">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#f12omzljt8o3p5)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="740.5" y="95.7754"/><rect fill="#FEFECE" filter="url(#f12omzljt8o3p5)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="736.5" y="99.7754"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="743.5" y="120.3105">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f12omzljt8o3p5)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="740.5" y="3408.8691"/><rect fill="#FEFECE" filter="url(#f12omzljt8o3p5)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="736.5" y="3412.8691"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="743.5" y="3433.4043">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55" x="910.5" y="99.334">Position</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="89" x="893.5" y="115.8223">Management</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="48" x="914" y="132.3105">Facade</text><ellipse cx="941" cy="69.7988" fill="#FEFECE" filter="url(#f12omzljt8o3p5)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="929" x2="953" y1="83.7988" y2="83.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55" x="910.5" y="3422.4043">Position</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="89" x="893.5" y="3438.8926">Management</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="48" x="914" y="3455.3809">Facade</text><ellipse cx="941" cy="3474.334" fill="#FEFECE" filter="url(#f12omzljt8o3p5)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="929" x2="953" y1="3488.334" y2="3488.334"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="998.5" y="132.3105">Position DAO</text><ellipse cx="1046.5" cy="102.7754" fill="#FEFECE" filter="url(#f12omzljt8o3p5)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1034.5" x2="1058.5" y1="116.7754" y2="116.7754"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="998.5" y="3422.4043">Position DAO</text><ellipse cx="1046.5" cy="3441.3574" fill="#FEFECE" filter="url(#f12omzljt8o3p5)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1034.5" x2="1058.5" y1="3455.3574" y2="3455.3574"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="1360.5" y="132.3105">Participant DAO</text><ellipse cx="1417.5" cy="102.7754" fill="#FEFECE" filter="url(#f12omzljt8o3p5)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1405.5" x2="1429.5" y1="116.7754" y2="116.7754"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="1360.5" y="3422.4043">Participant DAO</text><ellipse cx="1417.5" cy="3441.3574" fill="#FEFECE" filter="url(#f12omzljt8o3p5)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1405.5" x2="1429.5" y1="3455.3574" y2="3455.3574"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1484.5" y="132.3105">Transfer DAO</text><ellipse cx="1534" cy="102.7754" fill="#FEFECE" filter="url(#f12omzljt8o3p5)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1522" x2="1546" y1="116.7754" y2="116.7754"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1484.5" y="3422.4043">Transfer DAO</text><ellipse cx="1534" cy="3441.3574" fill="#FEFECE" filter="url(#f12omzljt8o3p5)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1522" x2="1546" y1="3455.3574" y2="3455.3574"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1787" y="132.3105">Central Store</text><path d="M1817,82.7754 C1817,72.7754 1835,72.7754 1835,72.7754 C1835,72.7754 1853,72.7754 1853,82.7754 L1853,108.7754 C1853,118.7754 1835,118.7754 1835,118.7754 C1835,118.7754 1817,118.7754 1817,108.7754 L1817,82.7754 " fill="#FEFECE" filter="url(#f12omzljt8o3p5)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1817,82.7754 C1817,92.7754 1835,92.7754 1835,92.7754 C1835,92.7754 1853,92.7754 1853,82.7754 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1787" y="3422.4043">Central Store</text><path d="M1817,3435.3574 C1817,3425.3574 1835,3425.3574 1835,3425.3574 C1835,3425.3574 1853,3425.3574 1853,3435.3574 L1853,3461.3574 C1853,3471.3574 1835,3471.3574 1835,3471.3574 C1835,3471.3574 1817,3471.3574 1817,3461.3574 L1817,3435.3574 " fill="#FEFECE" filter="url(#f12omzljt8o3p5)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1817,3435.3574 C1817,3445.3574 1835,3445.3574 1835,3445.3574 C1835,3445.3574 1853,3445.3574 1853,3435.3574 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="3232.6055" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="97.5" y="145.2637"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="658.5" y="2483.1816"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="805" y="3347.8691"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="398.9688" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="936" y="1641.1387"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="464.5898" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1041.5" y="429.6797"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="167.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1412.5" y="938.8906"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1529" y="206.1953"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="176.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1529" y="2636.3789"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1830" y="235.5059"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1830" y="629.7852"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1830" y="779.3379"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1830" y="968.2012"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1830" y="1694.7598"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1830" y="1818.002"/><rect fill="#FFFFFF" filter="url(#f12omzljt8o3p5)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1830" y="2720.3105"/><path d="M13,152.2637 L293,152.2637 L293,159.2637 L283,169.2637 L13,169.2637 L13,152.2637 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3240.6055" style="stroke: #000000; stroke-width: 2.0;" width="2100" x="13" y="152.2637"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="235" x="28" y="165.832">Prepare Position Handler Consume</text><polygon fill="#A80036" points="1517,202.1953,1527,206.1953,1517,210.1953,1521,206.1953" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="1523" y1="206.1953" y2="206.1953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="114.5" y="193.7979">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="127.5" y="186.1426">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="127.5" y="201.4531">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="204.5" y="201.4531">2003</text><polygon fill="#A80036" points="1818,231.5059,1828,235.5059,1818,239.5059,1822,235.5059" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1539" x2="1824" y1="235.5059" y2="235.5059"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1546" y="230.7637">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="1559" y="230.7637">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#f12omzljt8o3p5)" points="1769,248.5059,1900,248.5059,1910,259.5059,1900,271.5059,1769,271.5059,1759,259.5059,1769,248.5059" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1771" y="265.0742">transferStateChange</text><polygon fill="#A80036" points="1550,294.127,1540,298.127,1550,302.127,1546,298.127" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1544" x2="1834" y1="298.127" y2="298.127"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1556" y="293.3848">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="1569" y="293.3848">Return current state of transfer from DB</text><polygon fill="#A80036" points="118.5,323.4375,108.5,327.4375,118.5,331.4375,114.5,327.4375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="1533" y1="327.4375" y2="327.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="124.5" y="322.6953">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="137.5" y="322.6953">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="149.5" y1="372.0586" y2="372.0586"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="149.5" x2="149.5" y1="372.0586" y2="385.0586"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="108.5" x2="149.5" y1="385.0586" y2="385.0586"/><polygon fill="#A80036" points="118.5,381.0586,108.5,385.0586,118.5,389.0586,114.5,385.0586" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="114.5" y="359.6611">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="524" x="127.5" y="352.0059">Validate current state (transferStateChange.transferStateId == 'RECEIVED-PREPARE')</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="127.5" y="367.3164">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="204.5" y="367.3164">2001</text><polygon fill="#A80036" points="1029.5,425.6797,1039.5,429.6797,1029.5,433.6797,1033.5,429.6797" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="1035.5" y1="429.6797" y2="429.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="114.5" y="417.2822">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="543" x="127.5" y="409.627">Select effectivePosition from DB for Payer for update (pass in payload.amount.amount)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="127.5" y="424.9375">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="204.5" y="424.9375">2003</text><path d="M112,442.6797 L112,574.6797 L639,574.6797 L639,452.6797 L629,442.6797 L112,442.6797 " fill="#D3D3D3" filter="url(#f12omzljt8o3p5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M629,442.6797 L629,452.6797 L639,452.6797 L629,442.6797 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="118" y="460.248">transferAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="230" y="460.248">= payload.amount.amount</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="103" x="118" y="475.5586">currentPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="225" y="475.5586">= participantPosition.value</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="113" x="118" y="490.8691">reservedPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="235" y="490.8691">= participantPosition.{original}reservedValue</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="111" x="118" y="506.1797">effectivePosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="233" y="506.1797">= currentPosition + reservedPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="83" x="118" y="521.4902">heldPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="269" x="205" y="521.4902">= effectivePosition + sumTransfersInBatch</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="114" x="118" y="536.8008">availablePosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="215" x="236" y="536.8008">= NetDebitCap - effectivePosition</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="144" x="118" y="552.1113">sumTransfersInBatch</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="266" y="552.1113">= SUM amount against each Transfer in batch</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="118" y="567.4219">sumRESERVED</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="405" x="219" y="567.4219">= SUM of transfers that have met rule criteria and processed = 0</text><path d="M988.5,591.1641 L1153.5,591.1641 L1153.5,598.1641 L1143.5,608.1641 L988.5,608.1641 L988.5,591.1641 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="274.7949" style="stroke: #000000; stroke-width: 2.0;" width="1004.5" x="988.5" y="591.1641"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="1003.5" y="604.7324">DB TRANSACTION</text><polygon fill="#A80036" points="1818,625.7852,1828,629.7852,1818,633.7852,1822,629.7852" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1051.5" x2="1824" y1="629.7852" y2="629.7852"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1058.5" y="625.043">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="343" x="1071.5" y="625.043">Select effectivePosition FOR UPDATE from DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f12omzljt8o3p5)" points="1773,642.7852,1896,642.7852,1906,653.7852,1896,665.7852,1773,665.7852,1763,653.7852,1773,642.7852" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="1775" y="659.3535">participantPosition</text><polygon fill="#A80036" points="1062.5,688.4063,1052.5,692.4063,1062.5,696.4063,1058.5,692.4063" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1056.5" x2="1834" y1="692.4063" y2="692.4063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1068.5" y="687.6641">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="507" x="1081.5" y="687.6641">Return effectivePosition (currentPosition and reservedPosition) from DB for Payer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1051.5" x2="1093.5" y1="737.0273" y2="737.0273"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1093.5" x2="1093.5" y1="737.0273" y2="750.0273"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1052.5" x2="1093.5" y1="750.0273" y2="750.0273"/><polygon fill="#A80036" points="1062.5,746.0273,1052.5,750.0273,1062.5,754.0273,1058.5,750.0273" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1058.5" y="724.6299">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="1071.5" y="716.9746">Increment reservedValue to heldPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="334" x="1071.5" y="732.2852">(reservedValue = reservedPosition + transferAmount)</text><polygon fill="#A80036" points="1818,775.3379,1828,779.3379,1818,783.3379,1822,779.3379" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1051.5" x2="1824" y1="779.3379" y2="779.3379"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1058.5" y="774.5957">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="1080.5" y="774.5957">Persist reservedValue</text><polygon fill="#FFFFE0" filter="url(#f12omzljt8o3p5)" points="1696,822.3379,1973,822.3379,1983,841.3379,1973,860.3379,1696,860.3379,1686,841.3379,1696,822.3379" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1698" y="838.9063">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1752" y="838.9063">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="1698" y="854.2168">SET reservedValue += sumTransfersInBatch</text><polygon fill="#A80036" points="118.5,890.2695,108.5,894.2695,118.5,898.2695,114.5,894.2695" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="1045.5" y1="894.2695" y2="894.2695"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="889.5273">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="146.5" y="889.5273">Return currentPosition and reservedPosition</text><polygon fill="#A80036" points="1400.5,934.8906,1410.5,938.8906,1400.5,942.8906,1404.5,938.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="1406.5" y1="938.8906" y2="938.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="926.4932">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="136.5" y="918.8379">Request position limits for Payer Participant</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="934.1484">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="934.1484">2003</text><polygon fill="#A80036" points="1818,964.2012,1828,968.2012,1818,972.2012,1822,968.2012" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1422.5" x2="1824" y1="968.2012" y2="968.2012"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1429.5" y="963.459">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="1451.5" y="963.459">Request position limits for Payer Participant</text><polygon fill="#FFFFE0" filter="url(#f12omzljt8o3p5)" points="1643,981.2012,2027,981.2012,2037,1015.2012,2027,1050.2012,1643,1050.2012,1633,1015.2012,1643,981.2012" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1645" y="997.7695">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="1685" y="997.7695">participantLimit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="348" x="1645" y="1013.0801">WHERE participantLimit.limitTypeId = 'NET-DEBIT-CAP'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="344" x="1645" y="1028.3906">AND participantLimit.participantId = payload.payerFsp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="380" x="1645" y="1043.7012">AND participantLimit.currencyId = payload.amount.currency</text><polygon fill="#A80036" points="1433.5,1072.7539,1423.5,1076.7539,1433.5,1080.7539,1429.5,1076.7539" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1427.5" x2="1834" y1="1076.7539" y2="1076.7539"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1439.5" y="1072.0117">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="1461.5" y="1072.0117">Return position limits</text><polygon fill="#A80036" points="118.5,1102.0645,108.5,1106.0645,118.5,1110.0645,114.5,1106.0645" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="1416.5" y1="1106.0645" y2="1106.0645"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="1101.3223">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="146.5" y="1101.3223">Return position limits</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="149.5" y1="1135.375" y2="1135.375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="149.5" x2="149.5" y1="1135.375" y2="1148.375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="108.5" x2="149.5" y1="1148.375" y2="1148.375"/><polygon fill="#A80036" points="118.5,1144.375,108.5,1148.375,118.5,1152.375,114.5,1148.375" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="1130.6328">16</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="90" x="136.5" y="1130.6328">latestPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="403" x="230.5" y="1130.6328">= payload.amount.amount + currentPosition + reservedPosition</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="149.5" y1="1192.9961" y2="1192.9961"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="149.5" x2="149.5" y1="1192.9961" y2="1205.9961"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="108.5" x2="149.5" y1="1205.9961" y2="1205.9961"/><polygon fill="#A80036" points="118.5,1201.9961,108.5,1205.9961,118.5,1209.9961,114.5,1205.9961" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="1180.5986">17</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="114" x="136.5" y="1172.9434">availablePosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="227" x="254.5" y="1172.9434">= netDebitCap - effectivePosition =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="324" x="140.5" y="1188.2539">= netDebitCap - currentPosition - reservedPosition</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="149.5" y1="1250.6172" y2="1250.6172"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="149.5" x2="149.5" y1="1250.6172" y2="1263.6172"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="108.5" x2="149.5" y1="1263.6172" y2="1263.6172"/><polygon fill="#A80036" points="118.5,1259.6172,108.5,1263.6172,118.5,1267.6172,114.5,1263.6172" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="1238.2197">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="136.5" y="1230.5645">Validate availablePosition &gt;= transferAmount</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="1245.875">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="1245.875">4001</text><path d="M112,1276.6172 L112,1515.6172 L889,1515.6172 L889,1286.6172 L879,1276.6172 L112,1276.6172 " fill="#D3D3D3" filter="url(#f12omzljt8o3p5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M879,1276.6172 L879,1286.6172 L889,1286.6172 L879,1276.6172 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="118" y="1294.1855">01: sumRESERVED = 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="335" x="118" y="1309.4961">02: preparedTransfer.positionValue = currentPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="285" x="118" y="1324.8066">02: foreach preparedTransfer in transferBatch</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="330" x="134" y="1340.1172">03: if availablePosition &gt;= preparedTransfer.amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="150" y="1355.4277">04: preparedTransfer.state = "RESERVED"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="150" y="1370.7383">05: availablePosition -= preparedTransfer.amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="300" x="150" y="1386.0488">06: sumRESERVED += preparedTransfer.amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="408" x="150" y="1401.3594">07: preparedTransfer.positionValue += preparedTransfer.amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="724" x="150" y="1416.6699">08: preparedTransfer.positionReservedValue = reservedPosition + sumTransfersInBatch - preparedTransfer.amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="134" y="1431.9805">09: else</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="150" y="1447.291">10: preparedTransfer.state = "ABORTED"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="669" x="150" y="1462.6016">11: preparedTransfer.reason = "Net Debit Cap exceeded by this request at this time, please try again later"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="724" x="150" y="1477.9121">12: preparedTransfer.positionReservedValue = reservedPosition + sumTransfersInBatch - preparedTransfer.amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="134" y="1493.2227">13: end if</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="118" y="1508.5332">14: end foreach</text><path d="M23,1532.2754 L85,1532.2754 L85,1539.2754 L75,1549.2754 L23,1549.2754 L23,1532.2754 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1853.5938" style="stroke: #000000; stroke-width: 2.0;" width="2080" x="23" y="1532.2754"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="38" y="1545.8438">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="307" x="100" y="1544.9102">[Calculate &amp; Validate Latest Position Prepare (success)]</text><path d="M33,1556.5859 L738,1556.5859 L738,1563.5859 L728,1573.5859 L33,1573.5859 L33,1556.5859 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="491.5215" style="stroke: #000000; stroke-width: 2.0;" width="2060" x="33" y="1556.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="660" x="48" y="1570.1543">Persist Position change and Transfer State (with transferState='RESERVED' on position check pass)</text><polygon fill="#A80036" points="924,1637.1387,934,1641.1387,924,1645.1387,928,1641.1387" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="930" y1="1641.1387" y2="1641.1387"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="1613.4307">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="136.5" y="1590.4648">Request to increment position</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="37" x="330.5" y="1590.4648">value</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="371.5" y="1590.4648">by</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="390.5" y="1590.4648">sumRESERVED</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="487.5" y="1590.4648">,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="136.5" y="1605.7754">decrement</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="206.5" y="1605.7754">reservedValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="308.5" y="1605.7754">by</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="144" x="327.5" y="1605.7754">sumTransfersInBatch</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="55" x="475.5" y="1605.7754">for Payer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="136.5" y="1621.0859">and persist state change</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="1636.3965">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="1636.3965">2003</text><path d="M883.5,1656.1387 L1048.5,1656.1387 L1048.5,1663.1387 L1038.5,1673.1387 L883.5,1673.1387 L883.5,1656.1387 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="355.6582" style="stroke: #000000; stroke-width: 2.0;" width="1199.5" x="883.5" y="1656.1387"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="898.5" y="1669.707">DB TRANSACTION</text><polygon fill="#A80036" points="1818,1690.7598,1828,1694.7598,1818,1698.7598,1822,1694.7598" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="946" x2="1824" y1="1694.7598" y2="1694.7598"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="953" y="1690.0176">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="975" y="1690.0176">Persist latest position</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="37" x="1116" y="1690.0176">value</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="1157" y="1690.0176">and</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="1184" y="1690.0176">reservedValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="1286" y="1690.0176">to DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f12omzljt8o3p5)" points="1710,1737.7598,1959,1737.7598,1969,1763.7598,1959,1790.7598,1710,1790.7598,1700,1763.7598,1710,1737.7598" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1712" y="1754.3281">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1766" y="1754.3281">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="1712" y="1769.6387">SET value += sumRESERVED,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="245" x="1712" y="1784.9492">reservedValue -= sumTransfersInBatch</text><polygon fill="#A80036" points="1818,1814.002,1828,1818.002,1818,1822.002,1822,1818.002" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="946" x2="1824" y1="1818.002" y2="1818.002"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="953" y="1813.2598">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="334" x="975" y="1813.2598">Persist transfer state and participant position change</text><polygon fill="#FFFFE0" filter="url(#f12omzljt8o3p5)" points="1606,1861.002,2063,1861.002,2073,1933.002,2063,2006.002,1606,2006.002,1596,1933.002,1606,1861.002" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="254" x="1608" y="1877.5703">bulk insert for all processed transfers</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1862" y="1877.5703">:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1624" y="1892.8809">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1612" y="1908.1914"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="1624" y="1923.502">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="1672" y="1923.502">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="437" x="1624" y="1938.8125">SET transferStateChangeId = preparedTransfer.transferStateChangeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="391" x="1624" y="1954.123">particpantPositionId = preparedTransfer.participantPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="1624" y="1969.4336">value = preparedTransfer.positionValue,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="1624" y="1984.7441">reservedValue = preparedTransfer.positionReservedValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1612" y="2000.0547"/><polygon fill="#A80036" points="118.5,2036.1074,108.5,2040.1074,118.5,2044.1074,114.5,2040.1074" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="940" y1="2040.1074" y2="2040.1074"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="2035.3652">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="146.5" y="2035.3652">Return success</text><path d="M112,2060.1074 L112,2437.1074 L374,2437.1074 L374,2070.1074 L364,2060.1074 L112,2060.1074 " fill="#FFFF00" filter="url(#f12omzljt8o3p5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M364,2060.1074 L364,2070.1074 L374,2070.1074 L364,2060.1074 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="118" y="2077.6758">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="118" y="2092.9863">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="134" y="2108.2969">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="134" y="2123.6074">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="134" y="2138.918">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="134" y="2154.2285">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="134" y="2169.5391">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="150" y="2184.8496">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="150" y="2200.1602">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="134" y="2215.4707">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="134" y="2230.7813">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="150" y="2246.0918">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="166" y="2261.4023">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="166" y="2276.7129">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="166" y="2292.0234">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="166" y="2307.334">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="166" y="2322.6445">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="166" y="2337.9551">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="182" y="2353.2656">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="182" y="2368.5762">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="2383.8867">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="2399.1973">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="2414.5078">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="118" y="2429.8184">}</text><polygon fill="#A80036" points="646.5,2479.1816,656.5,2483.1816,646.5,2487.1816,650.5,2483.1816" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="652.5" y1="2483.1816" y2="2483.1816"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="2470.7842">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="136.5" y="2463.1289">Publish Transfer event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="2478.4395">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="2478.4395">2003</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="2103" y1="2522.1816" y2="2522.1816"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="301" x="28" y="2532.8164">[Calculate &amp; Validate Latest Position Prepare (failure)]</text><path d="M112,2541.1367 L112,2566.1367 L244,2566.1367 L244,2551.1367 L234,2541.1367 L112,2541.1367 " fill="#FF0000" filter="url(#f12omzljt8o3p5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M234,2541.1367 L234,2551.1367 L244,2551.1367 L234,2541.1367 " fill="#FF0000" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="118" y="2558.7051">Validation failure!</text><path d="M33,2582.4473 L584,2582.4473 L584,2589.4473 L574,2599.4473 L33,2599.4473 L33,2582.4473 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="238.4844" style="stroke: #000000; stroke-width: 2.0;" width="1887" x="33" y="2582.4473"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="506" x="48" y="2596.0156">Persist Transfer State (with transferState='ABORTED' on position check fail)</text><polygon fill="#A80036" points="1517,2632.3789,1527,2636.3789,1517,2640.3789,1521,2636.3789" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="1523" y1="2636.3789" y2="2636.3789"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="2623.9814">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="136.5" y="2616.3262">Request to persist transfer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="2631.6367">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="2631.6367">2003</text><path d="M112,2649.3789 L112,2689.3789 L798,2689.3789 L798,2659.3789 L788,2649.3789 L112,2649.3789 " fill="#D3D3D3" filter="url(#f12omzljt8o3p5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M788,2649.3789 L788,2659.3789 L798,2659.3789 L788,2649.3789 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="118" y="2666.9473">transferStateChange.state = "ABORTED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="665" x="118" y="2682.2578">transferStateChange.reason = "Net Debit Cap exceeded by this request at this time, please try again later"</text><polygon fill="#A80036" points="1818,2716.3105,1828,2720.3105,1818,2724.3105,1822,2720.3105" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1539" x2="1824" y1="2720.3105" y2="2720.3105"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1546" y="2715.5684">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1568" y="2715.5684">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#f12omzljt8o3p5)" points="1769,2763.3105,1900,2763.3105,1910,2774.3105,1900,2786.3105,1769,2786.3105,1759,2774.3105,1769,2763.3105" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1771" y="2779.8789">transferStateChange</text><polygon fill="#A80036" points="118.5,2808.9316,108.5,2812.9316,118.5,2816.9316,114.5,2812.9316" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="1533" y1="2812.9316" y2="2812.9316"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="2808.1895">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="146.5" y="2808.1895">Return success</text><path d="M112,2832.9316 L112,3301.9316 L522,3301.9316 L522,2842.9316 L512,2832.9316 L112,2832.9316 " fill="#FFFF00" filter="url(#f12omzljt8o3p5)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M512,2832.9316 L512,2842.9316 L522,2842.9316 L512,2832.9316 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="118" y="2850.5">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="118" y="2865.8105">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="134" y="2881.1211">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="134" y="2896.4316">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="134" y="2911.7422">to: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="134" y="2927.0527">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="134" y="2942.3633">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="150" y="2957.6738">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="150" y="2972.9844">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="166" y="2988.2949">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="182" y="3003.6055">"errorCode": 4001,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="325" x="182" y="3018.916">"errorDescription": "Payer FSP insufficient liquidity",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="182" y="3034.2266">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="3049.5371">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="134" y="3064.8477">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="134" y="3080.1582">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="150" y="3095.4688">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="166" y="3110.7793">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="166" y="3126.0898">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="166" y="3141.4004">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="166" y="3156.7109">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="166" y="3172.0215">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="166" y="3187.332">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="182" y="3202.6426">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="182" y="3217.9531">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="182" y="3233.2637">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="3248.5742">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="3263.8848">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="3279.1953">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="118" y="3294.5059">}</text><polygon fill="#A80036" points="793,3343.8691,803,3347.8691,793,3351.8691,797,3347.8691" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="799" y1="3347.8691" y2="3347.8691"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="3335.4717">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="136.5" y="3327.8164">Publish Notification (failure) event for Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="3343.127">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="3343.127">2003</text><!--
@startuml
title 1.3.1 Prepare Position Handler Consume

autonumber


control "Position Handler" as POS_HANDLER
collections "Transfer-Topic" as TOPIC_TRANSFERS
entity "Position\nManagement\nFacade" as POS_MGMT
entity "Position DAO" as POS_DAO
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Participant DAO" as PARTICIPANT_DAO
entity "Transfer DAO" as TRANS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant POS_HANDLER
    participant TOPIC_TRANSFERS
    participant TOPIC_NOTIFICATIONS
    participant POS_MGMT
    participant POS_DAO
    participant PARTICIPANT_DAO
    participant TRANS_DAO
    participant DB
end box

activate POS_HANDLER
group Prepare Position Handler Consume
    POS_HANDLER -> TRANS_DAO: Request current state of transfer from DB\n<color #FF0000><b>Error code:</b> 2003</color>
    activate TRANS_DAO
    TRANS_DAO -> DB: Retrieve current state of transfer from DB
    activate DB
    hnote over DB #lightyellow
        transferStateChange
    end note
    DB - -> TRANS_DAO: Return current state of transfer from DB
    deactivate DB
    TRANS_DAO - -> POS_HANDLER: Return current state of transfer from DB
    deactivate TRANS_DAO

    POS_HANDLER <-> POS_HANDLER: Validate current state (transferStateChange.transferStateId == 'RECEIVED-PREPARE')\n<color #FF0000><b>Error code:</b> 2001</color>
    POS_HANDLER -> POS_DAO: Select effectivePosition from DB for Payer for update (pass in payload.amount.amount)\n<color #FF0000><b>Error code:</b> 2003</color>
    activate POS_DAO
    note right of POS_HANDLER #lightgray
        **transferAmount** = payload.amount.amount
        **currentPosition** = participantPosition.value
        **reservedPosition** = participantPosition.{original}reservedValue
        **effectivePosition** = currentPosition + reservedPosition
        **heldPosition** = effectivePosition + sumTransfersInBatch
        **availablePosition** = NetDebitCap - effectivePosition
        **sumTransfersInBatch** = SUM amount against each Transfer in batch
        **sumRESERVED** = SUM of transfers that have met rule criteria and processed = 0
    end note
    group <color #blue>DB TRANSACTION</color>
        POS_DAO -> DB: Select effectivePosition FOR UPDATE from DB for Payer
        activate DB
        hnote over DB #lightyellow
            participantPosition
        end note
        DB - -> POS_DAO: Return effectivePosition (currentPosition and reservedPosition) from DB for Payer
        deactivate DB
        POS_DAO -> POS_DAO: Increment reservedValue to heldPosition\n(reservedValue = reservedPosition + transferAmount)
        POS_DAO -> DB: Persist reservedValue
        activate DB
        hnote over DB #lightyellow
            UPDATE **participantPosition**
            SET reservedValue += sumTransfersInBatch
        end note
        deactivate DB
    end
    POS_DAO - -> POS_HANDLER: Return currentPosition and reservedPosition
    deactivate POS_DAO

    POS_HANDLER -> PARTICIPANT_DAO: Request position limits for Payer Participant\n<color #FF0000><b>Error code:</b> 2003</color>
    activate PARTICIPANT_DAO
    PARTICIPANT_DAO -> DB: Request position limits for Payer Participant
    activate DB
    hnote over DB #lightyellow
        FROM **participantLimit**
        WHERE participantLimit.limitTypeId = 'NET-DEBIT-CAP'
        AND participantLimit.participantId = payload.payerFsp
        AND participantLimit.currencyId = payload.amount.currency
    end note
    DB - -> PARTICIPANT_DAO: Return position limits
    deactivate DB
    PARTICIPANT_DAO - -> POS_HANDLER: Return position limits
    deactivate PARTICIPANT_DAO

    POS_HANDLER <-> POS_HANDLER: **latestPosition** = payload.amount.amount + currentPosition + reservedPosition
    POS_HANDLER <-> POS_HANDLER: **availablePosition** = netDebitCap - effectivePosition =\n = netDebitCap - currentPosition - reservedPosition
    POS_HANDLER <-> POS_HANDLER: Validate availablePosition >= transferAmount\n<color #FF0000><b>Error code:</b> 4001</color>
    note right of POS_HANDLER #lightgray
    01: sumRESERVED = 0
    02: preparedTransfer.positionValue = currentPosition
    02: foreach preparedTransfer in transferBatch
        03: if availablePosition >= preparedTransfer.amount
            04: preparedTransfer.state = "RESERVED"
            05: availablePosition -= preparedTransfer.amount
            06: sumRESERVED += preparedTransfer.amount
            07: preparedTransfer.positionValue += preparedTransfer.amount
            08: preparedTransfer.positionReservedValue = reservedPosition + sumTransfersInBatch - preparedTransfer.amount
        09: else
            10: preparedTransfer.state = "ABORTED"
            11: preparedTransfer.reason = "Net Debit Cap exceeded by this request at this time, please try again later"
            12: preparedTransfer.positionReservedValue = reservedPosition + sumTransfersInBatch - preparedTransfer.amount
        13: end if
    14: end foreach
    end note

    alt Calculate & Validate Latest Position Prepare (success)
        group Persist Position change and Transfer State (with transferState='RESERVED' on position check pass)
            POS_HANDLER -> POS_MGMT: Request to increment position **value** by **sumRESERVED**,\ndecrement **reservedValue** by **sumTransfersInBatch** for Payer\nand persist state change\n<color #FF0000><b>Error code:</b> 2003</color>
            group <color #blue>DB TRANSACTION</color>
                activate POS_MGMT
                POS_MGMT->DB: Persist latest position **value** and **reservedValue** to DB for Payer
                hnote over DB #lightyellow
                    UPDATE **participantPosition**
                    SET value += sumRESERVED,
                    reservedValue -= sumTransfersInBatch
                end note
                activate DB
                deactivate DB
                deactivate POS_DAO
                POS_MGMT -> DB: Persist transfer state and participant position change
                hnote over DB #lightyellow
                    **bulk insert for all processed transfers**:
                        transferStateChange

                        INSERT **participantPositionChange**
                        SET transferStateChangeId = preparedTransfer.transferStateChangeId,
                        particpantPositionId = preparedTransfer.participantPositionId,
                        value = preparedTransfer.positionValue,
                        reservedValue = preparedTransfer.positionReservedValue

                end note
                activate DB
                deactivate DB
                deactivate TRANS_DAO
            end
            POS_MGMT - -> POS_HANDLER: Return success
            deactivate POS_MGMT
        end
        note right of POS_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_TRANSFERS: Publish Transfer event\n<color #FF0000><b>Error code:</b> 2003</color>
        activate TOPIC_TRANSFERS
        deactivate TOPIC_TRANSFERS
   else Calculate & Validate Latest Position Prepare (failure)
        note right of POS_HANDLER #red: Validation failure!

        group Persist Transfer State (with transferState='ABORTED' on position check fail)
            POS_HANDLER -> TRANS_DAO: Request to persist transfer\n<color #FF0000><b>Error code:</b> 2003</color>
            activate TRANS_DAO
            note right of POS_HANDLER #lightgray
                transferStateChange.state = "ABORTED",
                transferStateChange.reason = "Net Debit Cap exceeded by this request at this time, please try again later"
            end note
            TRANS_DAO -> DB: Persist transfer state
            hnote over DB #lightyellow
                transferStateChange
            end note
            activate DB
            deactivate DB
            TRANS_DAO - -> POS_HANDLER: Return success
            deactivate TRANS_DAO
        end

        note right of POS_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <ledgerName>,
                to: <transferMessage.payerFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                        "errorInformation": {
                            "errorCode": 4001,
                            "errorDescription": "Payer FSP insufficient liquidity",
                            "extensionList": <transferMessage.extensionList>
                    }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: notification,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification (failure) event for Payer\n<color #FF0000><b>Error code:</b> 2003</color>
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS
        deactivate POS_HANDLER
   end
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.5
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>